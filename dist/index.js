"use strict";var ec=Object.defineProperty;var wi=s=>{throw TypeError(s)};var tc=(s,e,t)=>e in s?ec(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var w=(s,e,t)=>tc(s,typeof e!="symbol"?e+"":e,t),sa=(s,e,t)=>e.has(s)||wi("Cannot "+t);var O=(s,e,t)=>(sa(s,e,"read from private field"),t?t.call(s):e.get(s)),Ne=(s,e,t)=>e.has(s)?wi("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),Me=(s,e,t,r)=>(sa(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),kt=(s,e,t)=>(sa(s,e,"access private method"),t);const Ka=require("siyuan"),ya=!1;var Ga=Array.isArray,rc=Array.prototype.indexOf,Vn=Array.from,sc=Object.defineProperty,Ls=Object.getOwnPropertyDescriptor,Do=Object.getOwnPropertyDescriptors,nc=Object.prototype,ac=Array.prototype,Qa=Object.getPrototypeOf,Ti=Object.isExtensible;function ic(s){for(var e=0;e<s.length;e++)s[e]()}function Eo(){var s,e,t=new Promise((r,n)=>{s=r,e=n});return{promise:t,resolve:s,reject:e}}function xo(s,e){if(Array.isArray(s))return s;if(!(Symbol.iterator in s))return Array.from(s);const t=[];for(const r of s)if(t.push(r),t.length===e)break;return t}const Dt=2,Ln=4,Xn=8,Ao=1<<24,Lr=16,Fr=32,Ts=64,$a=128,ar=512,Ot=1024,Pt=2048,Pr=4096,Qt=8192,Or=16384,Va=32768,Hs=65536,Si=1<<17,Co=1<<18,Xs=1<<19,oc=1<<20,Cr=1<<25,_s=32768,ma=1<<21,Xa=1<<22,Xr=1<<23,Mr=Symbol("$state"),lc=Symbol("legacy props"),cc=Symbol(""),qs=new class extends Error{constructor(){super(...arguments);w(this,"name","StaleReactionError");w(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Za(s){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function uc(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function dc(s){throw new Error("https://svelte.dev/e/effect_in_teardown")}function hc(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function fc(s){throw new Error("https://svelte.dev/e/effect_orphan")}function vc(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function pc(s){throw new Error("https://svelte.dev/e/props_invalid_value")}function yc(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function mc(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function gc(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function bc(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const _c=1,kc=2,Io=4,wc=8,Tc=16,Sc=1,Dc=4,Ec=8,xc=16,Ac=1,Cc=2,wt=Symbol(),Ic="http://www.w3.org/1999/xhtml";function Oc(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Mc(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Oo(s){return s===this.v}function Mo(s,e){return s!=s?e==e:s!==e||s!==null&&typeof s=="object"||typeof s=="function"}function No(s){return!Mo(s,this.v)}let Nc=!1,ht=null;function Ws(s){ht=s}function qo(s){return Lo().get(s)}function qc(s,e){return Lo().set(s,e),e}function Je(s,e=!1,t){ht={p:ht,i:!1,c:null,e:null,s,x:null,l:null}}function et(s){var e=ht,t=e.e;if(t!==null){e.e=null;for(var r of t)tl(r)}return e.i=!0,ht=e.p,{}}function Ro(){return!0}function Lo(s){return ht===null&&Za(),ht.c??(ht.c=new Map(Rc(ht)||void 0))}function Rc(s){let e=s.p;for(;e!==null;){const t=e.c;if(t!==null)return t;e=e.p}return null}let os=[];function Fo(){var s=os;os=[],ic(s)}function Zs(s){if(os.length===0&&!on){var e=os;queueMicrotask(()=>{e===os&&Fo()})}os.push(s)}function Lc(){for(;os.length>0;)Fo()}function Po(s){var e=je;if(e===null)return xe.f|=Xr,s;if(e.f&Va)Ks(s,e);else{if(!(e.f&$a))throw s;e.b.error(s)}}function Ks(s,e){for(;e!==null;){if(e.f&$a)try{e.b.error(s);return}catch(t){s=t}e=e.parent}throw s}const Fc=-7169;function gt(s,e){s.f=s.f&Fc|e}function Ja(s){s.f&ar||s.deps===null?gt(s,Ot):gt(s,Pr)}function Bo(s){if(s!==null)for(const e of s)!(e.f&Dt)||!(e.f&_s)||(e.f^=_s,Bo(e.deps))}function Uo(s,e,t){s.f&Pt?e.add(s):s.f&Pr&&t.add(s),Bo(s.deps),gt(s,Ot)}const En=new Set;let De=null,an=null,Tt=null,rr=[],Zn=null,ga=!1,on=!1;var Ps,Bs,us,ds,mn,Us,zs,ir,ba,_a,zo,jo;const Gn=class Gn{constructor(){Ne(this,ir);w(this,"committed",!1);w(this,"current",new Map);w(this,"previous",new Map);Ne(this,Ps,new Set);Ne(this,Bs,new Set);Ne(this,us,0);Ne(this,ds,0);Ne(this,mn,null);Ne(this,Us,new Set);Ne(this,zs,new Set);w(this,"skipped_effects",new Set);w(this,"is_fork",!1)}is_deferred(){return this.is_fork||O(this,ds)>0}process(e){var n;rr=[],an=null,this.apply();var t=[],r=[];for(const a of e)kt(this,ir,ba).call(this,a,t,r);this.is_fork||kt(this,ir,zo).call(this),this.is_deferred()?(kt(this,ir,_a).call(this,r),kt(this,ir,_a).call(this,t)):(an=this,De=null,Di(r),Di(t),an=null,(n=O(this,mn))==null||n.resolve()),Tt=null}capture(e,t){t!==wt&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Xr||(this.current.set(e,e.v),Tt==null||Tt.set(e,e.v))}activate(){De=this,this.apply()}deactivate(){De===this&&(De=null,Tt=null)}flush(){if(this.activate(),rr.length>0){if(Yo(),De!==null&&De!==this)return}else O(this,us)===0&&this.process([]);this.deactivate()}discard(){for(const e of O(this,Bs))e(this);O(this,Bs).clear()}increment(e){Me(this,us,O(this,us)+1),e&&Me(this,ds,O(this,ds)+1)}decrement(e){Me(this,us,O(this,us)-1),e&&Me(this,ds,O(this,ds)-1),this.revive()}revive(){for(const e of O(this,Us))O(this,zs).delete(e),gt(e,Pt),qr(e);for(const e of O(this,zs))gt(e,Pr),qr(e);this.flush()}oncommit(e){O(this,Ps).add(e)}ondiscard(e){O(this,Bs).add(e)}settled(){return(O(this,mn)??Me(this,mn,Eo())).promise}static ensure(){if(De===null){const e=De=new Gn;En.add(De),on||Gn.enqueue(()=>{De===e&&e.flush()})}return De}static enqueue(e){Zs(e)}apply(){}};Ps=new WeakMap,Bs=new WeakMap,us=new WeakMap,ds=new WeakMap,mn=new WeakMap,Us=new WeakMap,zs=new WeakMap,ir=new WeakSet,ba=function(e,t,r){e.f^=Ot;for(var n=e.first,a=null;n!==null;){var o=n.f,l=(o&(Fr|Ts))!==0,c=l&&(o&Ot)!==0,u=c||(o&Qt)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){l?n.f^=Ot:a!==null&&o&(Ln|Xn|Ao)?a.b.defer_effect(n):o&Ln?t.push(n):wn(n)&&(o&Lr&&O(this,Us).add(n),hn(n));var h=n.first;if(h!==null){n=h;continue}}var p=n.parent;for(n=n.next;n===null&&p!==null;)p===a&&(a=null),n=p.next,p=p.parent}},_a=function(e){for(var t=0;t<e.length;t+=1)Uo(e[t],O(this,Us),O(this,zs))},zo=function(){if(O(this,ds)===0){for(const e of O(this,Ps))e();O(this,Ps).clear()}O(this,us)===0&&kt(this,ir,jo).call(this)},jo=function(){var n;if(En.size>1){this.previous.clear();var e=Tt,t=!0;for(const a of En){if(a===this){t=!1;continue}const o=[];for(const[c,u]of this.current){if(a.current.has(c))if(t&&u!==a.current.get(c))a.current.set(c,u);else continue;o.push(c)}if(o.length===0)continue;const l=[...a.current.keys()].filter(c=>!this.current.has(c));if(l.length>0){var r=rr;rr=[];const c=new Set,u=new Map;for(const h of o)Ho(h,l,c,u);if(rr.length>0){De=a,a.apply();for(const h of rr)kt(n=a,ir,ba).call(n,h,[],[]);a.deactivate()}rr=r}}De=null,Tt=e}this.committed=!0,En.delete(this)};let Ir=Gn;function Pc(s){var e=on;on=!0;try{for(var t;;){if(Lc(),rr.length===0&&(De==null||De.flush(),rr.length===0))return Zn=null,t;Yo()}}finally{on=e}}function Yo(){var s=ms;ga=!0;var e=null;try{var t=0;for(Pn(!0);rr.length>0;){var r=Ir.ensure();if(t++>1e3){var n,a;Bc()}r.process(rr),Zr.clear()}}finally{ga=!1,Pn(s),Zn=null}}function Bc(){try{vc()}catch(s){Ks(s,Zn)}}let cr=null;function Di(s){var e=s.length;if(e!==0){for(var t=0;t<e;){var r=s[t++];if(!(r.f&(Or|Qt))&&wn(r)&&(cr=new Set,hn(r),r.deps===null&&r.first===null&&r.nodes===null&&(r.teardown===null&&r.ac===null?al(r):r.fn=null),(cr==null?void 0:cr.size)>0)){Zr.clear();for(const n of cr){if(n.f&(Or|Qt))continue;const a=[n];let o=n.parent;for(;o!==null;)cr.has(o)&&(cr.delete(o),a.push(o)),o=o.parent;for(let l=a.length-1;l>=0;l--){const c=a[l];c.f&(Or|Qt)||hn(c)}}cr.clear()}}cr=null}}function Ho(s,e,t,r){if(!t.has(s)&&(t.add(s),s.reactions!==null))for(const n of s.reactions){const a=n.f;a&Dt?Ho(n,e,t,r):a&(Xa|Lr)&&!(a&Pt)&&Wo(n,e,r)&&(gt(n,Pt),qr(n))}}function Wo(s,e,t){const r=t.get(s);if(r!==void 0)return r;if(s.deps!==null)for(const n of s.deps){if(e.includes(n))return!0;if(n.f&Dt&&Wo(n,e,t))return t.set(n,!0),!0}return t.set(s,!1),!1}function qr(s){for(var e=Zn=s;e.parent!==null;){e=e.parent;var t=e.f;if(ga&&e===je&&t&Lr&&!(t&Co))return;if(t&(Ts|Fr)){if(!(t&Ot))return;e.f^=Ot}}rr.push(e)}function Uc(s){let e=0,t=ks(0),r;return()=>{ri()&&(i(t),kn(()=>(e===0&&(r=ts(()=>s(()=>ln(t)))),e+=1,()=>{Zs(()=>{e-=1,e===0&&(r==null||r(),r=void 0,ln(t))})})))}}var zc=Hs|Xs|$a;function jc(s,e,t){new Yc(s,e,t)}var er,Wa,gr,hs,br,tr,Bt,_r,Ar,Wr,fs,Kr,vs,js,Ys,Gr,Qn,mt,Hc,Wc,ka,On,Mn,wa;class Yc{constructor(e,t,r){Ne(this,mt);w(this,"parent");w(this,"is_pending",!1);Ne(this,er);Ne(this,Wa,null);Ne(this,gr);Ne(this,hs);Ne(this,br);Ne(this,tr,null);Ne(this,Bt,null);Ne(this,_r,null);Ne(this,Ar,null);Ne(this,Wr,null);Ne(this,fs,0);Ne(this,Kr,0);Ne(this,vs,!1);Ne(this,js,new Set);Ne(this,Ys,new Set);Ne(this,Gr,null);Ne(this,Qn,Uc(()=>(Me(this,Gr,ks(O(this,fs))),()=>{Me(this,Gr,null)})));Me(this,er,e),Me(this,gr,t),Me(this,hs,r),this.parent=je.b,this.is_pending=!!O(this,gr).pending,Me(this,br,ai(()=>{je.b=this;{var n=kt(this,mt,ka).call(this);try{Me(this,tr,sr(()=>r(n)))}catch(a){this.error(a)}O(this,Kr)>0?kt(this,mt,Mn).call(this):this.is_pending=!1}return()=>{var a;(a=O(this,Wr))==null||a.remove()}},zc))}defer_effect(e){Uo(e,O(this,js),O(this,Ys))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!O(this,gr).pending}update_pending_count(e){kt(this,mt,wa).call(this,e),Me(this,fs,O(this,fs)+e),O(this,Gr)&&Gs(O(this,Gr),O(this,fs))}get_effect_pending(){return O(this,Qn).call(this),i(O(this,Gr))}error(e){var t=O(this,gr).onerror;let r=O(this,gr).failed;if(O(this,vs)||!t&&!r)throw e;O(this,tr)&&(zt(O(this,tr)),Me(this,tr,null)),O(this,Bt)&&(zt(O(this,Bt)),Me(this,Bt,null)),O(this,_r)&&(zt(O(this,_r)),Me(this,_r,null));var n=!1,a=!1;const o=()=>{if(n){Mc();return}n=!0,a&&bc(),Ir.ensure(),Me(this,fs,0),O(this,_r)!==null&&ys(O(this,_r),()=>{Me(this,_r,null)}),this.is_pending=this.has_pending_snippet(),Me(this,tr,kt(this,mt,On).call(this,()=>(Me(this,vs,!1),sr(()=>O(this,hs).call(this,O(this,er)))))),O(this,Kr)>0?kt(this,mt,Mn).call(this):this.is_pending=!1};var l=xe;try{Ut(null),a=!0,t==null||t(e,o),a=!1}catch(c){Ks(c,O(this,br)&&O(this,br).parent)}finally{Ut(l)}r&&Zs(()=>{Me(this,_r,kt(this,mt,On).call(this,()=>{Ir.ensure(),Me(this,vs,!0);try{return sr(()=>{r(O(this,er),()=>e,()=>o)})}catch(c){return Ks(c,O(this,br).parent),null}finally{Me(this,vs,!1)}}))})}}er=new WeakMap,Wa=new WeakMap,gr=new WeakMap,hs=new WeakMap,br=new WeakMap,tr=new WeakMap,Bt=new WeakMap,_r=new WeakMap,Ar=new WeakMap,Wr=new WeakMap,fs=new WeakMap,Kr=new WeakMap,vs=new WeakMap,js=new WeakMap,Ys=new WeakMap,Gr=new WeakMap,Qn=new WeakMap,mt=new WeakSet,Hc=function(){try{Me(this,tr,sr(()=>O(this,hs).call(this,O(this,er))))}catch(e){this.error(e)}},Wc=function(){const e=O(this,gr).pending;e&&(Me(this,Bt,sr(()=>e(O(this,er)))),Ir.enqueue(()=>{var t=kt(this,mt,ka).call(this);Me(this,tr,kt(this,mt,On).call(this,()=>(Ir.ensure(),sr(()=>O(this,hs).call(this,t))))),O(this,Kr)>0?kt(this,mt,Mn).call(this):(ys(O(this,Bt),()=>{Me(this,Bt,null)}),this.is_pending=!1)}))},ka=function(){var e=O(this,er);return this.is_pending&&(Me(this,Wr,Nr()),O(this,er).before(O(this,Wr)),e=O(this,Wr)),e},On=function(e){var t=je,r=xe,n=ht;Tr(O(this,br)),Ut(O(this,br)),Ws(O(this,br).ctx);try{return e()}catch(a){return Po(a),null}finally{Tr(t),Ut(r),Ws(n)}},Mn=function(){const e=O(this,gr).pending;O(this,tr)!==null&&(Me(this,Ar,document.createDocumentFragment()),O(this,Ar).append(O(this,Wr)),ll(O(this,tr),O(this,Ar))),O(this,Bt)===null&&Me(this,Bt,sr(()=>e(O(this,er))))},wa=function(e){var t;if(!this.has_pending_snippet()){this.parent&&kt(t=this.parent,mt,wa).call(t,e);return}if(Me(this,Kr,O(this,Kr)+e),O(this,Kr)===0){this.is_pending=!1;for(const r of O(this,js))gt(r,Pt),qr(r);for(const r of O(this,Ys))gt(r,Pr),qr(r);O(this,js).clear(),O(this,Ys).clear(),O(this,Bt)&&ys(O(this,Bt),()=>{Me(this,Bt,null)}),O(this,Ar)&&(O(this,er).before(O(this,Ar)),Me(this,Ar,null))}};function Kc(s,e,t,r){const n=Jn;if(t.length===0&&s.length===0){r(e.map(n));return}var a=De,o=je,l=Gc();function c(){Promise.all(t.map(u=>Qc(u))).then(u=>{l();try{r([...e.map(n),...u])}catch(h){o.f&Or||Ks(h,o)}a==null||a.deactivate(),Fn()}).catch(u=>{Ks(u,o)})}s.length>0?Promise.all(s).then(()=>{l();try{return c()}finally{a==null||a.deactivate(),Fn()}}):c()}function Gc(){var s=je,e=xe,t=ht,r=De;return function(a=!0){Tr(s),Ut(e),Ws(t),a&&(r==null||r.activate())}}function Fn(){Tr(null),Ut(null),Ws(null)}function Jn(s){var e=Dt|Pt,t=xe!==null&&xe.f&Dt?xe:null;return je!==null&&(je.f|=Xs),{ctx:ht,deps:null,effects:null,equals:Oo,f:e,fn:s,reactions:null,rv:0,v:wt,wv:0,parent:t??je,ac:null}}function Qc(s,e,t){let r=je;r===null&&uc();var n=r.b,a=void 0,o=ks(wt),l=!xe,c=new Map;return au(()=>{var y;var u=Eo();a=u.promise;try{Promise.resolve(s()).then(u.resolve,u.reject).then(()=>{h===De&&h.committed&&h.deactivate(),Fn()})}catch(k){u.reject(k),Fn()}var h=De;if(l){var p=n.is_rendered();n.update_pending_count(1),h.increment(p),(y=c.get(h))==null||y.reject(qs),c.delete(h),c.set(h,u)}const v=(k,m=void 0)=>{if(h.activate(),m)m!==qs&&(o.f|=Xr,Gs(o,m));else{o.f&Xr&&(o.f^=Xr),Gs(o,k);for(const[g,_]of c){if(c.delete(g),g===h)break;_.reject(qs)}}l&&(n.update_pending_count(-1),h.decrement(p))};u.promise.then(v,k=>v(null,k||"unknown"))}),si(()=>{for(const u of c.values())u.reject(qs)}),new Promise(u=>{function h(p){function v(){p===a?u(o):h(a)}p.then(v,v)}h(a)})}function V(s){const e=Jn(s);return cl(e),e}function Ko(s){const e=Jn(s);return e.equals=No,e}function Go(s){var e=s.effects;if(e!==null){s.effects=null;for(var t=0;t<e.length;t+=1)zt(e[t])}}function $c(s){for(var e=s.parent;e!==null;){if(!(e.f&Dt))return e.f&Or?null:e;e=e.parent}return null}function ei(s){var e,t=je;Tr($c(s));try{s.f&=~_s,Go(s),e=fl(s)}finally{Tr(t)}return e}function Qo(s){var e=ei(s);if(!s.equals(e)&&(s.wv=dl(),(!(De!=null&&De.is_fork)||s.deps===null)&&(s.v=e,s.deps===null))){gt(s,Ot);return}es||(Tt!==null?(ri()||De!=null&&De.is_fork)&&Tt.set(s,e):Ja(s))}let Ta=new Set;const Zr=new Map;let $o=!1;function ks(s,e){var t={f:0,v:s,reactions:null,equals:Oo,rv:0,wv:0};return t}function W(s,e){const t=ks(s);return cl(t),t}function Vc(s,e=!1,t=!0){const r=ks(s);return e||(r.equals=No),r}function b(s,e,t=!1){xe!==null&&(!hr||xe.f&Si)&&Ro()&&xe.f&(Dt|Lr|Xa|Si)&&!(Ft!=null&&Ft.includes(s))&&gc();let r=t?ke(e):e;return Gs(s,r)}function Gs(s,e){if(!s.equals(e)){var t=s.v;es?Zr.set(s,e):Zr.set(s,t),s.v=e;var r=Ir.ensure();if(r.capture(s,t),s.f&Dt){const n=s;s.f&Pt&&ei(n),Ja(n)}s.wv=dl(),Vo(s,Pt),je!==null&&je.f&Ot&&!(je.f&(Fr|Ts))&&(Jt===null?ou([s]):Jt.push(s)),!r.is_fork&&Ta.size>0&&!$o&&Xc()}return e}function Xc(){$o=!1;var s=ms;Pn(!0);const e=Array.from(Ta);try{for(const t of e)t.f&Ot&&gt(t,Pr),wn(t)&&hn(t)}finally{Pn(s)}Ta.clear()}function Ei(s,e=1){var t=i(s),r=e===1?t++:t--;return b(s,t),r}function ln(s){b(s,s.v+1)}function Vo(s,e){var t=s.reactions;if(t!==null)for(var r=t.length,n=0;n<r;n++){var a=t[n],o=a.f,l=(o&Pt)===0;if(l&&gt(a,e),o&Dt){var c=a;Tt==null||Tt.delete(c),o&_s||(o&ar&&(a.f|=_s),Vo(c,Pr))}else l&&(o&Lr&&cr!==null&&cr.add(a),qr(a))}}function ke(s){if(typeof s!="object"||s===null||Mr in s)return s;const e=Qa(s);if(e!==nc&&e!==ac)return s;var t=new Map,r=Ga(s),n=W(0),a=gs,o=l=>{if(gs===a)return l();var c=xe,u=gs;Ut(null),Oi(a);var h=l();return Ut(c),Oi(u),h};return r&&t.set("length",W(s.length)),new Proxy(s,{defineProperty(l,c,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&yc();var h=t.get(c);return h===void 0?h=o(()=>{var p=W(u.value);return t.set(c,p),p}):b(h,u.value,!0),!0},deleteProperty(l,c){var u=t.get(c);if(u===void 0){if(c in l){const h=o(()=>W(wt));t.set(c,h),ln(n)}}else b(u,wt),ln(n);return!0},get(l,c,u){var y;if(c===Mr)return s;var h=t.get(c),p=c in l;if(h===void 0&&(!p||(y=Ls(l,c))!=null&&y.writable)&&(h=o(()=>{var k=ke(p?l[c]:wt),m=W(k);return m}),t.set(c,h)),h!==void 0){var v=i(h);return v===wt?void 0:v}return Reflect.get(l,c,u)},getOwnPropertyDescriptor(l,c){var u=Reflect.getOwnPropertyDescriptor(l,c);if(u&&"value"in u){var h=t.get(c);h&&(u.value=i(h))}else if(u===void 0){var p=t.get(c),v=p==null?void 0:p.v;if(p!==void 0&&v!==wt)return{enumerable:!0,configurable:!0,value:v,writable:!0}}return u},has(l,c){var v;if(c===Mr)return!0;var u=t.get(c),h=u!==void 0&&u.v!==wt||Reflect.has(l,c);if(u!==void 0||je!==null&&(!h||(v=Ls(l,c))!=null&&v.writable)){u===void 0&&(u=o(()=>{var y=h?ke(l[c]):wt,k=W(y);return k}),t.set(c,u));var p=i(u);if(p===wt)return!1}return h},set(l,c,u,h){var E;var p=t.get(c),v=c in l;if(r&&c==="length")for(var y=u;y<p.v;y+=1){var k=t.get(y+"");k!==void 0?b(k,wt):y in l&&(k=o(()=>W(wt)),t.set(y+"",k))}if(p===void 0)(!v||(E=Ls(l,c))!=null&&E.writable)&&(p=o(()=>W(void 0)),b(p,ke(u)),t.set(c,p));else{v=p.v!==wt;var m=o(()=>ke(u));b(p,m)}var g=Reflect.getOwnPropertyDescriptor(l,c);if(g!=null&&g.set&&g.set.call(h,u),!v){if(r&&typeof c=="string"){var _=t.get("length"),D=Number(c);Number.isInteger(D)&&D>=_.v&&b(_,D+1)}ln(n)}return!0},ownKeys(l){i(n);var c=Reflect.ownKeys(l).filter(p=>{var v=t.get(p);return v===void 0||v.v!==wt});for(var[u,h]of t)h.v!==wt&&!(u in l)&&c.push(u);return c},setPrototypeOf(){mc()}})}function xi(s){try{if(s!==null&&typeof s=="object"&&Mr in s)return s[Mr]}catch{}return s}function Zc(s,e){return Object.is(xi(s),xi(e))}var Ai,Xo,Zo,Jo;function Jc(){if(Ai===void 0){Ai=window,Xo=/Firefox/.test(navigator.userAgent);var s=Element.prototype,e=Node.prototype,t=Text.prototype;Zo=Ls(e,"firstChild").get,Jo=Ls(e,"nextSibling").get,Ti(s)&&(s.__click=void 0,s.__className=void 0,s.__attributes=null,s.__style=void 0,s.__e=void 0),Ti(t)&&(t.__t=void 0)}}function Nr(s=""){return document.createTextNode(s)}function Qr(s){return Zo.call(s)}function _n(s){return Jo.call(s)}function d(s,e){return Qr(s)}function Ge(s,e=!1){{var t=Qr(s);return t instanceof Comment&&t.data===""?_n(t):t}}function f(s,e=1,t=!1){let r=s;for(;e--;)r=_n(r);return r}function eu(s){s.textContent=""}function el(){return!1}let Ci=!1;function tu(){Ci||(Ci=!0,document.addEventListener("reset",s=>{Promise.resolve().then(()=>{var e;if(!s.defaultPrevented)for(const t of s.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function ea(s){var e=xe,t=je;Ut(null),Tr(null);try{return s()}finally{Ut(e),Tr(t)}}function ti(s,e,t,r=t){s.addEventListener(e,()=>ea(t));const n=s.__on_r;n?s.__on_r=()=>{n(),r(!0)}:s.__on_r=()=>r(!0),tu()}function ru(s){je===null&&(xe===null&&fc(),hc()),es&&dc()}function su(s,e){var t=e.last;t===null?e.last=e.first=s:(t.next=s,s.prev=t,e.last=s)}function Br(s,e,t){var r=je;r!==null&&r.f&Qt&&(s|=Qt);var n={ctx:ht,deps:null,nodes:null,f:s|Pt|ar,first:null,fn:e,last:null,next:null,parent:r,b:r&&r.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{hn(n),n.f|=Va}catch(l){throw zt(n),l}else e!==null&&qr(n);var a=n;if(t&&a.deps===null&&a.teardown===null&&a.nodes===null&&a.first===a.last&&!(a.f&Xs)&&(a=a.first,s&Lr&&s&Hs&&a!==null&&(a.f|=Hs)),a!==null&&(a.parent=r,r!==null&&su(a,r),xe!==null&&xe.f&Dt&&!(s&Ts))){var o=xe;(o.effects??(o.effects=[])).push(a)}return n}function ri(){return xe!==null&&!hr}function si(s){const e=Br(Xn,null,!1);return gt(e,Ot),e.teardown=s,e}function yt(s){ru();var e=je.f,t=!xe&&(e&Fr)!==0&&(e&Va)===0;if(t){var r=ht;(r.e??(r.e=[])).push(s)}else return tl(s)}function tl(s){return Br(Ln|oc,s,!1)}function nu(s){Ir.ensure();const e=Br(Ts|Xs,s,!0);return(t={})=>new Promise(r=>{t.outro?ys(e,()=>{zt(e),r(void 0)}):(zt(e),r(void 0))})}function ni(s){return Br(Ln,s,!1)}function au(s){return Br(Xa|Xs,s,!0)}function kn(s,e=0){return Br(Xn|e,s,!0)}function j(s,e=[],t=[],r=[]){Kc(r,e,t,n=>{Br(Xn,()=>s(...n.map(i)),!0)})}function ai(s,e=0){var t=Br(Lr|e,s,!0);return t}function sr(s){return Br(Fr|Xs,s,!0)}function rl(s){var e=s.teardown;if(e!==null){const t=es,r=xe;Ii(!0),Ut(null);try{e.call(null)}finally{Ii(t),Ut(r)}}}function sl(s,e=!1){var t=s.first;for(s.first=s.last=null;t!==null;){const n=t.ac;n!==null&&ea(()=>{n.abort(qs)});var r=t.next;t.f&Ts?t.parent=null:zt(t,e),t=r}}function iu(s){for(var e=s.first;e!==null;){var t=e.next;e.f&Fr||zt(e),e=t}}function zt(s,e=!0){var t=!1;(e||s.f&Co)&&s.nodes!==null&&s.nodes.end!==null&&(nl(s.nodes.start,s.nodes.end),t=!0),sl(s,e&&!t),Bn(s,0),gt(s,Or);var r=s.nodes&&s.nodes.t;if(r!==null)for(const a of r)a.stop();rl(s);var n=s.parent;n!==null&&n.first!==null&&al(s),s.next=s.prev=s.teardown=s.ctx=s.deps=s.fn=s.nodes=s.ac=null}function nl(s,e){for(;s!==null;){var t=s===e?null:_n(s);s.remove(),s=t}}function al(s){var e=s.parent,t=s.prev,r=s.next;t!==null&&(t.next=r),r!==null&&(r.prev=t),e!==null&&(e.first===s&&(e.first=r),e.last===s&&(e.last=t))}function ys(s,e,t=!0){var r=[];il(s,r,!0);var n=()=>{t&&zt(s),e&&e()},a=r.length;if(a>0){var o=()=>--a||n();for(var l of r)l.out(o)}else n()}function il(s,e,t){if(!(s.f&Qt)){s.f^=Qt;var r=s.nodes&&s.nodes.t;if(r!==null)for(const l of r)(l.is_global||t)&&e.push(l);for(var n=s.first;n!==null;){var a=n.next,o=(n.f&Hs)!==0||(n.f&Fr)!==0&&(s.f&Lr)!==0;il(n,e,o?t:!1),n=a}}}function ii(s){ol(s,!0)}function ol(s,e){if(s.f&Qt){s.f^=Qt,s.f&Ot||(gt(s,Pt),qr(s));for(var t=s.first;t!==null;){var r=t.next,n=(t.f&Hs)!==0||(t.f&Fr)!==0;ol(t,n?e:!1),t=r}var a=s.nodes&&s.nodes.t;if(a!==null)for(const o of a)(o.is_global||e)&&o.in()}}function ll(s,e){if(s.nodes)for(var t=s.nodes.start,r=s.nodes.end;t!==null;){var n=t===r?null:_n(t);e.append(t),t=n}}let ms=!1;function Pn(s){ms=s}let es=!1;function Ii(s){es=s}let xe=null,hr=!1;function Ut(s){xe=s}let je=null;function Tr(s){je=s}let Ft=null;function cl(s){xe!==null&&(Ft===null?Ft=[s]:Ft.push(s))}let Rt=null,Wt=0,Jt=null;function ou(s){Jt=s}let ul=1,dn=0,gs=dn;function Oi(s){gs=s}function dl(){return++ul}function wn(s){var e=s.f;if(e&Pt)return!0;if(e&Dt&&(s.f&=~_s),e&Pr){for(var t=s.deps,r=t.length,n=0;n<r;n++){var a=t[n];if(wn(a)&&Qo(a),a.wv>s.wv)return!0}e&ar&&Tt===null&&gt(s,Ot)}return!1}function hl(s,e,t=!0){var r=s.reactions;if(r!==null&&!(Ft!=null&&Ft.includes(s)))for(var n=0;n<r.length;n++){var a=r[n];a.f&Dt?hl(a,e,!1):e===a&&(t?gt(a,Pt):a.f&Ot&&gt(a,Pr),qr(a))}}function fl(s){var k;var e=Rt,t=Wt,r=Jt,n=xe,a=Ft,o=ht,l=hr,c=gs,u=s.f;Rt=null,Wt=0,Jt=null,xe=u&(Fr|Ts)?null:s,Ft=null,Ws(s.ctx),hr=!1,gs=++dn,s.ac!==null&&(ea(()=>{s.ac.abort(qs)}),s.ac=null);try{s.f|=ma;var h=s.fn,p=h(),v=s.deps;if(Rt!==null){var y;if(Bn(s,Wt),v!==null&&Wt>0)for(v.length=Wt+Rt.length,y=0;y<Rt.length;y++)v[Wt+y]=Rt[y];else s.deps=v=Rt;if(ri()&&s.f&ar)for(y=Wt;y<v.length;y++)((k=v[y]).reactions??(k.reactions=[])).push(s)}else v!==null&&Wt<v.length&&(Bn(s,Wt),v.length=Wt);if(Ro()&&Jt!==null&&!hr&&v!==null&&!(s.f&(Dt|Pr|Pt)))for(y=0;y<Jt.length;y++)hl(Jt[y],s);return n!==null&&n!==s&&(dn++,Jt!==null&&(r===null?r=Jt:r.push(...Jt))),s.f&Xr&&(s.f^=Xr),p}catch(m){return Po(m)}finally{s.f^=ma,Rt=e,Wt=t,Jt=r,xe=n,Ft=a,Ws(o),hr=l,gs=c}}function lu(s,e){let t=e.reactions;if(t!==null){var r=rc.call(t,s);if(r!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[r]=t[n],t.pop())}}if(t===null&&e.f&Dt&&(Rt===null||!Rt.includes(e))){var a=e;a.f&ar&&(a.f^=ar,a.f&=~_s),Ja(a),Go(a),Bn(a,0)}}function Bn(s,e){var t=s.deps;if(t!==null)for(var r=e;r<t.length;r++)lu(s,t[r])}function hn(s){var e=s.f;if(!(e&Or)){gt(s,Ot);var t=je,r=ms;je=s,ms=!0;try{e&(Lr|Ao)?iu(s):sl(s),rl(s);var n=fl(s);s.teardown=typeof n=="function"?n:null,s.wv=ul;var a;ya&&Nc&&s.f&Pt&&s.deps}finally{ms=r,je=t}}}async function vl(){await Promise.resolve(),Pc()}function i(s){var e=s.f,t=(e&Dt)!==0;if(xe!==null&&!hr){var r=je!==null&&(je.f&Or)!==0;if(!r&&!(Ft!=null&&Ft.includes(s))){var n=xe.deps;if(xe.f&ma)s.rv<dn&&(s.rv=dn,Rt===null&&n!==null&&n[Wt]===s?Wt++:Rt===null?Rt=[s]:Rt.includes(s)||Rt.push(s));else{(xe.deps??(xe.deps=[])).push(s);var a=s.reactions;a===null?s.reactions=[xe]:a.includes(xe)||a.push(xe)}}}if(es&&Zr.has(s))return Zr.get(s);if(t){var o=s;if(es){var l=o.v;return(!(o.f&Ot)&&o.reactions!==null||yl(o))&&(l=ei(o)),Zr.set(o,l),l}var c=(o.f&ar)===0&&!hr&&xe!==null&&(ms||(xe.f&ar)!==0),u=o.deps===null;wn(o)&&(c&&(o.f|=ar),Qo(o)),c&&!u&&pl(o)}if(Tt!=null&&Tt.has(s))return Tt.get(s);if(s.f&Xr)throw s.v;return s.v}function pl(s){if(s.deps!==null){s.f|=ar;for(const e of s.deps)(e.reactions??(e.reactions=[])).push(s),e.f&Dt&&!(e.f&ar)&&pl(e)}}function yl(s){if(s.v===wt)return!0;if(s.deps===null)return!1;for(const e of s.deps)if(Zr.has(e)||e.f&Dt&&yl(e))return!0;return!1}function ts(s){var e=hr;try{return hr=!0,s()}finally{hr=e}}function cu(s){if(!(typeof s!="object"||!s||s instanceof EventTarget)){if(Mr in s)Sa(s);else if(!Array.isArray(s))for(let e in s){const t=s[e];typeof t=="object"&&t&&Mr in t&&Sa(t)}}}function Sa(s,e=new Set){if(typeof s=="object"&&s!==null&&!(s instanceof EventTarget)&&!e.has(s)){e.add(s),s instanceof Date&&s.getTime();for(let r in s)try{Sa(s[r],e)}catch{}const t=Qa(s);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const r=Do(t);for(let n in r){const a=r[n].get;if(a)try{a.call(s)}catch{}}}}}const uu=["touchstart","touchmove"];function du(s){return uu.includes(s)}const ml=new Set,Da=new Set;function hu(s,e,t,r={}){function n(a){if(r.capture||rn.call(e,a),!a.cancelBubble)return ea(()=>t==null?void 0:t.call(this,a))}return s.startsWith("pointer")||s.startsWith("touch")||s==="wheel"?Zs(()=>{e.addEventListener(s,n,r)}):e.addEventListener(s,n,r),n}function St(s,e,t,r,n){var a={capture:r,passive:n},o=hu(s,e,t,a);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&si(()=>{e.removeEventListener(s,o,a)})}function ft(s){for(var e=0;e<s.length;e++)ml.add(s[e]);for(var t of Da)t(s)}let Mi=null;function rn(s){var g;var e=this,t=e.ownerDocument,r=s.type,n=((g=s.composedPath)==null?void 0:g.call(s))||[],a=n[0]||s.target;Mi=s;var o=0,l=Mi===s&&s.__root;if(l){var c=n.indexOf(l);if(c!==-1&&(e===document||e===window)){s.__root=e;return}var u=n.indexOf(e);if(u===-1)return;c<=u&&(o=c)}if(a=n[o]||s.target,a!==e){sc(s,"currentTarget",{configurable:!0,get(){return a||t}});var h=xe,p=je;Ut(null),Tr(null);try{for(var v,y=[];a!==null;){var k=a.assignedSlot||a.parentNode||a.host||null;try{var m=a["__"+r];m!=null&&(!a.disabled||s.target===a)&&m.call(a,s)}catch(_){v?y.push(_):v=_}if(s.cancelBubble||k===e||k===null)break;a=k}if(v){for(let _ of y)queueMicrotask(()=>{throw _});throw v}}finally{s.__root=e,delete s.currentTarget,Ut(h),Tr(p)}}}function gl(s){var e=document.createElement("template");return e.innerHTML=s.replaceAll("<!>","<!---->"),e.content}function fn(s,e){var t=je;t.nodes===null&&(t.nodes={start:s,end:e,a:null,t:null})}function A(s,e){var t=(e&Ac)!==0,r=(e&Cc)!==0,n,a=!s.startsWith("<!>");return()=>{n===void 0&&(n=gl(a?s:"<!>"+s),t||(n=Qr(n)));var o=r||Xo?document.importNode(n,!0):n.cloneNode(!0);if(t){var l=Qr(o),c=o.lastChild;fn(l,c)}else fn(o,o);return o}}function na(s=""){{var e=Nr(s+"");return fn(e,e),e}}function st(){var s=document.createDocumentFragment(),e=document.createComment(""),t=Nr();return s.append(e,t),fn(e,t),s}function S(s,e){s!==null&&s.before(e)}function P(s,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(s.__t??(s.__t=s.nodeValue))&&(s.__t=t,s.nodeValue=t+"")}function xn(s,e){return fu(s,e)}const Cs=new Map;function fu(s,{target:e,anchor:t,props:r={},events:n,context:a,intro:o=!0}){Jc();var l=new Set,c=p=>{for(var v=0;v<p.length;v++){var y=p[v];if(!l.has(y)){l.add(y);var k=du(y);e.addEventListener(y,rn,{passive:k});var m=Cs.get(y);m===void 0?(document.addEventListener(y,rn,{passive:k}),Cs.set(y,1)):Cs.set(y,m+1)}}};c(Vn(ml)),Da.add(c);var u=void 0,h=nu(()=>{var p=t??e.appendChild(Nr());return jc(p,{pending:()=>{}},v=>{if(a){Je({});var y=ht;y.c=a}n&&(r.$$events=n),u=s(v,r)||{},a&&et()}),()=>{var k;for(var v of l){e.removeEventListener(v,rn);var y=Cs.get(v);--y===0?(document.removeEventListener(v,rn),Cs.delete(v)):Cs.set(v,y)}Da.delete(c),p!==t&&((k=p.parentNode)==null||k.removeChild(p))}});return Ea.set(u,h),u}let Ea=new WeakMap;function An(s,e){const t=Ea.get(s);return t?(Ea.delete(s),t(e)):Promise.resolve()}var ur,kr,Kt,ps,gn,bn,$n;class vu{constructor(e,t=!0){w(this,"anchor");Ne(this,ur,new Map);Ne(this,kr,new Map);Ne(this,Kt,new Map);Ne(this,ps,new Set);Ne(this,gn,!0);Ne(this,bn,()=>{var e=De;if(O(this,ur).has(e)){var t=O(this,ur).get(e),r=O(this,kr).get(t);if(r)ii(r),O(this,ps).delete(t);else{var n=O(this,Kt).get(t);n&&(O(this,kr).set(t,n.effect),O(this,Kt).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),r=n.effect)}for(const[a,o]of O(this,ur)){if(O(this,ur).delete(a),a===e)break;const l=O(this,Kt).get(o);l&&(zt(l.effect),O(this,Kt).delete(o))}for(const[a,o]of O(this,kr)){if(a===t||O(this,ps).has(a))continue;const l=()=>{if(Array.from(O(this,ur).values()).includes(a)){var u=document.createDocumentFragment();ll(o,u),u.append(Nr()),O(this,Kt).set(a,{effect:o,fragment:u})}else zt(o);O(this,ps).delete(a),O(this,kr).delete(a)};O(this,gn)||!r?(O(this,ps).add(a),ys(o,l,!1)):l()}}});Ne(this,$n,e=>{O(this,ur).delete(e);const t=Array.from(O(this,ur).values());for(const[r,n]of O(this,Kt))t.includes(r)||(zt(n.effect),O(this,Kt).delete(r))});this.anchor=e,Me(this,gn,t)}ensure(e,t){var r=De,n=el();if(t&&!O(this,kr).has(e)&&!O(this,Kt).has(e))if(n){var a=document.createDocumentFragment(),o=Nr();a.append(o),O(this,Kt).set(e,{effect:sr(()=>t(o)),fragment:a})}else O(this,kr).set(e,sr(()=>t(this.anchor)));if(O(this,ur).set(r,e),n){for(const[l,c]of O(this,kr))l===e?r.skipped_effects.delete(c):r.skipped_effects.add(c);for(const[l,c]of O(this,Kt))l===e?r.skipped_effects.delete(c.effect):r.skipped_effects.add(c.effect);r.oncommit(O(this,bn)),r.ondiscard(O(this,$n))}else O(this,bn).call(this)}}ur=new WeakMap,kr=new WeakMap,Kt=new WeakMap,ps=new WeakMap,gn=new WeakMap,bn=new WeakMap,$n=new WeakMap;function G(s,e,t=!1){var r=new vu(s),n=t?Hs:0;function a(o,l){r.ensure(o,l)}ai(()=>{var o=!1;e((l,c=!0)=>{o=!0,a(c,l)}),o||a(!1,null)},n)}function nt(s,e){return e}function pu(s,e,t){for(var r=[],n=e.length,a,o=e.length,l=0;l<n;l++){let p=e[l];ys(p,()=>{if(a){if(a.pending.delete(p),a.done.add(p),a.pending.size===0){var v=s.outrogroups;xa(Vn(a.done)),v.delete(a),v.size===0&&(s.outrogroups=null)}}else o-=1},!1)}if(o===0){var c=r.length===0&&t!==null;if(c){var u=t,h=u.parentNode;eu(h),h.append(u),s.items.clear()}xa(e,!c)}else a={pending:new Set(e),done:new Set},(s.outrogroups??(s.outrogroups=new Set)).add(a)}function xa(s,e=!0){for(var t=0;t<s.length;t++)zt(s[t],e)}var Ni;function Fe(s,e,t,r,n,a=null){var o=s,l=new Map,c=(e&Io)!==0;if(c){var u=s;o=u.appendChild(Nr())}var h=null,p=Ko(()=>{var _=t();return Ga(_)?_:_==null?[]:Vn(_)}),v,y=!0;function k(){g.fallback=h,yu(g,v,o,e,r),h!==null&&(v.length===0?h.f&Cr?(h.f^=Cr,sn(h,null,o)):ii(h):ys(h,()=>{h=null}))}var m=ai(()=>{v=i(p);for(var _=v.length,D=new Set,E=De,x=el(),R=0;R<_;R+=1){var U=v[R],N=r(U,R),K=y?null:l.get(N);K?(K.v&&Gs(K.v,U),K.i&&Gs(K.i,R),x&&E.skipped_effects.delete(K.e)):(K=mu(l,y?o:Ni??(Ni=Nr()),U,N,R,n,e,t),y||(K.e.f|=Cr),l.set(N,K)),D.add(N)}if(_===0&&a&&!h&&(y?h=sr(()=>a(o)):(h=sr(()=>a(Ni??(Ni=Nr()))),h.f|=Cr)),!y)if(x){for(const[Y,J]of l)D.has(Y)||E.skipped_effects.add(J.e);E.oncommit(k),E.ondiscard(()=>{})}else k();i(p)}),g={effect:m,items:l,outrogroups:null,fallback:h};y=!1}function yu(s,e,t,r,n){var J,se,te,le,ye,H,L,C,z;var a=(r&wc)!==0,o=e.length,l=s.items,c=s.effect.first,u,h=null,p,v=[],y=[],k,m,g,_;if(a)for(_=0;_<o;_+=1)k=e[_],m=n(k,_),g=l.get(m).e,g.f&Cr||((se=(J=g.nodes)==null?void 0:J.a)==null||se.measure(),(p??(p=new Set)).add(g));for(_=0;_<o;_+=1){if(k=e[_],m=n(k,_),g=l.get(m).e,s.outrogroups!==null)for(const re of s.outrogroups)re.pending.delete(g),re.done.delete(g);if(g.f&Cr)if(g.f^=Cr,g===c)sn(g,null,t);else{var D=h?h.next:c;g===s.effect.last&&(s.effect.last=g.prev),g.prev&&(g.prev.next=g.next),g.next&&(g.next.prev=g.prev),jr(s,h,g),jr(s,g,D),sn(g,D,t),h=g,v=[],y=[],c=h.next;continue}if(g.f&Qt&&(ii(g),a&&((le=(te=g.nodes)==null?void 0:te.a)==null||le.unfix(),(p??(p=new Set)).delete(g))),g!==c){if(u!==void 0&&u.has(g)){if(v.length<y.length){var E=y[0],x;h=E.prev;var R=v[0],U=v[v.length-1];for(x=0;x<v.length;x+=1)sn(v[x],E,t);for(x=0;x<y.length;x+=1)u.delete(y[x]);jr(s,R.prev,U.next),jr(s,h,R),jr(s,U,E),c=E,h=U,_-=1,v=[],y=[]}else u.delete(g),sn(g,c,t),jr(s,g.prev,g.next),jr(s,g,h===null?s.effect.first:h.next),jr(s,h,g),h=g;continue}for(v=[],y=[];c!==null&&c!==g;)(u??(u=new Set)).add(c),y.push(c),c=c.next;if(c===null)continue}g.f&Cr||v.push(g),h=g,c=g.next}if(s.outrogroups!==null){for(const re of s.outrogroups)re.pending.size===0&&(xa(Vn(re.done)),(ye=s.outrogroups)==null||ye.delete(re));s.outrogroups.size===0&&(s.outrogroups=null)}if(c!==null||u!==void 0){var N=[];if(u!==void 0)for(g of u)g.f&Qt||N.push(g);for(;c!==null;)!(c.f&Qt)&&c!==s.fallback&&N.push(c),c=c.next;var K=N.length;if(K>0){var Y=r&Io&&o===0?t:null;if(a){for(_=0;_<K;_+=1)(L=(H=N[_].nodes)==null?void 0:H.a)==null||L.measure();for(_=0;_<K;_+=1)(z=(C=N[_].nodes)==null?void 0:C.a)==null||z.fix()}pu(s,N,Y)}}a&&Zs(()=>{var re,X;if(p!==void 0)for(g of p)(X=(re=g.nodes)==null?void 0:re.a)==null||X.apply()})}function mu(s,e,t,r,n,a,o,l){var c=o&_c?o&Tc?ks(t):Vc(t,!1,!1):null,u=o&kc?ks(n):null;return{v:c,i:u,e:sr(()=>(a(e,c??t,u??n,l),()=>{s.delete(r)}))}}function sn(s,e,t){if(s.nodes)for(var r=s.nodes.start,n=s.nodes.end,a=e&&!(e.f&Cr)?e.nodes.start:t;r!==null;){var o=_n(r);if(a.before(r),r===n)return;r=o}}function jr(s,e,t){e===null?s.effect.first=t:e.next=t,t===null?s.effect.last=e:t.prev=e}function gu(s,e,t=!1,r=!1,n=!1){var a=s,o="";j(()=>{var l=je;if(o!==(o=e()??"")&&(l.nodes!==null&&(nl(l.nodes.start,l.nodes.end),l.nodes=null),o!=="")){var c=o+"";t?c=`<svg>${c}</svg>`:r&&(c=`<math>${c}</math>`);var u=gl(c);if((t||r)&&(u=Qr(u)),fn(Qr(u),u.lastChild),t||r)for(;Qr(u);)a.before(Qr(u));else a.before(u)}})}function bu(s,e,t){ni(()=>{var r=ts(()=>e(s,t==null?void 0:t())||{});if(t&&(r!=null&&r.update)){var n=!1,a={};kn(()=>{var o=t();cu(o),n&&Mo(a,o)&&(a=o,r.update(o))}),n=!0}if(r!=null&&r.destroy)return()=>r.destroy()})}function bl(s){var e,t,r="";if(typeof s=="string"||typeof s=="number")r+=s;else if(typeof s=="object")if(Array.isArray(s)){var n=s.length;for(e=0;e<n;e++)s[e]&&(t=bl(s[e]))&&(r&&(r+=" "),r+=t)}else for(t in s)s[t]&&(r&&(r+=" "),r+=t);return r}function _u(){for(var s,e,t=0,r="",n=arguments.length;t<n;t++)(s=arguments[t])&&(e=bl(s))&&(r&&(r+=" "),r+=e);return r}function ku(s){return typeof s=="object"?_u(s):s??""}const qi=[...` 	
\r\f \v\uFEFF`];function wu(s,e,t){var r=s==null?"":""+s;if(e&&(r=r?r+" "+e:e),t){for(var n in t)if(t[n])r=r?r+" "+n:n;else if(r.length)for(var a=n.length,o=0;(o=r.indexOf(n,o))>=0;){var l=o+a;(o===0||qi.includes(r[o-1]))&&(l===r.length||qi.includes(r[l]))?r=(o===0?"":r.substring(0,o))+r.substring(l+1):o=l}}return r===""?null:r}function Tu(s,e){return s==null?null:String(s)}function We(s,e,t,r,n,a){var o=s.__className;if(o!==t||o===void 0){var l=wu(t,r,a);l==null?s.removeAttribute("class"):s.className=l,s.__className=t}else if(a&&n!==a)for(var c in a){var u=!!a[c];(n==null||u!==!!n[c])&&s.classList.toggle(c,u)}return a}function bs(s,e,t,r){var n=s.__style;if(n!==e){var a=Tu(e);a==null?s.removeAttribute("style"):s.style.cssText=a,s.__style=e}return r}function _l(s,e,t=!1){if(s.multiple){if(e==null)return;if(!Ga(e))return Oc();for(var r of s.options)r.selected=e.includes(cn(r));return}for(r of s.options){var n=cn(r);if(Zc(n,e)){r.selected=!0;return}}(!t||e!==void 0)&&(s.selectedIndex=-1)}function Su(s){var e=new MutationObserver(()=>{_l(s,s.__value)});e.observe(s,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),si(()=>{e.disconnect()})}function Du(s,e,t=e){var r=new WeakSet,n=!0;ti(s,"change",a=>{var o=a?"[selected]":":checked",l;if(s.multiple)l=[].map.call(s.querySelectorAll(o),cn);else{var c=s.querySelector(o)??s.querySelector("option:not([disabled])");l=c&&cn(c)}t(l),De!==null&&r.add(De)}),ni(()=>{var a=e();if(s===document.activeElement){var o=an??De;if(r.has(o))return}if(_l(s,a,n),n&&a===void 0){var l=s.querySelector(":checked");l!==null&&(a=cn(l),t(a))}s.__value=a,n=!1}),Su(s)}function cn(s){return"__value"in s?s.__value:s.value}const Eu=Symbol("is custom element"),xu=Symbol("is html");function oi(s,e){var t=li(s);t.value===(t.value=e??void 0)||s.value===e&&(e!==0||s.nodeName!=="PROGRESS")||(s.value=e??"")}function Fs(s,e){var t=li(s);t.checked!==(t.checked=e??void 0)&&(s.checked=e)}function Ee(s,e,t,r){var n=li(s);n[e]!==(n[e]=t)&&(e==="loading"&&(s[cc]=t),t==null?s.removeAttribute(e):typeof t!="string"&&Au(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function li(s){return s.__attributes??(s.__attributes={[Eu]:s.nodeName.includes("-"),[xu]:s.namespaceURI===Ic})}var Ri=new Map;function Au(s){var e=s.getAttribute("is")||s.nodeName,t=Ri.get(e);if(t)return t;Ri.set(e,t=[]);for(var r,n=s,a=Element.prototype;a!==n;){r=Do(n);for(var o in r)r[o].set&&t.push(o);n=Qa(n)}return t}function at(s,e,t=e){var r=new WeakSet;ti(s,"input",async n=>{var a=n?s.defaultValue:s.value;if(a=aa(s)?ia(a):a,t(a),De!==null&&r.add(De),await vl(),a!==(a=e())){var o=s.selectionStart,l=s.selectionEnd,c=s.value.length;if(s.value=a??"",l!==null){var u=s.value.length;o===l&&l===c&&u>c?(s.selectionStart=u,s.selectionEnd=u):(s.selectionStart=o,s.selectionEnd=Math.min(l,u))}}}),ts(e)==null&&s.value&&(t(aa(s)?ia(s.value):s.value),De!==null&&r.add(De)),kn(()=>{var n=e();if(s===document.activeElement){var a=an??De;if(r.has(a))return}aa(s)&&n===ia(s.value)||s.type==="date"&&!n&&!s.value||n!==s.value&&(s.value=n??"")})}function Aa(s,e,t=e){ti(s,"change",r=>{var n=r?s.defaultChecked:s.checked;t(n)}),ts(e)==null&&t(s.checked),kn(()=>{var r=e();s.checked=!!r})}function aa(s){var e=s.type;return e==="number"||e==="range"}function ia(s){return s===""?null:+s}function Li(s,e){return s===e||(s==null?void 0:s[Mr])===e}function fr(s={},e,t,r){return ni(()=>{var n,a;return kn(()=>{n=a,a=(r==null?void 0:r())||[],ts(()=>{s!==t(...a)&&(e(s,...a),n&&Li(t(...n),s)&&e(null,...n))})}),()=>{Zs(()=>{a&&Li(t(...a),s)&&e(null,...a)})}}),s}let Cn=!1;function Cu(s){var e=Cn;try{return Cn=!1,[s(),Cn]}finally{Cn=e}}function Rr(s,e,t,r){var D;var n=(t&Ec)!==0,a=(t&xc)!==0,o=r,l=!0,c=()=>(l&&(l=!1,o=a?ts(r):r),o),u;if(n){var h=Mr in s||lc in s;u=((D=Ls(s,e))==null?void 0:D.set)??(h&&e in s?E=>s[e]=E:void 0)}var p,v=!1;n?[p,v]=Cu(()=>s[e]):p=s[e],p===void 0&&r!==void 0&&(p=c(),u&&(pc(),u(p)));var y;if(y=()=>{var E=s[e];return E===void 0?c():(l=!0,E)},!(t&Dc))return y;if(u){var k=s.$$legacy;return function(E,x){return arguments.length>0?((!x||k||v)&&u(x?y():E),E):y()}}var m=!1,g=(t&Sc?Jn:Ko)(()=>(m=!1,y()));n&&i(g);var _=je;return function(E,x){if(arguments.length>0){const R=x?i(g):n?ke(E):E;return b(g,R),m=!0,o!==void 0&&(o=R),E}return es&&m||_.f&Or?g.v:i(g)}}function Tn(s){ht===null&&Za(),yt(()=>{const e=ts(s);if(typeof e=="function")return e})}function Iu(s){ht===null&&Za(),Tn(()=>()=>ts(s))}const Ou="5";var So;typeof window<"u"&&((So=window.__svelte??(window.__svelte={})).v??(So.v=new Set)).add(Ou);function Mu(){return{type:"daily",interval:1,time:"09:00"}}function kl(s){return!s||!s.type||!s.interval||s.interval<1?!1:s.type==="weekly"?Array.isArray(s.weekdays)&&s.weekdays.length>0&&s.weekdays.every(e=>e>=0&&e<=6):s.type==="monthly"?s.dayOfMonth>=1&&s.dayOfMonth<=31:s.type==="yearly"?s.month>=0&&s.month<=11&&s.dayOfMonth>=1&&s.dayOfMonth<=31:!0}const ls="recurring-tasks-active",Nn="recurring-tasks-archive",Fi="recurring-tasks",Pi="recurring-tasks.json.bak",Bi="n8n-event-settings",Ui="n8n-event-queue",Nu="notification-state",qu="recurring-tasks-dock",zi="scheduler-emitted-occurrences",Yr=4,Ca={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},ci=60*1e3,Ru=30*1e3,oa=2e3,ji="shehab-note-recurring-plugin",Yi="1.0.0",Lu=60*60*1e3,Fu=3,Hi=10,la=1e3,qn=100,Wi=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Pu=[{label:"+1 day",minutes:60*24},{label:"+3 days",minutes:60*24*3},{label:"+1 week",minutes:60*24*7}],Bu={lowest:"#94a3b8",low:"#64748b",normal:"#3b82f6",medium:"#f59e0b",high:"#f97316",highest:"#ef4444"},Uu=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Ki="last-run-timestamp",Gi="custom-recurring-task-id",Qi="custom-recurring-task-due",$i="custom-recurring-task-enabled",In=3,Vi=[1e3,5e3,3e4],zu=1e4,ui={dueSoonScoreMax:100,dueSoonScoreMin:0,dueDateWeight:10,overdueBaseScore:110,overduePenaltyWeight:15,noDueDateScore:0,priorityMultipliers:{lowest:.8,low:1,normal:1.1,medium:1.2,high:1.5,highest:2},maxUrgency:200,minUrgency:0},wl=24*60*60*1e3,ju=(s,e,t)=>Math.min(t,Math.max(e,s)),Xi=s=>new Date(s.getFullYear(),s.getMonth(),s.getDate()),Yu=(s,e)=>{const t=Xi(s),r=Xi(e);return Math.round((r.getTime()-t.getTime())/wl)},Hu=(s,e)=>e.priorityMultipliers[s]??1;function di(s,e={}){return Wu(s,e).score}function Wu(s,e={}){const t=e.now??new Date,r=e.settings??ui;if(!hi(s))return{score:0,breakdown:{priorityContribution:0,dueDateContribution:0,overdueContribution:0}};const n=Qs(s.priority)??"normal",a=Hu(n,r);if(!s.dueAt){const k=r.noDueDateScore,m=k*a;return{score:ca(m,r),breakdown:{priorityContribution:m-k,dueDateContribution:k,overdueContribution:0}}}const o=new Date(s.dueAt);if(Number.isNaN(o.getTime())){const k=r.noDueDateScore,m=k*a;return{score:ca(m,r),breakdown:{priorityContribution:m-k,dueDateContribution:k,overdueContribution:0}}}const l=o.getTime()<t.getTime(),c=Yu(t,o),u=l?Math.max(1,Math.ceil((t.getTime()-o.getTime())/wl)):0,h=l?0:ju(r.dueSoonScoreMax-c*r.dueDateWeight,r.dueSoonScoreMin,r.dueSoonScoreMax),p=l?r.overdueBaseScore+u*r.overduePenaltyWeight:0,v=h+p,y=v*a;return{score:ca(y,r),breakdown:{priorityContribution:y-v,dueDateContribution:h,overdueContribution:p}}}function ca(s,e){const t=e.maxUrgency!==void 0?Math.min(e.maxUrgency,s):s;return Math.round(Math.max(e.minUrgency,t))}function Tl(s,e,t){const r=new Date().toISOString(),n=t||new Date;return{id:Sl(),name:s,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:Yr,createdAt:r,updatedAt:r}}const Ku=["lowest","low","normal","medium","high","highest"];function Qs(s){if(!s)return;const e=s.toLowerCase();if(e==="urgent")return"highest";if(e==="none")return"normal";if(Ku.includes(e))return e}function Sl(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Dl(s,e={}){const t=new Date().toISOString();return{...{...s,id:Sl(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Gu(s){var r;const e=new Date().toISOString(),t=new Date(e);if(s.completionCount=(s.completionCount||0)+1,s.currentStreak=(s.currentStreak||0)+1,s.bestStreak=Math.max(s.bestStreak||0,s.currentStreak),s.recentCompletions||(s.recentCompletions=[]),s.recentCompletions.push(e),s.recentCompletions.length>Hi&&(s.recentCompletions=s.recentCompletions.slice(-Hi)),(r=s.smartRecurrence)!=null&&r.enabled){s.completionHistory||(s.completionHistory=[]);const n=new Date(s.dueAt),a=Math.round((t.getTime()-n.getTime())/(1e3*60)),o={scheduledFor:s.dueAt,completedAt:e,delayMinutes:a,dayOfWeek:t.getDay(),context:{tags:s.tags||[],relatedBlocks:s.linkedBlockId?[s.linkedBlockId]:[]}};s.completionHistory.push(o),s.completionHistory.length>100&&(s.completionHistory=s.completionHistory.slice(-100))}s.snoozeCount=0,s.lastCompletedAt=e,s.updatedAt=e}function El(s){s.missCount=(s.missCount||0)+1,s.currentStreak=0,s.updatedAt=new Date().toISOString()}function xl(s){const e=s.completionCount||0,t=s.missCount||0,r=e+t;if(r===0)return 100;let a=e/r*70;const o=s.currentStreak||0,l=Math.min(30,o*3);return a+=l,Math.round(Math.min(100,a))}function Qu(s,e){const t=new Set([...s.blockedBy??[],...s.dependsOn??[]]);return t.size===0?!1:e.filter(n=>t.has(n.id)).some(n=>hi(n))}function $u(s,e){return e.some(t=>t.id===s.id||!new Set([...t.blockedBy??[],...t.dependsOn??[]]).has(s.id)?!1:hi(t))}function hi(s){return s.status?s.status==="todo":s.enabled}function cs(s){const{message:e,type:t="info",duration:r=3e3,actionLabel:n,onAction:a,showCountdown:o=!1}=s,l=document.createElement("div");l.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const c=document.createElement("span");c.textContent=e,l.appendChild(c);let u=null;if(n&&a){const p=document.createElement("button");p.type="button";let v=Math.max(1,Math.ceil(r/1e3));p.textContent=o?`${n} (${v}s)`:n,p.className="recurring-tasks-toast__action",p.addEventListener("click",()=>{a(),u!==null&&window.clearInterval(u),l.parentElement&&l.parentElement.removeChild(l)}),l.appendChild(p),o&&r>0&&(u=window.setInterval(()=>{v=Math.max(0,v-1),p.textContent=`${n} (${v}s)`,v<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(l.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:Vu(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(l);const h=()=>{u!==null&&window.clearInterval(u),l.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{l.parentElement&&l.parentElement.removeChild(l)},300)};r>0&&setTimeout(()=>{h()},r)}function Vu(s){switch(s){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const Q={success:(s,e)=>cs({message:s,type:"success",duration:e}),error:(s,e)=>cs({message:s,type:"error",duration:e}),warning:(s,e)=>cs({message:s,type:"warning",duration:e}),info:(s,e)=>cs({message:s,type:"info",duration:e})};if(typeof document<"u"){const s=document.createElement("style");s.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(s)}class Xu{constructor(){w(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var r;return(r=this.handlers.get(e))==null?void 0:r.delete(t)}}emit(e,t){var r;(r=this.handlers.get(e))==null||r.forEach(n=>n(t))}clear(){this.handlers.clear()}}const ze=new Xu;function ua(s,e){const t=s.findIndex(n=>n.id===e.id);if(t===-1)return[...s,e];const r=[...s];return r[t]=e,r}function Zi(s,e){const t=s.filter(r=>r.id!==e);return t.length===s.length?s:t}function da(s,e,t){let r=!1;const n=s.map(a=>a.id!==e?a:(r=!0,t(a)));return r?n:s}function Zu(s,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),s.filter(r=>r.enabled?new Date(r.dueAt)<=t:!1)}const fi=Symbol("urgency-settings"),Ju=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function ta(s,e,t){const r={timestamp:new Date().toISOString()},n=`[${s.toUpperCase()}] [${r.timestamp}]`;s==="error"?console.error(n,e,t||""):s==="warn"?console.warn(n,e,t||""):s==="debug"&&Ju?console.debug(n,e,t||""):s==="info"&&console.log(n,e,t||"")}function Al(s,e){ta("debug",s,e)}function de(s,e){ta("info",s,e)}function Qe(s,e){ta("warn",s,e)}function be(s,e){ta("error",s,e)}async function ed(s){return new Promise(e=>{try{Ka.fetchPost("/api/block/getBlockInfo",{id:s},t=>{var n,a,o;const r=((n=t==null?void 0:t.data)==null?void 0:n.content)??((a=t==null?void 0:t.data)==null?void 0:a.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(r?r.trim():null)})}catch(t){Qe("Failed to fetch block preview",t),e(null)}})}async function td(s){return new Promise(e=>{try{Ka.fetchPost("/api/block/getBlockHTML",{id:s},t=>{var n;const r=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(r?r.trim():null)})}catch(t){Qe("Failed to fetch block embed",t),e(null)}})}function Ia(s){const[e,t]=s.split(":").map(Number);return{hours:e,minutes:t}}function rd(s){const e=s.getHours().toString().padStart(2,"0"),t=s.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function sd(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Oa(s){return s.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function vi(s){const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()}function nd(s){return s<new Date}function ad(s){return nd(s)&&!vi(s)}function vn(s,e){const t=new Date(s);return t.setDate(t.getDate()+e),t}function Ji(s,e){return vn(s,e*7)}function eo(s,e,t){const r=new Date(s);r.setHours(e,t,0,0);const n=r.getHours()!==e||r.getMinutes()!==t;return{date:r,shifted:n}}function Ma(s){const e=new Date(s);return e.setHours(0,0,0,0),e}function id(s){const e=new Date(s);return e.setHours(23,59,59,999),e}function od(s,e){const r=Math.abs(e.getTime()-s.getTime());return Math.floor(r/864e5)}function ld(s,e){const t=[];for(let r=0;r<e;r++)t.push(vn(s,r));return t}var cd=A('<span class="task-card__streak svelte-yjw1ud"> </span>'),ud=A('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">✏️</button>'),dd=A('<span class="task-card__relative svelte-yjw1ud"> </span>'),hd=A('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),fd=A('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),vd=A('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),pd=A('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),yd=A('<button class="task-card__snooze-chip"> </button>'),md=A('<button class="task-card__snooze-option" role="menuitem"> </button>'),gd=A('<div class="task-card__snooze-menu" role="menu" tabindex="0" aria-label="Snooze options"></div>'),bd=A('<div role="article" tabindex="0"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <div class="task-card__urgency svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Urgency:</span> <span class="task-card__value svelte-yjw1ud"> </span></div> <!> <!></div> <div><div class="task-card__health-bar"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze" aria-label="Snooze task" aria-haspopup="menu">🕒 Snooze</button> <div class="task-card__snooze-quick"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay" aria-label="Delay task to tomorrow">🕒 Tomorrow</button> <button class="task-card__action task-card__action--skip" aria-label="Skip this occurrence">⏭️ Skip</button> <button class="task-card__action task-card__action--done" aria-label="Mark task as done">✅ Done</button></div></div>');function Js(s,e){Je(e,!0);const t=V(()=>new Date(e.task.dueAt)),r=V(()=>ad(i(t))),n=V(()=>vi(i(t))),a=V(()=>i(r)?od(new Date(e.task.dueAt),new Date):0),o=V(()=>i(r)?"task-card--overdue":i(n)?"task-card--today":""),l=V(()=>()=>i(r)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(a)*.05)})`:""),c=V(()=>()=>i(r)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(a)*.08)})`:""),u=V(()=>()=>{const ee=Qs(e.task.priority)||"normal";return Bu[ee]}),h=V(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),p=V(()=>(e.task.currentStreak||0)>0),v=V(()=>()=>"🔥"),y=V(()=>xl(e.task)),k=V(()=>i(y)>=80?"health--good":i(y)>=50?"health--fair":"health--poor"),m=qo(fi),g=V(()=>di(e.task,{settings:m}));let _=W(!1),D=W(-1),E=[],x=W(!1),R=W(null),U=W(null),N=W(!1);const K=V(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}…`:e.task.linkedBlockId:""),Y=V(()=>()=>{if(!i(R))return"";const ee=i(R).replace(/\s+/g," ").trim();return ee.length>220?`${ee.slice(0,220)}…`:ee}),J=V(()=>()=>Wi.filter(ee=>[15,60,120].includes(ee.minutes))),se=V(()=>()=>`snooze-menu-${e.task.id}`);yt(()=>{b(R,e.task.linkedBlockContent??null,!0),b(U,null),b(N,!1)});function te(){e.onDone(e.task)}function le(){e.onDelay(e.task)}function ye(){e.onEdit&&e.onEdit(e.task)}function H(){e.onSkip(e.task)}async function L(){b(_,!i(_)),i(_)&&(await vl(),b(D,-1),E=[])}function C(ee){const ge=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:ee}});window.dispatchEvent(ge),b(_,!1),b(D,-1)}function z(ee){var Be,ce,Se,Ue;const ge=i(J);ee.key==="ArrowDown"?(ee.preventDefault(),b(D,Math.min(i(D)+1,ge.length-1),!0),(Be=E[i(D)])==null||Be.focus()):ee.key==="ArrowUp"?(ee.preventDefault(),b(D,Math.max(i(D)-1,0),!0),(ce=E[i(D)])==null||ce.focus()):ee.key==="Escape"?(b(_,!1),b(D,-1)):ee.key==="Home"?(ee.preventDefault(),b(D,0),(Se=E[0])==null||Se.focus()):ee.key==="End"&&(ee.preventDefault(),b(D,ge.length-1),(Ue=E[i(D)])==null||Ue.focus())}function re(ee){if(ee.key==="Escape"&&i(_)){b(_,!1);return}(ee.key==="Enter"||ee.key===" ")&&(ee.preventDefault(),L())}async function X(){if(b(x,!0),!e.task.linkedBlockId||i(N)||i(U))return;b(N,!0);const[ee,ge]=await Promise.all([td(e.task.linkedBlockId),ed(e.task.linkedBlockId)]);b(U,ee,!0),b(R,ge,!0),b(N,!1)}function me(){b(x,!1)}const ve=V(()=>()=>`Task:  ${e.task.name.replace(/[<>"&]/g,ge=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[ge]||ge)}`);var he=bd();he.__keydown=ee=>{ee.key==="Escape"&&i(_)&&b(_,!1)};var Te=d(he),_e=d(Te),qe=d(_e),fe=f(qe,2),F=d(fe),T=f(fe,2);{var q=ee=>{var ge=cd(),Be=d(ge);j(ce=>{Ee(ge,"title",`${e.task.currentStreak??""} day streak`),P(Be,`${ce??""} ${e.task.currentStreak??""}`)},[()=>i(v)()]),S(ee,ge)};G(T,ee=>{i(p)&&ee(q)})}var Z=f(_e,2);{var ne=ee=>{var ge=ud();ge.__click=ye,S(ee,ge)};G(Z,ee=>{e.onEdit&&ee(ne)})}var I=f(Te,2),M=d(I),ie=f(d(M),2),Ae=d(ie),Ie=f(ie,2);{var Ce=ee=>{var ge=dd(),Be=d(ge);j(ce=>P(Be,ce),[()=>i(h)()]),S(ee,ge)};G(Ie,ee=>{e.timezoneHandler&&ee(Ce)})}var Ye=f(M,2),Pe=f(d(Ye),2),ct=d(Pe),bt=f(Ye,2);{var $e=ee=>{var ge=hd(),Be=f(d(ge),2),ce=d(Be);j(Se=>P(ce,Se),[()=>Oa(new Date(e.task.lastCompletedAt))]),S(ee,ge)};G(bt,ee=>{e.task.lastCompletedAt&&ee($e)})}var Et=f(bt,2);{var vt=ee=>{var ge=pd(),Be=d(ge),ce=d(Be),Se=f(Be,2);{var Ue=Ze=>{var ut=vd(),dt=d(ut);{var qt=xt=>{var or=na("Loading preview…");S(xt,or)},Vt=xt=>{var or=st(),Yt=Ge(or);{var lr=Ht=>{var B=fd(),ue=d(B);gu(ue,()=>i(U)),S(Ht,B)},zr=Ht=>{var B=st(),ue=Ge(B);{var it=Xt=>{var Ss=na();j(()=>P(Ss,i(Y))),S(Xt,Ss)},Dr=Xt=>{var Ss=na("No preview available.");S(Xt,Ss)};G(ue,Xt=>{i(R)?Xt(it):Xt(Dr,!1)},!0)}S(Ht,B)};G(Yt,Ht=>{i(U)?Ht(lr):Ht(zr,!1)},!0)}S(xt,or)};G(dt,xt=>{i(N)?xt(qt):xt(Vt,!1)})}S(Ze,ut)};G(Se,Ze=>{i(x)&&Ze(Ue)})}j(()=>{Ee(Be,"title",`Linked block: ${e.task.linkedBlockId}`),P(ce,`📝 Block ${i(K)??""}`)}),St("mouseenter",Be,X),St("mouseleave",Be,me),St("focus",Be,X),St("blur",Be,me),S(ee,ge)};G(Et,ee=>{e.task.linkedBlockId&&ee(vt)})}var Oe=f(I,2),_t=d(Oe),He=f(Oe,2),Ve=d(He),Xe=d(Ve);Xe.__click=L,Xe.__keydown=re;var Mt=f(Xe,2),Nt=d(Mt);Fe(Nt,17,()=>i(J),nt,(ee,ge)=>{var Be=yd();Be.__click=()=>C(i(ge).minutes);var ce=d(Be);j(()=>{Ee(Be,"aria-label",`Snooze for ${i(ge).label}`),P(ce,i(ge).label)}),S(ee,Be)});var jt=f(Nt,2);jt.__click=le;var ae=f(Mt,2);{var oe=ee=>{var ge=gd();ge.__keydown=z,Fe(ge,21,()=>Wi,nt,(Be,ce,Se)=>{var Ue=md();Ue.__click=()=>C(i(ce).minutes),Ee(Ue,"tabindex",Se===0?0:-1);var Ze=d(Ue);fr(Ue,(ut,dt)=>E[dt]=ut,ut=>E==null?void 0:E[ut],()=>[Se]),j(()=>P(Ze,i(ce).label)),S(Be,Ue)}),j(()=>Ee(ge,"id",i(se))),S(ee,ge)};G(ae,ee=>{i(_)&&ee(oe)})}var we=f(Ve,2);we.__click=le;var tt=f(we,2);tt.__click=H;var pr=f(tt,2);pr.__click=te,j((ee,ge)=>{We(he,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),bs(he,`--overdue-tint: ${i(l)??""}; --overdue-border: ${i(c)??""};`),Ee(he,"aria-label",ee),Ee(he,"data-task-id",e.task.id),bs(qe,`background-color: ${i(u)??""}`),Ee(qe,"title",`Priority:  ${(e.task.priority||"normal")??""}`),P(F,e.task.name),P(Ae,ge),Ee(Ye,"title",`Urgency score: ${i(g)??""}`),P(ct,i(g)),We(Oe,1,`task-card__health ${i(k)??""}`,"svelte-yjw1ud"),Ee(Oe,"title",`Task health:  ${i(y)??""}%`),bs(_t,`width: ${i(y)??""}%`),Ee(Xe,"aria-expanded",i(_)),Ee(Xe,"aria-controls",i(se))},[()=>i(ve)(),()=>Oa(i(t))]),S(s,he),et()}ft(["keydown","click"]);var _d=A(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">🎉 No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),kd=A('<div class="today-tab__card-wrapper svelte-u7986x" role="listitem"><!></div>'),wd=A('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x" role="list" aria-label="Today and overdue tasks"><!></div></div>');function Td(s,e){Je(e,!0);const t=V(()=>[...e.tasks].sort((m,g)=>new Date(m.dueAt).getTime()-new Date(g.dueAt).getTime()));let r=W(0),n=ke([]);yt(()=>{i(r)>=i(t).length&&b(r,Math.max(0,i(t).length-1),!0)});function a(m){var _;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));b(r,g,!0),(_=n[g])==null||_.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Home"?(m.preventDefault(),a(0)):m.key==="End"&&(m.preventDefault(),a(i(t).length-1))}var l=wd(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var y=m=>{var g=_d();S(m,g)},k=m=>{var g=st(),_=Ge(g);Fe(_,19,()=>i(t),D=>D.id,(D,E,x)=>{var R=kd();R.__keydown=N=>o(N,i(x));var U=d(R);Js(U,{get task(){return i(E)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),fr(R,(N,K)=>n[K]=N,N=>n==null?void 0:n[N],()=>[i(x)]),j(()=>Ee(R,"tabindex",i(x)===i(r)?0:-1)),St("focus",R,()=>b(r,i(x),!0)),S(D,R)}),S(m,g)};G(v,m=>{i(t).length===0?m(y):m(k,!1)})}j(()=>P(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),S(s,l),et()}ft(["keydown"]);var Sd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Dd=A('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Ed=A('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">✏️</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">📄</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">🗑️</button></div></td></tr>'),xd=A('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ad=A('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),Cd=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Id=A('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Od=A('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">🔍</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Md(s,e){Je(e,!0);let t=W(null),r=W(!1),n=W(""),a=W(""),o=W(ke(new Set)),l=W(0),c=ke([]),u=W(null);const h=V(()=>[...e.tasks].sort((I,M)=>new Date(I.dueAt).getTime()-new Date(M.dueAt).getTime())),p=V(()=>()=>{const I=i(a).trim().toLowerCase();return I?i(h).filter(M=>{var Ae;return[M.name,M.description,M.category,M.linkedBlockContent,(Ae=M.tags)==null?void 0:Ae.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(I)}):i(h)}),v=V(()=>i(p).map(I=>I.id)),y=V(()=>i(o).size>0),k=V(()=>i(p).length>0&&i(p).every(I=>i(o).has(I.id))),m=V(()=>i(p).some(I=>i(o).has(I.id))&&!i(k));yt(()=>{const I=new Set([...i(o)].filter(M=>e.tasks.some(ie=>ie.id===M)));I.size!==i(o).size&&b(o,I,!0)}),yt(()=>{i(u)&&(i(u).indeterminate=i(m))}),yt(()=>{i(l)>=i(p).length&&b(l,Math.max(0,i(p).length-1),!0)}),yt(()=>{const I=window.setTimeout(()=>{b(a,i(n),!0)},300);return()=>{window.clearTimeout(I)}});function g(I){b(t,I,!0)}function _(){i(t)&&(e.onDelete(i(t)),b(t,null))}function D(){b(t,null)}function E(I){const M=new Set(i(o));M.has(I)?M.delete(I):M.add(I),b(o,M,!0)}function x(){const I=new Set(i(o));i(k)?i(v).forEach(M=>I.delete(M)):i(v).forEach(M=>I.add(M)),b(o,I,!0)}function R(I){var ie;if(i(p).length===0)return;const M=Math.max(0,Math.min(I,i(p).length-1));b(l,M,!0),(ie=c[M])==null||ie.focus()}function U(I,M){I.key==="ArrowDown"?(I.preventDefault(),R(M+1)):I.key==="ArrowUp"?(I.preventDefault(),R(M-1)):I.key==="Home"?(I.preventDefault(),R(0)):I.key==="End"&&(I.preventDefault(),R(i(p).length-1))}function N(){if(i(o).size===0){b(r,!1);return}e.onBulkDelete([...i(o)]),b(o,new Set,!0),b(r,!1)}function K(){b(r,!1)}function Y(I){const{type:M,interval:ie}=I.frequency,Ae=M==="daily"?"day":M==="weekly"?"week":M==="monthly"?"month":"year",Ie=ie===1?`Every ${Ae}`:`Every ${ie} ${Ae}s`;if(M==="weekly")return`${Ie} on ${I.frequency.weekdays.map(Ce=>Uu[Ce]??Ce).join(", ")}`;if(M==="monthly")return`${Ie} on day ${I.frequency.dayOfMonth}`;if(M==="yearly"){const Ce=J[I.frequency.month]??`Month ${I.frequency.month+1}`;return`${Ie} on ${Ce} ${I.frequency.dayOfMonth}`}return Ie}const J=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var se=Od(),te=Ge(se),le=d(te),ye=f(d(le),2),H=d(ye),L=f(d(H),2),C=f(H,2);C.__click=function(...I){var M;(M=e.onCreate)==null||M.apply(this,I)};var z=f(le,2),re=d(z),X=d(re),me=d(X),ve=f(X,2),he=d(ve);he.__click=()=>e.onBulkEnable([...i(o)]);var Te=f(he,2);Te.__click=()=>e.onBulkDisable([...i(o)]);var _e=f(Te,2);_e.__click=()=>b(r,!0);var qe=f(re,2);{var fe=I=>{var M=Sd();S(I,M)},F=I=>{var M=Ad(),ie=d(M);{var Ae=Ce=>{var Ye=Dd(),Pe=d(Ye),ct=d(Pe);j(bt=>P(ct,`No tasks match "${bt??""}".`),[()=>i(a).trim()]),S(Ce,Ye)},Ie=Ce=>{var Ye=xd(),Pe=d(Ye),ct=d(Pe),bt=d(ct),$e=d(bt);$e.__click=x,fr($e,vt=>b(u,vt),()=>i(u));var Et=f(Pe);Fe(Et,23,()=>i(p),vt=>vt.id,(vt,Oe,_t)=>{var He=Ed();He.__keydown=Ze=>U(Ze,i(_t));var Ve=d(He),Xe=d(Ve);Xe.__click=()=>E(i(Oe).id);var Mt=f(Ve),Nt=d(Mt),jt=f(Mt),ae=d(jt),oe=f(jt),we=d(oe),tt=f(oe),pr=d(tt),ee=d(pr);ee.__change=()=>e.onToggleEnabled(i(Oe));var ge=f(tt),Be=d(ge),ce=d(Be);ce.__click=()=>e.onEdit(i(Oe));var Se=f(ce,2);Se.__click=()=>e.onDuplicate(i(Oe));var Ue=f(Se,2);Ue.__click=()=>g(i(Oe)),fr(He,(Ze,ut)=>c[ut]=Ze,Ze=>c==null?void 0:c[Ze],()=>[i(_t)]),j((Ze,ut,dt,qt)=>{We(He,1,ku(i(Oe).enabled?"":"disabled"),"svelte-i091qn"),Ee(He,"tabindex",i(_t)===i(l)?0:-1),Ee(He,"aria-selected",Ze),Ee(Xe,"aria-label",`Select ${i(Oe).name}`),Fs(Xe,ut),P(Nt,i(Oe).name),P(ae,dt),P(we,qt),Fs(ee,i(Oe).enabled)},[()=>i(o).has(i(Oe).id),()=>i(o).has(i(Oe).id),()=>Oa(new Date(i(Oe).dueAt)),()=>Y(i(Oe))]),St("focus",He,()=>b(l,i(_t),!0)),S(vt,He)}),j(()=>{Fs($e,i(k)),$e.disabled=i(p).length===0}),S(Ce,Ye)};G(ie,Ce=>{i(p).length===0?Ce(Ae):Ce(Ie,!1)})}S(I,M)};G(qe,I=>{i(h).length===0?I(fe):I(F,!1)})}var T=f(te,2);{var q=I=>{var M=Cd(),ie=d(M),Ae=f(d(ie),2),Ie=d(Ae),Ce=f(Ae,2),Ye=d(Ce);Ye.__click=D;var Pe=f(Ye,2);Pe.__click=_,j(()=>P(Ie,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),S(I,M)};G(T,I=>{i(t)&&I(q)})}var Z=f(T,2);{var ne=I=>{var M=Id(),ie=d(M),Ae=f(d(ie),2),Ie=d(Ae),Ce=f(Ae,2),Ye=d(Ce);Ye.__click=K;var Pe=f(Ye,2);Pe.__click=N,j(()=>P(Ie,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),S(I,M)};G(Z,I=>{i(r)&&I(ne)})}j(()=>{L.disabled=i(h).length===0,P(me,`${i(o).size??""} selected`),he.disabled=!i(y),Te.disabled=!i(y),_e.disabled=!i(y)}),at(L,()=>i(n),I=>b(n,I)),S(s,se),et()}ft(["click","keydown","change"]);var Nd=A('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),qd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Rd=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Ld=A('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Fd=A('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Pd=A('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Bd=A('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Ud=A('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function zd(s,e){Je(e,!0);let t=Rr(e,"days",3,30);function r(_){const{frequency:D}=_;if(D.type==="weekly"){const E=[...D.weekdays].sort((x,R)=>x-R).join(",");return`weekly:${D.interval}:${D.time??""}:${E}`}return D.type==="monthly"?`monthly:${D.interval}:${D.time??""}:${D.dayOfMonth}`:D.type==="yearly"?`yearly:${D.interval}:${D.time??""}:${D.month}:${D.dayOfMonth}`:`daily:${D.interval}:${D.time??""}`}function n(_,D){const E=_.map(x=>`${x.id}:${x.enabled}:${x.dueAt}:${r(x)}`).join("|");return`${D}:${E}`}function a(_,D){const E=Ma(new Date),x=id(vn(E,D-1)),R=24*60*60*1e3,N=ld(E,D).map(K=>({date:K,tasks:[]}));for(const K of _.filter(Y=>Y.enabled)){const Y=new Date(K.dueAt),J=e.recurrenceEngine.getOccurrencesInRange(E,x,K.frequency,Y);for(const se of J){const te=Ma(se),le=Math.floor((te.getTime()-E.getTime())/R);le>=0&&le<D&&N[le].tasks.push({task:K,occurrence:se})}}for(const K of N)K.tasks.sort((Y,J)=>Y.occurrence.getTime()-J.occurrence.getTime());return N}const o=(()=>{let _="",D=[];return{get(E,x){const R=n(E,x);return R===_||(_=R,D=a(E,x)),D}}})(),l=V(()=>o.get(e.tasks,t())),c=V(()=>i(l).some(_=>_.tasks.length>0));var u=Ud(),h=d(u),p=f(d(h),2),v=d(p),y=f(h,2),k=d(y);{var m=_=>{var D=Nd(),E=d(D),x=d(E);j(()=>P(x,`No tasks scheduled in the next ${t()??""} days.`)),S(_,D)},g=_=>{var D=Bd();Fe(D,21,()=>i(l),E=>E.date.toISOString(),(E,x)=>{var R=st(),U=Ge(R);{var N=K=>{var Y=Pd(),J=d(Y),se=d(J),te=d(se),le=f(se,2),ye=d(le),H=f(J,2);Fe(H,21,()=>i(x).tasks,({task:L,occurrence:C})=>L.id+C.toISOString(),(L,C)=>{let z=()=>i(C).task,re=()=>i(C).occurrence;var X=Fd(),me=d(X),ve=d(me),he=f(me,2),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe);{var F=I=>{var M=qd(),ie=d(M);j(()=>P(ie,`🔗 ${z().linkedBlockId??""}`)),S(I,M)};G(fe,I=>{z().linkedBlockId&&I(F)})}var T=f(fe,2);{var q=I=>{var M=Rd(),ie=d(M);j(()=>P(ie,`⚡ ${z().priority??""}`)),S(I,M)};G(T,I=>{z().priority&&I(q)})}var Z=f(T,2);{var ne=I=>{var M=Ld(),ie=d(M);j(Ae=>P(ie,`🏷️ ${Ae??""}`),[()=>z().tags.join(", ")]),S(I,M)};G(Z,I=>{var M;(M=z().tags)!=null&&M.length&&I(ne)})}j(I=>{P(ve,I),P(_e,z().name)},[()=>rd(re())]),S(L,X)}),j((L,C)=>{P(te,L),P(ye,C)},[()=>sd(i(x).date),()=>i(x).date.toLocaleDateString(void 0,{weekday:"short"})]),S(K,Y)};G(U,K=>{i(x).tasks.length>0&&K(N)})}S(E,R)}),S(_,D)};G(k,_=>{i(c)?_(g,!1):_(m)})}j(()=>P(v,`Next ${t()??""} days`)),S(s,u),et()}var jd=A('<span class="leaderboard-item__badge svelte-1ptoc1q">🏆 Best</span>'),Yd=A('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Hd=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">🔥 Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Wd=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Kd=A('<h4 class="subsection-title svelte-1ptoc1q">✅ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Gd=A('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Qd=A('<h4 class="subsection-title svelte-1ptoc1q">⚠️ Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),$d=A('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">✅</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),Vd=A('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),Xd=A('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Zd(s,e){Je(e,!0);const t=V(()=>()=>{let L=0,C=0;for(const X of e.tasks)L+=X.completionCount||0,C+=X.missCount||0;const z=L+C,re=z>0?L/z*100:100;return{totalCompletions:L,totalMisses:C,completionRate:Math.round(re)}}),r=V(()=>()=>[...e.tasks].filter(L=>(L.currentStreak||0)>0).sort((L,C)=>(C.currentStreak||0)-(L.currentStreak||0)).slice(0,10)),n=V(()=>()=>[...e.tasks].map(L=>({task:L,health:xl(L)})).sort((L,C)=>L.health-C.health)),a=V(()=>()=>i(n)().slice(-5).reverse()),o=V(()=>()=>i(n)().slice(0,5)),l=V(()=>()=>{const L=[];for(const C of e.tasks)if(C.recentCompletions&&C.recentCompletions.length>0)for(const z of C.recentCompletions)L.push({task:C,completedAt:z});return L.sort((C,z)=>new Date(z.completedAt).getTime()-new Date(C.completedAt).getTime()).slice(0,10)});function c(L){return new Date(L).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(L){return L>=80?"#10b981":L>=60?"#3b82f6":L>=40?"#f59e0b":"#ef4444"}var h=Xd(),p=f(d(h),2),v=d(p),y=f(d(v),2),k=d(y),m=d(k),g=d(m),_=f(k,2),D=d(_),E=d(D),x=f(_,2),R=d(x),U=d(R),N=f(v,2);{var K=L=>{var C=Hd(),z=f(d(C),2);Fe(z,21,()=>i(r)(),nt,(re,X,me)=>{var ve=Yd(),he=d(ve);he.textContent=`#${me+1}`;var Te=f(he,2),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe);{var T=q=>{var Z=jd();S(q,Z)};G(F,q=>{i(X).bestStreak&&i(X).currentStreak===i(X).bestStreak&&q(T)})}j(()=>{P(_e,i(X).name),P(fe,`${i(X).currentStreak??""} day${i(X).currentStreak!==1?"s":""} `)}),S(re,ve)}),S(L,C)};G(N,L=>{i(r)().length>0&&L(K)})}var Y=f(N,2),J=f(d(Y),2);{var se=L=>{var C=Kd(),z=f(Ge(C),2);Fe(z,21,()=>i(a)(),nt,(re,X)=>{let me=()=>i(X).task,ve=()=>i(X).health;var he=Wd(),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe,2),T=d(F);j(q=>{P(_e,me().name),bs(fe,`width: ${ve()??""}%; background-color: ${q??""}`),P(T,`${ve()??""}/100`)},[()=>u(ve())]),S(re,he)}),S(L,C)};G(J,L=>{i(a)().length>0&&L(se)})}var te=f(J,2);{var le=L=>{var C=Qd(),z=f(Ge(C),2);Fe(z,21,()=>i(o)(),nt,(re,X)=>{let me=()=>i(X).task,ve=()=>i(X).health;var he=Gd(),Te=d(he),_e=d(Te),qe=f(Te,2),fe=d(qe),F=f(fe,2),T=d(F);j(q=>{P(_e,me().name),bs(fe,`width: ${ve()??""}%; background-color: ${q??""}`),P(T,`${ve()??""}/100`)},[()=>u(ve())]),S(re,he)}),S(L,C)};G(te,L=>{i(o)().length>0&&i(o)()[0].health<80&&L(le)})}var ye=f(Y,2);{var H=L=>{var C=Vd(),z=f(d(C),2);Fe(z,21,()=>i(l)(),nt,(re,X)=>{let me=()=>i(X).task,ve=()=>i(X).completedAt;var he=$d(),Te=f(d(he),2),_e=d(Te),qe=d(_e),fe=f(_e,2),F=d(fe);j(T=>{P(qe,me().name),P(F,T)},[()=>c(ve())]),S(re,he)}),S(L,C)};G(ye,L=>{i(l)().length>0&&L(H)})}j((L,C,z)=>{P(g,L),P(E,C),P(U,`${z??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),S(s,h),et()}var Jd=A('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">📥 No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),eh=A('<div class="inbox-tab__card-wrapper svelte-1jnb97y" role="listitem"><!></div>'),th=A('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y" role="list" aria-label="Inbox tasks"><!></div></div>');function rh(s,e){Je(e,!0);const t=V(()=>e.tasks.filter(m=>m.status!=="done"&&m.status!=="cancelled"&&!m.dueAt&&!m.scheduledAt&&!m.startAt).sort((m,g)=>new Date(g.createdAt).getTime()-new Date(m.createdAt).getTime()));let r=W(0),n=ke([]);yt(()=>{i(r)>=i(t).length&&b(r,Math.max(0,i(t).length-1),!0)});function a(m){var _;if(i(t).length===0)return;const g=Math.max(0,Math.min(m,i(t).length-1));b(r,g,!0),(_=n[g])==null||_.focus()}function o(m,g){m.key==="ArrowDown"?(m.preventDefault(),a(g+1)):m.key==="ArrowUp"?(m.preventDefault(),a(g-1)):m.key==="Enter"&&e.onEdit?(m.preventDefault(),e.onEdit(i(t)[g])):m.key===" "&&e.onDone&&(m.preventDefault(),e.onDone(i(t)[g]))}var l=th(),c=d(l),u=f(d(c),2),h=d(u),p=f(c,2),v=d(p);{var y=m=>{var g=Jd();S(m,g)},k=m=>{var g=st(),_=Ge(g);Fe(_,19,()=>i(t),D=>D.id,(D,E,x)=>{var R=eh();R.__keydown=N=>o(N,i(x));var U=d(R);Js(U,{get task(){return i(E)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fr(R,(N,K)=>n[K]=N,N=>n==null?void 0:n[N],()=>[i(x)]),j(()=>Ee(R,"tabindex",i(x)===i(r)?0:-1)),St("focus",R,()=>b(r,i(x),!0)),S(D,R)}),S(m,g)};G(v,m=>{i(t).length===0?m(y):m(k,!1)})}j(()=>P(h,`${i(t).length??""} task${i(t).length!==1?"s":""} without dates`)),S(s,l),et()}ft(["keydown"]);var sh=A('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),nh=A('<div class="upcoming-tab__card-wrapper svelte-102jr7u" role="listitem"><!></div>'),ah=A('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),ih=A('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u" role="list" aria-label="Upcoming tasks"><!></div></div>');function oh(s,e){Je(e,!0);let t=Rr(e,"daysAhead",3,7);const r=new Date;r.setHours(0,0,0,0);const n=new Date(r);n.setDate(n.getDate()+t());const a=V(()=>e.tasks.filter(E=>{if(E.status==="done"||E.status==="cancelled"||!E.dueAt)return!1;const x=new Date(E.dueAt);return x.setHours(0,0,0,0),x>r&&x<=n}).sort((E,x)=>new Date(E.dueAt).getTime()-new Date(x.dueAt).getTime())),o=V(()=>()=>{const E=new Map;return i(a).forEach(x=>{const R=new Date(x.dueAt);R.setHours(0,0,0,0);const U=R.toISOString().split("T")[0];E.has(U)||E.set(U,[]),E.get(U).push(x)}),E});function l(E){const x=new Date(E),R=Math.floor((x.getTime()-r.getTime())/(1e3*60*60*24)),U=x.toLocaleDateString("en-US",{weekday:"long"}),N=x.toLocaleDateString("en-US",{month:"short",day:"numeric"});return R===1?`Tomorrow - ${U}, ${N}`:`${U}, ${N} (in ${R} days)`}let c=W(0),u=ke([]);yt(()=>{i(c)>=i(a).length&&b(c,Math.max(0,i(a).length-1),!0)});function h(E,x){E.key==="ArrowDown"?(E.preventDefault(),b(c,Math.min(i(c)+1,i(a).length-1),!0)):E.key==="ArrowUp"?(E.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):E.key==="Enter"&&e.onEdit?(E.preventDefault(),e.onEdit(i(a)[x])):E.key===" "&&e.onDone&&(E.preventDefault(),e.onDone(i(a)[x]))}var p=ih(),v=d(p),y=f(d(v),2),k=d(y),m=f(v,2),g=d(m);{var _=E=>{var x=sh(),R=d(x),U=d(R);j(()=>P(U,`📅 No tasks scheduled for the next ${t()??""} days`)),S(E,x)},D=E=>{var x=st(),R=Ge(x);Fe(R,17,()=>[...i(o).entries()],nt,(U,N)=>{var K=V(()=>xo(i(N),2));let Y=()=>i(K)[0],J=()=>i(K)[1];var se=ah(),te=d(se),le=d(te),ye=f(te,2);Fe(ye,19,J,H=>H.id,(H,L)=>{const C=V(()=>i(a).indexOf(i(L)));var z=nh();z.__keydown=X=>h(X,i(C));var re=d(z);Js(re,{get task(){return i(L)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fr(z,(X,me)=>u[me]=X,X=>u==null?void 0:u[X],()=>[i(C)]),j(()=>Ee(z,"tabindex",i(C)===i(c)?0:-1)),St("focus",z,()=>b(c,i(C),!0)),S(H,z)}),j(H=>P(le,H),[()=>l(Y())]),S(U,se)}),S(E,x)};G(g,E=>{i(a).length===0?E(_):E(D,!1)})}j(()=>P(k,`${i(a).length??""} task${i(a).length!==1?"s":""} in the next ${t()??""} days`)),S(s,p),et()}ft(["keydown"]);var lh=A('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">✅ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),ch=A('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),uh=A('<div class="done-tab__card-wrapper svelte-z9ywjc" role="listitem"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),dh=A('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">← Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next →</button></div>'),hh=A("<!> <!>",1),fh=A('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc" role="list" aria-label="Completed tasks"><!></div></div>');function vh(s,e){Je(e,!0);let t=Rr(e,"daysBack",3,30),r=W(0);const n=50,a=new Date;a.setDate(a.getDate()-t()),a.setHours(0,0,0,0);const o=V(()=>e.tasks.filter(N=>N.status!=="done"||!N.doneAt?!1:new Date(N.doneAt)>=a).sort((N,K)=>new Date(K.doneAt).getTime()-new Date(N.doneAt).getTime())),l=V(()=>Math.ceil(i(o).length/n)),c=V(()=>i(o).slice(i(r)*n,(i(r)+1)*n));yt(()=>{i(r)>=i(l)&&i(l)>0&&b(r,i(l)-1)});function u(){i(r)<i(l)-1&&Ei(r)}function h(){i(r)>0&&Ei(r,-1)}function p(N){const K=new Date(N),Y=new Date,J=Y.getTime()-K.getTime(),se=Math.floor(J/(1e3*60*60*24));return se===0?"Today":se===1?"Yesterday":se<7?`${se} days ago`:K.toLocaleDateString("en-US",{month:"short",day:"numeric",year:K.getFullYear()!==Y.getFullYear()?"numeric":void 0})}let v=W(0),y=ke([]);yt(()=>{i(v)>=i(c).length&&b(v,Math.max(0,i(c).length-1),!0)});function k(N,K){N.key==="ArrowDown"?(N.preventDefault(),b(v,Math.min(i(v)+1,i(c).length-1),!0)):N.key==="ArrowUp"?(N.preventDefault(),b(v,Math.max(i(v)-1,0),!0)):N.key==="Enter"&&e.onEdit&&(N.preventDefault(),e.onEdit(i(c)[K]))}var m=fh(),g=d(m),_=f(d(g),2),D=d(_),E=f(g,2),x=d(E);{var R=N=>{var K=lh();S(N,K)},U=N=>{var K=hh(),Y=Ge(K);Fe(Y,19,()=>i(c),te=>te.id,(te,le,ye)=>{var H=uh();H.__keydown=ve=>k(ve,i(ye));var L=d(H),C=d(L),z=d(C),re=f(C,2);{var X=ve=>{var he=ch();he.__click=()=>e.onUncomplete(i(le)),S(ve,he)};G(re,ve=>{e.onUncomplete&&ve(X)})}var me=f(L,2);Js(me,{get task(){return i(le)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),fr(H,(ve,he)=>y[he]=ve,ve=>y==null?void 0:y[ve],()=>[i(ye)]),j(ve=>{Ee(H,"tabindex",i(ye)===i(v)?0:-1),P(z,`Completed ${ve??""}`)},[()=>p(i(le).doneAt)]),St("focus",H,()=>b(v,i(ye),!0)),S(te,H)});var J=f(Y,2);{var se=te=>{var le=dh(),ye=d(le);ye.__click=h;var H=f(ye,2),L=d(H),C=f(H,2);C.__click=u,j(()=>{ye.disabled=i(r)===0,P(L,`Page ${i(r)+1} of ${i(l)??""}`),C.disabled=i(r)>=i(l)-1}),S(te,le)};G(J,te=>{i(l)>1&&te(se)})}S(N,K)};G(x,N=>{i(o).length===0?N(R):N(U,!1)})}j(()=>P(D,`${i(o).length??""} completed task${i(o).length!==1?"s":""} in the last ${t()??""} days`)),S(s,m),et()}ft(["keydown","click"]);var ph=A('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">📁 No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),yh=A('<div class="projects-tab__card-wrapper svelte-8ybpha" role="listitem"><!></div>'),mh=A('<div class="projects-tab__project-tasks svelte-8ybpha" role="list"></div>'),gh=A('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),bh=A('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha" role="region" aria-label="Project task lists"><!></div></div>');function _h(s,e){Je(e,!0);const t=V(()=>()=>{const Y=new Map;return e.tasks.filter(se=>se.status!=="done"&&se.status!=="cancelled").forEach(se=>{const te=se.linkedBlockPath||"Uncategorized";Y.has(te)||Y.set(te,[]),Y.get(te).push(se)}),Y.forEach(se=>{se.sort((te,le)=>!te.dueAt&&!le.dueAt?0:te.dueAt?le.dueAt?new Date(te.dueAt).getTime()-new Date(le.dueAt).getTime():-1:1)}),new Map([...Y.entries()].sort(([se],[te])=>se.localeCompare(te)))}),r=V(()=>[...i(t).values()].reduce((Y,J)=>Y+J.length,0));let n=W(ke(new Set([...i(t).keys()])));function a(Y){const J=new Set(i(n));J.has(Y)?J.delete(Y):J.add(Y),b(n,J,!0)}function o(){b(n,new Set([...i(t).keys()]),!0)}function l(){b(n,new Set,!0)}let c=W(0),u=ke([]);const h=V(()=>()=>{const Y=[];return i(t).forEach((J,se)=>{i(n).has(se)&&Y.push(...J)}),Y});yt(()=>{i(c)>=i(h).length&&b(c,Math.max(0,i(h).length-1),!0)});function p(Y,J){Y.key==="ArrowDown"?(Y.preventDefault(),b(c,Math.min(i(c)+1,i(h).length-1),!0)):Y.key==="ArrowUp"?(Y.preventDefault(),b(c,Math.max(i(c)-1,0),!0)):Y.key==="Enter"&&e.onEdit?(Y.preventDefault(),e.onEdit(i(h)[J])):Y.key===" "&&e.onDone&&(Y.preventDefault(),e.onDone(i(h)[J]))}function v(Y){const J=Y.split("/");return J[J.length-1]||Y}var y=bh(),k=d(y),m=d(k),g=f(d(m),2),_=d(g),D=f(m,2),E=d(D);E.__click=o;var x=f(E,2);x.__click=l;var R=f(k,2),U=d(R);{var N=Y=>{var J=ph();S(Y,J)},K=Y=>{var J=st(),se=Ge(J);Fe(se,17,()=>[...i(t).entries()],nt,(te,le)=>{var ye=V(()=>xo(i(le),2));let H=()=>i(ye)[0],L=()=>i(ye)[1];var C=gh(),z=d(C);z.__click=()=>a(H());var re=d(z),X=d(re),me=f(re,2),ve=d(me),he=f(me,2),Te=d(he),_e=f(z,2);{var qe=fe=>{var F=mh();Fe(F,23,L,T=>T.id,(T,q)=>{const Z=V(()=>i(h).indexOf(i(q)));var ne=yh();ne.__keydown=M=>p(M,i(Z));var I=d(ne);Js(I,{get task(){return i(q)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fr(ne,(M,ie)=>u[ie]=M,M=>u==null?void 0:u[M],()=>[i(Z)]),j(()=>Ee(ne,"tabindex",i(Z)===i(c)?0:-1)),St("focus",ne,()=>b(c,i(Z),!0)),S(T,ne)}),j(T=>Ee(F,"aria-label",T),[()=>`Tasks for ${v(H())}`]),S(fe,F)};G(_e,fe=>{i(n).has(H())&&fe(qe)})}j((fe,F)=>{P(X,fe),Ee(me,"title",H()),P(ve,F),P(Te,L().length)},[()=>i(n).has(H())?"▼":"▶",()=>v(H())]),S(te,C)}),S(Y,J)};G(U,Y=>{i(t).size===0?Y(N):Y(K,!1)})}j(()=>P(_,`${i(r)??""} task${i(r)!==1?"s":""} in ${i(t).size??""} project${i(t).size!==1?"s":""}`)),S(s,y),et()}ft(["click","keydown"]);class Zt extends Error{constructor(e,t,r,n){super(e),this.line=t,this.column=r,this.suggestion=n,this.name="QuerySyntaxError"}}class Is extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var rt=(s=>(s.TODO="TODO",s.IN_PROGRESS="IN_PROGRESS",s.DONE="DONE",s.CANCELLED="CANCELLED",s.NON_TASK="NON_TASK",s.EMPTY="EMPTY",s))(rt||{});const mr=class mr{constructor(e){w(this,"symbol");w(this,"name");w(this,"nextStatusSymbol");w(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};w(mr,"TODO",new mr({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),w(mr,"DONE",new mr({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),w(mr,"IN_PROGRESS",new mr({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),w(mr,"CANCELLED",new mr({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let xr=mr;class kh{static parse(e,t=new Date){const r=e.trim().toLowerCase(),n=e;if(!r)return{date:null,isValid:!1,error:"Empty date string",original:n};if(r.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const y=new Date(r);if(!isNaN(y.getTime()))return{date:y,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),r==="today")return{date:o,isValid:!0,original:n};if(r==="tomorrow"){const y=new Date(o);return y.setDate(y.getDate()+1),{date:y,isValid:!0,original:n}}if(r==="yesterday"){const y=new Date(o);return y.setDate(y.getDate()-1),{date:y,isValid:!0,original:n}}const l=r.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(l){const y=parseInt(l[1]),k=l[2],m=new Date(o);return k.startsWith("day")?m.setDate(m.getDate()+y):k.startsWith("week")?m.setDate(m.getDate()+y*7):k.startsWith("month")&&m.setMonth(m.getMonth()+y),{date:m,isValid:!0,original:n}}const c=r.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(c){const y=parseInt(c[1]),k=c[2],m=new Date(o);return k.startsWith("day")?m.setDate(m.getDate()-y):k.startsWith("week")?m.setDate(m.getDate()-y*7):k.startsWith("month")&&m.setMonth(m.getMonth()-y),{date:m,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=r.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const y=h[1],k=u.indexOf(h[2]),m=o.getDay();let g=k-m;y==="next"?g<=0&&(g+=7):g>=0&&(g-=7);const _=new Date(o);return _.setDate(_.getDate()+g),{date:_,isValid:!0,original:n}}const p=r.match(/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(p){const y=u.indexOf(p[1]),k=o.getDay();let m=y-k;m<0&&(m+=7);const g=new Date(o);return g.setDate(g.getDate()+m),{date:g,isValid:!0,original:n}}const v=r.match(/^(this|next|last)\s+(week|month)$/);if(v){const y=v[1],k=v[2],m=new Date(o);if(k==="week"){const g=m.getDay(),_=g===0?-6:1-g;m.setDate(m.getDate()+_),y==="next"?m.setDate(m.getDate()+7):y==="last"&&m.setDate(m.getDate()-7)}else k==="month"&&(m.setDate(1),y==="next"?m.setMonth(m.getMonth()+1):y==="last"&&m.setMonth(m.getMonth()-1));return{date:m,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class Jr{constructor(){w(this,"input","");w(this,"position",0);w(this,"line",1);w(this,"column",1);w(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const r={filters:[]},n=this.input.split(`
`).map(a=>a.trim()).filter(a=>a.length>0);for(let a=0;a<n.length;a++){this.line=a+1,this.column=1;const o=n[a];if(o.startsWith("sort by "))r.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))r.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))r.limit=this.parseLimitInstruction(o);else if(/^explain$/i.test(o))r.explain=!0;else{const l=this.parseFilterInstruction(o);l&&r.filters.push(l)}}return r}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Zt?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(/\s+(and|AND)\s+/i.test(e))return this.parseAndFilter(e);if(/\s+(or|OR)\s+/i.test(e))return this.parseOrFilter(e);if(/^(not|NOT)\s+/i.test(e))return this.parseNotFilter(e);if(e.startsWith("status.type is ")){const r=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(r)}}if(e.startsWith("status.name includes ")){const r=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(r)}}if(e.startsWith("status.symbol is ")){const r=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(r)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("urgency is ")){const r=e.substring(11).trim();return{type:"urgency",operator:"is",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency above ")){const r=e.substring(14).trim();return{type:"urgency",operator:"above",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("urgency below ")){const r=e.substring(14).trim();return{type:"urgency",operator:"below",value:this.parseNumericValue(r,"urgency")}}if(e.startsWith("tag includes ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e.startsWith("tag does not include ")){const r=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(r),negate:!0}}if(e.startsWith("tags include ")){const r=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(r)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const r=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(r)}}if(e.startsWith("path does not include ")){const r=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(r),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};if(e.startsWith("description includes ")){const r=e.substring(21).trim();return{type:"description",operator:"includes",value:this.unquote(r)}}if(e.startsWith("description does not include ")){const r=e.substring(29).trim();return{type:"description",operator:"does not include",value:this.unquote(r)}}if(e.startsWith("description regex ")){const r=e.substring(18).trim();return{type:"description",operator:"regex",value:this.unquote(r)}}if(e.startsWith("heading includes ")){const r=e.substring(17).trim();return{type:"heading",operator:"includes",value:this.unquote(r)}}if(e.startsWith("heading does not include ")){const r=e.substring(25).trim();return{type:"heading",operator:"does not include",value:this.unquote(r)}}throw new Zt(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const r of t){if(e===`has ${r} date`)return{type:"date",operator:"has",value:{field:r}};if(e===`no ${r} date`)return{type:"date",operator:"has",value:{field:r},negate:!0};const n=["before","after","on","on or before","on or after"];for(const a of n){const o=`${r} ${a} `;if(e.startsWith(o)){const l=e.substring(o.length).trim(),c=kh.parse(l,this.referenceDate);if(!c.isValid||!c.date)throw new Zt(`Invalid date value: "${l}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:a,value:{field:r,date:c.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Zt(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Zt(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Zt(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return rt.TODO;case"IN_PROGRESS":return rt.IN_PROGRESS;case"DONE":return rt.DONE;case"CANCELLED":return rt.CANCELLED;case"NON_TASK":return rt.NON_TASK;default:throw new Zt(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}parseNumericValue(e,t){const r=Number(e);if(Number.isNaN(r))throw new Zt(`Invalid ${t} value: "${e}"`,this.line,this.column,`Use a numeric ${t} value (e.g., "${t} above 75")`);return r}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}parseAndFilter(e){const r=e.split(/\s+(and|AND)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(r.length===0)throw new Zt("Empty AND expression",this.line,this.column,"AND must have filters on both sides");if(r.length===1)return r[0];let n=r[0];for(let a=1;a<r.length;a++)n={type:"boolean",operator:"AND",value:null,left:n,right:r[a]};return n}parseOrFilter(e){const r=e.split(/\s+(or|OR)\s+/i).filter((a,o)=>o%2===0).map(a=>this.parseFilterInstruction(a.trim())).filter(a=>a!==null);if(r.length===0)throw new Zt("Empty OR expression",this.line,this.column,"OR must have filters on both sides");if(r.length===1)return r[0];let n=r[0];for(let a=1;a<r.length;a++)n={type:"boolean",operator:"OR",value:null,left:n,right:r[a]};return n}parseNotFilter(e){const t=e.replace(/^NOT\s+/i,"").trim();if(!t)throw new Zt("Empty NOT expression",this.line,this.column,"NOT must have a filter after it");const r=this.parseFilterInstruction(t);if(!r)throw new Zt("Invalid filter after NOT",this.line,this.column,"NOT must be followed by a valid filter");return{type:"boolean",operator:"NOT",value:null,inner:r}}}class lt{}const ns=class ns{constructor(){w(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return ns.instance||(ns.instance=new ns),ns.instance}addDefaultStatuses(){this.add(xr.TODO),this.add(xr.IN_PROGRESS),this.add(xr.DONE),this.add(xr.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}register(e){this.add(e)}unregister(e){this.statuses.delete(e)}get(e){const t=this.statuses.get(e);return t||new xr({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:xr.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}getAll(){return this.getAllStatuses()}reset(){this.statuses.clear(),this.addDefaultStatuses()}};w(ns,"instance",null);let vr=ns;class wh extends lt{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=vr.getInstance(),r=e.statusSymbol||" ",a=t.get(r).type===this.statusType;return this.negate?!a:a}}class Th extends lt{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=vr.getInstance(),r=e.statusSymbol||" ",a=t.get(r).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!a:a}}class Sh extends lt{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const r=(e.statusSymbol||" ")===this.symbol;return this.negate?!r:r}}class Dh extends lt{matches(e){const t=vr.getInstance(),r=e.statusSymbol||" ";return t.get(r).type===rt.DONE}}class Eh extends lt{matches(e){const t=vr.getInstance(),r=e.statusSymbol||" ";return t.get(r).type!==rt.DONE}}class xh extends lt{constructor(e,t,r){super(),this.field=e,this.comparator=t,this.targetDate=r}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const r=new Date(this.targetDate);r.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<r;case"after":return n>r;case"on":return n.getTime()===r.getTime();case"on or before":return n<=r;case"on or after":return n>=r;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class Ah extends lt{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const to={lowest:0,low:1,normal:2,medium:3,high:4,highest:5};function Ch(s){return Qs(s)??"normal"}function Ih(s){return s==="urgent"?"highest":s==="none"?"normal":s}class Oh extends lt{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=Ch(e.priority),r=to[t],n=to[Ih(this.level)];switch(this.operator){case"is":return r===n;case"above":return r>n;case"below":return r<n;default:return!1}}}class Mh extends lt{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],r=this.tag.toLowerCase(),n=t.some(a=>a.toLowerCase().includes(r));return this.negate?!n:n}}class Nh extends lt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class qh extends lt{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const r=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!r:r}}class Rh extends lt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const r=e.blockedBy&&e.blockedBy.length>0;return this.negate?!r:!!r}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Lh extends lt{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Fh extends lt{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class Ph extends lt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Bh extends lt{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class Uh extends lt{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class zh extends lt{constructor(e,t,r=!1){super(),this.operator=e,this.pattern=t,this.caseSensitive=r}matches(e){const t=e.name||"",r=e.description||"",n=`${t} ${r}`.trim();switch(this.operator){case"includes":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"does not include":{const a=this.caseSensitive?this.pattern:this.pattern.toLowerCase();return!(this.caseSensitive?n:n.toLowerCase()).includes(a)}case"regex":try{const a=this.caseSensitive?"":"i";return new RegExp(this.pattern,a).test(n)}catch{return!1}}}}class jh extends lt{constructor(e,t){super(),this.operator=e,this.pattern=t}matches(e){const r=(e.heading||"").toLowerCase().includes(this.pattern.toLowerCase());return this.operator==="includes"?r:!r}}class Yh extends lt{constructor(e,t,r,n){super(),this.comparator=e,this.threshold=t,this.referenceDate=r,this.settings=n}matches(e){const t=di(e,{now:this.referenceDate,settings:this.settings});switch(this.comparator){case"above":return t>this.threshold;case"below":return t<this.threshold;case"is":return t===this.threshold;default:return!1}}}class rs{group(e){const t=new Map;for(const r of e){const n=this.getGroupKey(r);this.addToGroup(t,n,r)}return t}addToGroup(e,t,r){e.has(t)||e.set(t,[]),e.get(t).push(r)}}class Hh extends rs{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const r=new Date(e.dueAt);r.setHours(0,0,0,0);const n=r.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Overdue":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Wh extends rs{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const r=new Date(e.scheduledAt);r.setHours(0,0,0,0);const n=r.getTime()-t.getTime(),a=Math.ceil(n/(1e3*60*60*24));return a<0?"Past":a===0?"Today":a===1?"Tomorrow":a<=7?"This Week":"Later"}}class Kh extends rs{getGroupKey(e){const t=vr.getInstance(),r=e.statusSymbol||" ";return t.get(r).type}}class Gh extends rs{getGroupKey(e){const t=vr.getInstance(),r=e.statusSymbol||" ";return t.get(r).name}}class Qh extends rs{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class $h extends rs{getGroupKey(e){return e.path||""||"No path"}}class Vh extends rs{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const r=t.lastIndexOf("/");return r===-1?"Root":t.substring(0,r)||"Root"}}class Xh extends rs{group(e){const t=new Map;for(const r of e){const n=r.tags||[];if(n.length===0)this.addToGroup(t,"No tags",r);else for(const a of n)this.addToGroup(t,a,r)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}function Cl(s){const e=[];if(s.filters.length>0){e.push("**Filters:**");for(const t of s.filters)e.push(`- ${Ms(t)}`)}else e.push("**Filters:** None (showing all tasks)");if(s.sort){const t=s.sort.reverse?"descending":"ascending";e.push(`
**Sort:** By ${s.sort.field} (${t})`)}return s.group&&e.push(`
**Group:** By ${s.group.field}`),s.limit!==void 0&&s.limit>0&&e.push(`
**Limit:** First ${s.limit} tasks`),e.join(`
`)}function Ms(s){const e=s.negate?"NOT ":"";switch(s.type){case"status":return`${e}Status ${s.operator} "${s.value}"`;case"date":return`${e}${s.value.field} ${s.value.comparator} ${s.value.date}`;case"priority":return`${e}Priority ${s.operator} ${s.value}`;case"urgency":return`${e}Urgency ${s.operator} ${s.value}`;case"tag":return s.operator==="includes"?`${e}Tag includes "${s.value}"`:s.operator==="has"?`${e}Has tags`:`${e}Tag ${s.operator} "${s.value}"`;case"path":return`${e}Path ${s.operator} "${s.value}"`;case"dependency":return s.value==="blocked"?`${e}Is blocked by another task`:s.value==="blocking"?`${e}Is blocking another task`:`${e}Dependency ${s.operator} ${s.value}`;case"recurrence":return`${e}Recurrence ${s.operator} ${s.value}`;case"boolean":return s.operator==="and"?`(${Ms(s.left)} AND ${Ms(s.right)})`:s.operator==="or"?`(${Ms(s.left)} OR ${Ms(s.right)})`:s.operator==="not"?`(NOT ${Ms(s.inner)})`:"Unknown boolean filter";case"done":return s.value?`${e}Done`:`${e}Not done`;case"description":return`${e}Description ${s.operator} "${s.value}"`;default:return`${e}Unknown filter`}}class Il{constructor(e,t={}){w(this,"dependencyGraph",null);w(this,"globalFilterAST",null);w(this,"urgencySettings");this.taskIndex=e,this.urgencySettings=t.urgencySettings??ui}setDependencyGraph(e){this.dependencyGraph=e}setGlobalFilter(e){if(!e){this.globalFilterAST=null;return}try{const t=new Jr;this.globalFilterAST=t.parse(e)}catch(t){console.error("Failed to parse global filter:",t),this.globalFilterAST=null}}execute(e){const t=performance.now(),r=new Date;try{const n=e.explain?this.generateExplanation(e):void 0;let a=this.taskIndex.getAllTasks();const o=a.length;this.globalFilterAST&&this.globalFilterAST.filters.length>0&&(a=this.applyFilters(a,this.globalFilterAST.filters,r)),e.filters.length>0&&(a=this.applyFilters(a,e.filters,r)),e.sort&&(a=this.applySort(a,e.sort,r)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let l;e.group&&(l=this.applyGrouping(a,e.group));const u=performance.now()-t;return{tasks:a,groups:l,totalCount:o,executionTimeMs:u,explanation:n}}catch(n){throw new Is(`Failed to execute query: ${n instanceof Error?n.message:String(n)}`,n instanceof Error?n:void 0)}}executeString(e){const r=new Jr().parse(e);return this.execute(r)}validateQuery(e){try{return{valid:!0,parsedFilters:new Jr().parse(e).filters.map(n=>`${n.type}:${n.operator}`)}}catch(t){return{valid:!1,error:t instanceof Error?t.message:String(t)}}}applyFilters(e,t,r){let n=e;for(const a of t){const o=this.createFilter(a,r);n=n.filter(l=>o.matches(l))}return n}createFilter(e,t){switch(e.type){case"done":return e.value?new Dh:new Eh;case"status":if(e.operator==="type-is")return new wh(e.value,e.negate);if(e.operator==="name-includes")return new Th(e.value,e.negate);if(e.operator==="symbol-is")return new Sh(e.value,e.negate);throw new Is(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new Ah(e.value.field,e.negate):new xh(e.value.field,e.operator,e.value.date);case"priority":return new Oh(e.operator,e.value);case"urgency":return new Yh(e.operator,e.value,t,this.urgencySettings);case"tag":return e.operator==="has"?new Nh(!e.value):new Mh(e.value,e.negate);case"path":return new qh(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new Rh(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Lh(this.dependencyGraph,!e.value);throw new Is(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Fh(!e.value);case"description":return new zh(e.operator,e.value,e.negate);case"heading":return new jh(e.operator,e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new Ph(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="OR"&&e.left&&e.right)return new Bh(this.createFilter(e.left,t),this.createFilter(e.right,t));if(e.operator==="NOT"&&e.inner)return new Uh(this.createFilter(e.inner,t));throw new Is(`Invalid boolean operator: ${e.operator}`);default:throw new Is(`Unknown filter type: ${e.type}`)}}applySort(e,t,r){const n=[...e];return n.sort((a,o)=>{let l=0;switch(t.field){case"due":l=this.compareDates(a.dueAt,o.dueAt);break;case"scheduled":l=this.compareDates(a.scheduledAt,o.scheduledAt);break;case"start":l=this.compareDates(a.startAt,o.startAt);break;case"created":l=this.compareDates(a.createdAt,o.createdAt);break;case"done":l=this.compareDates(a.doneAt,o.doneAt);break;case"priority":l=this.comparePriorities(a.priority,o.priority);break;case"urgency":l=this.getUrgencyScore(o,r)-this.getUrgencyScore(a,r);break;case"status.type":l=this.compareStatusTypes(a,o);break;case"description":l=(a.description||"").localeCompare(o.description||"");break;case"heading":l=(a.heading||"").localeCompare(o.heading||"");break;case"path":l=(a.path||"").localeCompare(o.path||"");break;default:l=a.name.localeCompare(o.name)}return t.reverse?-l:l}),n}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const r={lowest:0,low:1,normal:2,medium:3,high:4,highest:5},n=r[Qs(e)||"normal"]||2,a=r[Qs(t)||"normal"]||2;return n-a}compareStatusTypes(e,t){const r=n=>{const a=n.statusSymbol||" ";return a===" "?0:a==="/"?1:a==="x"?2:a==="-"?3:0};return r(e)-r(t)}getUrgencyScore(e,t){return di(e,{now:t,settings:this.urgencySettings})}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new Hh;case"scheduled":return new Wh;case"status.type":return new Kh;case"status.name":return new Gh;case"priority":return new Qh;case"path":return new $h;case"folder":return new Vh;case"tags":return new Xh;default:throw new Is(`Unknown grouping field: ${e}`)}}generateExplanation(e){return Cl(e)}}class Ol{constructor(e){w(this,"parser");this.parser=e??new Jr}compose(e,t){const{query:r,ignoreGlobal:n}=this.stripIgnoreDirective(e),a=this.parser.parse(r);return!n&&t&&t.filters.length>0?{ast:{...a,filters:[...t.filters,...a.filters]},ignoredGlobal:!1}:{ast:a,ignoredGlobal:n}}stripIgnoreDirective(e){const t=e.split(`
`),r=[];let n=!1;for(const a of t){if(/^ignore global query$/i.test(a.trim())){n=!0;continue}r.push(a)}return{query:r.join(`
`),ignoreGlobal:n}}}const Un={enabled:!1,query:""},as=class as{constructor(e=Un){w(this,"config");w(this,"ast",null);w(this,"error",null);this.config=e,this.parse()}static getInstance(){return as.instance||(as.instance=new as),as.instance}initialize(e){this.config=e,this.parse()}updateConfig(e){this.config=e,this.parse()}getConfig(){return this.config}isEnabled(){return this.config.enabled&&this.config.query.trim().length>0}getAST(){return this.ast}getError(){return this.error}parse(){if(!this.isEnabled()){this.ast=null,this.error=null;return}try{const e=new Jr;this.ast=e.parse(this.config.query),this.error=null}catch(e){this.ast=null,this.error=e instanceof Error?e.message:String(e)}}};w(as,"instance",null);let $s=as;var Zh=A('<button class="search-tab__btn svelte-1yjlv38"> </button>'),Jh=A('<div class="search-tab__error svelte-1yjlv38"> </div>'),ef=A('<div class="search-tab__stats svelte-1yjlv38"> </div>'),tf=A('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),rf=A('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),sf=A('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),nf=A('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">🔍 No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),af=A('<div class="search-tab__card-wrapper svelte-1yjlv38" role="listitem"><!></div>'),of=A(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38" role="list" aria-label="Search results"><!></div></div>`);function lf(s,e){Je(e,!0);let t=W(""),r=W(ke([])),n=W(""),a=W(0),o=W(ke([])),l=W(!1),c=W(!1);const u=["not done","priority is high","due before tomorrow","not done AND priority above medium","is blocked","description includes meeting","tag includes #work","is recurring","priority is high OR priority is medium","NOT is blocked","not done AND priority is high AND description includes priority","sort by priority","sort by urgency","urgency above 80","group by priority"],h={getAllTasks:()=>e.tasks},p=qo(fi),v=new Il(h,{urgencySettings:p}),y=new Ol(new Jr);function k(){if(!i(t).trim()){b(r,[],!0),b(n,"");return}b(c,!0),b(n,"");try{const F=$s.getInstance();if(F.isEnabled()&&F.getError())throw new Error(`Global query error: ${F.getError()}`);const T=y.compose(i(t),F.getAST()).ast,q=v.execute(T);if(b(r,q.tasks,!0),b(a,q.executionTimeMs,!0),!i(o).includes(i(t))){b(o,[i(t),...i(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(i(o)))}catch{}}}catch(F){b(n,F instanceof Error?F.message:String(F),!0),b(r,[],!0),Q.error(`Query error: ${i(n)}`)}finally{b(c,!1)}}function m(){try{const F=localStorage.getItem("query-history");F&&b(o,JSON.parse(F),!0)}catch{}}function g(F){b(t,F,!0),k()}function _(F){b(t,F,!0),b(l,!1),k()}function D(){b(o,[],!0);try{localStorage.removeItem("query-history")}catch{}b(l,!1)}function E(F){F.key==="Enter"&&!F.shiftKey&&(F.preventDefault(),k())}yt(()=>{m()});let x=W(0),R=ke([]);yt(()=>{i(x)>=i(r).length&&b(x,Math.max(0,i(r).length-1),!0)});function U(F,T){F.key==="ArrowDown"?(F.preventDefault(),b(x,Math.min(i(x)+1,i(r).length-1),!0)):F.key==="ArrowUp"?(F.preventDefault(),b(x,Math.max(i(x)-1,0),!0)):F.key==="Enter"&&e.onEdit?(F.preventDefault(),e.onEdit(i(r)[T])):F.key===" "&&e.onDone&&(F.preventDefault(),e.onDone(i(r)[T]))}var N=of(),K=f(d(N),2),Y=d(K),J=d(Y);J.__keydown=E;var se=f(J,2),te=d(se);te.__click=k;var le=d(te),ye=f(te,2);{var H=F=>{var T=Zh();T.__click=()=>b(l,!i(l));var q=d(T);j(()=>P(q,`History (${i(o).length??""})`)),S(F,T)};G(ye,F=>{i(o).length>0&&F(H)})}var L=f(Y,2);{var C=F=>{var T=Jh(),q=d(T);j(()=>P(q,`⚠️ ${i(n)??""}`)),S(F,T)};G(L,F=>{i(n)&&F(C)})}var z=f(L,2);{var re=F=>{var T=ef(),q=d(T);j(Z=>P(q,`Found ${i(r).length??""} task${i(r).length!==1?"s":""} in ${Z??""}ms`),[()=>i(a).toFixed(2)]),S(F,T)};G(z,F=>{i(a)>0&&!i(n)&&F(re)})}var X=f(K,2);{var me=F=>{var T=rf(),q=d(T),Z=f(d(q),2);Z.__click=D;var ne=f(q,2);Fe(ne,21,()=>i(o),nt,(I,M)=>{var ie=tf(),Ae=d(ie);Ae.__click=()=>_(i(M));var Ie=d(Ae);j(()=>P(Ie,i(M))),S(I,ie)}),S(F,T)};G(X,F=>{i(l)&&i(o).length>0&&F(me)})}var ve=f(X,2),he=f(d(ve),2);Fe(he,21,()=>u,nt,(F,T)=>{var q=sf();q.__click=()=>g(i(T));var Z=d(q),ne=d(Z);j(()=>P(ne,i(T))),S(F,q)});var Te=f(ve,2),_e=d(Te);{var qe=F=>{var T=nf();S(F,T)},fe=F=>{var T=st(),q=Ge(T);{var Z=ne=>{var I=st(),M=Ge(I);Fe(M,19,()=>i(r),ie=>ie.id,(ie,Ae,Ie)=>{var Ce=af();Ce.__keydown=Pe=>U(Pe,i(Ie));var Ye=d(Ce);Js(Ye,{get task(){return i(Ae)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),fr(Ce,(Pe,ct)=>R[ct]=Pe,Pe=>R==null?void 0:R[Pe],()=>[i(Ie)]),j(()=>Ee(Ce,"tabindex",i(Ie)===i(x)?0:-1)),St("focus",Ce,()=>b(x,i(Ie),!0)),S(ie,Ce)}),S(ne,I)};G(q,ne=>{i(r).length>0&&ne(Z)},!0)}S(F,T)};G(_e,F=>{i(r).length===0&&i(t).trim()&&!i(n)?F(qe):F(fe,!1)})}j(()=>{te.disabled=i(c),P(le,i(c)?"Searching...":"Search")}),at(J,()=>i(t),F=>b(t,F)),S(s,N),et()}ft(["keydown","click"]);class Na{static parse(e){const t=e,r=e.trim().toLowerCase().replace(/\s+/g," ");if(!r)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=r.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};let a=n[1],o;const l=a.match(/^(.+?)\s+when\s+done$/),c=a.match(/^(.+?)\s+when\s+due$/);if(l?(a=l[1],o=!0):c&&(a=c[1],o=!1),a==="weekday"||a==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4],whenDone:o},raw:t,isValid:!0};if(a==="weekend"||a==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6],whenDone:o},raw:t,isValid:!0};const u=this.parseOrdinalWeekdayPattern(a);if(u.matched)return u.error||u.ordinal===void 0||u.weekday===void 0?{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:u.error||"Invalid ordinal weekday pattern"}:{frequency:{type:"monthly",interval:1,dayOfMonth:1,whenDone:o,rruleString:this.buildOrdinalRRuleString(u.weekday,u.ordinal),naturalLanguage:t},raw:t,isValid:!0};const h=a.match(/^(\d+\s+)?days?$/);if(h)return{frequency:{type:"daily",interval:h[1]?parseInt(h[1]):1,whenDone:o},raw:t,isValid:!0};const p=a.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(p){const k=p[1]?parseInt(p[1]):1,m=p[2];if(!m)return{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:o},raw:t,isValid:!0};const g=this.parseDayNames(m);return g.length===0?{frequency:{type:"weekly",interval:k,weekdays:[1],whenDone:o},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:k,weekdays:g,whenDone:o},raw:t,isValid:!0}}const v=a.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(v){const k=v[1]?parseInt(v[1]):1,m=v[2]?parseInt(v[2]):1;return m<1||m>31?{frequency:{type:"monthly",interval:k,dayOfMonth:1,whenDone:o},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:k,dayOfMonth:m,whenDone:o},raw:t,isValid:!0}}const y=a.match(/^(\d+\s+)?years?$/);return y?{frequency:{type:"yearly",interval:y[1]?parseInt(y[1]):1,month:0,dayOfMonth:1,whenDone:o},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1,whenDone:o},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=this.stringifyOrdinalWeekday(e.rruleString);if(t)return e.whenDone?`${t} when done`:t;const r=e.interval;let n;switch(e.type){case"daily":n=r===1?"every day":`every ${r} days`;break;case"weekly":{const a=r===1?"week":`${r} weeks`;if(e.weekdays.length===0)n=`every ${a}`;else{const o=e.weekdays.map(l=>this.getDayName(l)).join(", ");n=`every ${a} on ${o}`}break}case"monthly":{const a=r===1?"month":`${r} months`,o=this.getDaySuffix(e.dayOfMonth);n=`every ${a} on the ${e.dayOfMonth}${o}`;break}case"yearly":{n=`every ${r===1?"year":`${r} years`}`;break}default:n="every day"}return e.whenDone?`${n} when done`:n}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},r=e.split(",").map(a=>a.trim().toLowerCase()),n=[];for(const a of r)a in t&&n.push(t[a]);return n}static parseOrdinalWeekdayPattern(e){const t=e.split(" ");if(t.length<2)return{matched:!1};const r=this.parseOrdinalToken(t[0]);if(!r.matched)return{matched:!1};if(r.error)return{matched:!0,error:r.error};const n=this.parseSingleDay(t[1]);return n===null?{matched:!0,error:"Invalid weekday name"}:t.length===2?{matched:!0,ordinal:r.value,weekday:n}:t.length===5&&t[2]==="of"&&t[3]==="the"&&t[4]==="month"?{matched:!0,ordinal:r.value,weekday:n}:{matched:!0,error:"Ordinal weekday pattern must be 'every <ordinal> <weekday>' optionally followed by 'of the month'"}}static parseOrdinalToken(e){const t={first:1,second:2,third:3,fourth:4,last:-1};if(e in t)return{matched:!0,value:t[e]};const r=e.match(/^(\d+)(st|nd|rd|th)$/);if(!r)return{matched:!1};const n=parseInt(r[1],10);return n>=1&&n<=4?{matched:!0,value:n}:{matched:!0,error:"Ordinal weekday must be first, second, third, fourth, or last"}}static parseSingleDay(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6};return e in t?t[e]:null}static stringifyOrdinalWeekday(e){if(!e)return null;const t=this.parseRRuleString(e);if(!t||t.FREQ!=="MONTHLY"||!t.BYDAY||!t.BYSETPOS)return null;const r=this.fromRRuleWeekday(t.BYDAY);if(r===null)return null;const n=Number.parseInt(t.BYSETPOS,10);if(!Number.isFinite(n))return null;const a=this.ordinalWord(n);return a?`every ${a} ${this.getDayName(r)}`:null}static ordinalWord(e){switch(e){case 1:return"first";case 2:return"second";case 3:return"third";case 4:return"fourth";case-1:return"last";default:return null}}static buildOrdinalRRuleString(e,t){return`RRULE:FREQ=MONTHLY;BYDAY=${this.toRRuleWeekday(e)};BYSETPOS=${t}`}static toRRuleWeekday(e){return["MO","TU","WE","TH","FR","SA","SU"][e]||"MO"}static fromRRuleWeekday(e){const r=["MO","TU","WE","TH","FR","SA","SU"].indexOf(e);return r>=0?r:null}static parseRRuleString(e){const t=e.trim().toUpperCase(),r=t.startsWith("RRULE:")?t.slice(6):t;if(!r)return null;const n=r.split(";"),a={};for(const o of n){if(!o)continue;const[l,c]=o.split("=");if(!l||!c)return null;a[l]=c}return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var cf=A('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),uf=A('<div class="priority-selector svelte-1w15n9q"></div>');function df(s,e){Je(e,!0);let t=Rr(e,"value",15,"normal");const r=[{value:"highest",label:"Highest",emoji:"🔺",color:"var(--b3-theme-error, #ef4444)"},{value:"high",label:"High",emoji:"⏫",color:"#f97316"},{value:"medium",label:"Medium",emoji:"🔼",color:"#f59e0b"},{value:"normal",label:"Normal",emoji:"🟡",color:"#eab308"},{value:"low",label:"Low",emoji:"🔽",color:"#22c55e"},{value:"lowest",label:"Lowest",emoji:"⏬",color:"#64748b"}];function n(o){t(o),e.onchange(o)}var a=uf();Fe(a,21,()=>r,nt,(o,l)=>{var c=cf();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),y=f(p,2),k=d(y);j(()=>{u=We(c,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===i(l).value}),bs(c,`--priority-color: ${i(l).color??""}`),oi(h,i(l).value),Fs(h,t()===i(l).value),P(v,i(l).emoji),P(k,i(l).label)}),S(o,c)}),S(s,a),et()}ft(["change"]);var hf=A('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),ff=A('<div class="status-selector svelte-v9ezc0"></div>');function vf(s,e){Je(e,!0);let t=Rr(e,"value",15,"todo");const r=[{value:"todo",label:"Todo",icon:"○",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"✓",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"✕",color:"#999"}];function n(o){t(o),e.onchange(o)}var a=ff();Fe(a,21,()=>r,nt,(o,l)=>{var c=hf();let u;var h=d(c);h.__change=()=>n(i(l).value);var p=f(h,2),v=d(p),y=f(p,2),k=d(y);j(()=>{u=We(c,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===i(l).value}),bs(c,`--status-color: ${i(l).color??""}`),oi(h,i(l).value),Fs(h,t()===i(l).value),P(v,i(l).icon),P(k,i(l).label)}),S(o,c)}),S(s,a),et()}ft(["change"]);var pf=A('<div class="recurrence-input__valid svelte-787fjp">✓ Valid recurrence pattern</div>'),yf=A('<div class="recurrence-input__error svelte-787fjp"> </div>'),mf=A('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),gf=A('<li class="svelte-787fjp"> </li>'),bf=A('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),_f=A('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function kf(s,e){Je(e,!0);let t=Rr(e,"value",15,""),r=Rr(e,"showPreview",3,!0);const n=V(()=>Na.parse(t())),a=V(()=>i(n).isValid),o=V(()=>i(n).error);function l(_,D=3){const E=[],x=new Date;for(let R=0;R<D;R++){const U=new Date(x);switch(_.type){case"daily":U.setDate(x.getDate()+R*_.interval);break;case"weekly":U.setDate(x.getDate()+R*_.interval*7);break;case"monthly":U.setMonth(x.getMonth()+R*_.interval);break;case"yearly":U.setFullYear(x.getFullYear()+R*_.interval);break}E.push(U.toLocaleDateString())}return E}const c=V(()=>i(a)&&r()?l(i(n).frequency):[]);function u(_){const E=_.target.value;t(E);const x=Na.parse(E);e.onchange(E,x.isValid?x.frequency:null,x.isValid)}var h=_f(),p=d(h);let v;p.__input=u;var y=f(p,2);{var k=_=>{var D=mf(),E=d(D);{var x=U=>{var N=pf();S(U,N)},R=U=>{var N=yf(),K=d(N);j(()=>P(K,`⚠ ${(i(o)||"Invalid recurrence pattern")??""}`)),S(U,N)};G(E,U=>{i(a)?U(x):U(R,!1)})}S(_,D)};G(y,_=>{t().length>0&&_(k)})}var m=f(y,2);{var g=_=>{var D=bf(),E=f(d(D),2);Fe(E,21,()=>i(c),nt,(x,R)=>{var U=gf(),N=d(U);j(()=>P(N,i(R))),S(x,U)}),S(_,D)};G(m,_=>{i(a)&&r()&&i(c).length>0&&_(g)})}j(()=>{v=We(p,1,"recurrence-input__field svelte-787fjp",null,v,{valid:i(a),invalid:!i(a)&&t().length>0}),Ee(p,"aria-invalid",!i(a)&&t().length>0)}),at(p,t),S(s,h),et()}ft(["input"]);var wf=A('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">✕</button></div>'),Tf=A('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),Sf=A('<span class="dependency-picker__option-check svelte-10ls0lk">✓</span>'),Df=A('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),Ef=A('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),xf=A('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function ro(s,e){Je(e,!0);let t=Rr(e,"selected",31,()=>ke([])),r=Rr(e,"label",3,"Select tasks"),n=W(""),a=W(!1);const o=V(()=>e.repository.getAllTasks().filter(U=>U.id!==e.excludeId)),l=V(()=>i(n).trim()?i(o).filter(U=>U.name.toLowerCase().includes(i(n).toLowerCase())):i(o)),c=V(()=>i(o).filter(U=>t().includes(U.id)));function u(U){if(!t().includes(U)){const N=[...t(),U];t(N),e.onchange(N)}b(n,""),b(a,!1)}function h(U){const N=t().filter(K=>K!==U);t(N),e.onchange(N)}function p(){b(a,!0)}function v(){setTimeout(()=>{b(a,!1)},200)}var y=xf(),k=d(y),m=d(k),g=f(k,2);{var _=U=>{var N=Tf();Fe(N,21,()=>i(c),K=>K.id,(K,Y)=>{var J=wf(),se=d(J),te=d(se),le=f(se,2);le.__click=()=>h(i(Y).id),j(()=>{P(te,i(Y).name),Ee(le,"aria-label",`Remove ${i(Y).name??""}`)}),S(K,J)}),S(U,N)};G(g,U=>{i(c).length>0&&U(_)})}var D=f(g,2),E=d(D),x=f(E,2);{var R=U=>{var N=Ef();Fe(N,21,()=>i(l).slice(0,10),K=>K.id,(K,Y)=>{var J=Df();let se;J.__click=()=>u(i(Y).id);var te=d(J),le=d(te),ye=f(te,2);{var H=L=>{var C=Sf();S(L,C)};G(ye,L=>{t().includes(i(Y).id)&&L(H)})}j((L,C)=>{se=We(J,1,"dependency-picker__option svelte-10ls0lk",null,se,L),J.disabled=C,P(le,i(Y).name)},[()=>({selected:t().includes(i(Y).id)}),()=>t().includes(i(Y).id)]),S(K,J)}),S(U,N)};G(x,U=>{i(a)&&i(l).length>0&&U(R)})}j(()=>P(m,r())),St("focus",E,p),St("blur",E,v),at(E,()=>i(n),U=>b(n,U)),S(s,y),et()}ft(["click"]);var Af=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Cf=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),If=A('<div class="task-editor__error svelte-xc3qs9"> </div>'),Of=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Mf=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Nf=A('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),qf=A('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">✕</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">💡 Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">⌘/Ctrl+Enter</kbd> to save</div></div></div>');function Ml(s,e){var Ue,Ze,ut,dt,qt,Vt,xt,or,Yt,lr,zr,Ht;Je(e,!0);const t="every day",r="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",a=!e.task;let o=W(ke(((Ue=e.task)==null?void 0:Ue.name)||"")),l=W(ke(((Ze=e.task)==null?void 0:Ze.description)||"")),c=W(ke(((ut=e.task)==null?void 0:ut.priority)||"normal")),u=W(ke(((dt=e.task)==null?void 0:dt.status)||"todo")),h=W(ke((qt=e.task)!=null&&qt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),p=W(ke((Vt=e.task)!=null&&Vt.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),v=W(ke((xt=e.task)!=null&&xt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),y=W(ke(((or=e.task)==null?void 0:or.recurrenceText)||((Yt=e.task)!=null&&Yt.frequency?Na.stringify(e.task.frequency):t))),k=W(ke(((lr=e.task)==null?void 0:lr.frequency)||null)),m=W(!0),g=W(ke(((zr=e.task)==null?void 0:zr.blockedBy)||[])),_=W(ke(((Ht=e.task)==null?void 0:Ht.dependsOn)||[])),D=W(ke({name:!1,dueAt:!1,recurrence:!1})),E=W(!1),x=W(null);const R=V(()=>i(D).name&&!i(o).trim()?"Task name is required":""),U=V(()=>i(D).dueAt?i(h)?Number.isNaN(new Date(i(h)).getTime())?"Invalid due date":"":"Due date is required":""),N=V(()=>i(D).recurrence&&!i(m)?"Invalid recurrence pattern":""),K=V(()=>!!(i(R)||i(U)||i(N)));Tn(()=>{requestAnimationFrame(()=>{var B;(B=i(x))==null||B.focus()})});function Y(B,ue,it){b(y,B,!0),b(k,ue,!0),b(m,it,!0),i(D).recurrence=!0}function J(B){b(c,B,!0)}function se(B){b(u,B,!0)}function te(B){b(g,B,!0)}function le(B){b(_,B,!0)}async function ye(){if(b(D,{name:!0,dueAt:!0,recurrence:!0},!0),i(K)){Q.warning("Please fix validation errors");return}if(!i(k)){Q.error("Invalid recurrence pattern");return}b(E,!0);try{let B;a?B=Tl(i(o).trim(),i(k),new Date(i(h))):(B={...e.task},B.name=i(o).trim(),B.frequency=i(k),B.dueAt=new Date(i(h)).toISOString()),B.description=i(l).trim()||void 0,B.priority=i(c),B.status=i(u),B.recurrenceText=i(y),B.scheduledAt=i(p)?new Date(i(p)).toISOString():void 0,B.startAt=i(v)?new Date(i(v)).toISOString():void 0,B.blockedBy=i(g).length>0?i(g):void 0,B.dependsOn=i(_).length>0?i(_):void 0,B.updatedAt=new Date().toISOString(),i(u)==="done"&&!B.lastCompletedAt&&(B.lastCompletedAt=new Date().toISOString()),i(u)==="cancelled"&&!B.cancelledAt&&(B.cancelledAt=new Date().toISOString()),await e.repository.saveTask(B),e.onSave&&e.onSave(B),Q.success(`Task "${B.name}" ${a?"created":"updated"}`),ze.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(B){Q.error(`Failed to save task: ${B}`)}finally{b(E,!1)}}function H(B){B.key==="Escape"&&e.onClose(),(B.metaKey||B.ctrlKey)&&B.key==="Enter"&&(B.preventDefault(),ye())}function L(B){return B?new Date(B).toLocaleString():"—"}var C=qf();C.__keydown=H;var z=d(C),re=d(z),X=d(re),me=d(X),ve=f(X,2);ve.__click=function(...B){var ue;(ue=e.onClose)==null||ue.apply(this,B)};var he=f(re,2),Te=d(he),_e=f(d(Te),2);_e.__input=()=>i(D).name=!0,fr(_e,B=>b(x,B),()=>i(x));var qe=f(_e,2);{var fe=B=>{var ue=Af(),it=d(ue);j(()=>P(it,i(R))),S(B,ue)};G(qe,B=>{i(R)&&B(fe)})}var F=f(Te,2),T=f(d(F),2),q=f(F,2),Z=f(d(q),2);df(Z,{get value(){return i(c)},onchange:J});var ne=f(q,2),I=f(d(ne),2);vf(I,{get value(){return i(u)},onchange:se});var M=f(ne,2),ie=f(d(M),2);ie.__input=()=>i(D).dueAt=!0;var Ae=f(ie,2);{var Ie=B=>{var ue=Cf(),it=d(ue);j(()=>P(it,i(U))),S(B,ue)};G(Ae,B=>{i(U)&&B(Ie)})}var Ce=f(M,2),Ye=f(d(Ce),2),Pe=f(Ce,2),ct=f(d(Pe),2),bt=f(Pe,2),$e=f(d(bt),2);kf($e,{get value(){return i(y)},onchange:Y,showPreview:!0});var Et=f($e,2);{var vt=B=>{var ue=If(),it=d(ue);j(()=>P(it,i(N))),S(B,ue)};G(Et,B=>{i(N)&&B(vt)})}var Oe=f(bt,2),_t=d(Oe);{let B=V(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});ro(_t,{get repository(){return e.repository},get selected(){return i(g)},get excludeId(){return i(B)},onchange:te,label:r})}var He=f(Oe,2),Ve=d(He);{let B=V(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});ro(Ve,{get repository(){return e.repository},get selected(){return i(_)},get excludeId(){return i(B)},onchange:le,label:n})}var Xe=f(He,2),Mt=d(Xe),Nt=f(d(Mt),2),jt=d(Nt),ae=f(Mt,2);{var oe=B=>{var ue=Of(),it=f(d(ue),2),Dr=d(it);j(Xt=>P(Dr,Xt),[()=>L(e.task.lastCompletedAt)]),S(B,ue)};G(ae,B=>{var ue;(ue=e.task)!=null&&ue.lastCompletedAt&&B(oe)})}var we=f(ae,2);{var tt=B=>{var ue=Mf(),it=f(d(ue),2),Dr=d(it);j(Xt=>P(Dr,Xt),[()=>L(e.task.cancelledAt)]),S(B,ue)};G(we,B=>{var ue;(ue=e.task)!=null&&ue.cancelledAt&&B(tt)})}var pr=f(we,2);{var ee=B=>{var ue=Nf(),it=f(d(ue),2),Dr=d(it);j(()=>P(Dr,e.task.linkedBlockId)),S(B,ue)};G(pr,B=>{var ue;(ue=e.task)!=null&&ue.linkedBlockId&&B(ee)})}var ge=f(he,2),Be=d(ge);Be.__click=function(...B){var ue;(ue=e.onClose)==null||ue.apply(this,B)};var ce=f(Be,2);ce.__click=ye;var Se=d(ce);j(B=>{P(me,a?"Create Task":"Edit Task"),Ee(_e,"aria-invalid",!!i(R)),Ee(ie,"aria-invalid",!!i(U)),P(jt,B),ce.disabled=i(E),P(Se,i(E)?"Saving...":a?"Create Task":"Save Changes")},[()=>{var B;return L((B=e.task)==null?void 0:B.createdAt)}]),St("blur",_e,()=>i(D).name=!0),at(_e,()=>i(o),B=>b(o,B)),at(T,()=>i(l),B=>b(l,B)),St("blur",ie,()=>i(D).dueAt=!0),at(ie,()=>i(h),B=>b(h,B)),at(Ye,()=>i(p),B=>b(p,B)),at(ct,()=>i(v),B=>b(v,B)),S(s,C),et()}ft(["keydown","click","input"]);class Rf{constructor(e){w(this,"config");w(this,"compiledExcludeFolders",[]);w(this,"compiledExcludeNotebooks",[]);w(this,"compiledExcludeTags",[]);w(this,"compiledExcludeFilePatterns",[]);w(this,"statusRegistry",vr.getInstance());this.config=e,this.compileExclusions()}evaluate(e,t){if(!this.config.enabled)return!0;if(!this.passesExclusions(e,t))return!1;if(this.config.mode==="all")return!0;const r=this.config.rules.filter(l=>l.enabled);if(r.length===0)return!0;const n=r.map(l=>this.evaluateRule(l,e,t)),a=n.every(l=>l),o=n.some(l=>l);return this.config.mode==="include"?a:!o}updateConfig(e){this.config=e,this.compileExclusions()}getConfig(){return this.config}evaluateRule(e,t,r){switch(e.type){case"tag":const n=this.extractTags(t),a=e.pattern.replace(/\*/g,".*"),o=new RegExp(`^${a}$`);return n.some(c=>o.test(c));case"regex":try{const c=e.pattern.match(/^\/(.+)\/([gimsuy]*)$/);let u;return c?u=new RegExp(c[1],c[2]):u=new RegExp(e.pattern),u.test(t)}catch{return!1}case"path":return r?this.normalizePath(r).includes(e.pattern):!1;case"marker":return t.includes(e.pattern);default:return!1}}evaluateTask(e){if(!this.config.enabled)return!0;const t=e.linkedBlockContent??e.name??"",r=e.path;if(!this.passesExclusions(t,r,e.statusSymbol,e.tags))return!1;if(this.config.mode==="all")return!0;const n=this.config.rules.filter(c=>c.enabled);if(n.length===0)return!0;const a=n.map(c=>this.evaluateRule(c,t,r)),o=a.every(c=>c),l=a.some(c=>c);return this.config.mode==="include"?o:!l}extractTags(e){return e.match(/#[\w/-]+/g)||[]}passesExclusions(e,t,r,n){const a=t?this.normalizePath(t):void 0,o=n??this.extractTags(e);if(a&&(this.compiledExcludeFolders.some(l=>l.test(a))||this.compiledExcludeNotebooks.some(l=>l.test(a))||this.compiledExcludeFilePatterns.some(l=>l.test(a)))||o.length>0&&this.compiledExcludeTags.length>0&&o.some(l=>this.compiledExcludeTags.some(c=>c.test(l))))return!1;if(this.config.excludeStatusTypes.length>0){const l=this.resolveStatusType(r,e);if(l&&this.config.excludeStatusTypes.includes(l))return!1}return!0}resolveStatusType(e,t){const r=e??this.extractStatusSymbol(t??"");return r?this.statusRegistry.get(r).type:null}extractStatusSymbol(e){const t=e.match(/^\s*-\s*\[(.)\]/);return t?t[1]:null}compileExclusions(){this.compiledExcludeFolders=this.config.excludeFolders.map(e=>this.compilePathPattern(e)),this.compiledExcludeNotebooks=this.config.excludeNotebooks.map(e=>this.compilePathPattern(e)),this.compiledExcludeFilePatterns=this.config.excludeFilePatterns.map(e=>this.compilePathPattern(e)),this.compiledExcludeTags=this.config.excludeTags.map(e=>this.compileTagPattern(e))}compileTagPattern(e){const t=e.trim();if(!t)return/^$/;const r=t.replace(/\*/g,".*");return new RegExp(`^${r}$`,"i")}compilePathPattern(e){const t=e.trim();if(!t)return/^$/;const r=t.match(/^\/(.+)\/([gimsuy]*)$/);if(r)try{return new RegExp(r[1],r[2])}catch{return/^$/}return this.globToRegExp(t)}globToRegExp(e){let r=this.normalizePath(e).replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*\*/g,"::DOUBLE_STAR::").replace(/\*/g,"[^/]*").replace(/::DOUBLE_STAR::/g,".*");return r.startsWith(".*")||(r=`.*${r}`),new RegExp(r)}normalizePath(e){return e.replace(/\\/g,"/")}}const pn={enabled:!1,mode:"all",rules:[],excludeFolders:[],excludeNotebooks:[],excludeTags:[],excludeFilePatterns:[],excludeStatusTypes:[]},is=class is{constructor(){w(this,"engine");this.engine=new Rf(pn)}static getInstance(){return is.instance||(is.instance=new is),is.instance}initialize(e){this.engine.updateConfig(e)}shouldTreatAsTask(e,t){return this.engine.evaluate(e,t)}shouldIncludeTask(e){return this.engine.evaluateTask(e)}getConfig(){return this.engine.getConfig()}updateConfig(e){this.engine.updateConfig(e)}reset(){this.engine.updateConfig(pn)}};w(is,"instance",null);let zn=is;var Lf=A("<span> </span>"),Ff=A("<span>Preview unavailable</span>"),Pf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Bf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),Uf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),zf=A('<button class="pill svelte-b8rwae" type="button"> </button>'),jf=A('<label class="status-toggle svelte-b8rwae"><input type="checkbox"/> <span> </span></label>'),Yf=A("<div> </div>"),Hf=A('<pre class="query-explanation svelte-b8rwae"> </pre>'),Wf=A('<div class="global-filter-settings svelte-b8rwae"><h3 class="settings__section-title svelte-b8rwae">Global Filtering &amp; Query</h3> <p class="description svelte-b8rwae">Apply a hard exclusion filter before indexing, plus a default query fragment applied to every query.</p> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Filter (Hard Exclusions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Filter</span></label></div> <div class="preview svelte-b8rwae"><!></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Folders</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/archive/**"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Notebooks</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="Personal"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Tags</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="#log"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude File Patterns (glob or /regex/)</label> <div class="pill-list svelte-b8rwae"></div> <div class="input-row svelte-b8rwae"><input class="settings__input svelte-b8rwae" type="text" placeholder="/templates/** or /daily/.+\\.md/"/> <button class="add-btn svelte-b8rwae" type="button">Add</button></div></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Exclude Status Types</label> <div class="status-toggle-list svelte-b8rwae"></div></div> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Filter</button></section> <section class="settings__section svelte-b8rwae"><div class="settings__section-header svelte-b8rwae"><h4 class="subsection-title svelte-b8rwae">Global Query (Default Conditions)</h4> <label class="settings__toggle svelte-b8rwae"><input type="checkbox"/> <span>Enable Global Query</span></label></div> <div class="form-field svelte-b8rwae"><label class="settings__label svelte-b8rwae">Global Query DSL</label> <textarea class="settings__input svelte-b8rwae" rows="4" placeholder="not done\\nnot blocked\\ndue before next 30 days"></textarea></div> <div class="query-actions svelte-b8rwae"><button class="add-btn svelte-b8rwae" type="button">Save Global Query</button> <button class="add-btn svelte-b8rwae" type="button">Validate / Explain</button> <button class="reset-btn svelte-b8rwae" type="button">Reset Global Query</button></div> <!> <!> <p class="hint svelte-b8rwae">Use <code>ignore global query</code> on a local query line to bypass the global query for that block.</p></section></div>');function Kf(s,e){Je(e,!0);const t=zn.getInstance(),r=$s.getInstance();let n=W(ke(e.settingsService.get().globalFilter??pn)),a=W(ke(e.settingsService.get().globalQuery??Un)),o=W(""),l=W(""),c=W(""),u=W(""),h=W(null),p=W(null),v=W(null);const y=Object.values(rt);yt(()=>{x()});function k(ae){return Array.from(new Set(ae.map(oe=>oe.trim()).filter(Boolean)))}function m(ae,oe){const we=oe.trim();we&&(b(n,{...i(n),[ae]:k([...i(n)[ae],we])},!0),D())}function g(ae,oe){b(n,{...i(n),[ae]:i(n)[ae].filter(we=>we!==oe)},!0),D()}function _(ae){const oe=new Set(i(n).excludeStatusTypes);oe.has(ae)?oe.delete(ae):oe.add(ae),b(n,{...i(n),excludeStatusTypes:Array.from(oe)},!0),D()}async function D(){t.updateConfig(i(n)),await e.settingsService.update({globalFilter:i(n)}),ze.emit("task:settings",{source:"global-filter"}),x()}async function E(){r.updateConfig(i(a)),await e.settingsService.update({globalQuery:i(a)}),ze.emit("task:settings",{source:"global-query"})}function x(){if(!e.repository){b(h,null);return}const ae=e.repository.getAllTasks();b(h,ae.filter(oe=>!t.shouldIncludeTask(oe)).length,!0)}async function R(){b(n,{...pn},!0),await D(),Q.success("Global filter reset to defaults")}async function U(){b(a,{...Un},!0),b(p,null),b(v,null),await E(),Q.success("Global query reset to defaults")}function N(){const ae=new Jr;try{const oe=ae.parse(i(a).query||"");b(p,{valid:!0,message:"Global query is valid."},!0),b(v,Cl(oe),!0)}catch(oe){const we=oe instanceof Error?oe.message:String(oe);b(p,{valid:!1,message:we},!0),b(v,null)}}var K=Wf(),Y=f(d(K),4),J=d(Y),se=f(d(J),2),te=d(se);te.__change=D;var le=f(J,2),ye=d(le);{var H=ae=>{var oe=Lf(),we=d(oe);j(()=>P(we,`Preview: ${i(h)??""} tasks excluded (from current index)`)),S(ae,oe)},L=ae=>{var oe=Ff();S(ae,oe)};G(ye,ae=>{i(h)!==null?ae(H):ae(L,!1)})}var C=f(le,2),z=f(d(C),2);Fe(z,21,()=>i(n).excludeFolders,nt,(ae,oe)=>{var we=Pf();we.__click=()=>g("excludeFolders",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var re=f(z,2),X=d(re),me=f(X,2);me.__click=()=>{m("excludeFolders",i(o)),b(o,"")};var ve=f(C,2),he=f(d(ve),2);Fe(he,21,()=>i(n).excludeNotebooks,nt,(ae,oe)=>{var we=Bf();we.__click=()=>g("excludeNotebooks",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var Te=f(he,2),_e=d(Te),qe=f(_e,2);qe.__click=()=>{m("excludeNotebooks",i(l)),b(l,"")};var fe=f(ve,2),F=f(d(fe),2);Fe(F,21,()=>i(n).excludeTags,nt,(ae,oe)=>{var we=Uf();we.__click=()=>g("excludeTags",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var T=f(F,2),q=d(T),Z=f(q,2);Z.__click=()=>{m("excludeTags",i(c)),b(c,"")};var ne=f(fe,2),I=f(d(ne),2);Fe(I,21,()=>i(n).excludeFilePatterns,nt,(ae,oe)=>{var we=zf();we.__click=()=>g("excludeFilePatterns",i(oe));var tt=d(we);j(()=>P(tt,`${i(oe)??""} ✕`)),S(ae,we)});var M=f(I,2),ie=d(M),Ae=f(ie,2);Ae.__click=()=>{m("excludeFilePatterns",i(u)),b(u,"")};var Ie=f(ne,2),Ce=f(d(Ie),2);Fe(Ce,21,()=>y,nt,(ae,oe)=>{var we=jf(),tt=d(we);tt.__change=()=>_(i(oe));var pr=f(tt,2),ee=d(pr);j(ge=>{Fs(tt,ge),P(ee,i(oe))},[()=>i(n).excludeStatusTypes.includes(i(oe))]),S(ae,we)});var Ye=f(Ie,2);Ye.__click=R;var Pe=f(Y,2),ct=d(Pe),bt=f(d(ct),2),$e=d(bt);$e.__change=E;var Et=f(ct,2),vt=f(d(Et),2),Oe=f(Et,2),_t=d(Oe);_t.__click=E;var He=f(_t,2);He.__click=N;var Ve=f(He,2);Ve.__click=U;var Xe=f(Oe,2);{var Mt=ae=>{var oe=Yf(),we=d(oe);j(()=>{We(oe,1,`validation ${i(p).valid?"success":"error"}`,"svelte-b8rwae"),P(we,i(p).message)}),S(ae,oe)};G(Xe,ae=>{i(p)&&ae(Mt)})}var Nt=f(Xe,2);{var jt=ae=>{var oe=Hf(),we=d(oe);j(()=>P(we,i(v))),S(ae,oe)};G(Nt,ae=>{i(v)&&ae(jt)})}Aa(te,()=>i(n).enabled,ae=>i(n).enabled=ae),at(X,()=>i(o),ae=>b(o,ae)),at(_e,()=>i(l),ae=>b(l,ae)),at(q,()=>i(c),ae=>b(c,ae)),at(ie,()=>i(u),ae=>b(u,ae)),Aa($e,()=>i(a).enabled,ae=>i(a).enabled=ae),at(vt,()=>i(a).query,ae=>i(a).query=ae),S(s,K),et()}ft(["change","click"]);var Gf=A('<button class="delete-btn svelte-1qw3eru">Delete</button>'),Qf=A('<span class="default-badge svelte-1qw3eru">Default</span>'),$f=A('<tr class="svelte-1qw3eru"><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"> </td><td class="svelte-1qw3eru"><span class="status-type svelte-1qw3eru"> </span></td><td class="svelte-1qw3eru"><code class="status-symbol svelte-1qw3eru"> </code></td><td class="example-col svelte-1qw3eru"><code class="example svelte-1qw3eru"> </code></td><td class="svelte-1qw3eru"><!></td></tr>'),Vf=A('<div class="status-registry-editor svelte-1qw3eru"><h3 class="settings__section-title svelte-1qw3eru">Custom Task Statuses</h3> <p class="description svelte-1qw3eru">Define custom checkbox symbols for different task states</p> <div class="status-list svelte-1qw3eru"><div class="table-container svelte-1qw3eru"><table class="svelte-1qw3eru"><thead class="svelte-1qw3eru"><tr><th class="svelte-1qw3eru">Symbol</th><th class="svelte-1qw3eru">Name</th><th class="svelte-1qw3eru">Type</th><th class="svelte-1qw3eru">Next Symbol</th><th class="svelte-1qw3eru">Example</th><th class="svelte-1qw3eru">Actions</th></tr></thead><tbody class="svelte-1qw3eru"></tbody></table></div></div> <div class="add-status-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">Add Custom Status</h4> <div class="add-status-form"><div class="form-row svelte-1qw3eru"><div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Symbol (1 char)</label> <input type="text" placeholder="!" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Name</label> <input type="text" placeholder="Important" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Type</label> <select class="settings__input svelte-1qw3eru"><option>TODO</option><option>IN_PROGRESS</option><option>DONE</option><option>CANCELLED</option><option>NON_TASK</option></select></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">Next Symbol</label> <input type="text" placeholder="x" maxlength="1" class="settings__input svelte-1qw3eru"/></div> <div class="form-field svelte-1qw3eru"><label class="settings__label svelte-1qw3eru">&nbsp;</label> <button class="add-btn svelte-1qw3eru">Add Status</button></div></div></div></div> <div class="actions svelte-1qw3eru"><button class="reset-btn svelte-1qw3eru">Reset to Defaults</button></div> <div class="info-section svelte-1qw3eru"><h4 class="subsection-title svelte-1qw3eru">About Custom Statuses</h4> <ul class="svelte-1qw3eru"><li class="svelte-1qw3eru"><strong>Symbol:</strong> The character shown in the checkbox (e.g., <code class="svelte-1qw3eru">[!]</code>)</li> <li class="svelte-1qw3eru"><strong>Type:</strong> Determines how the task is treated (active, completed, etc.)</li> <li class="svelte-1qw3eru"><strong>Next Symbol:</strong> What symbol to use when toggling the task</li> <li class="svelte-1qw3eru"><strong>Examples:</strong> <code class="svelte-1qw3eru">[!]</code> for urgent, <code class="svelte-1qw3eru">[?]</code> for question, <code class="svelte-1qw3eru">[&gt;]</code> for forwarded</li></ul></div></div>');function Xf(s,e){Je(e,!0);let t=vr.getInstance(),r=W(ke([])),n=W(""),a=W(""),o=W(ke(rt.TODO)),l=W("x");function c(){b(r,t.getAll(),!0)}function u(){if(!i(n).trim()||!i(a).trim()){Q.error("Symbol and name are required");return}if(i(n).length!==1){Q.error("Symbol must be a single character");return}const fe={symbol:i(n),name:i(a),type:i(o),nextStatusSymbol:i(l)},F=new xr(fe);t.register(F),c(),v(),Q.success(`Status "${i(a)}" added`)}function h(fe){if([" ","x","/","-"].includes(fe)){Q.error("Cannot delete default status");return}t.unregister(fe),c(),Q.success("Status deleted")}function p(){confirm("Reset all statuses to defaults? This will remove all custom statuses.")&&(t.reset(),c(),Q.success("Statuses reset to defaults"))}function v(){b(n,""),b(a,""),b(o,rt.TODO,!0),b(l,"x")}yt(()=>{c()});var y=Vf(),k=f(d(y),4),m=d(k),g=d(m),_=f(d(g));Fe(_,21,()=>i(r),nt,(fe,F)=>{var T=$f(),q=d(T),Z=d(q),ne=d(Z),I=f(q),M=d(I),ie=f(I),Ae=d(ie),Ie=d(Ae),Ce=f(ie),Ye=d(Ce),Pe=d(Ye),ct=f(Ce),bt=d(ct),$e=d(bt),Et=f(ct),vt=d(Et);{var Oe=He=>{var Ve=Gf();Ve.__click=()=>h(i(F).symbol),S(He,Ve)},_t=He=>{var Ve=Qf();S(He,Ve)};G(vt,He=>{[" ","x","/","-"].includes(i(F).symbol)?He(_t,!1):He(Oe)})}j(()=>{P(ne,`[${i(F).symbol??""}]`),P(M,i(F).name),P(Ie,i(F).type),P(Pe,`[${i(F).nextStatusSymbol??""}]`),P($e,`- [${i(F).symbol??""}] Task example`)}),S(fe,T)});var D=f(k,2),E=f(d(D),2),x=d(E),R=d(x),U=f(d(R),2),N=f(R,2),K=f(d(N),2),Y=f(N,2),J=f(d(Y),2),se=d(J),te={},le=f(se),ye={},H=f(le),L={},C=f(H),z={},re=f(C),X={},me=f(Y,2),ve=f(d(me),2),he=f(me,2),Te=f(d(he),2);Te.__click=u;var _e=f(D,2),qe=d(_e);qe.__click=p,j(()=>{te!==(te=rt.TODO)&&(se.value=(se.__value=rt.TODO)??""),ye!==(ye=rt.IN_PROGRESS)&&(le.value=(le.__value=rt.IN_PROGRESS)??""),L!==(L=rt.DONE)&&(H.value=(H.__value=rt.DONE)??""),z!==(z=rt.CANCELLED)&&(C.value=(C.__value=rt.CANCELLED)??""),X!==(X=rt.NON_TASK)&&(re.value=(re.__value=rt.NON_TASK)??"")}),at(U,()=>i(n),fe=>b(n,fe)),at(K,()=>i(a),fe=>b(a,fe)),Du(J,()=>i(o),fe=>b(o,fe)),at(ve,()=>i(l),fe=>b(l,fe)),S(s,y),et()}ft(["click"]);var Zf=A('<button class="settings__close-btn svelte-1ke3hir">✕</button>'),Jf=A("<div> </div>"),ev=A('<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section>'),tv=A('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),rv=A('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"><input class="settings__shortcut-input svelte-1ke3hir" type="text" placeholder="Unassigned"/> <div class="settings__shortcut-actions svelte-1ke3hir"><button class="settings__shortcut-btn svelte-1ke3hir" type="button">Save</button> <button class="settings__shortcut-btn settings__shortcut-btn--ghost svelte-1ke3hir" type="button">Reset</button></div> <div class="settings__shortcut-default svelte-1ke3hir"> </div></div></div>'),sv=A(`<section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div> <button class="settings__shortcut-reset-all svelte-1ke3hir" type="button">Reset all shortcuts</button> <p class="settings__shortcut-note svelte-1ke3hir">Tip: You can also customize these in SiYuan's native shortcut settings.</p></section>`),nv=A('<div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div>'),av=A('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">Settings</h2> <!></div> <div class="settings__layout svelte-1ke3hir"><nav class="settings__nav svelte-1ke3hir"><button>General</button> <button>Global Filtering & Query</button> <button>Custom Statuses</button> <button>Shortcuts</button></nav> <div class="settings__content svelte-1ke3hir"><!></div></div> <!></div>');function iv(s,e){Je(e,!0);let t=W(ke(Ca)),r=W(null),n=ke({}),a=W("general"),o=W(ke([])),l=W(ke({}));function c(){if(!e.shortcutManager){b(o,[],!0),b(l,{},!0);return}b(o,e.shortcutManager.getShortcutDisplay(),!0),b(l,i(o).reduce((H,L)=>(H[L.id]=L.currentHotkey||"",H),{}),!0)}function u(H,L){b(l,{...i(l),[H]:L},!0)}async function h(H){if(!e.shortcutManager)return;const L=await e.shortcutManager.updateShortcut(H,i(l)[H]??"");if(!L.success){Q.error(L.message||"Failed to update shortcut.");return}Q.success("Shortcut updated."),c()}async function p(H){e.shortcutManager&&(await e.shortcutManager.resetShortcut(H),Q.success("Shortcut reset."),c())}async function v(){e.shortcutManager&&(await e.shortcutManager.resetAllShortcuts(),Q.success("Shortcuts reset to defaults."),c())}yt(()=>{b(t,e.eventService.getConfig(),!0)}),yt(()=>{c()});async function y(){try{await e.eventService.saveConfig(i(t)),Q.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(H){Q.error("Failed to save settings: "+H)}}async function k(){b(r,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const H=await e.eventService.testConnection();n.n8n={success:H.success,message:H.success?"Test successful!":H.message||"Test failed. Check configuration."}}catch(H){n.n8n={success:!1,message:"Error: "+(H instanceof Error?H.message:String(H))}}finally{b(r,null)}}var m=av(),g=d(m),_=f(d(g),2);{var D=H=>{var L=Zf();L.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)},S(H,L)};G(_,H=>{e.onClose&&H(D)})}var E=f(g,2),x=d(E),R=d(x);R.__click=()=>b(a,"general");var U=f(R,2);U.__click=()=>b(a,"filter");var N=f(U,2);N.__click=()=>b(a,"statuses");var K=f(N,2);K.__click=()=>b(a,"shortcuts");var Y=f(x,2),J=d(Y);{var se=H=>{var L=ev(),C=d(L),z=f(d(C),2),re=d(z),X=f(C,2),me=f(d(X),2),ve=f(X,2),he=f(d(ve),2),Te=f(ve,2);Te.__click=k;var _e=d(Te),qe=f(Te,2);{var fe=F=>{var T=Jf(),q=d(T);j(()=>{We(T,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),P(q,n.n8n.message)}),S(F,T)};G(qe,F=>{n.n8n&&F(fe)})}j(()=>{me.disabled=!i(t).n8n.enabled,he.disabled=!i(t).n8n.enabled,Te.disabled=!i(t).n8n.enabled||i(r)==="n8n",P(_e,i(r)==="n8n"?"Testing...":"Test Connection")}),Aa(re,()=>i(t).n8n.enabled,F=>i(t).n8n.enabled=F),at(me,()=>i(t).n8n.webhookUrl,F=>i(t).n8n.webhookUrl=F),at(he,()=>i(t).n8n.sharedSecret,F=>i(t).n8n.sharedSecret=F),S(H,L)},te=H=>{var L=st(),C=Ge(L);{var z=X=>{Kf(X,{get settingsService(){return e.settingsService},get repository(){return e.repository}})},re=X=>{var me=st(),ve=Ge(me);{var he=_e=>{Xf(_e,{})},Te=_e=>{var qe=st(),fe=Ge(qe);{var F=T=>{var q=sv(),Z=f(d(q),2);Fe(Z,21,()=>i(o),nt,(I,M)=>{var ie=rv(),Ae=d(ie),Ie=d(Ae),Ce=d(Ie),Ye=f(Ie,2),Pe=d(Ye),ct=f(Ye,2);{var bt=Xe=>{var Mt=tv(),Nt=d(Mt);j(()=>P(Nt,i(M).context)),S(Xe,Mt)};G(ct,Xe=>{i(M).context&&Xe(bt)})}var $e=f(Ae,2),Et=d($e);Et.__input=Xe=>u(i(M).id,Xe.currentTarget.value);var vt=f(Et,2),Oe=d(vt);Oe.__click=()=>h(i(M).id);var _t=f(Oe,2);_t.__click=()=>p(i(M).id);var He=f(vt,2),Ve=d(He);j(()=>{P(Ce,i(M).label),P(Pe,i(M).description),oi(Et,i(l)[i(M).id]??""),P(Ve,`Default: ${(i(M).defaultHotkey||"Unassigned")??""}`)}),S(I,ie)});var ne=f(Z,2);ne.__click=v,S(T,q)};G(fe,T=>{i(a)==="shortcuts"&&T(F)},!0)}S(_e,qe)};G(ve,_e=>{i(a)==="statuses"?_e(he):_e(Te,!1)},!0)}S(X,me)};G(C,X=>{i(a)==="filter"?X(z):X(re,!1)},!0)}S(H,L)};G(J,H=>{i(a)==="general"?H(se):H(te,!1)})}var le=f(E,2);{var ye=H=>{var L=nv(),C=d(L);C.__click=y,S(H,L)};G(le,H=>{i(a)==="general"&&H(ye)})}j(()=>{We(R,1,`settings__nav-btn ${i(a)==="general"?"active":""}`,"svelte-1ke3hir"),We(U,1,`settings__nav-btn ${i(a)==="filter"?"active":""}`,"svelte-1ke3hir"),We(N,1,`settings__nav-btn ${i(a)==="statuses"?"active":""}`,"svelte-1ke3hir"),We(K,1,`settings__nav-btn ${i(a)==="shortcuts"?"active":""}`,"svelte-1ke3hir")}),S(s,m),et()}ft(["click","input"]);var ov=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),lv=A('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),cv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),uv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),dv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),hv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),fv=A('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),vv=A('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>Blocking</button> <button>High Priority</button></div>'),pv=A('<div class="dashboard__tabs svelte-1y1a8hs" role="tablist" aria-label="Dashboard tabs"><button id="dashboard-tab-inbox" role="tab" aria-controls="dashboard-panel">📥 Inbox <!></button> <button id="dashboard-tab-today" role="tab" aria-controls="dashboard-panel">📋 Today <!></button> <button id="dashboard-tab-upcoming" role="tab" aria-controls="dashboard-panel">📅 Upcoming <!></button> <button id="dashboard-tab-done" role="tab" aria-controls="dashboard-panel">✅ Done <!></button> <button id="dashboard-tab-projects" role="tab" aria-controls="dashboard-panel">📁 Projects <!></button> <button id="dashboard-tab-search" role="tab" aria-controls="dashboard-panel">🔍 Search</button> <button id="dashboard-tab-all" role="tab" aria-controls="dashboard-panel">📝 All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div id="dashboard-panel" class="dashboard__content svelte-1y1a8hs" role="tabpanel"><!></div>',1),yv=A('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">⚙️ Settings</button></div></div> <!></div>');function mv(s,e){Je(e,!0),qc(fi,e.settingsService.get().urgency);const t=e.scheduler.getTimezoneHandler(),r=e.scheduler.getRecurrenceEngine();let n=W("today"),a=W(!1),o=W(!1),l=W(void 0),c=W(ke(new Set)),u=W(ke([])),h=V(()=>Zu(i(u))),p=W(!1);const v=V(()=>["inbox","today","upcoming","done","projects","search","all"].includes(i(n))?`dashboard-tab-${i(n)}`:void 0),y=V(()=>()=>{let T=i(u);if(i(c).has("notDone")&&(T=T.filter(q=>q.status!=="done"&&q.status!=="cancelled")),i(c).has("dueToday")){const q=new Date;q.setHours(0,0,0,0);const Z=new Date(q);Z.setDate(Z.getDate()+1),T=T.filter(ne=>{if(!ne.dueAt)return!1;const I=new Date(ne.dueAt);return I>=q&&I<Z})}if(i(c).has("overdue")){const q=new Date;q.setHours(0,0,0,0),T=T.filter(Z=>!Z.dueAt||Z.status==="done"||Z.status==="cancelled"?!1:new Date(Z.dueAt)<q)}return i(c).has("inProgress")&&(T=T.filter(q=>q.status==="todo"&&q.statusSymbol&&q.statusSymbol!==" ")),i(c).has("blocked")&&(T=T.filter(q=>Qu(q,i(u)))),i(c).has("blocking")&&(T=T.filter(q=>$u(q,i(u)))),i(c).has("highPriority")&&(T=T.filter(q=>{const Z=Qs(q.priority)||"normal";return Z==="high"||Z==="highest"})),T}),k=V(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled"&&!T.dueAt&&!T.scheduledAt&&!T.startAt).length),m=V(()=>()=>{const T=new Date;T.setHours(0,0,0,0);const q=new Date(T);return q.setDate(q.getDate()+7),i(u).filter(Z=>{if(Z.status==="done"||Z.status==="cancelled"||!Z.dueAt)return!1;const ne=new Date(Z.dueAt);return ne.setHours(0,0,0,0),ne>T&&ne<=q}).length}),g=V(()=>()=>{const T=new Date;return T.setDate(T.getDate()-30),T.setHours(0,0,0,0),i(u).filter(q=>q.status!=="done"||!q.doneAt?!1:new Date(q.doneAt)>=T).length}),_=V(()=>i(u).filter(T=>T.status!=="done"&&T.status!=="cancelled").length);function D(T="initial"){b(p,!0),b(u,e.repository.getAllTasks().map(q=>({...q})),!0),b(p,!1),T!=="initial"&&Q.info("Task list reloaded")}D();const E=()=>D("reload");Tn(()=>{window.addEventListener("recurring-task-refresh",E)}),Iu(()=>{window.removeEventListener("recurring-task-refresh",E)});async function x(T){ze.emit("task: complete",{taskId:T.id})}async function R(T){const q=i(u),Z=da(i(u),T.id,ne=>{const I={...ne},M=new Date(I.dueAt),ie=t.tomorrow();return ie.setHours(M.getHours(),M.getMinutes(),0,0),I.dueAt=ie.toISOString(),I.snoozeCount=(I.snoozeCount||0)+1,I.updatedAt=new Date().toISOString(),I});b(u,Z,!0),Q.info(`Task "${T.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task. snoozed",T),await e.scheduler.delayToTomorrow(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to delay task:  "+ne),D("external")}}async function U(T){var Z;if(!((Z=T.name)!=null&&Z.trim())){Q.error("Task name is required");return}if(!kl(T.frequency)){Q.error("Invalid frequency configuration");return}const q={...T};b(u,ua(i(u),q),!0),b(a,!1),b(l,void 0),Q.success(`Task "${T.name}" saved successfully`),e.repository.saveTask(q).catch(ne=>{Q.error("Failed to save task: "+ne),D("external")})}async function N(T){const q=i(u);b(u,Zi(i(u),T.id),!0);const Z=window.setTimeout(async()=>{try{await e.repository.deleteTask(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to delete task: "+ne),D("external")}},5e3);cs({message:`Task "${T.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(Z),b(u,q,!0),Q.info(`Restored "${T.name}"`)},showCountdown:!0})}async function K(T){const q=T.name.endsWith(" (copy)")?`${T.name} ${new Date().toLocaleDateString()}`:`${T.name} (copy)`,Z=Dl(T,{name:q});b(u,ua(i(u),Z),!0),Q.success(`Duplicated "${T.name}"`),e.repository.saveTask(Z).catch(ne=>{b(u,Zi(i(u),Z.id),!0),Q.error("Failed to duplicate task: "+ne),D("external")})}async function Y(T){const q=!T.enabled,Z={...T,enabled:q},ne=da(i(u),T.id,()=>Z);b(u,ne,!0),Q.info(`Task ${q?"enabled":"disabled"}`),e.repository.saveTask(Z).catch(I=>{Q.error("Failed to update task: "+I),D("external")})}async function J(T,q){if(T.length===0)return;const Z=i(u),ne=new Set(T),I=i(u).map(M=>ne.has(M.id)?{...M,enabled:q}:M);b(u,I,!0),Q.info(`${q?"Enabled":"Disabled"} ${T.length} task${T.length===1?"":"s"}`);try{const M=I.filter(ie=>ne.has(ie.id));await Promise.all(M.map(ie=>e.repository.saveTask(ie)))}catch(M){b(u,Z,!0),Q.error(`Failed to ${q?"enable":"disable"} tasks: ${M}`),D("external")}}async function se(T){if(T.length===0)return;const q=i(u),Z=new Set(T),ne=i(u).filter(M=>Z.has(M.id));b(u,i(u).filter(M=>!Z.has(M.id)),!0);const I=window.setTimeout(async()=>{try{await Promise.all(ne.map(M=>e.repository.deleteTask(M.id)))}catch(M){b(u,q,!0),Q.error("Failed to delete tasks: "+M),D("external")}},5e3);cs({message:`${ne.length} task${ne.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(I),b(u,q,!0),Q.info("Bulk delete undone")},showCountdown:!0})}function te(T){b(l,T,!0),b(a,!0)}function le(){b(l,void 0),b(a,!0)}function ye(){b(a,!1),b(l,void 0)}function H(){b(o,!0)}function L(){b(o,!1)}async function C(T){const q=i(u),Z=da(i(u),T.id,ne=>{const I={...ne};El(I);const M=r.calculateNext(new Date(I.dueAt),I.frequency);return I.dueAt=M.toISOString(),I});b(u,Z,!0),Q.info(`Task "${T.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",T),await e.scheduler.skipTaskOccurrence(T.id)}catch(ne){b(u,q,!0),Q.error("Failed to skip task: "+ne),D("external")}}function z(T){const q=new Set(i(c));q.has(T)?q.delete(T):q.add(T),b(c,q,!0)}async function re(T){const q={...T,status:"todo",doneAt:void 0};b(u,ua(i(u),q),!0),Q.success(`Task "${T.name}" marked as not done`),e.repository.saveTask(q).catch(Z=>{Q.error("Failed to update task: "+Z),D("external")})}var X=yv(),me=d(X),ve=f(d(me),2),he=d(ve);he.__click=()=>D("reload");var Te=d(he),_e=f(he,2);_e.__click=H;var qe=f(me,2);{var fe=T=>{var q=ov(),Z=d(q);iv(Z,{get eventService(){return e.eventService},get shortcutManager(){return e.shortcutManager},get settingsService(){return e.settingsService},get repository(){return e.repository},onClose:L}),S(T,q)},F=T=>{var q=st(),Z=Ge(q);{var ne=M=>{var ie=lv(),Ae=d(ie);Ml(Ae,{get task(){return i(l)},get repository(){return e.repository},onSave:U,onClose:ye}),S(M,ie)},I=M=>{var ie=pv(),Ae=Ge(ie),Ie=d(Ae);Ie.__click=()=>b(n,"inbox");var Ce=f(d(Ie));{var Ye=ce=>{var Se=cv(),Ue=d(Se);j(()=>P(Ue,i(k))),S(ce,Se)};G(Ce,ce=>{i(k)>0&&ce(Ye)})}var Pe=f(Ie,2);Pe.__click=()=>b(n,"today");var ct=f(d(Pe));{var bt=ce=>{var Se=uv(),Ue=d(Se);j(()=>P(Ue,i(h).length)),S(ce,Se)};G(ct,ce=>{i(h).length>0&&ce(bt)})}var $e=f(Pe,2);$e.__click=()=>b(n,"upcoming");var Et=f(d($e));{var vt=ce=>{var Se=dv(),Ue=d(Se);j(()=>P(Ue,i(m))),S(ce,Se)};G(Et,ce=>{i(m)>0&&ce(vt)})}var Oe=f($e,2);Oe.__click=()=>b(n,"done");var _t=f(d(Oe));{var He=ce=>{var Se=hv(),Ue=d(Se);j(()=>P(Ue,i(g))),S(ce,Se)};G(_t,ce=>{i(g)>0&&ce(He)})}var Ve=f(Oe,2);Ve.__click=()=>b(n,"projects");var Xe=f(d(Ve));{var Mt=ce=>{var Se=fv(),Ue=d(Se);j(()=>P(Ue,i(_))),S(ce,Se)};G(Xe,ce=>{i(_)>0&&ce(Mt)})}var Nt=f(Ve,2);Nt.__click=()=>b(n,"search");var jt=f(Nt,2);jt.__click=()=>b(n,"all");var ae=f(d(jt)),oe=d(ae),we=f(Ae,2);{var tt=ce=>{var Se=vv(),Ue=f(d(Se),2);Ue.__click=()=>z("notDone");var Ze=f(Ue,2);Ze.__click=()=>z("dueToday");var ut=f(Ze,2);ut.__click=()=>z("overdue");var dt=f(ut,2);dt.__click=()=>z("inProgress");var qt=f(dt,2);qt.__click=()=>z("blocked");var Vt=f(qt,2);Vt.__click=()=>z("blocking");var xt=f(Vt,2);xt.__click=()=>z("highPriority"),j((or,Yt,lr,zr,Ht,B,ue)=>{We(Ue,1,`dashboard__filter-btn ${or??""}`,"svelte-1y1a8hs"),We(Ze,1,`dashboard__filter-btn ${Yt??""}`,"svelte-1y1a8hs"),We(ut,1,`dashboard__filter-btn ${lr??""}`,"svelte-1y1a8hs"),We(dt,1,`dashboard__filter-btn ${zr??""}`,"svelte-1y1a8hs"),We(qt,1,`dashboard__filter-btn ${Ht??""}`,"svelte-1y1a8hs"),We(Vt,1,`dashboard__filter-btn ${B??""}`,"svelte-1y1a8hs"),We(xt,1,`dashboard__filter-btn ${ue??""}`,"svelte-1y1a8hs")},[()=>i(c).has("notDone")?"active":"",()=>i(c).has("dueToday")?"active":"",()=>i(c).has("overdue")?"active":"",()=>i(c).has("inProgress")?"active":"",()=>i(c).has("blocked")?"active":"",()=>i(c).has("blocking")?"active":"",()=>i(c).has("highPriority")?"active":""]),S(ce,Se)};G(we,ce=>{i(n)!=="search"&&i(n)!=="timeline"&&i(n)!=="analytics"&&ce(tt)})}var pr=f(we,2),ee=d(pr);{var ge=ce=>{{let Se=V(()=>i(c).size>0?i(y):i(u));rh(ce,{get tasks(){return i(Se)},onEdit:te,onDone:x,onDelete:N})}},Be=ce=>{var Se=st(),Ue=Ge(Se);{var Ze=dt=>{{let qt=V(()=>i(c).size>0?i(y).filter(Vt=>i(h).some(xt=>xt.id===Vt.id)):i(h));Td(dt,{get tasks(){return i(qt)},onDone:x,onDelay:R,onSkip:C,onEdit:te,get timezoneHandler(){return t}})}},ut=dt=>{var qt=st(),Vt=Ge(qt);{var xt=Yt=>{{let lr=V(()=>i(c).size>0?i(y):i(u));oh(Yt,{get tasks(){return i(lr)},onEdit:te,onDone:x,onDelete:N})}},or=Yt=>{var lr=st(),zr=Ge(lr);{var Ht=ue=>{{let it=V(()=>i(c).size>0?i(y):i(u));vh(ue,{get tasks(){return i(it)},onEdit:te,onDelete:N,onUncomplete:re})}},B=ue=>{var it=st(),Dr=Ge(it);{var Xt=Ds=>{{let Sn=V(()=>i(c).size>0?i(y):i(u));_h(Ds,{get tasks(){return i(Sn)},onEdit:te,onDone:x,onDelete:N})}},Ss=Ds=>{var Sn=st(),Hl=Ge(Sn);{var Wl=Es=>{lf(Es,{get tasks(){return i(u)},onEdit:te,onDone:x,onDelete:N})},Kl=Es=>{var _i=st(),Gl=Ge(_i);{var Ql=xs=>{{let Dn=V(()=>i(c).size>0?i(y):i(u));Md(xs,{get tasks(){return i(Dn)},onEdit:te,onDelete:N,onDuplicate:K,onToggleEnabled:Y,onBulkEnable:tn=>J(tn,!0),onBulkDisable:tn=>J(tn,!1),onBulkDelete:se,onCreate:le})}},$l=xs=>{var Dn=st(),tn=Ge(Dn);{var Vl=As=>{zd(As,{get tasks(){return i(u)},get recurrenceEngine(){return r}})},Xl=As=>{var ki=st(),Zl=Ge(ki);{var Jl=ra=>{Zd(ra,{get tasks(){return i(u)}})};G(Zl,ra=>{i(n)==="analytics"&&ra(Jl)},!0)}S(As,ki)};G(tn,As=>{i(n)==="timeline"?As(Vl):As(Xl,!1)},!0)}S(xs,Dn)};G(Gl,xs=>{i(n)==="all"?xs(Ql):xs($l,!1)},!0)}S(Es,_i)};G(Hl,Es=>{i(n)==="search"?Es(Wl):Es(Kl,!1)},!0)}S(Ds,Sn)};G(Dr,Ds=>{i(n)==="projects"?Ds(Xt):Ds(Ss,!1)},!0)}S(ue,it)};G(zr,ue=>{i(n)==="done"?ue(Ht):ue(B,!1)},!0)}S(Yt,lr)};G(Vt,Yt=>{i(n)==="upcoming"?Yt(xt):Yt(or,!1)},!0)}S(dt,qt)};G(Ue,dt=>{i(n)==="today"?dt(Ze):dt(ut,!1)},!0)}S(ce,Se)};G(ee,ce=>{i(n)==="inbox"?ce(ge):ce(Be,!1)})}j(()=>{We(Ie,1,`dashboard__tab ${i(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Ee(Ie,"aria-selected",i(n)==="inbox"),We(Pe,1,`dashboard__tab ${i(n)==="today"?"active":""}`,"svelte-1y1a8hs"),Ee(Pe,"aria-selected",i(n)==="today"),We($e,1,`dashboard__tab ${i(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Ee($e,"aria-selected",i(n)==="upcoming"),We(Oe,1,`dashboard__tab ${i(n)==="done"?"active":""}`,"svelte-1y1a8hs"),Ee(Oe,"aria-selected",i(n)==="done"),We(Ve,1,`dashboard__tab ${i(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),Ee(Ve,"aria-selected",i(n)==="projects"),We(Nt,1,`dashboard__tab ${i(n)==="search"?"active":""}`,"svelte-1y1a8hs"),Ee(Nt,"aria-selected",i(n)==="search"),We(jt,1,`dashboard__tab ${i(n)==="all"?"active":""}`,"svelte-1y1a8hs"),Ee(jt,"aria-selected",i(n)==="all"),P(oe,i(u).length),Ee(pr,"aria-labelledby",i(v))}),S(M,ie)};G(Z,M=>{i(a)?M(ne):M(I,!1)},!0)}S(T,q)};G(qe,T=>{i(o)?T(fe):T(F,!1)})}j(()=>{he.disabled=i(p),P(Te,i(p)?"⟳":"↻")}),S(s,X),et()}ft(["click"]);var gv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),bv=A('<div class="quick-add-card__error svelte-1q3w22"> </div>'),_v=A('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),kv=A('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),wv=A('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">✕</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ⌘/Ctrl + Enter to save.</p></div></div>');function Tv(s,e){var L;Je(e,!0);let t=W(ke(((L=e.prefill)==null?void 0:L.suggestedName)??"")),r=W(ke(new Date().toISOString().slice(0,16))),n=W(ke({name:!1,dueAt:!1})),a=W(!1),o=W(null);const l=V(()=>i(n).name&&!i(t).trim()?"Task name is required.":""),c=V(()=>i(n).dueAt?i(r)?Number.isNaN(new Date(i(r)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=V(()=>!!(i(l)||i(c)));Tn(()=>{var C;if((C=e.prefill)!=null&&C.suggestedTime){const z=new Date,[re,X]=e.prefill.suggestedTime.split(":").map(Number);z.setHours(re,X,0,0),b(r,z.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var z;(z=i(o))==null||z.focus()})});async function h(){var X,me;if(b(n,{name:!0,dueAt:!0},!0),i(u)){Q.warning("Please fill out the required fields.");return}const C=Mu(),z=i(r).slice(11,16);if(C.time=z,!kl(C)){Q.error("Invalid frequency configuration.");return}const re=Tl(i(t).trim(),C,new Date(i(r)));re.linkedBlockId=((X=e.prefill)==null?void 0:X.linkedBlockId)||void 0,re.linkedBlockContent=((me=e.prefill)==null?void 0:me.linkedBlockContent)||void 0,b(a,!0);try{await e.repository.saveTask(re),Q.success(`Task "${re.name}" created`),ze.emit("task:refresh",void 0),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(ve){Q.error("Failed to create task: "+ve)}finally{b(a,!1)}}function p(C){C.key==="Escape"&&e.onClose(),(C.metaKey||C.ctrlKey)&&C.key==="Enter"&&(C.preventDefault(),h())}var v=wv();v.__keydown=p;var y=d(v),k=d(y),m=f(d(k),2);m.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)};var g=f(k,2),_=f(d(g),2);_.__input=()=>i(n).name=!0,fr(_,C=>b(o,C),()=>i(o));var D=f(_,2);{var E=C=>{var z=gv(),re=d(z);j(()=>P(re,i(l))),S(C,z)};G(D,C=>{i(l)&&C(E)})}var x=f(g,2),R=f(d(x),2);R.__input=()=>i(n).dueAt=!0;var U=f(R,2);{var N=C=>{var z=bv(),re=d(z);j(()=>P(re,i(c))),S(C,z)};G(U,C=>{i(c)&&C(N)})}var K=f(x,2);{var Y=C=>{var z=_v(),re=f(d(z)),X=d(re);j(()=>P(X,e.prefill.linkedBlockId)),S(C,z)};G(K,C=>{var z;(z=e.prefill)!=null&&z.linkedBlockId&&C(Y)})}var J=f(K,2),se=d(J);se.__click=function(...C){var z;(z=e.onClose)==null||z.apply(this,C)};var te=f(se,2);{var le=C=>{var z=kv();z.__click=function(...re){var X;(X=e.onAdvanced)==null||X.apply(this,re)},S(C,z)};G(te,C=>{e.onAdvanced&&C(le)})}var ye=f(te,2);ye.__click=h;var H=d(ye);j(()=>{Ee(_,"aria-invalid",!!i(l)),Ee(R,"aria-invalid",!!i(c)),ye.disabled=i(a),P(H,i(a)?"Saving…":"Create Task")}),St("blur",_,()=>i(n).name=!0),at(_,()=>i(t),C=>b(t,C)),St("blur",R,()=>i(n).dueAt=!0),at(R,()=>i(r),C=>b(r,C)),S(s,v),et()}ft(["keydown","click","input"]);var Sv=A('<button class="postpone-card__option svelte-tkdeu6" type="button" role="listitem"> </button>'),Dv=A('<div class="postpone-overlay svelte-tkdeu6" role="dialog" aria-modal="true" aria-labelledby="postpone-title"><div class="postpone-card svelte-tkdeu6" role="document"><div class="postpone-card__header svelte-tkdeu6"><h2 id="postpone-title" class="svelte-tkdeu6">Postpone task</h2> <button class="postpone-card__close svelte-tkdeu6" type="button" aria-label="Close">✕</button></div> <p class="postpone-card__summary svelte-tkdeu6">Choose a new due offset for <strong> </strong>.</p> <div class="postpone-card__options svelte-tkdeu6" role="list"></div> <div class="postpone-card__actions svelte-tkdeu6"><button class="postpone-card__cancel svelte-tkdeu6" type="button">Cancel</button></div></div></div>');function Ev(s,e){Je(e,!0);let t=W(null);function r(m,g){g&&b(t,m,!0)}Tn(()=>{requestAnimationFrame(()=>{var m;(m=i(t))==null||m.focus()})});function n(m){m.key==="Escape"&&e.onClose()}var a=Dv();a.__keydown=n;var o=d(a),l=d(o),c=f(d(l),2);c.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)};var u=f(l,2),h=f(d(u)),p=d(h),v=f(u,2);Fe(v,21,()=>Pu,nt,(m,g,_)=>{var D=Sv();D.__click=()=>e.onSelect(i(g).minutes);var E=d(D);bu(D,(x,R)=>r==null?void 0:r(x,R),()=>_===0),j(()=>P(E,i(g).label)),S(m,D)});var y=f(v,2),k=d(y);k.__click=function(...m){var g;(g=e.onClose)==null||g.apply(this,m)},j(()=>P(p,e.taskName)),S(s,a),et()}ft(["keydown","click"]);class xv{constructor(e){w(this,"plugin");this.plugin=e}getCurrentVersion(){return Yr}async createBackup(e,t){try{const r=await this.plugin.loadData(e);if(r){const n=new Date().toISOString().replace(/[:.]/g,"-"),a=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${a}-${n}`;return await this.plugin.saveData(o,r),de(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(r){throw be("Failed to create backup",r),r}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Yr};const r=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(r.length===0)return de("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:Yr};let n=!1,a,o,l=0;for(let c=0;c<r.length;c++){const u=r[c],h=u.version||0;h<Yr&&(n||(o=h,a=await this.createBackup(e,h),n=!0),r[c]=this.migrateTask(u,h),l++,de(`Migrated task ${u.id} from v${h} to v${Yr}`))}if(n){const c=Array.isArray(t)?r:{...t,tasks:r};return await this.plugin.saveData(e,c),de(`Migration complete: ${l} tasks migrated`),{migrated:!0,tasksAffected:l,fromVersion:o,toVersion:Yr,backupKey:a}}else return de("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:Yr}}catch(t){throw be("Migration failed",t),t}}migrateTask(e,t){let r={...e};return t<1&&(r.version=1),t<2&&(r={...r,version:2,timezone:r.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:r.completionCount||0,missCount:r.missCount||0,currentStreak:r.currentStreak||0,bestStreak:r.bestStreak||0,recentCompletions:r.recentCompletions||[],priority:r.priority||"normal",tags:r.tags||[],notificationChannels:r.notificationChannels||[],snoozeCount:r.snoozeCount||0,maxSnoozes:r.maxSnoozes||3}),t<3&&(r={...r,version:3,escalationPolicy:r.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:r.linkedBlockContent||void 0,category:r.category||void 0,description:r.description||void 0}),t<4&&(r={...r,version:4,onCompletion:r.onCompletion||"keep",dependsOn:r.dependsOn||[],blockedBy:r.blockedBy||[]}),r}}class Av{constructor(e,t=50){w(this,"pendingState",null);w(this,"writeInProgress",!1);w(this,"scheduledTimer",null);w(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){be("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return be("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const qa={},Cv=Object.freeze(Object.defineProperty({__proto__:null,default:qa},Symbol.toStringTag,{value:"Module"})),so=new Set;function Rn(s){const e=`${s.feature}:${s.capability}:${s.message}`;so.has(e)||(so.add(e),Qe(s.message,{feature:s.feature,capability:s.capability,cause:s.cause}))}class Nl extends Error{constructor(t,r,n){super(n);w(this,"capability");w(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=r}}class ql extends Error{constructor(t,r,n,a){super(n);w(this,"capability");w(this,"feature");w(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=r,this.cause=a}}class Iv{constructor(e=globalThis){w(this,"supportedCapabilities");w(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,r,n;return typeof((n=(r=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:r.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,r;return this.isDataDirAvailable()?((r=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:r.dataDir)??null:null}async setBlockAttrs(e,t){const r=this.getSetBlockAttrs();try{await r(e,t)}catch(n){throw new ql("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Nl("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Ov=".tmp";class Mv{constructor(e,t){w(this,"plugin");w(this,"apiAdapter");w(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(ls);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){be("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),de(`Saved ${e.tasks.length} active tasks`)}catch(t){throw be("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(ls,e);return}const r=this.resolveStoragePath(ls);if(!r){await this.plugin.saveData(ls,e);return}const n=qa.dirname(r);await t.mkdir(n,{recursive:!0});const a=`${r}${Ov}`,o=JSON.stringify(e),l=await t.open(a,"w");try{await l.writeFile(o,"utf8"),await l.sync()}finally{await l.close()}try{await t.rename(a,r)}catch{await t.rm(r,{force:!0}),await t.rename(a,r)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>Cv);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Qe("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),r=this.plugin.name;return!t||!r?(t||Rn({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):qa.join(t,"storage",`p${r}`,`${e}.json`)}}const no=1,ao=1e3;class Nv{constructor(e){w(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),r=this.groupByYear(e);for(const[n,a]of r.entries())await this.appendTasksToYear(t,n,a);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const r=this.filterChunks(t.chunks,e),n=[];for(const l of r){const c=await this.loadChunk(l.key);if(c)for(const u of c.tasks)this.matchesQuery(u,e)&&n.push(u)}const a=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(a,a+o)}async loadIndex(){try{const e=await this.plugin.loadData(Nn);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??no,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){be("Failed to load archive index",e)}return{version:no,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Nn,e)}catch(t){throw be("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Nn}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){be("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(r){throw be("Failed to save archive chunk",{key:e,err:r}),r}}groupByYear(e){const t=new Map;for(const r of e){const n=this.getCompletionTimestamp(r),a=new Date(n).getFullYear(),o=t.get(a);o?o.push(r):t.set(a,[r])}return t}async appendTasksToYear(e,t,r){let n=[...r];for(;n.length>0;){const a=this.findOrCreateChunk(e,t),o=await this.loadChunk(a.key)||{tasks:[]},l=ao-o.tasks.length,c=n.slice(0,l);o.tasks.push(...c),n=n.slice(c.length);const u=this.updateChunkMeta(a,c);a.count=u.count,a.start=u.start,a.end=u.end,await this.saveChunk(a.key,o),e.totalCount+=c.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(l=>l.year===t).sort((l,c)=>l.sequence-c.sequence).at(-1);if(n&&n.count<ao)return n;const a=n?n.sequence+1:1,o={key:this.buildChunkKey(t,a),year:t,sequence:a,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let r=e.start,n=e.end;for(const a of t){const o=this.getCompletionTimestamp(a);(!r||o<r)&&(r=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:r,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const r=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(a=>{const o=a.start?new Date(a.start).getTime():null,l=a.end?new Date(a.end).getTime():null;return!(r&&l&&l<r||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const r=this.getCompletionTimestamp(e),n=new Date(r).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class qv{constructor(e,t=new Iv){w(this,"plugin");w(this,"activeTasks");w(this,"blockIndex",new Map);w(this,"taskBlockIndex",new Map);w(this,"dueIndex",new Map);w(this,"activeStore");w(this,"archiveStore");w(this,"persistence");w(this,"blockAttrSyncEnabled",!0);w(this,"blockApi");w(this,"apiAdapter");w(this,"syncRetryQueue",new Map);w(this,"retryProcessorInterval");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Mv(e,t),this.archiveStore=new Nv(e),this.persistence=new Av(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),de(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex(),this.startSyncRetryProcessor()}async loadActiveTasks(e=1e3,t){const r=await this.activeStore.loadActive(),n=Array.from(r.values()),a=n.length;if(a===0)return[];const o=[];for(let l=0;l<a;l+=e){const c=n.slice(l,Math.min(l+e,a));o.push(...c),t&&t(o.length,a),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));de(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);de(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),r=this.dueIndex.get(t);r&&(r.delete(e.id),r.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),r=[];for(const[n]of this.dueIndex)n<=t&&r.push(...this.getTasksForDueKey(n));return r}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const r=[];for(const n of t){const a=this.activeTasks.get(n);if(!a){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!a.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(a.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}r.push(a)}return r}removeStaleDueIndexEntry(e,t,r){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),Qe("Removed stale due index entry",{taskId:t,dateKey:e,reason:r}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id);if(t&&e.version!==void 0&&t.version!==void 0&&e.version<t.version)throw new Error(`Concurrent modification detected for task "${e.name}". Please refresh and try again.`);e.version=(e.version??0)+1;const r=this.activeTasks.get(e.id),n=this.taskBlockIndex.get(e.id);n&&n!==e.linkedBlockId&&(this.blockIndex.delete(n),this.taskBlockIndex.delete(e.id)),r&&r.enabled&&(r.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(r),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrsWithRetry(e),n&&n!==e.linkedBlockId&&await this.clearBlockAttrs(n)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Gi]:e.id,[Qi]:e.dueAt,[$i]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Gi]:"",[Qi]:"",[$i]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Rn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(r){r instanceof Nl||r instanceof ql?Rn({feature:r.feature,capability:r.capability,message:r.message,cause:r.cause}):Rn({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:r}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(r=>new Date(r.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(r=>{const n=new Date(r.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(ls);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Fi);if(!t)return;const r=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(r.length===0)return;await this.plugin.saveData(Pi,t),de(`Created legacy backup at ${Pi}`);const n=r.filter(l=>!l.enabled&&l.lastCompletedAt),a=r.filter(l=>!n.includes(l)),o=new Map(a.map(l=>[l.id,l]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),de("Legacy storage migration complete",{activeCount:a.length,archivedCount:n.length,legacyKey:Fi,activeKey:ls,archiveIndexKey:Nn})}async syncTaskToBlockAttrsWithRetry(e){try{await this.syncTaskToBlockAttrs(e),this.syncRetryQueue.delete(e.id)}catch(t){const r=this.syncRetryQueue.get(e.id)||{task:e,attempts:0,nextRetry:Date.now()};r.attempts<In?(r.attempts++,r.nextRetry=Date.now()+Vi[r.attempts-1],r.task=e,this.syncRetryQueue.set(e.id,r),Qe(`Block sync failed for task ${e.id}, added to retry queue`,{taskId:e.id,attempts:r.attempts,nextRetry:new Date(r.nextRetry).toISOString(),error:t instanceof Error?t.message:String(t)})):(be(`Block sync failed for task ${e.id} after ${In} attempts`,{taskId:e.id,error:t instanceof Error?t.message:String(t)}),this.syncRetryQueue.delete(e.id))}}startSyncRetryProcessor(){this.retryProcessorInterval&&clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=setInterval(async()=>{const e=Date.now(),t=[];for(const[r,n]of this.syncRetryQueue.entries())n.nextRetry<=e&&t.push({id:r,entry:n});for(const{id:r,entry:n}of t)try{await this.syncTaskToBlockAttrs(n.task),this.syncRetryQueue.delete(r),de(`Block sync retry succeeded for task ${r}`,{taskId:r,attempts:n.attempts})}catch(a){n.attempts<In?(n.attempts++,n.nextRetry=Date.now()+Vi[n.attempts-1],this.syncRetryQueue.set(r,n),Qe(`Block sync retry failed for task ${r}`,{taskId:r,attempts:n.attempts,nextRetry:new Date(n.nextRetry).toISOString(),error:a instanceof Error?a.message:String(a)})):(be(`Block sync retry exhausted for task ${r} after ${In} attempts`,{taskId:r,error:a instanceof Error?a.message:String(a)}),this.syncRetryQueue.delete(r))}},zu)}stopSyncRetryProcessor(){this.retryProcessorInterval&&(clearInterval(this.retryProcessorInterval),this.retryProcessorInterval=void 0)}}class Rv{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}var Ra=["MO","TU","WE","TH","FR","SA","SU"],Lt=function(){function s(e,t){if(t===0)throw new Error("Can't create weekday with n == 0");this.weekday=e,this.n=t}return s.fromStr=function(e){return new s(Ra.indexOf(e))},s.prototype.nth=function(e){return this.n===e?this:new s(this.weekday,e)},s.prototype.equals=function(e){return this.weekday===e.weekday&&this.n===e.n},s.prototype.toString=function(){var e=Ra[this.weekday];return this.n&&(e=(this.n>0?"+":"")+String(this.n)+e),e},s.prototype.getJsWeekday=function(){return this.weekday===6?0:this.weekday+1},s}(),ot=function(s){return s!=null},yr=function(s){return typeof s=="number"},io=function(s){return typeof s=="string"&&Ra.includes(s)},Gt=Array.isArray,Sr=function(s,e){e===void 0&&(e=s),arguments.length===1&&(e=s,s=0);for(var t=[],r=s;r<e;r++)t.push(r);return t},Re=function(s,e){var t=0,r=[];if(Gt(s))for(;t<e;t++)r[t]=[].concat(s);else for(;t<e;t++)r[t]=s;return r},Lv=function(s){return Gt(s)?s:[s]};function Os(s,e,t){t===void 0&&(t=" ");var r=String(s);return e=e>>0,r.length>e?String(r):(e=e-r.length,e>t.length&&(t+=Re(t,e/t.length)),t.slice(0,e)+String(r))}var Fv=function(s,e,t){var r=s.split(e);return t?r.slice(0,t).concat([r.slice(t).join(e)]):r},nr=function(s,e){var t=s%e;return t*e<0?t+e:t},ha=function(s,e){return{div:Math.floor(s/e),mod:nr(s,e)}},wr=function(s){return!ot(s)||s.length===0},pt=function(s){return!wr(s)},Ke=function(s,e){return pt(s)&&s.indexOf(e)!==-1},ws=function(s,e,t,r,n,a){return r===void 0&&(r=0),n===void 0&&(n=0),a===void 0&&(a=0),new Date(Date.UTC(s,e-1,t,r,n,a))},Pv=[31,28,31,30,31,30,31,31,30,31,30,31],Rl=1e3*60*60*24,Ll=9999,Fl=ws(1970,1,1),Bv=[6,0,1,2,3,4,5],un=function(s){return s%4===0&&s%100!==0||s%400===0},Pl=function(s){return s instanceof Date},nn=function(s){return Pl(s)&&!isNaN(s.getTime())},Uv=function(s,e){var t=s.getTime(),r=e.getTime(),n=t-r;return Math.round(n/Rl)},La=function(s){return Uv(s,Fl)},Bl=function(s){return new Date(Fl.getTime()+s*Rl)},zv=function(s){var e=s.getUTCMonth();return e===1&&un(s.getUTCFullYear())?29:Pv[e]},Vs=function(s){return Bv[s.getUTCDay()]},oo=function(s,e){var t=ws(s,e+1,1);return[Vs(t),zv(t)]},Ul=function(s,e){return e=e||s,new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds()))},Fa=function(s){var e=new Date(s.getTime());return e},lo=function(s){for(var e=[],t=0;t<s.length;t++)e.push(Fa(s[t]));return e},yn=function(s){s.sort(function(e,t){return e.getTime()-t.getTime()})},pi=function(s,e){e===void 0&&(e=!0);var t=new Date(s);return[Os(t.getUTCFullYear().toString(),4,"0"),Os(t.getUTCMonth()+1,2,"0"),Os(t.getUTCDate(),2,"0"),"T",Os(t.getUTCHours(),2,"0"),Os(t.getUTCMinutes(),2,"0"),Os(t.getUTCSeconds(),2,"0"),e?"Z":""].join("")},yi=function(s){var e=/^(\d{4})(\d{2})(\d{2})(T(\d{2})(\d{2})(\d{2})Z?)?$/,t=e.exec(s);if(!t)throw new Error("Invalid UNTIL value: ".concat(s));return new Date(Date.UTC(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10),parseInt(t[5],10)||0,parseInt(t[6],10)||0,parseInt(t[7],10)||0))},co=function(s,e){var t=s.toLocaleString("sv-SE",{timeZone:e});return t.replace(" ","T")+"Z"},jv=function(s,e){var t=Intl.DateTimeFormat().resolvedOptions().timeZone,r=new Date(co(s,t)),n=new Date(co(s,e??"UTC")),a=n.getTime()-r.getTime();return new Date(s.getTime()-a)},Rs=function(){function s(e,t){this.minDate=null,this.maxDate=null,this._result=[],this.total=0,this.method=e,this.args=t,e==="between"?(this.maxDate=t.inc?t.before:new Date(t.before.getTime()-1),this.minDate=t.inc?t.after:new Date(t.after.getTime()+1)):e==="before"?this.maxDate=t.inc?t.dt:new Date(t.dt.getTime()-1):e==="after"&&(this.minDate=t.inc?t.dt:new Date(t.dt.getTime()+1))}return s.prototype.accept=function(e){++this.total;var t=this.minDate&&e<this.minDate,r=this.maxDate&&e>this.maxDate;if(this.method==="between"){if(t)return!0;if(r)return!1}else if(this.method==="before"){if(r)return!1}else if(this.method==="after")return t?!0:(this.add(e),!1);return this.add(e)},s.prototype.add=function(e){return this._result.push(e),!0},s.prototype.getValue=function(){var e=this._result;switch(this.method){case"all":case"between":return e;case"before":case"after":default:return e.length?e[e.length-1]:null}},s.prototype.clone=function(){return new s(this.method,this.args)},s}(),Pa=function(s,e){return Pa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])},Pa(s,e)};function mi(s,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Pa(s,e);function t(){this.constructor=s}s.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var $t=function(){return $t=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},$t.apply(this,arguments)};function $(s,e,t){if(t||arguments.length===2)for(var r=0,n=e.length,a;r<n;r++)(a||!(r in e))&&(a||(a=Array.prototype.slice.call(e,0,r)),a[r]=e[r]);return s.concat(a||Array.prototype.slice.call(e))}var uo=function(s){mi(e,s);function e(t,r,n){var a=s.call(this,t,r)||this;return a.iterator=n,a}return e.prototype.add=function(t){return this.iterator(t,this._result.length)?(this._result.push(t),!0):!1},e}(Rs),jn={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],tokens:{SKIP:/^[ \r\n\t]+|^\.$/,number:/^[1-9][0-9]*/,numberAsText:/^(one|two|three)/i,every:/^every/i,"day(s)":/^days?/i,"weekday(s)":/^weekdays?/i,"week(s)":/^weeks?/i,"hour(s)":/^hours?/i,"minute(s)":/^minutes?/i,"month(s)":/^months?/i,"year(s)":/^years?/i,on:/^(on|in)/i,at:/^(at)/i,the:/^the/i,first:/^first/i,second:/^second/i,third:/^third/i,nth:/^([1-9][0-9]*)(\.|th|nd|rd|st)/i,last:/^last/i,for:/^for/i,"time(s)":/^times?/i,until:/^(un)?til/i,monday:/^mo(n(day)?)?/i,tuesday:/^tu(e(s(day)?)?)?/i,wednesday:/^we(d(n(esday)?)?)?/i,thursday:/^th(u(r(sday)?)?)?/i,friday:/^fr(i(day)?)?/i,saturday:/^sa(t(urday)?)?/i,sunday:/^su(n(day)?)?/i,january:/^jan(uary)?/i,february:/^feb(ruary)?/i,march:/^mar(ch)?/i,april:/^apr(il)?/i,may:/^may/i,june:/^june?/i,july:/^july?/i,august:/^aug(ust)?/i,september:/^sep(t(ember)?)?/i,october:/^oct(ober)?/i,november:/^nov(ember)?/i,december:/^dec(ember)?/i,comma:/^(,\s*|(and|or)\s*)+/i}},ho=function(s,e){return s.indexOf(e)!==-1},Yv=function(s){return s.toString()},Hv=function(s,e,t){return"".concat(e," ").concat(t,", ").concat(s)},Ur=function(){function s(e,t,r,n){if(t===void 0&&(t=Yv),r===void 0&&(r=jn),n===void 0&&(n=Hv),this.text=[],this.language=r||jn,this.gettext=t,this.dateFormatter=n,this.rrule=e,this.options=e.options,this.origOptions=e.origOptions,this.origOptions.bymonthday){var a=[].concat(this.options.bymonthday),o=[].concat(this.options.bynmonthday);a.sort(function(h,p){return h-p}),o.sort(function(h,p){return p-h}),this.bymonthday=a.concat(o),this.bymonthday.length||(this.bymonthday=null)}if(ot(this.origOptions.byweekday)){var l=Gt(this.origOptions.byweekday)?this.origOptions.byweekday:[this.origOptions.byweekday],c=String(l);this.byweekday={allWeeks:l.filter(function(h){return!h.n}),someWeeks:l.filter(function(h){return!!h.n}),isWeekdays:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")===-1&&c.indexOf("SU")===-1,isEveryDay:c.indexOf("MO")!==-1&&c.indexOf("TU")!==-1&&c.indexOf("WE")!==-1&&c.indexOf("TH")!==-1&&c.indexOf("FR")!==-1&&c.indexOf("SA")!==-1&&c.indexOf("SU")!==-1};var u=function(h,p){return h.weekday-p.weekday};this.byweekday.allWeeks.sort(u),this.byweekday.someWeeks.sort(u),this.byweekday.allWeeks.length||(this.byweekday.allWeeks=null),this.byweekday.someWeeks.length||(this.byweekday.someWeeks=null)}else this.byweekday=null}return s.isFullyConvertible=function(e){var t=!0;if(!(e.options.freq in s.IMPLEMENTED)||e.origOptions.until&&e.origOptions.count)return!1;for(var r in e.origOptions){if(ho(["dtstart","tzid","wkst","freq"],r))return!0;if(!ho(s.IMPLEMENTED[e.options.freq],r))return!1}return t},s.prototype.isFullyConvertible=function(){return s.isFullyConvertible(this.rrule)},s.prototype.toString=function(){var e=this.gettext;if(!(this.options.freq in s.IMPLEMENTED))return e("RRule error: Unable to fully convert this rrule to text");if(this.text=[e("every")],this[pe.FREQUENCIES[this.options.freq]](),this.options.until){this.add(e("until"));var t=this.options.until;this.add(this.dateFormatter(t.getUTCFullYear(),this.language.monthNames[t.getUTCMonth()],t.getUTCDate()))}else this.options.count&&this.add(e("for")).add(this.options.count.toString()).add(this.plural(this.options.count)?e("times"):e("time"));return this.isFullyConvertible()||this.add(e("(~ approximate)")),this.text.join("")},s.prototype.HOURLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("hours"):e("hour"))},s.prototype.MINUTELY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("minutes"):e("minute"))},s.prototype.DAILY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()),this.byweekday&&this.byweekday.isWeekdays?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(this.plural(this.options.interval)?e("days"):e("day")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday?this._byweekday():this.origOptions.byhour&&this._byhour()},s.prototype.WEEKLY=function(){var e=this.gettext;this.options.interval!==1&&this.add(this.options.interval.toString()).add(this.plural(this.options.interval)?e("weeks"):e("week")),this.byweekday&&this.byweekday.isWeekdays?this.options.interval===1?this.add(this.plural(this.options.interval)?e("weekdays"):e("weekday")):this.add(e("on")).add(e("weekdays")):this.byweekday&&this.byweekday.isEveryDay?this.add(this.plural(this.options.interval)?e("days"):e("day")):(this.options.interval===1&&this.add(e("week")),this.origOptions.bymonth&&(this.add(e("in")),this._bymonth()),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.origOptions.byhour&&this._byhour())},s.prototype.MONTHLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()).add(e("months")),this.plural(this.options.interval)&&this.add(e("in"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("months"):e("month"))),this.bymonthday?this._bymonthday():this.byweekday&&this.byweekday.isWeekdays?this.add(e("on")).add(e("weekdays")):this.byweekday&&this._byweekday()},s.prototype.YEARLY=function(){var e=this.gettext;this.origOptions.bymonth?(this.options.interval!==1&&(this.add(this.options.interval.toString()),this.add(e("years"))),this._bymonth()):(this.options.interval!==1&&this.add(this.options.interval.toString()),this.add(this.plural(this.options.interval)?e("years"):e("year"))),this.bymonthday?this._bymonthday():this.byweekday&&this._byweekday(),this.options.byyearday&&this.add(e("on the")).add(this.list(this.options.byyearday,this.nth,e("and"))).add(e("day")),this.options.byweekno&&this.add(e("in")).add(this.plural(this.options.byweekno.length)?e("weeks"):e("week")).add(this.list(this.options.byweekno,void 0,e("and")))},s.prototype._bymonthday=function(){var e=this.gettext;this.byweekday&&this.byweekday.allWeeks?this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext,e("or"))).add(e("the")).add(this.list(this.bymonthday,this.nth,e("or"))):this.add(e("on the")).add(this.list(this.bymonthday,this.nth,e("and")))},s.prototype._byweekday=function(){var e=this.gettext;this.byweekday.allWeeks&&!this.byweekday.isWeekdays&&this.add(e("on")).add(this.list(this.byweekday.allWeeks,this.weekdaytext)),this.byweekday.someWeeks&&(this.byweekday.allWeeks&&this.add(e("and")),this.add(e("on the")).add(this.list(this.byweekday.someWeeks,this.weekdaytext,e("and"))))},s.prototype._byhour=function(){var e=this.gettext;this.add(e("at")).add(this.list(this.origOptions.byhour,void 0,e("and")))},s.prototype._bymonth=function(){this.add(this.list(this.options.bymonth,this.monthtext,this.gettext("and")))},s.prototype.nth=function(e){e=parseInt(e.toString(),10);var t,r=this.gettext;if(e===-1)return r("last");var n=Math.abs(e);switch(n){case 1:case 21:case 31:t=n+r("st");break;case 2:case 22:t=n+r("nd");break;case 3:case 23:t=n+r("rd");break;default:t=n+r("th")}return e<0?t+" "+r("last"):t},s.prototype.monthtext=function(e){return this.language.monthNames[e-1]},s.prototype.weekdaytext=function(e){var t=yr(e)?(e+1)%7:e.getJsWeekday();return(e.n?this.nth(e.n)+" ":"")+this.language.dayNames[t]},s.prototype.plural=function(e){return e%100!==1},s.prototype.add=function(e){return this.text.push(" "),this.text.push(e),this},s.prototype.list=function(e,t,r,n){var a=this;n===void 0&&(n=","),Gt(e)||(e=[e]);var o=function(c,u,h){for(var p="",v=0;v<c.length;v++)v!==0&&(v===c.length-1?p+=" "+h+" ":p+=u+" "),p+=c[v];return p};t=t||function(c){return c.toString()};var l=function(c){return t&&t.call(a,c)};return r?o(e.map(l),n,r):e.map(l).join(n+" ")},s}(),Wv=function(){function s(e){this.done=!0,this.rules=e}return s.prototype.start=function(e){return this.text=e,this.done=!1,this.nextSymbol()},s.prototype.isDone=function(){return this.done&&this.symbol===null},s.prototype.nextSymbol=function(){var e,t;this.symbol=null,this.value=null;do{if(this.done)return!1;var r=void 0;e=null;for(var n in this.rules){r=this.rules[n];var a=r.exec(this.text);a&&(e===null||a[0].length>e[0].length)&&(e=a,t=n)}if(e!=null&&(this.text=this.text.substr(e[0].length),this.text===""&&(this.done=!0)),e==null){this.done=!0,this.symbol=null,this.value=null;return}}while(t==="SKIP");return this.symbol=t,this.value=e,!0},s.prototype.accept=function(e){if(this.symbol===e){if(this.value){var t=this.value;return this.nextSymbol(),t}return this.nextSymbol(),!0}return!1},s.prototype.acceptNumber=function(){return this.accept("number")},s.prototype.expect=function(e){if(this.accept(e))return!0;throw new Error("expected "+e+" but found "+this.symbol)},s}();function zl(s,e){e===void 0&&(e=jn);var t={},r=new Wv(e.tokens);if(!r.start(s))return null;return n(),t;function n(){r.expect("every");var v=r.acceptNumber();if(v&&(t.interval=parseInt(v[0],10)),r.isDone())throw new Error("Unexpected end");switch(r.symbol){case"day(s)":t.freq=pe.DAILY,r.nextSymbol()&&(o(),p());break;case"weekday(s)":t.freq=pe.WEEKLY,t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR],r.nextSymbol(),o(),p();break;case"week(s)":t.freq=pe.WEEKLY,r.nextSymbol()&&(a(),o(),p());break;case"hour(s)":t.freq=pe.HOURLY,r.nextSymbol()&&(a(),p());break;case"minute(s)":t.freq=pe.MINUTELY,r.nextSymbol()&&(a(),p());break;case"month(s)":t.freq=pe.MONTHLY,r.nextSymbol()&&(a(),p());break;case"year(s)":t.freq=pe.YEARLY,r.nextSymbol()&&(a(),p());break;case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":t.freq=pe.WEEKLY;var y=r.symbol.substr(0,2).toUpperCase();if(t.byweekday=[pe[y]],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var k=c();if(!k)throw new Error("Unexpected symbol "+r.symbol+", expected weekday");t.byweekday.push(pe[k]),r.nextSymbol()}o(),h(),p();break;case"january":case"february":case"march":case"april":case"may":case"june":case"july":case"august":case"september":case"october":case"november":case"december":if(t.freq=pe.YEARLY,t.bymonth=[l()],!r.nextSymbol())return;for(;r.accept("comma");){if(r.isDone())throw new Error("Unexpected end");var m=l();if(!m)throw new Error("Unexpected symbol "+r.symbol+", expected month");t.bymonth.push(m),r.nextSymbol()}a(),p();break;default:throw new Error("Unknown symbol")}}function a(){var v=r.accept("on"),y=r.accept("the");if(v||y)do{var k=u(),m=c(),g=l();if(k)m?(r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m].nth(k))):(t.bymonthday||(t.bymonthday=[]),t.bymonthday.push(k),r.accept("day(s)"));else if(m)r.nextSymbol(),t.byweekday||(t.byweekday=[]),t.byweekday.push(pe[m]);else if(r.symbol==="weekday(s)")r.nextSymbol(),t.byweekday||(t.byweekday=[pe.MO,pe.TU,pe.WE,pe.TH,pe.FR]);else if(r.symbol==="week(s)"){r.nextSymbol();var _=r.acceptNumber();if(!_)throw new Error("Unexpected symbol "+r.symbol+", expected week number");for(t.byweekno=[parseInt(_[0],10)];r.accept("comma");){if(_=r.acceptNumber(),!_)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.byweekno.push(parseInt(_[0],10))}}else if(g)r.nextSymbol(),t.bymonth||(t.bymonth=[]),t.bymonth.push(g);else return}while(r.accept("comma")||r.accept("the")||r.accept("on"))}function o(){var v=r.accept("at");if(v)do{var y=r.acceptNumber();if(!y)throw new Error("Unexpected symbol "+r.symbol+", expected hour");for(t.byhour=[parseInt(y[0],10)];r.accept("comma");){if(y=r.acceptNumber(),!y)throw new Error("Unexpected symbol "+r.symbol+"; expected hour");t.byhour.push(parseInt(y[0],10))}}while(r.accept("comma")||r.accept("at"))}function l(){switch(r.symbol){case"january":return 1;case"february":return 2;case"march":return 3;case"april":return 4;case"may":return 5;case"june":return 6;case"july":return 7;case"august":return 8;case"september":return 9;case"october":return 10;case"november":return 11;case"december":return 12;default:return!1}}function c(){switch(r.symbol){case"monday":case"tuesday":case"wednesday":case"thursday":case"friday":case"saturday":case"sunday":return r.symbol.substr(0,2).toUpperCase();default:return!1}}function u(){switch(r.symbol){case"last":return r.nextSymbol(),-1;case"first":return r.nextSymbol(),1;case"second":return r.nextSymbol(),r.accept("last")?-2:2;case"third":return r.nextSymbol(),r.accept("last")?-3:3;case"nth":var v=parseInt(r.value[1],10);if(v<-366||v>366)throw new Error("Nth out of range: "+v);return r.nextSymbol(),r.accept("last")?-v:v;default:return!1}}function h(){r.accept("on"),r.accept("the");var v=u();if(v)for(t.bymonthday=[v],r.nextSymbol();r.accept("comma");){if(v=u(),!v)throw new Error("Unexpected symbol "+r.symbol+"; expected monthday");t.bymonthday.push(v),r.nextSymbol()}}function p(){if(r.symbol==="until"){var v=Date.parse(r.text);if(!v)throw new Error("Cannot parse until date:"+r.text);t.until=new Date(v)}else r.accept("for")&&(t.count=parseInt(r.value[0],10),r.expect("number"))}}var Le;(function(s){s[s.YEARLY=0]="YEARLY",s[s.MONTHLY=1]="MONTHLY",s[s.WEEKLY=2]="WEEKLY",s[s.DAILY=3]="DAILY",s[s.HOURLY=4]="HOURLY",s[s.MINUTELY=5]="MINUTELY",s[s.SECONDLY=6]="SECONDLY"})(Le||(Le={}));function gi(s){return s<Le.HOURLY}var Kv=function(s,e){return e===void 0&&(e=jn),new pe(zl(s,e)||void 0)},en=["count","until","interval","byweekday","bymonthday","bymonth"];Ur.IMPLEMENTED=[];Ur.IMPLEMENTED[Le.HOURLY]=en;Ur.IMPLEMENTED[Le.MINUTELY]=en;Ur.IMPLEMENTED[Le.DAILY]=["byhour"].concat(en);Ur.IMPLEMENTED[Le.WEEKLY]=en;Ur.IMPLEMENTED[Le.MONTHLY]=en;Ur.IMPLEMENTED[Le.YEARLY]=["byweekno","byyearday"].concat(en);var Gv=function(s,e,t,r){return new Ur(s,e,t,r).toString()},Qv=Ur.isFullyConvertible,Yn=function(){function s(e,t,r,n){this.hour=e,this.minute=t,this.second=r,this.millisecond=n||0}return s.prototype.getHours=function(){return this.hour},s.prototype.getMinutes=function(){return this.minute},s.prototype.getSeconds=function(){return this.second},s.prototype.getMilliseconds=function(){return this.millisecond},s.prototype.getTime=function(){return(this.hour*60*60+this.minute*60+this.second)*1e3+this.millisecond},s}(),$v=function(s){mi(e,s);function e(t,r,n,a,o,l,c){var u=s.call(this,a,o,l,c)||this;return u.year=t,u.month=r,u.day=n,u}return e.fromDate=function(t){return new this(t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds(),t.valueOf()%1e3)},e.prototype.getWeekday=function(){return Vs(new Date(this.getTime()))},e.prototype.getTime=function(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond)).getTime()},e.prototype.getDay=function(){return this.day},e.prototype.getMonth=function(){return this.month},e.prototype.getYear=function(){return this.year},e.prototype.addYears=function(t){this.year+=t},e.prototype.addMonths=function(t){if(this.month+=t,this.month>12){var r=Math.floor(this.month/12),n=nr(this.month,12);this.month=n,this.year+=r,this.month===0&&(this.month=12,--this.year)}},e.prototype.addWeekly=function(t,r){r>this.getWeekday()?this.day+=-(this.getWeekday()+1+(6-r))+t*7:this.day+=-(this.getWeekday()-r)+t*7,this.fixDay()},e.prototype.addDaily=function(t){this.day+=t,this.fixDay()},e.prototype.addHours=function(t,r,n){for(r&&(this.hour+=Math.floor((23-this.hour)/t)*t);;){this.hour+=t;var a=ha(this.hour,24),o=a.div,l=a.mod;if(o&&(this.hour=l,this.addDaily(o)),wr(n)||Ke(n,this.hour))break}},e.prototype.addMinutes=function(t,r,n,a){for(r&&(this.minute+=Math.floor((1439-(this.hour*60+this.minute))/t)*t);;){this.minute+=t;var o=ha(this.minute,60),l=o.div,c=o.mod;if(l&&(this.minute=c,this.addHours(l,!1,n)),(wr(n)||Ke(n,this.hour))&&(wr(a)||Ke(a,this.minute)))break}},e.prototype.addSeconds=function(t,r,n,a,o){for(r&&(this.second+=Math.floor((86399-(this.hour*3600+this.minute*60+this.second))/t)*t);;){this.second+=t;var l=ha(this.second,60),c=l.div,u=l.mod;if(c&&(this.second=u,this.addMinutes(c,!1,n,a)),(wr(n)||Ke(n,this.hour))&&(wr(a)||Ke(a,this.minute))&&(wr(o)||Ke(o,this.second)))break}},e.prototype.fixDay=function(){if(!(this.day<=28)){var t=oo(this.year,this.month-1)[1];if(!(this.day<=t))for(;this.day>t;){if(this.day-=t,++this.month,this.month===13&&(this.month=1,++this.year,this.year>Ll))return;t=oo(this.year,this.month-1)[1]}}},e.prototype.add=function(t,r){var n=t.freq,a=t.interval,o=t.wkst,l=t.byhour,c=t.byminute,u=t.bysecond;switch(n){case Le.YEARLY:return this.addYears(a);case Le.MONTHLY:return this.addMonths(a);case Le.WEEKLY:return this.addWeekly(a,o);case Le.DAILY:return this.addDaily(a);case Le.HOURLY:return this.addHours(a,r,l);case Le.MINUTELY:return this.addMinutes(a,r,l,c);case Le.SECONDLY:return this.addSeconds(a,r,l,c,u)}},e}(Yn);function jl(s){for(var e=[],t=Object.keys(s),r=0,n=t;r<n.length;r++){var a=n[r];Ke(Dp,a)||e.push(a),Pl(s[a])&&!nn(s[a])&&e.push(a)}if(e.length)throw new Error("Invalid options: "+e.join(", "));return $t({},s)}function Vv(s){var e=$t($t({},bi),jl(s));if(ot(e.byeaster)&&(e.freq=pe.YEARLY),!(ot(e.freq)&&pe.FREQUENCIES[e.freq]))throw new Error("Invalid frequency: ".concat(e.freq," ").concat(s.freq));if(e.dtstart||(e.dtstart=new Date(new Date().setMilliseconds(0))),ot(e.wkst)?yr(e.wkst)||(e.wkst=e.wkst.weekday):e.wkst=pe.MO.weekday,ot(e.bysetpos)){yr(e.bysetpos)&&(e.bysetpos=[e.bysetpos]);for(var t=0;t<e.bysetpos.length;t++){var r=e.bysetpos[t];if(r===0||!(r>=-366&&r<=366))throw new Error("bysetpos must be between 1 and 366, or between -366 and -1")}}if(!(e.byweekno||pt(e.byweekno)||pt(e.byyearday)||e.bymonthday||pt(e.bymonthday)||ot(e.byweekday)||ot(e.byeaster)))switch(e.freq){case pe.YEARLY:e.bymonth||(e.bymonth=e.dtstart.getUTCMonth()+1),e.bymonthday=e.dtstart.getUTCDate();break;case pe.MONTHLY:e.bymonthday=e.dtstart.getUTCDate();break;case pe.WEEKLY:e.byweekday=[Vs(e.dtstart)];break}if(ot(e.bymonth)&&!Gt(e.bymonth)&&(e.bymonth=[e.bymonth]),ot(e.byyearday)&&!Gt(e.byyearday)&&yr(e.byyearday)&&(e.byyearday=[e.byyearday]),!ot(e.bymonthday))e.bymonthday=[],e.bynmonthday=[];else if(Gt(e.bymonthday)){for(var n=[],a=[],t=0;t<e.bymonthday.length;t++){var r=e.bymonthday[t];r>0?n.push(r):r<0&&a.push(r)}e.bymonthday=n,e.bynmonthday=a}else e.bymonthday<0?(e.bynmonthday=[e.bymonthday],e.bymonthday=[]):(e.bynmonthday=[],e.bymonthday=[e.bymonthday]);if(ot(e.byweekno)&&!Gt(e.byweekno)&&(e.byweekno=[e.byweekno]),!ot(e.byweekday))e.bynweekday=null;else if(yr(e.byweekday))e.byweekday=[e.byweekday],e.bynweekday=null;else if(io(e.byweekday))e.byweekday=[Lt.fromStr(e.byweekday).weekday],e.bynweekday=null;else if(e.byweekday instanceof Lt)!e.byweekday.n||e.freq>pe.MONTHLY?(e.byweekday=[e.byweekday.weekday],e.bynweekday=null):(e.bynweekday=[[e.byweekday.weekday,e.byweekday.n]],e.byweekday=null);else{for(var o=[],l=[],t=0;t<e.byweekday.length;t++){var c=e.byweekday[t];if(yr(c)){o.push(c);continue}else if(io(c)){o.push(Lt.fromStr(c).weekday);continue}!c.n||e.freq>pe.MONTHLY?o.push(c.weekday):l.push([c.weekday,c.n])}e.byweekday=pt(o)?o:null,e.bynweekday=pt(l)?l:null}return ot(e.byhour)?yr(e.byhour)&&(e.byhour=[e.byhour]):e.byhour=e.freq<pe.HOURLY?[e.dtstart.getUTCHours()]:null,ot(e.byminute)?yr(e.byminute)&&(e.byminute=[e.byminute]):e.byminute=e.freq<pe.MINUTELY?[e.dtstart.getUTCMinutes()]:null,ot(e.bysecond)?yr(e.bysecond)&&(e.bysecond=[e.bysecond]):e.bysecond=e.freq<pe.SECONDLY?[e.dtstart.getUTCSeconds()]:null,{parsedOptions:e}}function Xv(s){var e=s.dtstart.getTime()%1e3;if(!gi(s.freq))return[];var t=[];return s.byhour.forEach(function(r){s.byminute.forEach(function(n){s.bysecond.forEach(function(a){t.push(new Yn(r,n,a,e))})})}),t}function Ba(s){var e=s.split(`
`).map(Zv).filter(function(t){return t!==null});return $t($t({},e[0]),e[1])}function Hn(s){var e={},t=/DTSTART(?:;TZID=([^:=]+?))?(?::|=)([^;\s]+)/i.exec(s);if(!t)return e;var r=t[1],n=t[2];return r&&(e.tzid=r),e.dtstart=yi(n),e}function Zv(s){if(s=s.replace(/^\s+|\s+$/,""),!s.length)return null;var e=/^([A-Z]+?)[:;]/.exec(s.toUpperCase());if(!e)return fo(s);var t=e[1];switch(t.toUpperCase()){case"RRULE":case"EXRULE":return fo(s);case"DTSTART":return Hn(s);default:throw new Error("Unsupported RFC prop ".concat(t," in ").concat(s))}}function fo(s){var e=s.replace(/^RRULE:/i,""),t=Hn(e),r=s.replace(/^(?:RRULE|EXRULE):/i,"").split(";");return r.forEach(function(n){var a=n.split("="),o=a[0],l=a[1];switch(o.toUpperCase()){case"FREQ":t.freq=Le[l.toUpperCase()];break;case"WKST":t.wkst=dr[l.toUpperCase()];break;case"COUNT":case"INTERVAL":case"BYSETPOS":case"BYMONTH":case"BYMONTHDAY":case"BYYEARDAY":case"BYWEEKNO":case"BYHOUR":case"BYMINUTE":case"BYSECOND":var c=Jv(l),u=o.toLowerCase();t[u]=c;break;case"BYWEEKDAY":case"BYDAY":t.byweekday=ep(l);break;case"DTSTART":case"TZID":var h=Hn(s);t.tzid=h.tzid,t.dtstart=h.dtstart;break;case"UNTIL":t.until=yi(l);break;case"BYEASTER":t.byeaster=Number(l);break;default:throw new Error("Unknown RRULE property '"+o+"'")}}),t}function Jv(s){if(s.indexOf(",")!==-1){var e=s.split(",");return e.map(vo)}return vo(s)}function vo(s){return/^[+-]?\d+$/.test(s)?Number(s):s}function ep(s){var e=s.split(",");return e.map(function(t){if(t.length===2)return dr[t];var r=t.match(/^([+-]?\d{1,2})([A-Z]{2})$/);if(!r||r.length<3)throw new SyntaxError("Invalid weekday string: ".concat(t));var n=Number(r[1]),a=r[2],o=dr[a].weekday;return new Lt(o,n)})}var Wn=function(){function s(e,t){if(isNaN(e.getTime()))throw new RangeError("Invalid date passed to DateWithZone");this.date=e,this.tzid=t}return Object.defineProperty(s.prototype,"isUTC",{get:function(){return!this.tzid||this.tzid.toUpperCase()==="UTC"},enumerable:!1,configurable:!0}),s.prototype.toString=function(){var e=pi(this.date.getTime(),this.isUTC);return this.isUTC?":".concat(e):";TZID=".concat(this.tzid,":").concat(e)},s.prototype.getTime=function(){return this.date.getTime()},s.prototype.rezonedDate=function(){return this.isUTC?this.date:jv(this.date,this.tzid)},s}();function Ua(s){for(var e=[],t="",r=Object.keys(s),n=Object.keys(bi),a=0;a<r.length;a++)if(r[a]!=="tzid"&&Ke(n,r[a])){var o=r[a].toUpperCase(),l=s[r[a]],c="";if(!(!ot(l)||Gt(l)&&!l.length)){switch(o){case"FREQ":c=pe.FREQUENCIES[s.freq];break;case"WKST":yr(l)?c=new Lt(l).toString():c=l.toString();break;case"BYWEEKDAY":o="BYDAY",c=Lv(l).map(function(y){return y instanceof Lt?y:Gt(y)?new Lt(y[0],y[1]):new Lt(y)}).toString();break;case"DTSTART":t=tp(l,s.tzid);break;case"UNTIL":c=pi(l,!s.tzid);break;default:if(Gt(l)){for(var u=[],h=0;h<l.length;h++)u[h]=String(l[h]);c=u.toString()}else c=String(l)}c&&e.push([o,c])}}var p=e.map(function(y){var k=y[0],m=y[1];return"".concat(k,"=").concat(m.toString())}).join(";"),v="";return p!==""&&(v="RRULE:".concat(p)),[t,v].filter(function(y){return!!y}).join(`
`)}function tp(s,e){return s?"DTSTART"+new Wn(new Date(s),e).toString():""}function rp(s,e){return Array.isArray(s)?!Array.isArray(e)||s.length!==e.length?!1:s.every(function(t,r){return t.getTime()===e[r].getTime()}):s instanceof Date?e instanceof Date&&s.getTime()===e.getTime():s===e}var sp=function(){function s(){this.all=!1,this.before=[],this.after=[],this.between=[]}return s.prototype._cacheAdd=function(e,t,r){t&&(t=t instanceof Date?Fa(t):lo(t)),e==="all"?this.all=t:(r._value=t,this[e].push(r))},s.prototype._cacheGet=function(e,t){var r=!1,n=t?Object.keys(t):[],a=function(h){for(var p=0;p<n.length;p++){var v=n[p];if(!rp(t[v],h[v]))return!0}return!1},o=this[e];if(e==="all")r=this.all;else if(Gt(o))for(var l=0;l<o.length;l++){var c=o[l];if(!(n.length&&a(c))){r=c._value;break}}if(!r&&this.all){for(var u=new Rs(e,t),l=0;l<this.all.length&&u.accept(this.all[l]);l++);r=u.getValue(),this._cacheAdd(e,r,t)}return Gt(r)?lo(r):r instanceof Date?Fa(r):r},s}(),np=$($($($($($($($($($($($($([],Re(1,31),!0),Re(2,28),!0),Re(3,31),!0),Re(4,30),!0),Re(5,31),!0),Re(6,30),!0),Re(7,31),!0),Re(8,31),!0),Re(9,30),!0),Re(10,31),!0),Re(11,30),!0),Re(12,31),!0),Re(1,7),!0),ap=$($($($($($($($($($($($($([],Re(1,31),!0),Re(2,29),!0),Re(3,31),!0),Re(4,30),!0),Re(5,31),!0),Re(6,30),!0),Re(7,31),!0),Re(8,31),!0),Re(9,30),!0),Re(10,31),!0),Re(11,30),!0),Re(12,31),!0),Re(1,7),!0),ip=Sr(1,29),op=Sr(1,30),$r=Sr(1,31),Ct=Sr(1,32),lp=$($($($($($($($($($($($($([],Ct,!0),op,!0),Ct,!0),$r,!0),Ct,!0),$r,!0),Ct,!0),Ct,!0),$r,!0),Ct,!0),$r,!0),Ct,!0),Ct.slice(0,7),!0),cp=$($($($($($($($($($($($($([],Ct,!0),ip,!0),Ct,!0),$r,!0),Ct,!0),$r,!0),Ct,!0),Ct,!0),$r,!0),Ct,!0),$r,!0),Ct,!0),Ct.slice(0,7),!0),up=Sr(-28,0),dp=Sr(-29,0),Vr=Sr(-30,0),It=Sr(-31,0),hp=$($($($($($($($($($($($($([],It,!0),dp,!0),It,!0),Vr,!0),It,!0),Vr,!0),It,!0),It,!0),Vr,!0),It,!0),Vr,!0),It,!0),It.slice(0,7),!0),fp=$($($($($($($($($($($($($([],It,!0),up,!0),It,!0),Vr,!0),It,!0),Vr,!0),It,!0),It,!0),Vr,!0),It,!0),Vr,!0),It,!0),It.slice(0,7),!0),vp=[0,31,60,91,121,152,182,213,244,274,305,335,366],pp=[0,31,59,90,120,151,181,212,243,273,304,334,365],po=function(){for(var s=[],e=0;e<55;e++)s=s.concat(Sr(7));return s}();function yp(s,e){var t=ws(s,1,1),r=un(s)?366:365,n=un(s+1)?366:365,a=La(t),o=Vs(t),l=$t($t({yearlen:r,nextyearlen:n,yearordinal:a,yearweekday:o},mp(s)),{wnomask:null});if(wr(e.byweekno))return l;l.wnomask=Re(0,r+7);var c,u,h=c=nr(7-o+e.wkst,7);h>=4?(h=0,u=l.yearlen+nr(o-e.wkst,7)):u=r-h;for(var p=Math.floor(u/7),v=nr(u,7),y=Math.floor(p+v/4),k=0;k<e.byweekno.length;k++){var m=e.byweekno[k];if(m<0&&(m+=y+1),m>0&&m<=y){var g=void 0;m>1?(g=h+(m-1)*7,h!==c&&(g-=7-c)):g=h;for(var _=0;_<7&&(l.wnomask[g]=1,g++,l.wdaymask[g]!==e.wkst);_++);}}if(Ke(e.byweekno,1)){var g=h+y*7;if(h!==c&&(g-=7-c),g<r)for(var k=0;k<7&&(l.wnomask[g]=1,g+=1,l.wdaymask[g]!==e.wkst);k++);}if(h){var D=void 0;if(Ke(e.byweekno,-1))D=-1;else{var E=Vs(ws(s-1,1,1)),x=nr(7-E.valueOf()+e.wkst,7),R=un(s-1)?366:365,U=void 0;x>=4?(x=0,U=R+nr(E-e.wkst,7)):U=r-h,D=Math.floor(52+nr(U,7)/4)}if(Ke(e.byweekno,D))for(var g=0;g<h;g++)l.wnomask[g]=1}return l}function mp(s){var e=un(s)?366:365,t=ws(s,1,1),r=Vs(t);return e===365?{mmask:np,mdaymask:cp,nmdaymask:fp,wdaymask:po.slice(r),mrange:pp}:{mmask:ap,mdaymask:lp,nmdaymask:hp,wdaymask:po.slice(r),mrange:vp}}function gp(s,e,t,r,n,a){var o={lastyear:s,lastmonth:e,nwdaymask:[]},l=[];if(a.freq===pe.YEARLY)if(wr(a.bymonth))l=[[0,t]];else for(var c=0;c<a.bymonth.length;c++)e=a.bymonth[c],l.push(r.slice(e-1,e+1));else a.freq===pe.MONTHLY&&(l=[r.slice(e-1,e+1)]);if(wr(l))return o;o.nwdaymask=Re(0,t);for(var c=0;c<l.length;c++)for(var u=l[c],h=u[0],p=u[1]-1,v=0;v<a.bynweekday.length;v++){var y=void 0,k=a.bynweekday[v],m=k[0],g=k[1];g<0?(y=p+(g+1)*7,y-=nr(n[y]-m,7)):(y=h+(g-1)*7,y+=nr(7-n[y]+m,7)),h<=y&&y<=p&&(o.nwdaymask[y]=1)}return o}function bp(s,e){e===void 0&&(e=0);var t=s%19,r=Math.floor(s/100),n=s%100,a=Math.floor(r/4),o=r%4,l=Math.floor((r+8)/25),c=Math.floor((r-l+1)/3),u=Math.floor(19*t+r-a-c+15)%30,h=Math.floor(n/4),p=n%4,v=Math.floor(32+2*o+2*h-u-p)%7,y=Math.floor((t+11*u+22*v)/451),k=Math.floor((u+v-7*y+114)/31),m=(u+v-7*y+114)%31+1,g=Date.UTC(s,k-1,m+e),_=Date.UTC(s,0,1);return[Math.ceil((g-_)/(1e3*60*60*24))]}var _p=function(){function s(e){this.options=e}return s.prototype.rebuild=function(e,t){var r=this.options;if(e!==this.lastyear&&(this.yearinfo=yp(e,r)),pt(r.bynweekday)&&(t!==this.lastmonth||e!==this.lastyear)){var n=this.yearinfo,a=n.yearlen,o=n.mrange,l=n.wdaymask;this.monthinfo=gp(e,t,a,o,l,r)}ot(r.byeaster)&&(this.eastermask=bp(e,r.byeaster))},Object.defineProperty(s.prototype,"lastyear",{get:function(){return this.monthinfo?this.monthinfo.lastyear:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"lastmonth",{get:function(){return this.monthinfo?this.monthinfo.lastmonth:null},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearlen",{get:function(){return this.yearinfo.yearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"yearordinal",{get:function(){return this.yearinfo.yearordinal},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mrange",{get:function(){return this.yearinfo.mrange},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wdaymask",{get:function(){return this.yearinfo.wdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mmask",{get:function(){return this.yearinfo.mmask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"wnomask",{get:function(){return this.yearinfo.wnomask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nwdaymask",{get:function(){return this.monthinfo?this.monthinfo.nwdaymask:[]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nextyearlen",{get:function(){return this.yearinfo.nextyearlen},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"mdaymask",{get:function(){return this.yearinfo.mdaymask},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"nmdaymask",{get:function(){return this.yearinfo.nmdaymask},enumerable:!1,configurable:!0}),s.prototype.ydayset=function(){return[Sr(this.yearlen),0,this.yearlen]},s.prototype.mdayset=function(e,t){for(var r=this.mrange[t-1],n=this.mrange[t],a=Re(null,this.yearlen),o=r;o<n;o++)a[o]=o;return[a,r,n]},s.prototype.wdayset=function(e,t,r){for(var n=Re(null,this.yearlen+7),a=La(ws(e,t,r))-this.yearordinal,o=a,l=0;l<7&&(n[a]=a,++a,this.wdaymask[a]!==this.options.wkst);l++);return[n,o,a]},s.prototype.ddayset=function(e,t,r){var n=Re(null,this.yearlen),a=La(ws(e,t,r))-this.yearordinal;return n[a]=a,[n,a,a+1]},s.prototype.htimeset=function(e,t,r,n){var a=this,o=[];return this.options.byminute.forEach(function(l){o=o.concat(a.mtimeset(e,l,r,n))}),yn(o),o},s.prototype.mtimeset=function(e,t,r,n){var a=this.options.bysecond.map(function(o){return new Yn(e,t,o,n)});return yn(a),a},s.prototype.stimeset=function(e,t,r,n){return[new Yn(e,t,r,n)]},s.prototype.getdayset=function(e){switch(e){case Le.YEARLY:return this.ydayset.bind(this);case Le.MONTHLY:return this.mdayset.bind(this);case Le.WEEKLY:return this.wdayset.bind(this);case Le.DAILY:return this.ddayset.bind(this);default:return this.ddayset.bind(this)}},s.prototype.gettimeset=function(e){switch(e){case Le.HOURLY:return this.htimeset.bind(this);case Le.MINUTELY:return this.mtimeset.bind(this);case Le.SECONDLY:return this.stimeset.bind(this)}},s}();function kp(s,e,t,r,n,a){for(var o=[],l=0;l<s.length;l++){var c=void 0,u=void 0,h=s[l];h<0?(c=Math.floor(h/e.length),u=nr(h,e.length)):(c=Math.floor((h-1)/e.length),u=nr(h-1,e.length));for(var p=[],v=t;v<r;v++){var y=a[v];ot(y)&&p.push(y)}var k=void 0;c<0?k=p.slice(c)[0]:k=p[c];var m=e[u],g=Bl(n.yearordinal+k),_=Ul(g,m);Ke(o,_)||o.push(_)}return yn(o),o}function Yl(s,e){var t=e.dtstart,r=e.freq,n=e.interval,a=e.until,o=e.bysetpos,l=e.count;if(l===0||n===0)return Er(s);var c=$v.fromDate(t),u=new _p(e);u.rebuild(c.year,c.month);for(var h=Sp(u,c,e);;){var p=u.getdayset(r)(c.year,c.month,c.day),v=p[0],y=p[1],k=p[2],m=Tp(v,y,k,u,e);if(pt(o))for(var g=kp(o,h,y,k,u,v),_=0;_<g.length;_++){var D=g[_];if(a&&D>a)return Er(s);if(D>=t){var E=yo(D,e);if(!s.accept(E)||l&&(--l,!l))return Er(s)}}else for(var _=y;_<k;_++){var x=v[_];if(ot(x))for(var R=Bl(u.yearordinal+x),U=0;U<h.length;U++){var N=h[U],D=Ul(R,N);if(a&&D>a)return Er(s);if(D>=t){var E=yo(D,e);if(!s.accept(E)||l&&(--l,!l))return Er(s)}}}if(e.interval===0||(c.add(e,m),c.year>Ll))return Er(s);gi(r)||(h=u.gettimeset(r)(c.hour,c.minute,c.second,0)),u.rebuild(c.year,c.month)}}function wp(s,e,t){var r=t.bymonth,n=t.byweekno,a=t.byweekday,o=t.byeaster,l=t.bymonthday,c=t.bynmonthday,u=t.byyearday;return pt(r)&&!Ke(r,s.mmask[e])||pt(n)&&!s.wnomask[e]||pt(a)&&!Ke(a,s.wdaymask[e])||pt(s.nwdaymask)&&!s.nwdaymask[e]||o!==null&&!Ke(s.eastermask,e)||(pt(l)||pt(c))&&!Ke(l,s.mdaymask[e])&&!Ke(c,s.nmdaymask[e])||pt(u)&&(e<s.yearlen&&!Ke(u,e+1)&&!Ke(u,-s.yearlen+e)||e>=s.yearlen&&!Ke(u,e+1-s.yearlen)&&!Ke(u,-s.nextyearlen+e-s.yearlen))}function yo(s,e){return new Wn(s,e.tzid).rezonedDate()}function Er(s){return s.getValue()}function Tp(s,e,t,r,n){for(var a=!1,o=e;o<t;o++){var l=s[o];a=wp(r,l,n),a&&(s[l]=null)}return a}function Sp(s,e,t){var r=t.freq,n=t.byhour,a=t.byminute,o=t.bysecond;return gi(r)?Xv(t):r>=pe.HOURLY&&pt(n)&&!Ke(n,e.hour)||r>=pe.MINUTELY&&pt(a)&&!Ke(a,e.minute)||r>=pe.SECONDLY&&pt(o)&&!Ke(o,e.second)?[]:s.gettimeset(r)(e.hour,e.minute,e.second,e.millisecond)}var dr={MO:new Lt(0),TU:new Lt(1),WE:new Lt(2),TH:new Lt(3),FR:new Lt(4),SA:new Lt(5),SU:new Lt(6)},bi={freq:Le.YEARLY,dtstart:null,interval:1,wkst:dr.MO,count:null,until:null,tzid:null,bysetpos:null,bymonth:null,bymonthday:null,bynmonthday:null,byyearday:null,byweekno:null,byweekday:null,bynweekday:null,byhour:null,byminute:null,bysecond:null,byeaster:null},Dp=Object.keys(bi),pe=function(){function s(e,t){e===void 0&&(e={}),t===void 0&&(t=!1),this._cache=t?null:new sp,this.origOptions=jl(e);var r=Vv(e).parsedOptions;this.options=r}return s.parseText=function(e,t){return zl(e,t)},s.fromText=function(e,t){return Kv(e,t)},s.fromString=function(e){return new s(s.parseString(e)||void 0)},s.prototype._iter=function(e){return Yl(e,this.options)},s.prototype._cacheGet=function(e,t){return this._cache?this._cache._cacheGet(e,t):!1},s.prototype._cacheAdd=function(e,t,r){if(this._cache)return this._cache._cacheAdd(e,t,r)},s.prototype.all=function(e){if(e)return this._iter(new uo("all",{},e));var t=this._cacheGet("all");return t===!1&&(t=this._iter(new Rs("all",{})),this._cacheAdd("all",t)),t},s.prototype.between=function(e,t,r,n){if(r===void 0&&(r=!1),!nn(e)||!nn(t))throw new Error("Invalid date passed in to RRule.between");var a={before:t,after:e,inc:r};if(n)return this._iter(new uo("between",a,n));var o=this._cacheGet("between",a);return o===!1&&(o=this._iter(new Rs("between",a)),this._cacheAdd("between",o,a)),o},s.prototype.before=function(e,t){if(t===void 0&&(t=!1),!nn(e))throw new Error("Invalid date passed in to RRule.before");var r={dt:e,inc:t},n=this._cacheGet("before",r);return n===!1&&(n=this._iter(new Rs("before",r)),this._cacheAdd("before",n,r)),n},s.prototype.after=function(e,t){if(t===void 0&&(t=!1),!nn(e))throw new Error("Invalid date passed in to RRule.after");var r={dt:e,inc:t},n=this._cacheGet("after",r);return n===!1&&(n=this._iter(new Rs("after",r)),this._cacheAdd("after",n,r)),n},s.prototype.count=function(){return this.all().length},s.prototype.toString=function(){return Ua(this.origOptions)},s.prototype.toText=function(e,t,r){return Gv(this,e,t,r)},s.prototype.isFullyConvertibleToText=function(){return Qv(this)},s.prototype.clone=function(){return new s(this.origOptions)},s.FREQUENCIES=["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"],s.YEARLY=Le.YEARLY,s.MONTHLY=Le.MONTHLY,s.WEEKLY=Le.WEEKLY,s.DAILY=Le.DAILY,s.HOURLY=Le.HOURLY,s.MINUTELY=Le.MINUTELY,s.SECONDLY=Le.SECONDLY,s.MO=dr.MO,s.TU=dr.TU,s.WE=dr.WE,s.TH=dr.TH,s.FR=dr.FR,s.SA=dr.SA,s.SU=dr.SU,s.parseString=Ba,s.optionsToString=Ua,s}();function Ep(s,e,t,r,n,a){var o={},l=s.accept;function c(v,y){t.forEach(function(k){k.between(v,y,!0).forEach(function(m){o[Number(m)]=!0})})}n.forEach(function(v){var y=new Wn(v,a).rezonedDate();o[Number(y)]=!0}),s.accept=function(v){var y=Number(v);return isNaN(y)?l.call(this,v):!o[y]&&(c(new Date(y-1),new Date(y+1)),!o[y])?(o[y]=!0,l.call(this,v)):!0},s.method==="between"&&(c(s.args.after,s.args.before),s.accept=function(v){var y=Number(v);return o[y]?!0:(o[y]=!0,l.call(this,v))});for(var u=0;u<r.length;u++){var h=new Wn(r[u],a).rezonedDate();if(!s.accept(new Date(h.getTime())))break}e.forEach(function(v){Yl(s,v.options)});var p=s._result;switch(yn(p),s.method){case"all":case"between":return p;case"before":return p.length&&p[p.length-1]||null;case"after":default:return p.length&&p[0]||null}}var mo={dtstart:null,cache:!1,unfold:!1,forceset:!1,compatible:!1,tzid:null};function xp(s,e){var t=[],r=[],n=[],a=[],o=Hn(s),l=o.dtstart,c=o.tzid,u=Mp(s,e.unfold);return u.forEach(function(h){var p;if(h){var v=Op(h),y=v.name,k=v.parms,m=v.value;switch(y.toUpperCase()){case"RRULE":if(k.length)throw new Error("unsupported RRULE parm: ".concat(k.join(",")));t.push(Ba(h));break;case"RDATE":var g=(p=/RDATE(?:;TZID=([^:=]+))?/i.exec(h))!==null&&p!==void 0?p:[],_=g[1];_&&!c&&(c=_),r=r.concat(go(m,k));break;case"EXRULE":if(k.length)throw new Error("unsupported EXRULE parm: ".concat(k.join(",")));n.push(Ba(m));break;case"EXDATE":a=a.concat(go(m,k));break;case"DTSTART":break;default:throw new Error("unsupported property: "+y)}}}),{dtstart:l,tzid:c,rrulevals:t,rdatevals:r,exrulevals:n,exdatevals:a}}function Ap(s,e){var t=xp(s,e),r=t.rrulevals,n=t.rdatevals,a=t.exrulevals,o=t.exdatevals,l=t.dtstart,c=t.tzid,u=e.cache===!1;if(e.compatible&&(e.forceset=!0,e.unfold=!0),e.forceset||r.length>1||n.length||a.length||o.length){var h=new qp(u);return h.dtstart(l),h.tzid(c||void 0),r.forEach(function(v){h.rrule(new pe(fa(v,l,c),u))}),n.forEach(function(v){h.rdate(v)}),a.forEach(function(v){h.exrule(new pe(fa(v,l,c),u))}),o.forEach(function(v){h.exdate(v)}),e.compatible&&e.dtstart&&h.rdate(l),h}var p=r[0]||{};return new pe(fa(p,p.dtstart||e.dtstart||l,p.tzid||e.tzid||c),u)}function za(s,e){return e===void 0&&(e={}),Ap(s,Cp(e))}function fa(s,e,t){return $t($t({},s),{dtstart:e,tzid:t})}function Cp(s){var e=[],t=Object.keys(s),r=Object.keys(mo);if(t.forEach(function(n){Ke(r,n)||e.push(n)}),e.length)throw new Error("Invalid options: "+e.join(", "));return $t($t({},mo),s)}function Ip(s){if(s.indexOf(":")===-1)return{name:"RRULE",value:s};var e=Fv(s,":",1),t=e[0],r=e[1];return{name:t,value:r}}function Op(s){var e=Ip(s),t=e.name,r=e.value,n=t.split(";");if(!n)throw new Error("empty property name");return{name:n[0].toUpperCase(),parms:n.slice(1),value:r}}function Mp(s,e){if(e===void 0&&(e=!1),s=s&&s.trim(),!s)throw new Error("Invalid empty string");if(!e)return s.split(/\s/);for(var t=s.split(`
`),r=0;r<t.length;){var n=t[r]=t[r].replace(/\s+$/g,"");n?r>0&&n[0]===" "?(t[r-1]+=n.slice(1),t.splice(r,1)):r+=1:t.splice(r,1)}return t}function Np(s){s.forEach(function(e){if(!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(e))throw new Error("unsupported RDATE/EXDATE parm: "+e)})}function go(s,e){return Np(e),s.split(",").map(function(t){return yi(t)})}function bo(s){var e=this;return function(t){if(t!==void 0&&(e["_".concat(s)]=t),e["_".concat(s)]!==void 0)return e["_".concat(s)];for(var r=0;r<e._rrule.length;r++){var n=e._rrule[r].origOptions[s];if(n)return n}}}var qp=function(s){mi(e,s);function e(t){t===void 0&&(t=!1);var r=s.call(this,{},t)||this;return r.dtstart=bo.apply(r,["dtstart"]),r.tzid=bo.apply(r,["tzid"]),r._rrule=[],r._rdate=[],r._exrule=[],r._exdate=[],r}return e.prototype._iter=function(t){return Ep(t,this._rrule,this._exrule,this._rdate,this._exdate,this.tzid())},e.prototype.rrule=function(t){_o(t,this._rrule)},e.prototype.exrule=function(t){_o(t,this._exrule)},e.prototype.rdate=function(t){ko(t,this._rdate)},e.prototype.exdate=function(t){ko(t,this._exdate)},e.prototype.rrules=function(){return this._rrule.map(function(t){return za(t.toString())})},e.prototype.exrules=function(){return this._exrule.map(function(t){return za(t.toString())})},e.prototype.rdates=function(){return this._rdate.map(function(t){return new Date(t.getTime())})},e.prototype.exdates=function(){return this._exdate.map(function(t){return new Date(t.getTime())})},e.prototype.valueOf=function(){var t=[];return!this._rrule.length&&this._dtstart&&(t=t.concat(Ua({dtstart:this._dtstart}))),this._rrule.forEach(function(r){t=t.concat(r.toString().split(`
`))}),this._exrule.forEach(function(r){t=t.concat(r.toString().split(`
`).map(function(n){return n.replace(/^RRULE:/,"EXRULE:")}).filter(function(n){return!/^DTSTART/.test(n)}))}),this._rdate.length&&t.push(wo("RDATE",this._rdate,this.tzid())),this._exdate.length&&t.push(wo("EXDATE",this._exdate,this.tzid())),t},e.prototype.toString=function(){return this.valueOf().join(`
`)},e.prototype.clone=function(){var t=new e(!!this._cache);return this._rrule.forEach(function(r){return t.rrule(r.clone())}),this._exrule.forEach(function(r){return t.exrule(r.clone())}),this._rdate.forEach(function(r){return t.rdate(new Date(r.getTime()))}),this._exdate.forEach(function(r){return t.exdate(new Date(r.getTime()))}),t},e}(pe);function _o(s,e){if(!(s instanceof pe))throw new TypeError(String(s)+" is not RRule instance");Ke(e.map(String),String(s))||e.push(s)}function ko(s,e){if(!(s instanceof Date))throw new TypeError(String(s)+" is not Date instance");Ke(e.map(Number),Number(s))||(e.push(s),yn(e))}function wo(s,e,t){var r=!t||t.toUpperCase()==="UTC",n=r?"".concat(s,":"):"".concat(s,";TZID=").concat(t,":"),a=e.map(function(o){return pi(o.valueOf(),r)}).join(",");return"".concat(n).concat(a)}function Rp(){return Intl.DateTimeFormat().resolvedOptions().timeZone}class Lp{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const r of e)Number.isFinite(r)&&r>=0&&r<=6&&t.add(Math.floor(r));return Array.from(t).sort((r,n)=>r-n)}normalizeDayOfMonth(e,t){const r=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(r,1),31)}normalizeMonth(e,t){const r=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(r,0),11)}calculateNext(e,t,r){if(r!=null&&r.timezone||Rp(),t.rruleString)return this.calculateNextWithRRule(e,t,r);const a=((r==null?void 0:r.whenDone)??t.whenDone??!1)&&(r!=null&&r.completionDate)?r.completionDate:e,{type:o,time:l}=t,c=this.normalizeInterval(t.interval);let u;switch(o){case"daily":u=this.calculateNextDaily(a,c);break;case"weekly":u=this.calculateNextWeekly(a,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":u=this.calculateNextMonthly(a,c,this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;case"yearly":u=this.calculateNextYearly(a,c,this.normalizeMonth(t.month,a.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,a.getDate()));break;default:throw new Error(`Unknown frequency type: ${o}`)}if(l){const{hours:h,minutes:p}=Ia(l);if(Number.isFinite(h)&&Number.isFinite(p)){const{date:v,shifted:y}=eo(u,h,p);y&&Qe("DST shift detected while applying recurrence time",{requestedTime:l,original:u.toISOString(),adjusted:v.toISOString()}),u=v}}return u}calculateNextWithRRule(e,t,r){try{const a=((r==null?void 0:r.whenDone)??t.whenDone??!1)&&(r!=null&&r.completionDate)?r.completionDate:e,l=za(t.rruleString).after(a,!1);if(!l){Qe("RRule returned no next occurrence, falling back to legacy logic",{rruleString:t.rruleString,baseDate:a.toISOString()});const{rruleString:u,naturalLanguage:h,...p}=t;return this.calculateNext(a,p,r)}let c=l;if(t.time){const{hours:u,minutes:h}=Ia(t.time);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:p,shifted:v}=eo(c,u,h);v&&Qe("DST shift detected while applying recurrence time",{requestedTime:t.time,original:c.toISOString(),adjusted:p.toISOString()}),c=p}}return c}catch(n){be("Failed to parse rrule, falling back to legacy logic",{error:n instanceof Error?n.message:String(n),rruleString:t.rruleString});const{rruleString:a,naturalLanguage:o,...l}=t;return this.calculateNext(e,l,r)}}calculateNextDaily(e,t){return vn(e,t)}calculateNextWeekly(e,t,r){if(!r||r.length===0)return Ji(e,t);const n=this.getMondayIndex(e),a=Math.min(la,t*14);for(let o=1;o<=a;o++){if(Math.floor((n+o)/7)%t!==0)continue;const c=vn(e,o),u=this.getMondayIndex(c);if(r.includes(u))return c}return Qe("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:r}),Ji(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,r){const n=r??e.getDate(),a=e.getFullYear(),l=e.getMonth()+t,c=a+Math.floor(l/12),u=(l%12+12)%12,h=new Date(c,u+1,0).getDate(),p=Math.min(n,h),v=new Date(e);return v.setFullYear(c,u,p),v}calculateNextYearly(e,t,r,n){const a=n??e.getDate(),o=e.getFullYear()+t,l=new Date(o,r+1,0).getDate(),c=Math.min(a,l),u=new Date(e);return u.setFullYear(o,r,c),u}getOccurrencesInRange(e,t,r,n){const a=[];let o=new Date(n),l=0;for(;o<=t&&l<la;)o>=e&&a.push(new Date(o)),o=this.calculateNext(o,r),l++;return a}getMissedOccurrences(e,t,r,n){const a=[];let o=new Date(n),l=0;for(;o<=e&&l<la;)o=this.calculateNext(o,r),l++;let c=0;for(;o<t&&c<qn;)a.push(new Date(o)),o=this.calculateNext(o,r),c++;return c>=qn&&Qe("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:r,firstOccurrence:n.toISOString(),cap:qn}),a}}class Fp{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:r,minutes:n}=Ia(t);if(!Number.isFinite(r)||!Number.isFinite(n))return new Date(e);const a=new Date(e);return a.setHours(r,n,0,0),a}isSameLocalDay(e,t){const r=new Date(e),n=new Date(t);return r.getFullYear()===n.getFullYear()&&r.getMonth()===n.getMonth()&&r.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,r=e.getTime()-t.getTime(),n=Math.trunc(r/(1e3*60)),a=Math.trunc(r/(1e3*60*60)),o=Math.trunc(r/(1e3*60*60*24));return Math.abs(r)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(a)<24?a>0?`in ${a}h`:`${-a}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const r=new Date(e);return r.setDate(r.getDate()+t),r}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class Pp{constructor(e){w(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return de(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return Qe(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return Qe("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return Qe("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(r){return be("Failed to execute onCompletion action",{taskId:e.id,action:t,error:r}),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return Qe("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return be("Failed to check for nested items",{blockId:e,error:t}),!0}}}class Bp{constructor(e,t){w(this,"intervalMs");w(this,"timeoutId",null);w(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:ci,r=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},r)}}class Up{constructor(e,t=ci,r){w(this,"storage");w(this,"recurrenceEngine");w(this,"onCompletionHandler");w(this,"emittedDue",new Set);w(this,"emittedMissed",new Set);w(this,"timezoneHandler");w(this,"isChecking",!1);w(this,"lastCheckStartTime",0);w(this,"plugin",null);w(this,"listeners",{"task:due":new Set,"task:overdue":new Set});w(this,"MAX_EMITTED_ENTRIES",1e3);w(this,"EMITTED_RETENTION_DAYS",30);w(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);w(this,"persistTimeoutId",null);w(this,"emittedStateReady",null);w(this,"timer");this.storage=e,this.recurrenceEngine=new Lp,this.onCompletionHandler=new Pp(r),this.timezoneHandler=new Fp,this.plugin=r||null,this.timer=new Bp(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),de("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),de("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Qe("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const r of t){if(!this.isActive(r))continue;const n=new Date(r.dueAt),a=n<=e;if(a){const l=this.buildOccurrenceKey(r.id,n,"hour");this.emittedDue.has(l)||(this.emitEvent("task:due",{taskId:r.id,dueAt:n,context:"today",task:r}),this.registerEmittedKey("due",l),de(`Task due: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}const o=r.lastCompletedAt?new Date(r.lastCompletedAt):null;if(a&&e.getTime()-n.getTime()>=Lu&&(!o||o<n)){const l=this.buildOccurrenceKey(r.id,n,"hour");this.emittedMissed.has(l)||(this.emitEvent("task:overdue",{taskId:r.id,dueAt:n,context:"overdue",task:r}),this.registerEmittedKey("missed",l),Qe(`Task missed: ${r.name}`,{taskId:r.id,dueAt:r.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){const e=new Date;e.setDate(e.getDate()-this.EMITTED_RETENTION_DAYS);const t=this.pruneEmittedSet("due",this.emittedDue,e),r=this.pruneEmittedSet("missed",this.emittedMissed,e);this.emittedDue=t.set,this.emittedMissed=r.set,(t.didTrim||r.didTrim)&&this.schedulePersistEmittedState()}pruneEmittedSet(e,t,r){const n=r.getTime(),a=Array.from(t).map(u=>({entry:u,time:this.parseOccurrenceKeyTimestamp(u)}));let o=a.filter(({time:u})=>u===null||u>=n),l=o.length!==a.length;o.length>this.MAX_EMITTED_ENTRIES&&(o=o.sort((u,h)=>(u.time??0)-(h.time??0)).slice(-this.MAX_EMITTED_ENTRIES),l=!0);const c=new Set(o.map(({entry:u})=>u));return l&&de(`Cleaned up emitted${e==="due"?"Due":"Missed"} set: ${t.size} -> ${c.size}`),{set:c,didTrim:l}}parseOccurrenceKeyTimestamp(e){const t=e.indexOf(":");if(t===-1)return null;const r=e.slice(t+1);if(!r)return null;const n=r.length===13?`${r}:00:00.000Z`:r,a=new Date(n);return Number.isNaN(a.getTime())?null:a.getTime()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const r=new Date;t.doneAt=r.toISOString(),Gu(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const a=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,a);if(o.success||be(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:a,error:o.error}),o.warnings)for(const u of o.warnings)Qe(u,{taskId:t.id});const l=new Date(t.dueAt),c=this.recurrenceEngine.calculateNext(l,t.frequency,{completionDate:r,whenDone:t.whenDone});t.dueAt=c.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),de(`Task "${t.name}" completed and rescheduled to ${c.toISOString()}`)}async delayTask(e,t){const r=this.storage.getTask(e);if(!r)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(r);const n=new Date(r.dueAt),a=new Date(n.getTime()+t*60*1e3);r.dueAt=a.toISOString(),r.snoozeCount=(r.snoozeCount||0)+1,await this.storage.saveTask(r),de(`Task "${r.name}" delayed by ${t} minutes to ${a.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const r=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(r.getHours(),r.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),de(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);El(t);const r=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(r,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),de(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),de("First run detected, no recovery needed");return}de(`Recovering missed tasks since ${e.toISOString()}`);for(const r of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,r.frequency,new Date(r.createdAt));for(const a of n){const o=this.buildOccurrenceKey(r.id,a,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:r.id,dueAt:a,context:"overdue",task:r}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(r,t)}catch(n){be(`Failed to recover task ${r.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),de("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const r=new Date(e.dueAt);if(r>=t)return;let n=r,a=0;for(;n<t&&a<qn;)n=this.recurrenceEngine.calculateNext(n,e.frequency),a++;n>r&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),de(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Ki);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){be("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Ki,{timestamp:e.toISOString()})}catch(t){be("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const r=this.listeners[e];for(const n of r)try{const a=n(t);a instanceof Promise&&a.catch(o=>{be(`Scheduler listener error for ${e}:`,o)})}catch(a){be(`Scheduler listener error for ${e}:`,a)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Fu,r=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(r>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(zi),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],r=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(r.slice(-this.MAX_EMITTED_ENTRIES)),de("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){be("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(zi,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){be("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,r){return r==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const zp=7,jp=2e3;class Yp{constructor(e,t){w(this,"plugin");w(this,"storageKey");w(this,"notifications",new Map);w(this,"escalations",new Map);w(this,"lastCleanup",new Date);w(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const r of t.notifications)this.notifications.set(r.taskKey,r);if(Array.isArray(t.escalations))for(const r of t.escalations)this.escalations.set(r.taskId,r);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),de(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){be("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Al("Saved notification state")}catch(e){be("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>jp&&Array.from(this.notifications.keys()).slice(0,100).forEach(r=>this.notifications.delete(r))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const r=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:r,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,r}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const r=new Date(t);return`${e}:${r.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const r=new Date(e.getTime()-zp*24*60*60*1e3);let n=0;for(const[a,o]of this.notifications.entries())new Date(o.notifiedAt)<r&&(this.notifications.delete(a),n++);n>0&&(de(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function Hp(s){return{id:s.id,name:s.name,dueAt:s.dueAt,frequency:s.frequency,linkedBlockId:s.linkedBlockId,linkedBlockContent:s.linkedBlockContent,priority:s.priority,tags:s.tags,notificationChannels:s.notificationChannels,completionCount:s.completionCount,missCount:s.missCount,currentStreak:s.currentStreak,bestStreak:s.bestStreak}}const Wp=30*1e3,Kp=30*60*1e3,ss=500;class Gp{constructor(e,t={}){w(this,"plugin");w(this,"config");w(this,"queue",[]);w(this,"dedupeKeys",new Set);w(this,"flushIntervalId",null);w(this,"fetcher");w(this,"notificationState");w(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...Ca},this.notificationState=t.notificationState??new Yp(this.plugin,Nu)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Bi);e&&(this.config={...Ca,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Bi,e)}async loadQueue(){try{const e=await this.plugin.loadData(Ui);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>ss){const r=this.queue.length-ss;this.queue=this.queue.slice(-ss),console.warn(`Event queue trimmed to ${ss} entries (dropped ${r}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-oa);await this.plugin.saveData(Ui,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Ru))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,r),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const r=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,r),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,r=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const a=this.buildPayload(e,t,n,1,r);await this.sendPayload(a)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(a)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:ji,version:Yi,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},r=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return r.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${r.status}: ${r.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const r=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){r.push(n);continue}const a={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(a))this.markDelivered(a.delivery.dedupeKey),t=!0;else{const l=n.attempt+1,c=this.getRetryDelay(l);r.push({...n,attempt:l,nextAttemptAt:new Date(e+c).toISOString()}),t=!0}}t&&(this.queue=r,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,r,n,a=0){const o=new Date,l=new Date(t.dueAt),c=o.getTime()-l.getTime();return{event:e,source:ji,version:Yi,occurredAt:o.toISOString(),task:Hp(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:c>0?c:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:a,channels:t.notificationChannels||[]},delivery:{dedupeKey:r,attempt:n}}}buildDedupeKey(e,t){const r=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${r}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>oa){const t=Array.from(this.dedupeKeys).slice(-oa);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=ss){const r=this.queue.length-ss+1;this.queue.splice(0,r),console.warn(`Event queue capped at ${ss}. Dropped ${r} oldest entr${r===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=Wp*Math.pow(2,e-1);return Math.min(t,Kp)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const r=new TextEncoder,n=r.encode(t),a=r.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),l=await crypto.subtle.sign("HMAC",o,a);return Array.from(new Uint8Array(l)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(r){return console.error("Failed to generate signature:",r),""}}async buildHeaders(e){const t=JSON.stringify(e),r=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+r,this.config.n8n.sharedSecret));const a={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":r};return n&&(a["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(a["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),a}async sendPayload(e,t=!1){try{const r=JSON.stringify(e),n=await this.buildHeaders(e),a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:r});if(!a.ok)return console.error("n8n webhook failed:",a.statusText),!1;if(t){const o=await a.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(r){return console.error("Failed to send n8n event:",r),!1}}}const At={dates:{autoAddCreated:!1,autoAddDone:!0,autoAddCancelled:!0},recurrence:{newTaskPosition:"below",removeScheduledOnRecurrence:!1,preserveOriginalTime:!0},dependencies:{warnOnCycles:!0,autoValidate:!0},filenameDate:{enabled:!1,patterns:["YYYY-MM-DD","YYYYMMDD"],folders:["daily/","journal/"],targetField:"scheduled"},globalFilter:pn,globalQuery:Un,urgency:ui,smartRecurrence:{enabled:!0,autoAdjust:!1,minCompletionsForLearning:10,confidenceThreshold:.7},naturalLanguage:{enabled:!0,showConfidenceScore:!0,provideExamples:!0},crossNoteDependencies:{enabled:!0,checkInterval:5,notifyWhenMet:!0}};function To(s){var e,t,r,n,a;return{dates:{...At.dates,...s.dates},recurrence:{...At.recurrence,...s.recurrence},dependencies:{...At.dependencies,...s.dependencies},filenameDate:{...At.filenameDate,...s.filenameDate},globalFilter:{...At.globalFilter,...s.globalFilter,excludeFolders:((e=s.globalFilter)==null?void 0:e.excludeFolders)??At.globalFilter.excludeFolders,excludeNotebooks:((t=s.globalFilter)==null?void 0:t.excludeNotebooks)??At.globalFilter.excludeNotebooks,excludeTags:((r=s.globalFilter)==null?void 0:r.excludeTags)??At.globalFilter.excludeTags,excludeFilePatterns:((n=s.globalFilter)==null?void 0:n.excludeFilePatterns)??At.globalFilter.excludeFilePatterns,excludeStatusTypes:((a=s.globalFilter)==null?void 0:a.excludeStatusTypes)??At.globalFilter.excludeStatusTypes},globalQuery:{...At.globalQuery,...s.globalQuery},urgency:{...At.urgency,...s.urgency},smartRecurrence:{...At.smartRecurrence,...s.smartRecurrence},naturalLanguage:{...At.naturalLanguage,...s.naturalLanguage},crossNoteDependencies:{...At.crossNoteDependencies,...s.crossNoteDependencies}}}const va="plugin-settings";class Qp{constructor(e){w(this,"plugin");w(this,"settings");this.plugin=e,this.settings=At}async load(){try{const e=await this.plugin.loadData(va);e&&typeof e=="object"&&(this.settings=To(e))}catch(e){console.error("Failed to load plugin settings:",e)}}async save(e){this.settings=e,await this.plugin.saveData(va,e),ze.emit("task:refresh",void 0)}get(){return this.settings}async update(e){this.settings=To(e),await this.plugin.saveData(va,this.settings),ze.emit("task:refresh",void 0)}}const Hr=class Hr{constructor(e){w(this,"plugin");w(this,"isInitialized",!1);w(this,"storage");w(this,"repository");w(this,"scheduler");w(this,"eventService");w(this,"settingsService");this.plugin=e}static getInstance(e){if(!Hr.instance){if(!e)return null;Hr.instance=new Hr(e)}return Hr.instance}async initialize(){if(this.isInitialized){Qe("TaskManager already initialized");return}de("Initializing TaskManager"),this.settingsService=new Qp(this.plugin),await this.settingsService.load();const e=this.settingsService.get();zn.getInstance().initialize(e.globalFilter),$s.getInstance().initialize(e.globalQuery),this.storage=new qv(this.plugin),await this.storage.init(),this.repository=new Rv(this.storage),this.eventService=new Gp(this.plugin),await this.eventService.init(),this.scheduler=new Up(this.storage,ci,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,de("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:r})=>e(r)),t&&this.scheduler.on("task:overdue",({task:r})=>t(r)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),de("TaskManager started")}async destroy(){de("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,Hr.instance=null,de("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}getSettingsService(){return this.ensureInitialized(),this.settingsService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};w(Hr,"instance",null);let Kn=Hr;function $p(s){let t=`- [${s.status==="done"?"x":" "}] ${s.name}`;if(s.dueAt){const r=new Date(s.dueAt);t+=` 📅 ${r.toISOString().split("T")[0]}`}return s.frequency&&(t+=` 🔁 every ${s.frequency.interval} ${s.frequency.type}${s.frequency.interval>1?"s":""}`),t}class Vp{constructor(e,t,r,n){this.storage=e,this.recurrenceEngine=t,this.settings=r,this.siyuanApi=n}async onComplete(e,t){try{const r=[],n=this.addCompletionDate(e,t);let a;return e.frequency&&(a=await this.generateNextInstance(n,t),a&&(await this.placeNextInstance(n,a)||r.push("Could not place next instance in document (API unavailable)"),await this.storage.saveTask(a))),e.onCompletion==="delete"?await this.hasNestedItems(e.linkedBlockId)?(Qe("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),await this.storage.saveTask(n),r.push("Task has nested items - kept instead of deleted")):await this.deleteTask(e):await this.storage.saveTask(n),{success:!0,nextTask:a,warnings:r.length>0?r:void 0}}catch(r){return be("Failed to handle task completion",{taskId:e.id,error:r}),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}addCompletionDate(e,t){const r={...e},n=t.toISOString();return e.status==="done"&&this.settings.dates.autoAddDone?(r.doneAt=n,r.cancelledAt=void 0):e.status==="cancelled"&&this.settings.dates.autoAddCancelled&&(r.cancelledAt=n,r.doneAt=void 0),r}async generateNextInstance(e,t){if(e.frequency)try{const r=new Date(e.dueAt),n=this.recurrenceEngine.calculateNext(r,e.frequency,{completionDate:t,whenDone:e.frequency.whenDone||e.whenDone}),a=Dl(e,{dueAt:n.toISOString(),status:"todo",doneAt:void 0,cancelledAt:void 0,linkedBlockId:void 0,linkedBlockContent:void 0});return this.settings.recurrence.removeScheduledOnRecurrence&&(a.scheduledAt=void 0),a}catch(r){be("Failed to generate next recurrence instance",{taskId:e.id,frequency:e.frequency,error:r});return}}async placeNextInstance(e,t){if(!e.linkedBlockId)return Qe("Original task has no linkedBlockId, cannot place next instance"),!1;if(!this.siyuanApi)return Qe("SiYuan API not available, cannot place next instance"),!1;const r=this.settings.recurrence.newTaskPosition,n=$p(t);try{let a;return r==="above"&&this.siyuanApi.insertBlockAbove?a=await this.siyuanApi.insertBlockAbove(e.linkedBlockId,n):r==="below"&&this.siyuanApi.insertBlockBelow&&(a=await this.siyuanApi.insertBlockBelow(e.linkedBlockId,n)),a!=null&&a.id?(t.linkedBlockId=a.id,t.linkedBlockContent=n,!0):!1}catch(a){return be("Failed to place next instance in document",{taskId:e.id,placement:r,error:a}),!1}}async hasNestedItems(e){var t;if(!e||!((t=this.siyuanApi)!=null&&t.getChildBlocks))return!1;try{const r=await this.siyuanApi.getChildBlocks({id:e});return r&&r.length>0}catch(r){return be("Failed to check for nested items",{blockId:e,error:r}),!1}}async deleteTask(e){var t;if(await this.storage.deleteTask(e.id),e.linkedBlockId&&((t=this.siyuanApi)!=null&&t.deleteBlock))try{await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),de("Task deleted from document and storage",{taskId:e.id,blockId:e.linkedBlockId})}catch(r){be("Failed to delete task from document",{taskId:e.id,blockId:e.linkedBlockId,error:r})}else de("Task deleted from storage only (no linked block)",{taskId:e.id})}}class Xp{constructor(e,t,r,n){w(this,"completionHandler");this.repository=e,this.recurrenceEngine=t,this.getSettings=r,this.siyuanApi=n,t&&r&&(this.completionHandler=new Vp(e,t,r(),n))}get settings(){var e;return(e=this.getSettings)==null?void 0:e.call(this)}async toggleStatus(e){var t,r;try{const n=this.repository.getTask(e);if(!n){Q.error("Task not found");return}const a=vr.getInstance(),o=n.statusSymbol||" ",l=a.getNextSymbol(o),c={...n,statusSymbol:l},u=a.getStatus(l);if(u.type==="DONE"){if(c.status="done",n.frequency&&this.completionHandler){const h=await this.completionHandler.onComplete(c,new Date);h.success?(h.nextTask?(de("Next recurrence created",{taskId:c.id,nextTaskId:h.nextTask.id,nextDue:h.nextTask.dueAt}),Q.success("Task completed - next occurrence scheduled")):Q.success(`Task status updated to ${u.name}`),h.warnings&&h.warnings.forEach(p=>Q.warning(p))):Q.error(`Failed to complete task: ${h.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!c.doneAt&&(c.doneAt=new Date().toISOString()),await this.repository.saveTask(c),Q.success(`Task status updated to ${u.name}`);ze.emit("task:updated",{taskId:e})}else u.type==="CANCELLED"?(c.status="cancelled",(r=this.settings)!=null&&r.dates.autoAddCancelled&&!c.cancelledAt&&(c.cancelledAt=new Date().toISOString()),await this.repository.saveTask(c),ze.emit("task:updated",{taskId:e}),Q.success(`Task status updated to ${u.name}`)):u.type==="TODO"&&(c.status="todo",await this.repository.saveTask(c),ze.emit("task:updated",{taskId:e}),Q.success(`Task status updated to ${u.name}`))}catch(n){be("Failed to toggle task status",n),Q.error("Failed to toggle status")}}async completeTask(e){var t;try{const r=this.repository.getTask(e);if(!r){Q.error("Task not found");return}const n={...r,status:"done"};if(r.frequency&&this.completionHandler){const a=await this.completionHandler.onComplete(n,new Date);a.success?(a.nextTask?(de("Next recurrence created",{taskId:n.id,nextTaskId:a.nextTask.id,nextDue:a.nextTask.dueAt}),Q.success(`Task "${r.name}" completed - next occurrence scheduled`)):Q.success(`Task "${r.name}" completed`),a.warnings&&a.warnings.forEach(o=>Q.warning(o))):Q.error(`Failed to complete task: ${a.error}`)}else(t=this.settings)!=null&&t.dates.autoAddDone&&!n.doneAt&&(n.doneAt=new Date().toISOString()),await this.repository.saveTask(n),Q.success(`Task "${r.name}" completed`);ze.emit("task:complete",{taskId:e})}catch(r){be("Failed to complete task",r),Q.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){Q.error("Task not found");return}const n=this.repository.getAllTasks().filter(a=>{var o,l;return((o=a.blockedBy)==null?void 0:o.includes(e))||((l=a.dependsOn)==null?void 0:l.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),ze.emit("task:deleted",{taskId:e}),Q.success(`Task "${t.name}" deleted`)}catch(t){be("Failed to delete task",t),Q.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){Q.error("Task not found");return}const r=new Date;r.setHours(12,0,0,0);const n={...t,scheduledAt:r.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),ze.emit("task:updated",{taskId:e}),Q.success("Task rescheduled to today")}catch(t){be("Failed to reschedule task",t),Q.error("Failed to reschedule task")}}async deferTask(e,t){try{const r=this.repository.getTask(e);if(!r){Q.error("Task not found");return}const n={...r,updatedAt:new Date().toISOString()};if(r.dueAt){const a=new Date(r.dueAt);a.setDate(a.getDate()+t),n.dueAt=a.toISOString()}if(r.scheduledAt){const a=new Date(r.scheduledAt);a.setDate(a.getDate()+t),n.scheduledAt=a.toISOString()}await this.repository.saveTask(n),ze.emit("task:updated",{taskId:e}),Q.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(r){be("Failed to defer task",r),Q.error("Failed to defer task")}}}class Zp{constructor(e,t,r){w(this,"plugin");w(this,"storageKey");w(this,"settings");w(this,"defaults");this.plugin=e,this.storageKey=t,this.defaults={...r},this.settings={...r}}async load(){try{const e=await this.plugin.loadData(this.storageKey);e&&(this.settings={...this.defaults,...e})}catch(e){console.error(`Failed to load settings from ${this.storageKey}:`,e),this.settings={...this.defaults}}return this.settings}async save(e){e&&(this.settings=e);try{await this.plugin.saveData(this.storageKey,this.settings)}catch(t){throw console.error(`Failed to save settings to ${this.storageKey}:`,t),t}}get(){return{...this.settings}}async set(e,t){this.settings[e]=t,await this.save()}async reset(){this.settings={...this.defaults},await this.save()}has(e){return e in this.settings}getValue(e){return this.settings[e]}}const Ns=[{id:"quickAddTask",langKey:"quickAddTask",label:"Quick add recurring task",description:"Open the quick add dialog with focus on the task title.",defaultHotkey:"Ctrl+Shift+T",context:"Global / Editor"},{id:"markTaskDone",langKey:"markTaskDone",label:"Mark task as done",description:"Complete the focused task and trigger recurrence.",defaultHotkey:"Ctrl+Enter",context:"Task focus / Task block"},{id:"postponeTask",langKey:"postponeTask",label:"Postpone task",description:"Open the snooze selector for the focused task.",defaultHotkey:"Ctrl+Shift+P",context:"Task focus"},{id:"openRecurringTasksDock",langKey:"openRecurringTasksDock",label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",defaultHotkey:"Ctrl+Shift+O",context:"Global"},{id:"createRecurringTask",langKey:"createRecurringTask",label:"Create recurring task from selection",description:"Create a recurring task based on the current editor block.",defaultHotkey:"Ctrl+Shift+R",context:"Editor"},{id:"quickCompleteNextTask",langKey:"quickCompleteNextTask",label:"Quick complete next task",description:"Marks the most overdue task as complete.",defaultHotkey:"Ctrl+Shift+D",context:"Global"},{id:"toggleTaskStatus",langKey:"toggleTaskStatus",label:"Toggle task status",description:"Cycle the status of the focused task.",defaultHotkey:"Ctrl+Shift+X",context:"Task focus"},{id:"openTaskEditor",langKey:"openTaskEditor",label:"Open task editor",description:"Open the full task editor modal.",defaultHotkey:"Ctrl+Shift+E",context:"Global"}],pa=Ns.reduce((s,e)=>(s[e.id]=e.defaultHotkey,s),{});function ja(s,e){ze.emit("task:snooze",{taskId:s,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:e}})),de(`Snoozing task ${s} for ${e} minutes`)}function Jp(s){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const r=Ma(t),n=Math.max(0,Math.floor((r.getTime()-e.getTime())/(60*1e3)));ze.emit("task:snooze",{taskId:s,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:n}})),de(`Snoozing task ${s} to tomorrow`)}function ey(s){s.eventBus.on("click-blockicon",({detail:e})=>{var o,l,c;const t=e.blockElements;if(!t||t.length===0)return;const r=t[0],n=r==null?void 0:r.getAttribute("data-node-id");if(!n)return;const a=(r==null?void 0:r.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=s.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{ze.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ya(a),suggestedTime:Ha(a)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:a,suggestedName:Ya(a),suggestedTime:Ha(a)}}))}});try{const u=Kn.getInstance();if(u&&u.isReady()){const p=u.getRepository().getTaskByBlockId(n);if(p){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((l=s.i18n)==null?void 0:l.completeTask)||"Complete Task",click:()=>{ze.emit("task:complete",{taskId:p.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:p.id}}))}});const v=[{label:"15 minutes",click:()=>ja(p.id,15)},{label:"1 hour",click:()=>ja(p.id,60)},{label:"Tomorrow",click:()=>Jp(p.id)}];e.menu.addItem({icon:"iconClock",label:((c=s.i18n)==null?void 0:c.snoozeTask)||"Snooze Task",submenu:v})}}}catch{Al("TaskManager not available for quick actions")}}),de("Registered block context menu")}function Ya(s){const e=s.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function Ha(s){var r;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=s.match(e);if(t){let n=parseInt(t[1],10);const a=t[2],o=(r=t[3])==null?void 0:r.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${a}`}return null}const ty="recurring-task-shortcuts",ry=350;class sy{constructor(e,t,r,n,a){w(this,"settingsStore");w(this,"settings",{...pa});w(this,"taskCommands");w(this,"cooldownTimers",new Map);this.plugin=e,this.repository=t,this.handlers=a,this.settingsStore=new Zp(e,ty,pa),this.taskCommands=new Xp(t,r,n,void 0)}async initialize(){this.settings=await this.settingsStore.load()}registerShortcuts(){Ns.forEach(e=>{const t=this.settings[e.id]||e.defaultHotkey;this.plugin.addCommand({langKey:e.langKey,hotkey:t,callback:()=>{this.handleShortcut(e.id)}})}),de("Registered shortcut commands",{shortcuts:Ns.map(e=>({id:e.id,hotkey:this.settings[e.id]}))})}getShortcutDisplay(){return Ns.map(e=>({id:e.id,label:e.label,description:e.description,context:e.context,currentHotkey:this.settings[e.id]||"",defaultHotkey:e.defaultHotkey}))}async updateShortcut(e,t){const r=t.trim(),n=this.findDuplicateHotkey(e,r);return n?{success:!1,message:`Hotkey already assigned to "${n.label}".`}:(this.settings={...this.settings,[e]:r},await this.settingsStore.save(this.settings),this.registerShortcuts(),{success:!0})}async resetShortcut(e){const t=this.getDefinition(e);t&&(this.settings={...this.settings,[e]:t.defaultHotkey},await this.settingsStore.save(this.settings),this.registerShortcuts())}async resetAllShortcuts(){this.settings={...pa},await this.settingsStore.save(this.settings),this.registerShortcuts()}destroy(){this.cooldownTimers.forEach(e=>globalThis.clearTimeout(e)),this.cooldownTimers.clear()}async handleShortcut(e){if(!this.shouldIgnoreShortcut(e))switch(e){case"quickAddTask":this.guardCooldown(e,ry,()=>{this.handlers.createTask(this.buildCreatePayload("shortcut"))});break;case"createRecurringTask":this.handlers.createTask(this.buildCreatePayload("shortcut"));break;case"openRecurringTasksDock":this.handlers.openDock();break;case"markTaskDone":{const t=this.resolveTaskId();if(!t)return;await this.handlers.completeTask(t);break}case"postponeTask":{const t=this.resolveTaskId();if(!t)return;this.handlers.postponeTask(t);break}case"quickCompleteNextTask":await this.quickCompleteNextTask();break;case"toggleTaskStatus":{const t=this.resolveTaskId();if(!t)return;await this.taskCommands.toggleStatus(t);break}case"openTaskEditor":this.handlers.openTaskEditor();break}}guardCooldown(e,t,r){if(this.cooldownTimers.has(e))return;r();const n=globalThis.setTimeout(()=>{this.cooldownTimers.delete(e)},t);this.cooldownTimers.set(e,n)}shouldIgnoreShortcut(e){const t=document.activeElement;if(!t)return!1;const r=t.tagName.toLowerCase();return["input","textarea","select"].includes(r)?!0:t.isContentEditable?!this.isEditorAllowedShortcut(e):!1}isEditorAllowedShortcut(e){return e==="quickAddTask"||e==="createRecurringTask"}resolveTaskId(){const e=this.getFocusedTaskId();if(e)return e;const t=this.getSelectedBlockContext();if(!t)return null;const r=this.repository.getTaskByBlockId(t.blockId);return(r==null?void 0:r.id)??null}getFocusedTaskId(){const e=document.activeElement;if(!e)return null;const t=e.closest("[data-task-id]");return(t==null?void 0:t.dataset.taskId)??null}getSelectedBlockContext(){const e=window.getSelection(),t=e==null?void 0:e.anchorNode;if(!t)return null;const r=t instanceof HTMLElement?t:t.parentElement;if(!r)return null;const n=r.closest("[data-node-id]");if(!n)return null;const a=n.getAttribute("data-node-id");return a?{blockId:a,blockContent:n.textContent||""}:null}buildCreatePayload(e){const t=this.getSelectedBlockContext();return t?{source:e,linkedBlockId:t.blockId,linkedBlockContent:t.blockContent,suggestedName:Ya(t.blockContent),suggestedTime:Ha(t.blockContent)}:{source:e}}async quickCompleteNextTask(){try{const e=this.repository.getTodayAndOverdueTasks();if(e.length===0)return;const t=e[0];await this.taskCommands.completeTask(t.id)}catch(e){be("Failed to quick complete task",e),Q.error("Failed to complete task")}}getDefinition(e){return Ns.find(t=>t.id===e)}findDuplicateHotkey(e,t){if(!t)return null;const r=t.toLowerCase(),n=Ns.find(a=>a.id===e?!1:(this.settings[a.id]||"").toLowerCase()===r);return n?{id:n.id,label:n.label,description:n.description,context:n.context,currentHotkey:this.settings[n.id],defaultHotkey:n.defaultHotkey}:null}}async function ny(s,e,t,r,n){const a=new sy(s,e,r,n,t);return await a.initialize(),a.registerShortcuts(),a}class ay{constructor(e,t){w(this,"plugin");w(this,"repository");w(this,"topbarElement",null);w(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),de("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),de("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(r=>{const n=new Date(r.dueAt);return n<new Date&&!vi(n)}).length;if(e.length>0){const r=this.topbarElement.querySelector(".b3-badge");if(r)r.textContent=e.length.toString(),r.style.display="block",t>0?r.style.backgroundColor="var(--b3-theme-error)":r.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const r=this.topbarElement.querySelector(".b3-badge");r&&r.remove()}}toggleMenu(){ze.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class iy{constructor(e="tasks"){w(this,"codeLanguage");w(this,"cachedCodeBlocks",new WeakMap);w(this,"cachedAttributeBlocks",new WeakMap);this.codeLanguage=e.toLowerCase()}parse(e){const t=[];let r=this.cachedCodeBlocks.get(e);r||(r=e.querySelectorAll('[data-type="NodeCodeBlock"]'),this.cachedCodeBlocks.set(e,r)),r.forEach(a=>{var h;if((a.dataset.subtype||a.getAttribute("data-subtype")||"").toLowerCase()!==this.codeLanguage)return;const l=a.querySelector("code")||a.querySelector("textarea")||a.querySelector(".hljs")||a,c=((h=l==null?void 0:l.textContent)==null?void 0:h.trim())??"";if(!c)return;const u=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:u,query:c,element:a,source:"code"})});let n=this.cachedAttributeBlocks.get(e);return n||(n=e.querySelectorAll("[data-node-id]"),this.cachedAttributeBlocks.set(e,n)),n.forEach(a=>{if(a.classList.contains("rt-inline-query")||a.getAttribute("data-type")==="NodeCodeBlock")return;const o=this.parseAttributes(a);if(!o.query)return;const l=a.getAttribute("data-node-id")||`inline-query-${t.length}`;t.push({id:l,query:o.query,view:o.view,element:a,source:"attribute"})}),t}parseAttributes(e){var a;const t=e.getAttribute("custom-task-query")||e.getAttribute("data-attr-custom-task-query")||e.dataset.customTaskQuery||e.dataset.attrCustomTaskQuery,r=e.getAttribute("custom-task-view")||e.getAttribute("data-attr-custom-task-view")||e.dataset.customTaskView||e.dataset.attrCustomTaskView;if(t)return{query:t.trim(),view:r};const n=e.getAttribute("data-attrs");if(!n)return{};try{const o=JSON.parse(n),l=(a=o["custom-task-query"])==null?void 0:a.trim(),c=o["custom-task-view"];return{query:l,view:c}}catch{return{}}}}class oy{constructor(e=6e4,t=100){w(this,"cache",new Map);w(this,"metrics",{hits:0,misses:0,evictions:0});w(this,"maxSize");this.ttlMs=e,this.maxSize=t}buildKey(e,t){return`${e}::${t}`}get(e){const t=this.cache.get(e);return t?this.ttlMs>0&&Date.now()-t.updatedAt>this.ttlMs?(this.cache.delete(e),this.metrics.misses++,null):(t.lastAccessedAt=Date.now(),this.cache.delete(e),this.cache.set(e,t),this.metrics.hits++,t):(this.metrics.misses++,null)}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictLRU();const r=Date.now();this.cache.set(e,{result:t,updatedAt:r,lastAccessedAt:r})}clear(){this.cache.clear()}evictLRU(){const e=this.cache.keys().next().value;e&&(this.cache.delete(e),this.metrics.evictions++)}getMetrics(){return{hits:this.metrics.hits,misses:this.metrics.misses,size:this.cache.size,evictions:this.metrics.evictions}}resetMetrics(){this.metrics.hits=0,this.metrics.misses=0,this.metrics.evictions=0}}class ly{render(e,t){if(e.innerHTML="",e.classList.add("rt-inline-query"),e.dataset.query=t.query,e.dataset.view=t.view,e.setAttribute("role","region"),e.setAttribute("aria-label","Task query results"),t.isIndexing){e.appendChild(this.renderLoadingState());return}if(t.error){e.appendChild(this.renderErrorState(t.error));return}if(!t.result){e.appendChild(this.renderState("No results yet."));return}const r=t.result.tasks,n=r.length;if(n===0||r.length===0){e.appendChild(this.renderEmptyState());return}const a=document.createElement("div");a.className="rt-inline-query__header",a.textContent=`Inline Tasks · ${n}`,e.appendChild(a);const o=t.view||"list",l=t.result.groups;if(l&&l.size>0?l.forEach((c,u)=>{const h=this.renderGroupSection(u,c,o,t);e.appendChild(h)}):e.appendChild(this.renderTaskCollection(r,o,t)),typeof t.maxItems=="number"&&typeof t.renderedCount=="number"&&t.renderedCount<n){const c=document.createElement("div");c.className="rt-inline-query__footer";const u=document.createElement("button");u.type="button",u.className="rt-inline-query__more",u.dataset.rtAction="more",u.textContent=`Show more (${t.renderedCount}/${n})`,c.appendChild(u),e.appendChild(c)}}renderGroupSection(e,t,r,n){const a=document.createElement("section");a.className="rt-inline-query__group";const o=document.createElement("div");return o.className="rt-inline-query__group-title",o.textContent=e||"Untitled",a.appendChild(o),a.appendChild(this.renderTaskCollection(t,r,n)),a}renderTaskCollection(e,t,r){return t==="table"?this.renderTable(e,r):this.renderList(e,r)}renderList(e,t){const r=document.createElement("ul");r.className="rt-inline-query__list",r.setAttribute("role","list"),r.setAttribute("aria-label","Tasks");const n=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(o=>{const l=document.createElement("li");l.className="rt-inline-query__item",l.dataset.taskId=o.id;const c=document.createElement("button");c.type="button",c.className="rt-inline-query__checkbox",c.dataset.rtAction="toggle",c.setAttribute("aria-pressed",String(o.status==="done"));const u=o.status==="done"?`Mark incomplete: ${o.name.replace(/"/g,"'")}`:`Mark complete: ${o.name.replace(/"/g,"'")}`;c.setAttribute("aria-label",u),c.textContent=o.status==="done"?"☑":"☐";const h=document.createElement("span");h.className="rt-inline-query__title",h.textContent=o.name,o.status==="done"&&h.classList.add("rt-inline-query__title--done");const p=document.createElement("span");p.className="rt-inline-query__meta",p.textContent=this.formatTaskMeta(o);const v=this.renderSource(o),y=document.createElement("button");y.type="button",y.className="rt-inline-query__edit",y.dataset.rtAction="edit",y.setAttribute("aria-label",`Edit task: ${o.name.replace(/"/g,"'")}`),y.textContent="Edit",l.appendChild(c),l.appendChild(h),l.appendChild(p),v&&l.appendChild(v),l.appendChild(y),n.appendChild(l)}),r.appendChild(n),r}renderTable(e,t){const r=document.createElement("table");r.className="rt-inline-query__table",r.setAttribute("role","table"),r.setAttribute("aria-label","Tasks table");const n=document.createElement("thead"),a=document.createElement("tr");["Status","Task","Dates","Priority","Source",""].forEach(u=>{const h=document.createElement("th");h.textContent=u,a.appendChild(h)}),n.appendChild(a),r.appendChild(n);const o=document.createElement("tbody"),l=document.createDocumentFragment();return this.getRenderedTasks(e,t).forEach(u=>{const h=document.createElement("tr");h.dataset.taskId=u.id;const p=document.createElement("td"),v=document.createElement("button");v.type="button",v.className="rt-inline-query__checkbox",v.dataset.rtAction="toggle",v.setAttribute("aria-pressed",String(u.status==="done"));const y=u.status==="done"?`Mark incomplete: ${u.name.replace(/"/g,"'")}`:`Mark complete: ${u.name.replace(/"/g,"'")}`;v.setAttribute("aria-label",y),v.textContent=u.status==="done"?"☑":"☐",p.appendChild(v);const k=document.createElement("td");k.textContent=u.name,u.status==="done"&&k.classList.add("rt-inline-query__title--done");const m=document.createElement("td");m.textContent=this.formatTaskDates(u);const g=document.createElement("td");g.textContent=u.priority??"—";const _=document.createElement("td"),D=this.renderSource(u);D?_.appendChild(D):_.textContent="—";const E=document.createElement("td"),x=document.createElement("button");x.type="button",x.className="rt-inline-query__edit",x.dataset.rtAction="edit",x.setAttribute("aria-label",`Edit task: ${u.name.replace(/"/g,"'")}`),x.textContent="Edit",E.appendChild(x),h.appendChild(p),h.appendChild(k),h.appendChild(m),h.appendChild(g),h.appendChild(_),h.appendChild(E),l.appendChild(h)}),o.appendChild(l),r.appendChild(o),r}getRenderedTasks(e,t){return t.maxItems?e.slice(0,t.maxItems):e}formatTaskDates(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),t.length>0?t.join(" · "):"—"}formatTaskMeta(e){const t=[];return e.dueAt&&t.push(`Due ${this.formatDate(e.dueAt)}`),e.scheduledAt&&t.push(`Scheduled ${this.formatDate(e.scheduledAt)}`),e.startAt&&t.push(`Start ${this.formatDate(e.startAt)}`),e.priority&&t.push(`Priority ${e.priority}`),t.length>0?t.join(" · "):"No dates"}formatDate(e){if(!e)return"";try{return new Date(e).toLocaleDateString()}catch{return e}}renderSource(e){if(!e.linkedBlockId&&!e.path)return null;const t=document.createElement("a");return t.className="rt-inline-query__source",t.dataset.rtAction="jump",t.dataset.blockId=e.linkedBlockId??"",e.linkedBlockId&&(t.href=`siyuan://blocks/${e.linkedBlockId}`),t.textContent=this.formatSourceLabel(e),t.title=e.path??e.linkedBlockId??"",t}formatSourceLabel(e){if(e.path){const t=e.path.split("/");return t[t.length-1]||e.path}return e.linkedBlockId?"Block":"Source"}renderState(e,t="info"){const r=document.createElement("div");return r.className=`rt-inline-query__state rt-inline-query__state--${t}`,r.textContent=e,r}renderLoadingState(){const e=document.createElement("div");e.className="rt-inline-query__loading",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Loading tasks");const t=document.createElement("div");t.className="rt-inline-query__spinner";const r=document.createElement("div");return r.className="rt-inline-query__loading-text",r.textContent="Building index…",e.appendChild(t),e.appendChild(r),e}renderErrorState(e){const t=document.createElement("div");t.className="rt-inline-query__state rt-inline-query__state--error",t.setAttribute("role","alert");const r=document.createElement("div");r.className="rt-inline-query__error-icon",r.textContent="⚠";const n=document.createElement("div");n.className="rt-inline-query__error-message",n.textContent=e;const a=document.createElement("div");return a.className="rt-inline-query__error-hint",a.textContent="Check your query syntax and try again.",t.appendChild(r),t.appendChild(n),t.appendChild(a),t}renderEmptyState(){const e=document.createElement("div");e.className="rt-inline-query__state rt-inline-query__state--empty";const t=document.createElement("div");t.className="rt-inline-query__empty-icon",t.textContent="📋";const r=document.createElement("div");r.className="rt-inline-query__empty-message",r.textContent="No tasks match this query";const n=document.createElement("div");return n.className="rt-inline-query__empty-hint",n.textContent="Try adjusting your filters or create a new task.",e.appendChild(t),e.appendChild(r),e.appendChild(n),e}}class cy{constructor(e){w(this,"parser",new iy);w(this,"renderer",new ly);w(this,"cache",new oy);w(this,"queryComposer",new Ol(new Jr));w(this,"blocks",new Map);w(this,"refreshTimer");w(this,"indexReady",!1);w(this,"unsubs",[]);w(this,"debounceMs");w(this,"pageSize");this.options=e,this.debounceMs=e.debounceMs??300,this.pageSize=e.pageSize??50}mount(){var n,a,o,l;this.refreshAll();const{plugin:e}=this.options,t=()=>this.scheduleRefresh(),r=()=>this.scheduleRefresh();try{const c=(a=(n=e.eventBus).on)==null?void 0:a.call(n,"loaded-protyle",t),u=(l=(o=e.eventBus).on)==null?void 0:l.call(o,"switch-protyle",r);typeof c=="function"&&this.unsubs.push(c),typeof u=="function"&&this.unsubs.push(u)}catch(c){Qe("Inline query controller failed to bind protyle events",c)}this.unsubs.push(ze.on("task:refresh",()=>{this.cache.clear(),this.scheduleRefresh()})),this.unsubs.push(ze.on("task:settings",()=>{this.cache.clear(),this.scheduleRefresh()}))}destroy(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.blocks.forEach(({container:e})=>e.remove()),this.blocks.clear(),this.unsubs.forEach(e=>e()),this.unsubs=[]}scheduleRefresh(){this.refreshTimer&&globalThis.clearTimeout(this.refreshTimer),this.refreshTimer=globalThis.setTimeout(()=>{this.refreshAll()},this.debounceMs)}refreshAll(){const e=this.getProtyleRoots();if(e.length===0)return;const t=new Set;e.forEach(r=>{this.parser.parse(r).forEach(a=>{t.add(a.id);const o=this.getOrCreateBlockState(a);this.renderBlock(o)})}),Array.from(this.blocks.keys()).forEach(r=>{if(!t.has(r)){const n=this.blocks.get(r);n==null||n.container.remove(),this.blocks.delete(r)}}),this.indexReady=!0}renderBlock(e){const{block:t}=e,r=t.view??"list";if(!this.indexReady){this.renderer.render(e.container,{query:t.query,view:r,isIndexing:!0});return}let n,a;try{a=this.executeQuery(t.query)}catch(l){n=l instanceof Error?l.message:String(l)}const o=a?Math.min(e.renderLimit,a.tasks.length):0;this.renderer.render(e.container,{query:t.query,view:r,result:a,error:n,maxItems:e.renderLimit,renderedCount:o})}executeQuery(e){const t=this.options.settingsService.get(),r=this.buildSettingsHash(t),n=this.cache.buildKey(e,r),a=this.cache.get(n);if(a)return a.result;const o={getAllTasks:()=>this.options.repository.getAllTasks()},l=new Il(o,{urgencySettings:t.urgency}),c=$s.getInstance();if(c.isEnabled()&&c.getError())throw new Error(`Global query error: ${c.getError()}`);const u=this.queryComposer.compose(e,c.getAST()).ast,h=l.execute(u);return this.cache.set(n,h),h}buildSettingsHash(e){try{return JSON.stringify(e)}catch{return String(Date.now())}}getOrCreateBlockState(e){const t=this.blocks.get(e.id);if(t)return t.block=e,t;const r=document.createElement("div");r.dataset.rtInlineQuery=e.id,r.className="rt-inline-query",e.element.insertAdjacentElement("afterend",r),r.addEventListener("click",a=>this.handleContainerClick(a));const n={block:e,container:r,renderLimit:this.pageSize};return this.blocks.set(e.id,n),n}handleContainerClick(e){const t=e.target;if(!t)return;const r=t.closest("[data-rt-action]");if(!r)return;const n=r.dataset.rtAction,a=t.closest(".rt-inline-query");if(!a)return;const o=a.dataset.rtInlineQuery;if(!o)return;const l=this.blocks.get(o);if(!l)return;if(n==="more"){l.renderLimit+=this.pageSize,this.renderBlock(l);return}const c=t.closest("[data-task-id]"),u=c==null?void 0:c.dataset.taskId;if(u){if(n==="toggle"){this.options.onToggleTask(u);return}if(n==="edit"){const h=this.options.repository.getTask(u);h&&this.options.onEditTask(h)}}}getProtyleRoots(){return Array.from(document.querySelectorAll(".protyle-wysiwyg"))}}class uy extends Ka.Plugin{constructor(){super(...arguments);w(this,"taskManager");w(this,"repository");w(this,"scheduler");w(this,"eventService");w(this,"migrationManager");w(this,"topbarMenu");w(this,"settingsService");w(this,"dashboardComponent",null);w(this,"dockEl");w(this,"quickAddComponent",null);w(this,"quickAddContainer",null);w(this,"taskEditorComponent",null);w(this,"taskEditorContainer",null);w(this,"postponeComponent",null);w(this,"postponeContainer",null);w(this,"pendingCompletionTimeouts",new Map);w(this,"shortcutManager",null);w(this,"inlineQueryController",null);w(this,"handleCreateTaskEvent",t=>{try{const r=t;de("Create task event received",r.detail),this.openQuickAdd(r.detail)}catch(r){be("Failed to handle create task event",r),Q.error("Failed to open task creator.")}});w(this,"handleSettingsEvent",t=>{try{de("Settings event received",t.detail),this.openDock()}catch(r){be("Failed to handle settings event",r),Q.error("Failed to open settings.")}});w(this,"handleCompleteTaskEvent",async t=>{try{const r=t,{taskId:n}=r.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(r){be("Failed to complete task",r),Q.error("Failed to complete task.")}});w(this,"handleSnoozeTaskEvent",async t=>{try{const r=t,{taskId:n,minutes:a}=r.detail??{};if(!n||typeof a!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,a)}catch(r){be("Failed to snooze task",r),Q.error("Failed to snooze task.")}})}async onload(){de("Loading Recurring Tasks Plugin"),this.migrationManager=new xv(this);try{await this.migrationManager.migrate(ls)}catch(n){be("Migration failed, continuing with existing data",n)}const t=Kn.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();const r=this.taskManager.getSettingsService();this.settingsService=r;try{await this.taskManager.start()}catch(n){be("Failed to start TaskManager",n)}this.shortcutManager=await ny(this,this.repository,{createTask:n=>this.dispatchCreateTask(n),completeTask:n=>ze.emit("task:complete",{taskId:n}),postponeTask:n=>this.openPostponePicker(n),openDock:()=>this.openDock(),openTaskEditor:()=>this.openTaskEditor()},this.scheduler.getRecurrenceEngine(),()=>r.get()),ey(this),this.topbarMenu=new ay(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:qu,init:n=>{this.dockEl=n.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),this.inlineQueryController=new cy({plugin:this,repository:this.repository,settingsService:this.settingsService,onEditTask:n=>this.openTaskEditor(n),onToggleTask:n=>ze.emit("task:complete",{taskId:n})}),this.inlineQueryController.mount(),de("Recurring Tasks Plugin loaded successfully")}async onunload(){de("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.closePostponePicker(),this.removeEventListeners(),this.shortcutManager&&(this.shortcutManager.destroy(),this.shortcutManager=null),this.inlineQueryController&&(this.inlineQueryController.destroy(),this.inlineQueryController=null)}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=xn(mv,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService,shortcutManager:this.shortcutManager,settingsService:this.settingsService}}))}destroyDashboard(){this.dashboardComponent&&(An(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{ze.on("task:create",t=>{de("Create task event received",t),this.openQuickAdd(t)}),ze.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),ze.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),ze.on("task:settings",()=>{this.openDock()}),ze.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){be("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){ze.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const r=this.repository.getTask(t);if(r){if(this.pendingCompletionTimeouts.has(t)){Q.info(`Completion already pending for "${r.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(r),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),ze.emit("task:refresh",void 0),de(`Task completed: ${r.name}`)}catch(o){be("Failed to finalize task completion",o),Q.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const a=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),Q.info(`Undo: "${r.name}" restored`))};cs({message:`Task "${r.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:a,showCountdown:!0})}}async handleSnoozeTask(t,r){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,r),this.topbarMenu&&this.topbarMenu.update(),de(`Task snoozed: ${n.name} for ${r} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=xn(Tv,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}openPostponePicker(t){const r=this.repository.getTask(t);if(!r){Q.error("Task not found");return}this.postponeComponent&&this.closePostponePicker(),this.postponeContainer=document.createElement("div"),document.body.appendChild(this.postponeContainer),this.postponeComponent=xn(Ev,{target:this.postponeContainer,props:{taskName:r.name,onClose:()=>this.closePostponePicker(),onSelect:n=>{ja(t,n),this.closePostponePicker()}}})}closePostponePicker(){this.postponeComponent&&(An(this.postponeComponent),this.postponeComponent=null),this.postponeContainer&&(this.postponeContainer.remove(),this.postponeContainer=null)}dispatchCreateTask(t){ze.emit("task:create",t),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:t}))}closeQuickAdd(){this.quickAddComponent&&(An(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=xn(Ml,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(An(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=uy;
