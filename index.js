"use strict";var Ir=Object.defineProperty;var qa=n=>{throw TypeError(n)};var xr=(n,e,t)=>e in n?Ir(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var b=(n,e,t)=>xr(n,typeof e!="symbol"?e+"":e,t),Ws=(n,e,t)=>e.has(n)||qa("Cannot "+t);var m=(n,e,t)=>(Ws(n,e,"read from private field"),t?t.call(n):e.get(n)),ie=(n,e,t)=>e.has(n)?qa("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ae=(n,e,t,s)=>(Ws(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),Re=(n,e,t)=>(Ws(n,e,"access private method"),t);const ma=require("siyuan"),ta=!1;var ka=Array.isArray,Mr=Array.prototype.indexOf,Ls=Array.from,Or=Object.defineProperty,is=Object.getOwnPropertyDescriptor,qr=Object.getOwnPropertyDescriptors,Nr=Object.prototype,Rr=Array.prototype,gi=Object.getPrototypeOf,Na=Object.isExtensible;function Br(n){for(var e=0;e<n.length;e++)n[e]()}function pi(){var n,e,t=new Promise((s,a)=>{n=s,e=a});return{promise:t,resolve:n,reject:e}}const Fe=2,xs=4,Ps=8,yi=1<<24,Jt=16,Zt=32,Nn=64,ga=128,Tt=512,Le=1024,Ve=2048,$t=4096,vt=8192,fn=16384,pa=32768,Xn=65536,Ra=1<<17,bi=1<<18,$n=1<<19,zr=1<<20,Yt=1<<25,Mn=32768,na=1<<21,ya=1<<22,vn=1<<23,Kn=Symbol("$state"),Fr=Symbol(""),jn=new class extends Error{constructor(){super(...arguments);b(this,"name","StaleReactionError");b(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function wi(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Lr(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Pr(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function jr(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function Kr(n){throw new Error("https://svelte.dev/e/effect_orphan")}function Hr(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Ur(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Yr(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Qr(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Wr(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Vr=1,Xr=2,Ti=4,Gr=8,Jr=16,Zr=1,$r=2,Be=Symbol(),eo="http://www.w3.org/1999/xhtml";function to(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function no(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Si(n){return n===this.v}function so(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function Ei(n){return!so(n,this.v)}let ao=!1,it=null;function Gn(n){it=n}function Pt(n,e=!1,t){it={p:it,i:!1,c:null,e:null,s:n,x:null,l:null}}function jt(n){var e=it,t=e.e;if(t!==null){e.e=null;for(var s of t)Ui(s)}return e.i=!0,it=e.p,{}}function Di(){return!0}let pn=[];function Ai(){var n=pn;pn=[],Br(n)}function es(n){if(pn.length===0&&!os){var e=pn;queueMicrotask(()=>{e===pn&&Ai()})}pn.push(n)}function io(){for(;pn.length>0;)Ai()}function Ci(n){var e=fe;if(e===null)return ne.f|=vn,n;if(e.f&pa)Jn(n,e);else{if(!(e.f&ga))throw n;e.b.error(n)}}function Jn(n,e){for(;e!==null;){if(e.f&ga)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const ro=-7169;function qe(n,e){n.f=n.f&ro|e}function ba(n){n.f&Tt||n.deps===null?qe(n,Le):qe(n,$t)}function Ii(n){if(n!==null)for(const e of n)!(e.f&Fe)||!(e.f&Mn)||(e.f^=Mn,Ii(e.deps))}function xi(n,e,t){n.f&Ve?e.add(n):n.f&$t&&t.add(n),Ii(n.deps),qe(n,Le)}const ws=new Set;let te=null,rs=null,ze=null,yt=[],js=null,sa=!1,os=!1;var Hn,Un,wn,Tn,ms,Yn,Qn,St,aa,ia,Mi,Oi;const Bs=class Bs{constructor(){ie(this,St);b(this,"committed",!1);b(this,"current",new Map);b(this,"previous",new Map);ie(this,Hn,new Set);ie(this,Un,new Set);ie(this,wn,0);ie(this,Tn,0);ie(this,ms,null);ie(this,Yn,new Set);ie(this,Qn,new Set);b(this,"skipped_effects",new Set);b(this,"is_fork",!1)}is_deferred(){return this.is_fork||m(this,Tn)>0}process(e){var a;yt=[],rs=null,this.apply();var t=[],s=[];for(const r of e)Re(this,St,aa).call(this,r,t,s);this.is_fork||Re(this,St,Mi).call(this),this.is_deferred()?(Re(this,St,ia).call(this,s),Re(this,St,ia).call(this,t)):(rs=this,te=null,Ba(s),Ba(t),rs=null,(a=m(this,ms))==null||a.resolve()),ze=null}capture(e,t){t!==Be&&!this.previous.has(e)&&this.previous.set(e,t),e.f&vn||(this.current.set(e,e.v),ze==null||ze.set(e,e.v))}activate(){te=this,this.apply()}deactivate(){te===this&&(te=null,ze=null)}flush(){if(this.activate(),yt.length>0){if(qi(),te!==null&&te!==this)return}else m(this,wn)===0&&this.process([]);this.deactivate()}discard(){for(const e of m(this,Un))e(this);m(this,Un).clear()}increment(e){ae(this,wn,m(this,wn)+1),e&&ae(this,Tn,m(this,Tn)+1)}decrement(e){ae(this,wn,m(this,wn)-1),e&&ae(this,Tn,m(this,Tn)-1),this.revive()}revive(){for(const e of m(this,Yn))m(this,Qn).delete(e),qe(e,Ve),Gt(e);for(const e of m(this,Qn))qe(e,$t),Gt(e);this.flush()}oncommit(e){m(this,Hn).add(e)}ondiscard(e){m(this,Un).add(e)}settled(){return(m(this,ms)??ae(this,ms,pi())).promise}static ensure(){if(te===null){const e=te=new Bs;ws.add(te),os||Bs.enqueue(()=>{te===e&&e.flush()})}return te}static enqueue(e){es(e)}apply(){}};Hn=new WeakMap,Un=new WeakMap,wn=new WeakMap,Tn=new WeakMap,ms=new WeakMap,Yn=new WeakMap,Qn=new WeakMap,St=new WeakSet,aa=function(e,t,s){e.f^=Le;for(var a=e.first,r=null;a!==null;){var o=a.f,c=(o&(Zt|Nn))!==0,l=c&&(o&Le)!==0,u=l||(o&vt)!==0||this.skipped_effects.has(a);if(!u&&a.fn!==null){c?a.f^=Le:r!==null&&o&(xs|Ps|yi)?r.b.defer_effect(a):o&xs?t.push(a):ys(a)&&(o&Jt&&m(this,Yn).add(a),fs(a));var _=a.first;if(_!==null){a=_;continue}}var k=a.parent;for(a=a.next;a===null&&k!==null;)k===r&&(r=null),a=k.next,k=k.parent}},ia=function(e){for(var t=0;t<e.length;t+=1)xi(e[t],m(this,Yn),m(this,Qn))},Mi=function(){if(m(this,Tn)===0){for(const e of m(this,Hn))e();m(this,Hn).clear()}m(this,wn)===0&&Re(this,St,Oi).call(this)},Oi=function(){var a;if(ws.size>1){this.previous.clear();var e=ze,t=!0;for(const r of ws){if(r===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(r.current.has(l))if(t&&u!==r.current.get(l))r.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...r.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var s=yt;yt=[];const l=new Set,u=new Map;for(const _ of o)Ni(_,c,l,u);if(yt.length>0){te=r,r.apply();for(const _ of yt)Re(a=r,St,aa).call(a,_,[],[]);r.deactivate()}yt=s}}te=null,ze=e}this.committed=!0,ws.delete(this)};let Qt=Bs;function oo(n){var e=os;os=!0;try{for(var t;;){if(io(),yt.length===0&&(te==null||te.flush(),yt.length===0))return js=null,t;qi()}}finally{os=e}}function qi(){var n=In;sa=!0;var e=null;try{var t=0;for(Os(!0);yt.length>0;){var s=Qt.ensure();if(t++>1e3){var a,r;lo()}s.process(yt),hn.clear()}}finally{sa=!1,Os(n),js=null}}function lo(){try{Hr()}catch(n){Jn(n,js)}}let Dt=null;function Ba(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var s=n[t++];if(!(s.f&(fn|vt))&&ys(s)&&(Dt=new Set,fs(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Xi(s):s.fn=null),(Dt==null?void 0:Dt.size)>0)){hn.clear();for(const a of Dt){if(a.f&(fn|vt))continue;const r=[a];let o=a.parent;for(;o!==null;)Dt.has(o)&&(Dt.delete(o),r.push(o)),o=o.parent;for(let c=r.length-1;c>=0;c--){const l=r[c];l.f&(fn|vt)||fs(l)}}Dt.clear()}}Dt=null}}function Ni(n,e,t,s){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const a of n.reactions){const r=a.f;r&Fe?Ni(a,e,t,s):r&(ya|Jt)&&!(r&Ve)&&Ri(a,e,s)&&(qe(a,Ve),Gt(a))}}function Ri(n,e,t){const s=t.get(n);if(s!==void 0)return s;if(n.deps!==null)for(const a of n.deps){if(e.includes(a))return!0;if(a.f&Fe&&Ri(a,e,t))return t.set(a,!0),!0}return t.set(n,!1),!1}function Gt(n){for(var e=js=n;e.parent!==null;){e=e.parent;var t=e.f;if(sa&&e===fe&&t&Jt&&!(t&bi))return;if(t&(Nn|Zt)){if(!(t&Le))return;e.f^=Le}}yt.push(e)}function co(n){let e=0,t=On(0),s;return()=>{Ea()&&(i(t),Hs(()=>(e===0&&(s=ts(()=>n(()=>ls(t)))),e+=1,()=>{es(()=>{e-=1,e===0&&(s==null||s(),s=void 0,ls(t))})})))}}var uo=Xn|$n|ga;function fo(n,e,t){new vo(n,e,t)}var gt,_a,Rt,Sn,Bt,pt,tt,zt,Ut,on,En,ln,Dn,Wn,Vn,cn,zs,Oe,ho,_o,ra,Ss,Es,oa;class vo{constructor(e,t,s){ie(this,Oe);b(this,"parent");b(this,"is_pending",!1);ie(this,gt);ie(this,_a,null);ie(this,Rt);ie(this,Sn);ie(this,Bt);ie(this,pt,null);ie(this,tt,null);ie(this,zt,null);ie(this,Ut,null);ie(this,on,null);ie(this,En,0);ie(this,ln,0);ie(this,Dn,!1);ie(this,Wn,new Set);ie(this,Vn,new Set);ie(this,cn,null);ie(this,zs,co(()=>(ae(this,cn,On(m(this,En))),()=>{ae(this,cn,null)})));ae(this,gt,e),ae(this,Rt,t),ae(this,Sn,s),this.parent=fe.b,this.is_pending=!!m(this,Rt).pending,ae(this,Bt,Aa(()=>{fe.b=this;{var a=Re(this,Oe,ra).call(this);try{ae(this,pt,bt(()=>s(a)))}catch(r){this.error(r)}m(this,ln)>0?Re(this,Oe,Es).call(this):this.is_pending=!1}return()=>{var r;(r=m(this,on))==null||r.remove()}},uo))}defer_effect(e){xi(e,m(this,Wn),m(this,Vn))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!m(this,Rt).pending}update_pending_count(e){Re(this,Oe,oa).call(this,e),ae(this,En,m(this,En)+e),m(this,cn)&&Zn(m(this,cn),m(this,En))}get_effect_pending(){return m(this,zs).call(this),i(m(this,cn))}error(e){var t=m(this,Rt).onerror;let s=m(this,Rt).failed;if(m(this,Dn)||!t&&!s)throw e;m(this,pt)&&(at(m(this,pt)),ae(this,pt,null)),m(this,tt)&&(at(m(this,tt)),ae(this,tt,null)),m(this,zt)&&(at(m(this,zt)),ae(this,zt,null));var a=!1,r=!1;const o=()=>{if(a){no();return}a=!0,r&&Wr(),Qt.ensure(),ae(this,En,0),m(this,zt)!==null&&Cn(m(this,zt),()=>{ae(this,zt,null)}),this.is_pending=this.has_pending_snippet(),ae(this,pt,Re(this,Oe,Ss).call(this,()=>(ae(this,Dn,!1),bt(()=>m(this,Sn).call(this,m(this,gt)))))),m(this,ln)>0?Re(this,Oe,Es).call(this):this.is_pending=!1};var c=ne;try{st(null),r=!0,t==null||t(e,o),r=!1}catch(l){Jn(l,m(this,Bt)&&m(this,Bt).parent)}finally{st(c)}s&&es(()=>{ae(this,zt,Re(this,Oe,Ss).call(this,()=>{Qt.ensure(),ae(this,Dn,!0);try{return bt(()=>{s(m(this,gt),()=>e,()=>o)})}catch(l){return Jn(l,m(this,Bt).parent),null}finally{ae(this,Dn,!1)}}))})}}gt=new WeakMap,_a=new WeakMap,Rt=new WeakMap,Sn=new WeakMap,Bt=new WeakMap,pt=new WeakMap,tt=new WeakMap,zt=new WeakMap,Ut=new WeakMap,on=new WeakMap,En=new WeakMap,ln=new WeakMap,Dn=new WeakMap,Wn=new WeakMap,Vn=new WeakMap,cn=new WeakMap,zs=new WeakMap,Oe=new WeakSet,ho=function(){try{ae(this,pt,bt(()=>m(this,Sn).call(this,m(this,gt))))}catch(e){this.error(e)}},_o=function(){const e=m(this,Rt).pending;e&&(ae(this,tt,bt(()=>e(m(this,gt)))),Qt.enqueue(()=>{var t=Re(this,Oe,ra).call(this);ae(this,pt,Re(this,Oe,Ss).call(this,()=>(Qt.ensure(),bt(()=>m(this,Sn).call(this,t))))),m(this,ln)>0?Re(this,Oe,Es).call(this):(Cn(m(this,tt),()=>{ae(this,tt,null)}),this.is_pending=!1)}))},ra=function(){var e=m(this,gt);return this.is_pending&&(ae(this,on,Xt()),m(this,gt).before(m(this,on)),e=m(this,on)),e},Ss=function(e){var t=fe,s=ne,a=it;Lt(m(this,Bt)),st(m(this,Bt)),Gn(m(this,Bt).ctx);try{return e()}catch(r){return Ci(r),null}finally{Lt(t),st(s),Gn(a)}},Es=function(){const e=m(this,Rt).pending;m(this,pt)!==null&&(ae(this,Ut,document.createDocumentFragment()),m(this,Ut).append(m(this,on)),Zi(m(this,pt),m(this,Ut))),m(this,tt)===null&&ae(this,tt,bt(()=>e(m(this,gt))))},oa=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Re(t=this.parent,Oe,oa).call(t,e);return}if(ae(this,ln,m(this,ln)+e),m(this,ln)===0){this.is_pending=!1;for(const s of m(this,Wn))qe(s,Ve),Gt(s);for(const s of m(this,Vn))qe(s,$t),Gt(s);m(this,Wn).clear(),m(this,Vn).clear(),m(this,tt)&&Cn(m(this,tt),()=>{ae(this,tt,null)}),m(this,Ut)&&(m(this,gt).before(m(this,Ut)),ae(this,Ut,null))}};function mo(n,e,t,s){const a=wa;if(t.length===0&&n.length===0){s(e.map(a));return}var r=te,o=fe,c=ko();function l(){Promise.all(t.map(u=>go(u))).then(u=>{c();try{s([...e.map(a),...u])}catch(_){o.f&fn||Jn(_,o)}r==null||r.deactivate(),Ms()}).catch(u=>{Jn(u,o)})}n.length>0?Promise.all(n).then(()=>{c();try{return l()}finally{r==null||r.deactivate(),Ms()}}):l()}function ko(){var n=fe,e=ne,t=it,s=te;return function(r=!0){Lt(n),st(e),Gn(t),r&&(s==null||s.activate())}}function Ms(){Lt(null),st(null),Gn(null)}function wa(n){var e=Fe|Ve,t=ne!==null&&ne.f&Fe?ne:null;return fe!==null&&(fe.f|=$n),{ctx:it,deps:null,effects:null,equals:Si,f:e,fn:n,reactions:null,rv:0,v:Be,wv:0,parent:t??fe,ac:null}}function go(n,e,t){let s=fe;s===null&&Lr();var a=s.b,r=void 0,o=On(Be),c=!ne,l=new Map;return xo(()=>{var w;var u=pi();r=u.promise;try{Promise.resolve(n()).then(u.resolve,u.reject).then(()=>{_===te&&_.committed&&_.deactivate(),Ms()})}catch(O){u.reject(O),Ms()}var _=te;if(c){var k=a.is_rendered();a.update_pending_count(1),_.increment(k),(w=l.get(_))==null||w.reject(jn),l.delete(_),l.set(_,u)}const g=(O,D=void 0)=>{if(_.activate(),D)D!==jn&&(o.f|=vn,Zn(o,D));else{o.f&vn&&(o.f^=vn),Zn(o,O);for(const[p,y]of l){if(l.delete(p),p===_)break;y.reject(jn)}}c&&(a.update_pending_count(-1),_.decrement(k))};u.promise.then(g,O=>g(null,O||"unknown"))}),Da(()=>{for(const u of l.values())u.reject(jn)}),new Promise(u=>{function _(k){function g(){k===r?u(o):_(r)}k.then(g,g)}_(r)})}function X(n){const e=wa(n);return $i(e),e}function po(n){const e=wa(n);return e.equals=Ei,e}function Bi(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)at(e[t])}}function yo(n){for(var e=n.parent;e!==null;){if(!(e.f&Fe))return e.f&fn?null:e;e=e.parent}return null}function Ta(n){var e,t=fe;Lt(yo(n));try{n.f&=~Mn,Bi(n),e=sr(n)}finally{Lt(t)}return e}function zi(n){var e=Ta(n);if(!n.equals(e)&&(n.wv=tr(),(!(te!=null&&te.is_fork)||n.deps===null)&&(n.v=e,n.deps===null))){qe(n,Le);return}qn||(ze!==null?(Ea()||te!=null&&te.is_fork)&&ze.set(n,e):ba(n))}let la=new Set;const hn=new Map;let Fi=!1;function On(n,e){var t={f:0,v:n,reactions:null,equals:Si,rv:0,wv:0};return t}function H(n,e){const t=On(n);return $i(t),t}function bo(n,e=!1,t=!0){const s=On(n);return e||(s.equals=Ei),s}function f(n,e,t=!1){ne!==null&&(!Ct||ne.f&Ra)&&Di()&&ne.f&(Fe|Jt|ya|Ra)&&!(We!=null&&We.includes(n))&&Qr();let s=t?Me(e):e;return Zn(n,s)}function Zn(n,e){if(!n.equals(e)){var t=n.v;qn?hn.set(n,e):hn.set(n,t),n.v=e;var s=Qt.ensure();if(s.capture(n,t),n.f&Fe){const a=n;n.f&Ve&&Ta(a),ba(a)}n.wv=tr(),Li(n,Ve),fe!==null&&fe.f&Le&&!(fe.f&(Zt|Nn))&&(kt===null?Oo([n]):kt.push(n)),!s.is_fork&&la.size>0&&!Fi&&wo()}return e}function wo(){Fi=!1;var n=In;Os(!0);const e=Array.from(la);try{for(const t of e)t.f&Le&&qe(t,$t),ys(t)&&fs(t)}finally{Os(n)}la.clear()}function ls(n){f(n,n.v+1)}function Li(n,e){var t=n.reactions;if(t!==null)for(var s=t.length,a=0;a<s;a++){var r=t[a],o=r.f,c=(o&Ve)===0;if(c&&qe(r,e),o&Fe){var l=r;ze==null||ze.delete(l),o&Mn||(o&Tt&&(r.f|=Mn),Li(l,$t))}else c&&(o&Jt&&Dt!==null&&Dt.add(r),Gt(r))}}function Me(n){if(typeof n!="object"||n===null||Kn in n)return n;const e=gi(n);if(e!==Nr&&e!==Rr)return n;var t=new Map,s=ka(n),a=H(0),r=xn,o=c=>{if(xn===r)return c();var l=ne,u=xn;st(null),ja(r);var _=c();return st(l),ja(u),_};return s&&t.set("length",H(n.length)),new Proxy(n,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&Ur();var _=t.get(l);return _===void 0?_=o(()=>{var k=H(u.value);return t.set(l,k),k}):f(_,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const _=o(()=>H(Be));t.set(l,_),ls(a)}}else f(u,Be),ls(a);return!0},get(c,l,u){var w;if(l===Kn)return n;var _=t.get(l),k=l in c;if(_===void 0&&(!k||(w=is(c,l))!=null&&w.writable)&&(_=o(()=>{var O=Me(k?c[l]:Be),D=H(O);return D}),t.set(l,_)),_!==void 0){var g=i(_);return g===Be?void 0:g}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var _=t.get(l);_&&(u.value=i(_))}else if(u===void 0){var k=t.get(l),g=k==null?void 0:k.v;if(k!==void 0&&g!==Be)return{enumerable:!0,configurable:!0,value:g,writable:!0}}return u},has(c,l){var g;if(l===Kn)return!0;var u=t.get(l),_=u!==void 0&&u.v!==Be||Reflect.has(c,l);if(u!==void 0||fe!==null&&(!_||(g=is(c,l))!=null&&g.writable)){u===void 0&&(u=o(()=>{var w=_?Me(c[l]):Be,O=H(w);return O}),t.set(l,u));var k=i(u);if(k===Be)return!1}return _},set(c,l,u,_){var C;var k=t.get(l),g=l in c;if(s&&l==="length")for(var w=u;w<k.v;w+=1){var O=t.get(w+"");O!==void 0?f(O,Be):w in c&&(O=o(()=>H(Be)),t.set(w+"",O))}if(k===void 0)(!g||(C=is(c,l))!=null&&C.writable)&&(k=o(()=>H(void 0)),f(k,Me(u)),t.set(l,k));else{g=k.v!==Be;var D=o(()=>Me(u));f(k,D)}var p=Reflect.getOwnPropertyDescriptor(c,l);if(p!=null&&p.set&&p.set.call(_,u),!g){if(s&&typeof l=="string"){var y=t.get("length"),M=Number(l);Number.isInteger(M)&&M>=y.v&&f(y,M+1)}ls(a)}return!0},ownKeys(c){i(a);var l=Reflect.ownKeys(c).filter(k=>{var g=t.get(k);return g===void 0||g.v!==Be});for(var[u,_]of t)_.v!==Be&&!(u in c)&&l.push(u);return l},setPrototypeOf(){Yr()}})}function za(n){try{if(n!==null&&typeof n=="object"&&Kn in n)return n[Kn]}catch{}return n}function To(n,e){return Object.is(za(n),za(e))}var Fa,Pi,ji,Ki;function So(){if(Fa===void 0){Fa=window,Pi=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;ji=is(e,"firstChild").get,Ki=is(e,"nextSibling").get,Na(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),Na(t)&&(t.__t=void 0)}}function Xt(n=""){return document.createTextNode(n)}function un(n){return ji.call(n)}function ps(n){return Ki.call(n)}function d(n,e){return un(n)}function wt(n,e=!1){{var t=un(n);return t instanceof Comment&&t.data===""?ps(t):t}}function v(n,e=1,t=!1){let s=n;for(;e--;)s=ps(s);return s}function Eo(n){n.textContent=""}function Hi(){return!1}let La=!1;function Do(){La||(La=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Ks(n){var e=ne,t=fe;st(null),Lt(null);try{return n()}finally{st(e),Lt(t)}}function Sa(n,e,t,s=t){n.addEventListener(e,()=>Ks(t));const a=n.__on_r;a?n.__on_r=()=>{a(),s(!0)}:n.__on_r=()=>s(!0),Do()}function Ao(n){fe===null&&(ne===null&&Kr(),jr()),qn&&Pr()}function Co(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function en(n,e,t){var s=fe;s!==null&&s.f&vt&&(n|=vt);var a={ctx:it,deps:null,nodes:null,f:n|Ve|Tt,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{fs(a),a.f|=pa}catch(c){throw at(a),c}else e!==null&&Gt(a);var r=a;if(t&&r.deps===null&&r.teardown===null&&r.nodes===null&&r.first===r.last&&!(r.f&$n)&&(r=r.first,n&Jt&&n&Xn&&r!==null&&(r.f|=Xn)),r!==null&&(r.parent=s,s!==null&&Co(r,s),ne!==null&&ne.f&Fe&&!(n&Nn))){var o=ne;(o.effects??(o.effects=[])).push(r)}return a}function Ea(){return ne!==null&&!Ct}function Da(n){const e=en(Ps,null,!1);return qe(e,Le),e.teardown=n,e}function Wt(n){Ao();var e=fe.f,t=!ne&&(e&Zt)!==0&&(e&pa)===0;if(t){var s=it;(s.e??(s.e=[])).push(n)}else return Ui(n)}function Ui(n){return en(xs|zr,n,!1)}function Io(n){Qt.ensure();const e=en(Nn|$n,n,!0);return(t={})=>new Promise(s=>{t.outro?Cn(e,()=>{at(e),s(void 0)}):(at(e),s(void 0))})}function Yi(n){return en(xs,n,!1)}function xo(n){return en(ya|$n,n,!0)}function Hs(n,e=0){return en(Ps|e,n,!0)}function K(n,e=[],t=[],s=[]){mo(s,e,t,a=>{en(Ps,()=>n(...a.map(i)),!0)})}function Aa(n,e=0){var t=en(Jt|e,n,!0);return t}function bt(n){return en(Zt|$n,n,!0)}function Qi(n){var e=n.teardown;if(e!==null){const t=qn,s=ne;Pa(!0),st(null);try{e.call(null)}finally{Pa(t),st(s)}}}function Wi(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const a=t.ac;a!==null&&Ks(()=>{a.abort(jn)});var s=t.next;t.f&Nn?t.parent=null:at(t,e),t=s}}function Mo(n){for(var e=n.first;e!==null;){var t=e.next;e.f&Zt||at(e),e=t}}function at(n,e=!0){var t=!1;(e||n.f&bi)&&n.nodes!==null&&n.nodes.end!==null&&(Vi(n.nodes.start,n.nodes.end),t=!0),Wi(n,e&&!t),qs(n,0),qe(n,fn);var s=n.nodes&&n.nodes.t;if(s!==null)for(const r of s)r.stop();Qi(n);var a=n.parent;a!==null&&a.first!==null&&Xi(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function Vi(n,e){for(;n!==null;){var t=n===e?null:ps(n);n.remove(),n=t}}function Xi(n){var e=n.parent,t=n.prev,s=n.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===n&&(e.first=s),e.last===n&&(e.last=t))}function Cn(n,e,t=!0){var s=[];Gi(n,s,!0);var a=()=>{t&&at(n),e&&e()},r=s.length;if(r>0){var o=()=>--r||a();for(var c of s)c.out(o)}else a()}function Gi(n,e,t){if(!(n.f&vt)){n.f^=vt;var s=n.nodes&&n.nodes.t;if(s!==null)for(const c of s)(c.is_global||t)&&e.push(c);for(var a=n.first;a!==null;){var r=a.next,o=(a.f&Xn)!==0||(a.f&Zt)!==0&&(n.f&Jt)!==0;Gi(a,e,o?t:!1),a=r}}}function Ca(n){Ji(n,!0)}function Ji(n,e){if(n.f&vt){n.f^=vt,n.f&Le||(qe(n,Ve),Gt(n));for(var t=n.first;t!==null;){var s=t.next,a=(t.f&Xn)!==0||(t.f&Zt)!==0;Ji(t,a?e:!1),t=s}var r=n.nodes&&n.nodes.t;if(r!==null)for(const o of r)(o.is_global||e)&&o.in()}}function Zi(n,e){if(n.nodes)for(var t=n.nodes.start,s=n.nodes.end;t!==null;){var a=t===s?null:ps(t);e.append(t),t=a}}let In=!1;function Os(n){In=n}let qn=!1;function Pa(n){qn=n}let ne=null,Ct=!1;function st(n){ne=n}let fe=null;function Lt(n){fe=n}let We=null;function $i(n){ne!==null&&(We===null?We=[n]:We.push(n))}let Ye=null,ct=0,kt=null;function Oo(n){kt=n}let er=1,ds=0,xn=ds;function ja(n){xn=n}function tr(){return++er}function ys(n){var e=n.f;if(e&Ve)return!0;if(e&Fe&&(n.f&=~Mn),e&$t){for(var t=n.deps,s=t.length,a=0;a<s;a++){var r=t[a];if(ys(r)&&zi(r),r.wv>n.wv)return!0}e&Tt&&ze===null&&qe(n,Le)}return!1}function nr(n,e,t=!0){var s=n.reactions;if(s!==null&&!(We!=null&&We.includes(n)))for(var a=0;a<s.length;a++){var r=s[a];r.f&Fe?nr(r,e,!1):e===r&&(t?qe(r,Ve):r.f&Le&&qe(r,$t),Gt(r))}}function sr(n){var O;var e=Ye,t=ct,s=kt,a=ne,r=We,o=it,c=Ct,l=xn,u=n.f;Ye=null,ct=0,kt=null,ne=u&(Zt|Nn)?null:n,We=null,Gn(n.ctx),Ct=!1,xn=++ds,n.ac!==null&&(Ks(()=>{n.ac.abort(jn)}),n.ac=null);try{n.f|=na;var _=n.fn,k=_(),g=n.deps;if(Ye!==null){var w;if(qs(n,ct),g!==null&&ct>0)for(g.length=ct+Ye.length,w=0;w<Ye.length;w++)g[ct+w]=Ye[w];else n.deps=g=Ye;if(Ea()&&n.f&Tt)for(w=ct;w<g.length;w++)((O=g[w]).reactions??(O.reactions=[])).push(n)}else g!==null&&ct<g.length&&(qs(n,ct),g.length=ct);if(Di()&&kt!==null&&!Ct&&g!==null&&!(n.f&(Fe|$t|Ve)))for(w=0;w<kt.length;w++)nr(kt[w],n);return a!==null&&a!==n&&(ds++,kt!==null&&(s===null?s=kt:s.push(...kt))),n.f&vn&&(n.f^=vn),k}catch(D){return Ci(D)}finally{n.f^=na,Ye=e,ct=t,kt=s,ne=a,We=r,Gn(o),Ct=c,xn=l}}function qo(n,e){let t=e.reactions;if(t!==null){var s=Mr.call(t,n);if(s!==-1){var a=t.length-1;a===0?t=e.reactions=null:(t[s]=t[a],t.pop())}}if(t===null&&e.f&Fe&&(Ye===null||!Ye.includes(e))){var r=e;r.f&Tt&&(r.f^=Tt,r.f&=~Mn),ba(r),Bi(r),qs(r,0)}}function qs(n,e){var t=n.deps;if(t!==null)for(var s=e;s<t.length;s++)qo(n,t[s])}function fs(n){var e=n.f;if(!(e&fn)){qe(n,Le);var t=fe,s=In;fe=n,In=!0;try{e&(Jt|yi)?Mo(n):Wi(n),Qi(n);var a=sr(n);n.teardown=typeof a=="function"?a:null,n.wv=er;var r;ta&&ao&&n.f&Ve&&n.deps}finally{In=s,fe=t}}}async function ar(){await Promise.resolve(),oo()}function i(n){var e=n.f,t=(e&Fe)!==0;if(ne!==null&&!Ct){var s=fe!==null&&(fe.f&fn)!==0;if(!s&&!(We!=null&&We.includes(n))){var a=ne.deps;if(ne.f&na)n.rv<ds&&(n.rv=ds,Ye===null&&a!==null&&a[ct]===n?ct++:Ye===null?Ye=[n]:Ye.includes(n)||Ye.push(n));else{(ne.deps??(ne.deps=[])).push(n);var r=n.reactions;r===null?n.reactions=[ne]:r.includes(ne)||r.push(ne)}}}if(qn&&hn.has(n))return hn.get(n);if(t){var o=n;if(qn){var c=o.v;return(!(o.f&Le)&&o.reactions!==null||rr(o))&&(c=Ta(o)),hn.set(o,c),c}var l=(o.f&Tt)===0&&!Ct&&ne!==null&&(In||(ne.f&Tt)!==0),u=o.deps===null;ys(o)&&(l&&(o.f|=Tt),zi(o)),l&&!u&&ir(o)}if(ze!=null&&ze.has(n))return ze.get(n);if(n.f&vn)throw n.v;return n.v}function ir(n){if(n.deps!==null){n.f|=Tt;for(const e of n.deps)(e.reactions??(e.reactions=[])).push(n),e.f&Fe&&!(e.f&Tt)&&ir(e)}}function rr(n){if(n.v===Be)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(hn.has(e)||e.f&Fe&&rr(e))return!0;return!1}function ts(n){var e=Ct;try{return Ct=!0,n()}finally{Ct=e}}const No=["touchstart","touchmove"];function Ro(n){return No.includes(n)}const or=new Set,ca=new Set;function Bo(n,e,t,s={}){function a(r){if(s.capture||ss.call(e,r),!r.cancelBubble)return Ks(()=>t==null?void 0:t.call(this,r))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?es(()=>{e.addEventListener(n,a,s)}):e.addEventListener(n,a,s),a}function ft(n,e,t,s,a){var r={capture:s,passive:a},o=Bo(n,e,t,r);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&Da(()=>{e.removeEventListener(n,o,r)})}function Rn(n){for(var e=0;e<n.length;e++)or.add(n[e]);for(var t of ca)t(n)}let Ka=null;function ss(n){var p;var e=this,t=e.ownerDocument,s=n.type,a=((p=n.composedPath)==null?void 0:p.call(n))||[],r=a[0]||n.target;Ka=n;var o=0,c=Ka===n&&n.__root;if(c){var l=a.indexOf(c);if(l!==-1&&(e===document||e===window)){n.__root=e;return}var u=a.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(r=a[o]||n.target,r!==e){Or(n,"currentTarget",{configurable:!0,get(){return r||t}});var _=ne,k=fe;st(null),Lt(null);try{for(var g,w=[];r!==null;){var O=r.assignedSlot||r.parentNode||r.host||null;try{var D=r["__"+s];D!=null&&(!r.disabled||n.target===r)&&D.call(r,n)}catch(y){g?w.push(y):g=y}if(n.cancelBubble||O===e||O===null)break;r=O}if(g){for(let y of w)queueMicrotask(()=>{throw y});throw g}}finally{n.__root=e,delete n.currentTarget,st(_),Lt(k)}}}function lr(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function vs(n,e){var t=fe;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function x(n,e){var t=(e&Zr)!==0,s=(e&$r)!==0,a,r=!n.startsWith("<!>");return()=>{a===void 0&&(a=lr(r?n:"<!>"+n),t||(a=un(a)));var o=s||Pi?document.importNode(a,!0):a.cloneNode(!0);if(t){var c=un(o),l=o.lastChild;vs(c,l)}else vs(o,o);return o}}function Vs(n=""){{var e=Xt(n+"");return vs(e,e),e}}function dn(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Xt();return n.append(e,t),vs(e,t),n}function E(n,e){n!==null&&n.before(e)}function z(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Ha(n,e){return zo(n,e)}const Pn=new Map;function zo(n,{target:e,anchor:t,props:s={},events:a,context:r,intro:o=!0}){So();var c=new Set,l=k=>{for(var g=0;g<k.length;g++){var w=k[g];if(!c.has(w)){c.add(w);var O=Ro(w);e.addEventListener(w,ss,{passive:O});var D=Pn.get(w);D===void 0?(document.addEventListener(w,ss,{passive:O}),Pn.set(w,1)):Pn.set(w,D+1)}}};l(Ls(or)),ca.add(l);var u=void 0,_=Io(()=>{var k=t??e.appendChild(Xt());return fo(k,{pending:()=>{}},g=>{if(r){Pt({});var w=it;w.c=r}a&&(s.$$events=a),u=n(g,s)||{},r&&jt()}),()=>{var O;for(var g of c){e.removeEventListener(g,ss);var w=Pn.get(g);--w===0?(document.removeEventListener(g,ss),Pn.delete(g)):Pn.set(g,w)}ca.delete(l),k!==t&&((O=k.parentNode)==null||O.removeChild(k))}});return ua.set(u,_),u}let ua=new WeakMap;function Ua(n,e){const t=ua.get(n);return t?(ua.delete(n),t(e)):Promise.resolve()}var At,Ft,ut,An,ks,gs,Fs;class Fo{constructor(e,t=!0){b(this,"anchor");ie(this,At,new Map);ie(this,Ft,new Map);ie(this,ut,new Map);ie(this,An,new Set);ie(this,ks,!0);ie(this,gs,()=>{var e=te;if(m(this,At).has(e)){var t=m(this,At).get(e),s=m(this,Ft).get(t);if(s)Ca(s),m(this,An).delete(t);else{var a=m(this,ut).get(t);a&&(m(this,Ft).set(t,a.effect),m(this,ut).delete(t),a.fragment.lastChild.remove(),this.anchor.before(a.fragment),s=a.effect)}for(const[r,o]of m(this,At)){if(m(this,At).delete(r),r===e)break;const c=m(this,ut).get(o);c&&(at(c.effect),m(this,ut).delete(o))}for(const[r,o]of m(this,Ft)){if(r===t||m(this,An).has(r))continue;const c=()=>{if(Array.from(m(this,At).values()).includes(r)){var u=document.createDocumentFragment();Zi(o,u),u.append(Xt()),m(this,ut).set(r,{effect:o,fragment:u})}else at(o);m(this,An).delete(r),m(this,Ft).delete(r)};m(this,ks)||!s?(m(this,An).add(r),Cn(o,c,!1)):c()}}});ie(this,Fs,e=>{m(this,At).delete(e);const t=Array.from(m(this,At).values());for(const[s,a]of m(this,ut))t.includes(s)||(at(a.effect),m(this,ut).delete(s))});this.anchor=e,ae(this,ks,t)}ensure(e,t){var s=te,a=Hi();if(t&&!m(this,Ft).has(e)&&!m(this,ut).has(e))if(a){var r=document.createDocumentFragment(),o=Xt();r.append(o),m(this,ut).set(e,{effect:bt(()=>t(o)),fragment:r})}else m(this,Ft).set(e,bt(()=>t(this.anchor)));if(m(this,At).set(s,e),a){for(const[c,l]of m(this,Ft))c===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[c,l]of m(this,ut))c===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(m(this,gs)),s.ondiscard(m(this,Fs))}else m(this,gs).call(this)}}At=new WeakMap,Ft=new WeakMap,ut=new WeakMap,An=new WeakMap,ks=new WeakMap,gs=new WeakMap,Fs=new WeakMap;function W(n,e,t=!1){var s=new Fo(n),a=t?Xn:0;function r(o,c){s.ensure(o,c)}Aa(()=>{var o=!1;e((c,l=!0)=>{o=!0,r(l,c)}),o||r(!1,null)},a)}function It(n,e){return e}function Lo(n,e,t){for(var s=[],a=e.length,r,o=e.length,c=0;c<a;c++){let k=e[c];Cn(k,()=>{if(r){if(r.pending.delete(k),r.done.add(k),r.pending.size===0){var g=n.outrogroups;da(Ls(r.done)),g.delete(r),g.size===0&&(n.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=s.length===0&&t!==null;if(l){var u=t,_=u.parentNode;Eo(_),_.append(u),n.items.clear()}da(e,!l)}else r={pending:new Set(e),done:new Set},(n.outrogroups??(n.outrogroups=new Set)).add(r)}function da(n,e=!0){for(var t=0;t<n.length;t++)at(n[t],e)}var Ya;function Qe(n,e,t,s,a,r=null){var o=n,c=new Map,l=(e&Ti)!==0;if(l){var u=n;o=u.appendChild(Xt())}var _=null,k=po(()=>{var y=t();return ka(y)?y:y==null?[]:Ls(y)}),g,w=!0;function O(){p.fallback=_,Po(p,g,o,e,s),_!==null&&(g.length===0?_.f&Yt?(_.f^=Yt,as(_,null,o)):Ca(_):Cn(_,()=>{_=null}))}var D=Aa(()=>{g=i(k);for(var y=g.length,M=new Set,C=te,B=Hi(),j=0;j<y;j+=1){var ve=g[j],G=s(ve,j),V=w?null:c.get(G);V?(V.v&&Zn(V.v,ve),V.i&&Zn(V.i,j),B&&C.skipped_effects.delete(V.e)):(V=jo(c,w?o:Ya??(Ya=Xt()),ve,G,j,a,e,t),w||(V.e.f|=Yt),c.set(G,V)),M.add(G)}if(y===0&&r&&!_&&(w?_=bt(()=>r(o)):(_=bt(()=>r(Ya??(Ya=Xt()))),_.f|=Yt)),!w)if(B){for(const[_e,ue]of c)M.has(_e)||C.skipped_effects.add(ue.e);C.oncommit(O),C.ondiscard(()=>{})}else O();i(k)}),p={effect:D,items:c,outrogroups:null,fallback:_};w=!1}function Po(n,e,t,s,a){var ue,me,Y,se,pe,P,h,T,I;var r=(s&Gr)!==0,o=e.length,c=n.items,l=n.effect.first,u,_=null,k,g=[],w=[],O,D,p,y;if(r)for(y=0;y<o;y+=1)O=e[y],D=a(O,y),p=c.get(D).e,p.f&Yt||((me=(ue=p.nodes)==null?void 0:ue.a)==null||me.measure(),(k??(k=new Set)).add(p));for(y=0;y<o;y+=1){if(O=e[y],D=a(O,y),p=c.get(D).e,n.outrogroups!==null)for(const F of n.outrogroups)F.pending.delete(p),F.done.delete(p);if(p.f&Yt)if(p.f^=Yt,p===l)as(p,null,t);else{var M=_?_.next:l;p===n.effect.last&&(n.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),an(n,_,p),an(n,p,M),as(p,M,t),_=p,g=[],w=[],l=_.next;continue}if(p.f&vt&&(Ca(p),r&&((se=(Y=p.nodes)==null?void 0:Y.a)==null||se.unfix(),(k??(k=new Set)).delete(p))),p!==l){if(u!==void 0&&u.has(p)){if(g.length<w.length){var C=w[0],B;_=C.prev;var j=g[0],ve=g[g.length-1];for(B=0;B<g.length;B+=1)as(g[B],C,t);for(B=0;B<w.length;B+=1)u.delete(w[B]);an(n,j.prev,ve.next),an(n,_,j),an(n,ve,C),l=C,_=ve,y-=1,g=[],w=[]}else u.delete(p),as(p,l,t),an(n,p.prev,p.next),an(n,p,_===null?n.effect.first:_.next),an(n,_,p),_=p;continue}for(g=[],w=[];l!==null&&l!==p;)(u??(u=new Set)).add(l),w.push(l),l=l.next;if(l===null)continue}p.f&Yt||g.push(p),_=p,l=p.next}if(n.outrogroups!==null){for(const F of n.outrogroups)F.pending.size===0&&(da(Ls(F.done)),(pe=n.outrogroups)==null||pe.delete(F));n.outrogroups.size===0&&(n.outrogroups=null)}if(l!==null||u!==void 0){var G=[];if(u!==void 0)for(p of u)p.f&vt||G.push(p);for(;l!==null;)!(l.f&vt)&&l!==n.fallback&&G.push(l),l=l.next;var V=G.length;if(V>0){var _e=s&Ti&&o===0?t:null;if(r){for(y=0;y<V;y+=1)(h=(P=G[y].nodes)==null?void 0:P.a)==null||h.measure();for(y=0;y<V;y+=1)(I=(T=G[y].nodes)==null?void 0:T.a)==null||I.fix()}Lo(n,G,_e)}}r&&es(()=>{var F,N;if(k!==void 0)for(p of k)(N=(F=p.nodes)==null?void 0:F.a)==null||N.apply()})}function jo(n,e,t,s,a,r,o,c){var l=o&Vr?o&Jr?On(t):bo(t,!1,!1):null,u=o&Xr?On(a):null;return{v:l,i:u,e:bt(()=>(r(e,l??t,u??a,c),()=>{n.delete(s)}))}}function as(n,e,t){if(n.nodes)for(var s=n.nodes.start,a=n.nodes.end,r=e&&!(e.f&Yt)?e.nodes.start:t;s!==null;){var o=ps(s);if(r.before(s),s===a)return;s=o}}function an(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}function Ko(n,e,t=!1,s=!1,a=!1){var r=n,o="";K(()=>{var c=fe;if(o!==(o=e()??"")&&(c.nodes!==null&&(Vi(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var u=lr(l);if((t||s)&&(u=un(u)),vs(un(u),u.lastChild),t||s)for(;un(u);)r.before(un(u));else r.before(u)}})}function cr(n){var e,t,s="";if(typeof n=="string"||typeof n=="number")s+=n;else if(typeof n=="object")if(Array.isArray(n)){var a=n.length;for(e=0;e<a;e++)n[e]&&(t=cr(n[e]))&&(s&&(s+=" "),s+=t)}else for(t in n)n[t]&&(s&&(s+=" "),s+=t);return s}function Ho(){for(var n,e,t=0,s="",a=arguments.length;t<a;t++)(n=arguments[t])&&(e=cr(n))&&(s&&(s+=" "),s+=e);return s}function Uo(n){return typeof n=="object"?Ho(n):n??""}function Yo(n,e,t){var s=n==null?"":""+n;return e&&(s=s?s+" "+e:e),s===""?null:s}function Qo(n,e){return n==null?null:String(n)}function Vt(n,e,t,s,a,r){var o=n.__className;if(o!==t||o===void 0){var c=Yo(t,s);c==null?n.removeAttribute("class"):n.className=c,n.__className=t}return r}function cs(n,e,t,s){var a=n.__style;if(a!==e){var r=Qo(e);r==null?n.removeAttribute("style"):n.style.cssText=r,n.__style=e}return s}function ur(n,e,t=!1){if(n.multiple){if(e==null)return;if(!ka(e))return to();for(var s of n.options)s.selected=e.includes(us(s));return}for(s of n.options){var a=us(s);if(To(a,e)){s.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Wo(n){var e=new MutationObserver(()=>{ur(n,n.__value)});e.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Da(()=>{e.disconnect()})}function Ts(n,e,t=e){var s=new WeakSet,a=!0;Sa(n,"change",r=>{var o=r?"[selected]":":checked",c;if(n.multiple)c=[].map.call(n.querySelectorAll(o),us);else{var l=n.querySelector(o)??n.querySelector("option:not([disabled])");c=l&&us(l)}t(c),te!==null&&s.add(te)}),Yi(()=>{var r=e();if(n===document.activeElement){var o=rs??te;if(s.has(o))return}if(ur(n,r,a),a&&r===void 0){var c=n.querySelector(":checked");c!==null&&(r=us(c),t(r))}n.__value=r,a=!1}),Wo(n)}function us(n){return"__value"in n?n.__value:n.value}const Vo=Symbol("is custom element"),Xo=Symbol("is html");function Xs(n,e){var t=dr(n);t.checked!==(t.checked=e??void 0)&&(n.checked=e)}function Se(n,e,t,s){var a=dr(n);a[e]!==(a[e]=t)&&(e==="loading"&&(n[Fr]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Go(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function dr(n){return n.__attributes??(n.__attributes={[Vo]:n.nodeName.includes("-"),[Xo]:n.namespaceURI===eo})}var Qa=new Map;function Go(n){var e=n.getAttribute("is")||n.nodeName,t=Qa.get(e);if(t)return t;Qa.set(e,t=[]);for(var s,a=n,r=Element.prototype;r!==a;){s=qr(a);for(var o in s)s[o].set&&t.push(o);a=gi(a)}return t}function dt(n,e,t=e){var s=new WeakSet;Sa(n,"input",async a=>{var r=a?n.defaultValue:n.value;if(r=Gs(n)?Js(r):r,t(r),te!==null&&s.add(te),await ar(),r!==(r=e())){var o=n.selectionStart,c=n.selectionEnd,l=n.value.length;if(n.value=r??"",c!==null){var u=n.value.length;o===c&&c===l&&u>l?(n.selectionStart=u,n.selectionEnd=u):(n.selectionStart=o,n.selectionEnd=Math.min(c,u))}}}),ts(e)==null&&n.value&&(t(Gs(n)?Js(n.value):n.value),te!==null&&s.add(te)),Hs(()=>{var a=e();if(n===document.activeElement){var r=rs??te;if(s.has(r))return}Gs(n)&&a===Js(n.value)||n.type==="date"&&!a&&!n.value||a!==n.value&&(n.value=a??"")})}function fr(n,e,t=e){Sa(n,"change",s=>{var a=s?n.defaultChecked:n.checked;t(a)}),ts(e)==null&&t(n.checked),Hs(()=>{var s=e();n.checked=!!s})}function Gs(n){var e=n.type;return e==="number"||e==="range"}function Js(n){return n===""?null:+n}function Wa(n,e){return n===e||(n==null?void 0:n[Kn])===e}function hs(n={},e,t,s){return Yi(()=>{var a,r;return Hs(()=>{a=r,r=(s==null?void 0:s())||[],ts(()=>{n!==t(...r)&&(e(n,...r),a&&Wa(t(...a),n)&&e(null,...a))})}),()=>{es(()=>{r&&Wa(t(...r),n)&&e(null,...r)})}}),n}function Jo(n,e,t,s){var a=s,r=!0,o=()=>(r&&(r=!1,a=s),a),c;c=n[e],c===void 0&&s!==void 0&&(c=o());var l;return l=()=>{var u=n[e];return u===void 0?o():(r=!0,u)},l}function Ia(n){it===null&&wi(),Wt(()=>{const e=ts(n);if(typeof e=="function")return e})}function Zo(n){it===null&&wi(),Ia(()=>()=>ts(n))}const $o="5";var ki;typeof window<"u"&&((ki=window.__svelte??(window.__svelte={})).v??(ki.v=new Set)).add($o);function el(){return{type:"daily",interval:1,time:"09:00"}}function vr(n){return!n||!n.type||!n.interval||n.interval<1?!1:n.type==="weekly"?Array.isArray(n.weekdays)&&n.weekdays.length>0&&n.weekdays.every(e=>e>=0&&e<=6):n.type==="monthly"?n.dayOfMonth>=1&&n.dayOfMonth<=31:n.type==="yearly"?n.month>=0&&n.month<=11&&n.dayOfMonth>=1&&n.dayOfMonth<=31:!0}const yn="recurring-tasks-active",Ds="recurring-tasks-archive",Va="recurring-tasks",Xa="recurring-tasks.json.bak",Ga="n8n-event-settings",Ja="n8n-event-queue",tl="notification-state",nl="recurring-tasks-dock",Za="scheduler-emitted-occurrences",As=3,fa={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},hr=60*1e3,sl=30*1e3,Zs=2e3,$a="shehab-note-recurring-plugin",ei="1.0.0",al=60*60*1e3,il=3,ti=10,$s=1e3,Cs=100,ni=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],si={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},rl=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],ol=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],ai="last-run-timestamp",ii="custom-recurring-task-id",ri="custom-recurring-task-due",oi="custom-recurring-task-enabled";function _r(n,e,t){const s=new Date().toISOString(),a=t||new Date;return{id:mr(),name:n,lastCompletedAt:void 0,dueAt:a.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:As,createdAt:s,updatedAt:s}}function mr(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function ll(n,e={}){const t=new Date().toISOString();return{...{...n,id:mr(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function cl(n){const e=new Date().toISOString();n.completionCount=(n.completionCount||0)+1,n.currentStreak=(n.currentStreak||0)+1,n.bestStreak=Math.max(n.bestStreak||0,n.currentStreak),n.recentCompletions||(n.recentCompletions=[]),n.recentCompletions.push(e),n.recentCompletions.length>ti&&(n.recentCompletions=n.recentCompletions.slice(-ti)),n.snoozeCount=0,n.lastCompletedAt=e,n.updatedAt=e}function kr(n){n.missCount=(n.missCount||0)+1,n.currentStreak=0,n.updatedAt=new Date().toISOString()}function gr(n){const e=n.completionCount||0,t=n.missCount||0,s=e+t;if(s===0)return 100;let r=e/s*70;const o=n.currentStreak||0,c=Math.min(30,o*3);return r+=c,Math.round(Math.min(100,r))}function bn(n){const{message:e,type:t="info",duration:s=3e3,actionLabel:a,onAction:r,showCountdown:o=!1}=n,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(a&&r){const k=document.createElement("button");k.type="button";let g=Math.max(1,Math.ceil(s/1e3));k.textContent=o?`${a} (${g}s)`:a,k.className="recurring-tasks-toast__action",k.addEventListener("click",()=>{r(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(k),o&&s>0&&(u=window.setInterval(()=>{g=Math.max(0,g-1),k.textContent=`${a} (${g}s)`,g<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:ul(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const _=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};s>0&&setTimeout(()=>{_()},s)}function ul(n){switch(n){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const $={success:(n,e)=>bn({message:n,type:"success",duration:e}),error:(n,e)=>bn({message:n,type:"error",duration:e}),warning:(n,e)=>bn({message:n,type:"warning",duration:e}),info:(n,e)=>bn({message:n,type:"info",duration:e})};if(typeof document<"u"){const n=document.createElement("style");n.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(n)}class dl{constructor(){b(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(a=>a(t))}clear(){this.handlers.clear()}}const nt=new dl;function li(n,e){const t=n.findIndex(a=>a.id===e.id);if(t===-1)return[...n,e];const s=[...n];return s[t]=e,s}function ci(n,e){const t=n.filter(s=>s.id!==e);return t.length===n.length?n:t}function ea(n,e,t){let s=!1;const a=n.map(r=>r.id!==e?r:(s=!0,t(r)));return s?a:n}function fl(n,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),n.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const vl=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function Us(n,e,t){const s={timestamp:new Date().toISOString()},a=`[${n.toUpperCase()}] [${s.timestamp}]`;n==="error"?console.error(a,e,t||""):n==="warn"?console.warn(a,e,t||""):n==="debug"&&vl?console.debug(a,e,t||""):n==="info"&&console.log(a,e,t||"")}function pr(n,e){Us("debug",n,e)}function U(n,e){Us("info",n,e)}function xt(n,e){Us("warn",n,e)}function he(n,e){Us("error",n,e)}async function hl(n){return new Promise(e=>{try{ma.fetchPost("/api/block/getBlockInfo",{id:n},t=>{var a,r,o;const s=((a=t==null?void 0:t.data)==null?void 0:a.content)??((r=t==null?void 0:t.data)==null?void 0:r.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){xt("Failed to fetch block preview",t),e(null)}})}async function _l(n){return new Promise(e=>{try{ma.fetchPost("/api/block/getBlockHTML",{id:n},t=>{var a;const s=((a=t==null?void 0:t.data)==null?void 0:a.html)??null;e(s?s.trim():null)})}catch(t){xt("Failed to fetch block embed",t),e(null)}})}function yr(n){const[e,t]=n.split(":").map(Number);return{hours:e,minutes:t}}function ml(n){const e=n.getHours().toString().padStart(2,"0"),t=n.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function kl(n){return n.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Ns(n){return n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function xa(n){const e=new Date;return n.getDate()===e.getDate()&&n.getMonth()===e.getMonth()&&n.getFullYear()===e.getFullYear()}function gl(n){return n<new Date}function pl(n){return gl(n)&&!xa(n)}function _s(n,e){const t=new Date(n);return t.setDate(t.getDate()+e),t}function ui(n,e){return _s(n,e*7)}function yl(n,e,t){const s=new Date(n);s.setHours(e,t,0,0);const a=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:a}}function va(n){const e=new Date(n);return e.setHours(0,0,0,0),e}function bl(n){const e=new Date(n);return e.setHours(23,59,59,999),e}function wl(n,e){const s=Math.abs(e.getTime()-n.getTime());return Math.floor(s/864e5)}function Tl(n,e){const t=[];for(let s=0;s<e;s++)t.push(_s(n,s));return t}var Sl=x('<span class="task-card__streak svelte-yjw1ud"> </span>'),El=x('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),Dl=x('<span class="task-card__relative svelte-yjw1ud"> </span>'),Al=x('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),Cl=x('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),Il=x('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),xl=x('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),Ml=x('<button class="task-card__snooze-chip svelte-yjw1ud"> </button>'),Ol=x('<button class="task-card__snooze-option svelte-yjw1ud" role="menuitem"> </button>'),ql=x('<div class="task-card__snooze-menu svelte-yjw1ud" role="menu" tabindex="0"></div>'),Nl=x('<div role="article"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar svelte-yjw1ud"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze svelte-yjw1ud" aria-label="Snooze task">üïí Snooze</button> <div class="task-card__snooze-quick svelte-yjw1ud"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow svelte-yjw1ud" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay svelte-yjw1ud" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip svelte-yjw1ud" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done svelte-yjw1ud" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function Rl(n,e){Pt(e,!0);const t=X(()=>new Date(e.task.dueAt)),s=X(()=>pl(i(t))),a=X(()=>xa(i(t))),r=X(()=>i(s)?wl(new Date(e.task.dueAt),new Date):0),o=X(()=>i(s)?"task-card--overdue":i(a)?"task-card--today":""),c=X(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+i(r)*.05)})`:""),l=X(()=>()=>i(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+i(r)*.08)})`:""),u=X(()=>e.task.priority?si[e.task.priority]:si.normal),_=X(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(i(t)):""),k=X(()=>(e.task.currentStreak||0)>0),g=X(()=>()=>"üî•"),w=X(()=>gr(e.task)),O=X(()=>i(w)>=80?"health--good":i(w)>=50?"health--fair":"health--poor");let D=H(!1),p=H(-1),y=H(Me([])),M=H(!1),C=H(null),B=H(null),j=H(!1);const ve=X(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),G=X(()=>()=>{if(!i(C))return"";const R=i(C).replace(/\s+/g," ").trim();return R.length>220?`${R.slice(0,220)}‚Ä¶`:R}),V=X(()=>()=>ni.filter(R=>[15,60,120].includes(R.minutes)));Wt(()=>{f(C,e.task.linkedBlockContent??null,!0),f(B,null),f(j,!1)});function _e(){e.onDone(e.task)}function ue(){e.onDelay(e.task)}function me(){e.onEdit&&e.onEdit(e.task)}function Y(){e.onSkip(e.task)}async function se(){f(D,!i(D)),i(D)&&(await ar(),f(p,-1),f(y,[],!0))}function pe(R){const J=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:R}});window.dispatchEvent(J),f(D,!1),f(p,-1)}function P(R){var de,Ce,$e,Ke;const J=i(V);R.key==="ArrowDown"?(R.preventDefault(),f(p,Math.min(i(p)+1,J.length-1),!0),(de=i(y)[i(p)])==null||de.focus()):R.key==="ArrowUp"?(R.preventDefault(),f(p,Math.max(i(p)-1,0),!0),(Ce=i(y)[i(p)])==null||Ce.focus()):R.key==="Escape"?(f(D,!1),f(p,-1)):R.key==="Home"?(R.preventDefault(),f(p,0),($e=i(y)[0])==null||$e.focus()):R.key==="End"&&(R.preventDefault(),f(p,J.length-1),(Ke=i(y)[i(p)])==null||Ke.focus())}function h(R){if(R.key==="Escape"&&i(D)){f(D,!1);return}(R.key==="Enter"||R.key===" ")&&(R.preventDefault(),se())}async function T(){if(f(M,!0),!e.task.linkedBlockId||i(j)||i(B))return;f(j,!0);const[R,J]=await Promise.all([_l(e.task.linkedBlockId),hl(e.task.linkedBlockId)]);f(B,R,!0),f(C,J,!0),f(j,!1)}function I(){f(M,!1)}const F=X(()=>()=>`Task: ${e.task.name.replace(/[<>"&]/g,J=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[J]||J)}`);var N=Nl();N.__keydown=R=>{R.key==="Escape"&&i(D)&&f(D,!1)};var Q=d(N),ee=d(Q),re=d(ee),oe=v(re,2),be=d(oe),Ee=v(oe,2);{var ge=R=>{var J=Sl(),de=d(J);K(Ce=>{Se(J,"title",`${e.task.currentStreak??""} day streak`),z(de,`${Ce??""} ${e.task.currentStreak??""}`)},[()=>i(g)()]),E(R,J)};W(Ee,R=>{i(k)&&R(ge)})}var Ie=v(ee,2);{var xe=R=>{var J=El();J.__click=me,E(R,J)};W(Ie,R=>{e.onEdit&&R(xe)})}var De=v(Q,2),Xe=d(De),Et=v(d(Xe),2),S=d(Et),q=v(Et,2);{var ce=R=>{var J=Dl(),de=d(J);K(Ce=>z(de,Ce),[()=>i(_)()]),E(R,J)};W(q,R=>{e.timezoneHandler&&R(ce)})}var le=v(Xe,2);{var Ae=R=>{var J=Al(),de=v(d(J),2),Ce=d(de);K($e=>z(Ce,$e),[()=>Ns(new Date(e.task.lastCompletedAt))]),E(R,J)};W(le,R=>{e.task.lastCompletedAt&&R(Ae)})}var ye=v(le,2);{var we=R=>{var J=xl(),de=d(J),Ce=d(de),$e=v(de,2);{var Ke=Mt=>{var Ot=Il(),qt=d(Ot);{var mn=Nt=>{var He=Vs("Loading preview‚Ä¶");E(Nt,He)},zn=Nt=>{var He=dn(),nn=wt(He);{var ns=Kt=>{var Ht=Cl(),kn=d(Ht);Ko(kn,()=>i(B)),E(Kt,Ht)},Fn=Kt=>{var Ht=dn(),kn=wt(Ht);{var bs=sn=>{var Ln=Vs();K(()=>z(Ln,i(G))),E(sn,Ln)},Ys=sn=>{var Ln=Vs("No preview available.");E(sn,Ln)};W(kn,sn=>{i(C)?sn(bs):sn(Ys,!1)},!0)}E(Kt,Ht)};W(nn,Kt=>{i(B)?Kt(ns):Kt(Fn,!1)},!0)}E(Nt,He)};W(qt,Nt=>{i(j)?Nt(mn):Nt(zn,!1)})}E(Mt,Ot)};W($e,Mt=>{i(M)&&Mt(Ke)})}K(()=>{Se(de,"title",`Linked block: ${e.task.linkedBlockId}`),z(Ce,`üìù Block ${i(ve)??""}`)}),ft("mouseenter",de,T),ft("mouseleave",de,I),ft("focus",de,T),ft("blur",de,I),E(R,J)};W(ye,R=>{e.task.linkedBlockId&&R(we)})}var Ne=v(De,2),Ge=d(Ne),Pe=v(Ne,2),ht=d(Pe),_t=d(ht);_t.__click=se,_t.__keydown=h;var Je=v(_t,2),ke=d(Je);Qe(ke,17,()=>i(V),It,(R,J)=>{var de=Ml();de.__click=()=>pe(i(J).minutes);var Ce=d(de);K(()=>{Se(de,"aria-label",`Snooze for ${i(J).label}`),z(Ce,i(J).label)}),E(R,de)});var Ze=v(ke,2);Ze.__click=ue;var je=v(Je,2);{var tn=R=>{var J=ql();J.__keydown=P,Qe(J,21,()=>ni,It,(de,Ce,$e)=>{var Ke=Ol();Ke.__click=()=>pe(i(Ce).minutes),Se(Ke,"tabindex",$e===0?0:-1);var Mt=d(Ke);hs(Ke,(Ot,qt)=>i(y)[qt]=Ot,Ot=>{var qt;return(qt=i(y))==null?void 0:qt[Ot]},()=>[$e]),K(()=>z(Mt,i(Ce).label)),E(de,Ke)}),E(R,J)};W(je,R=>{i(D)&&R(tn)})}var rt=v(ht,2);rt.__click=ue;var _n=v(rt,2);_n.__click=Y;var Bn=v(_n,2);Bn.__click=_e,K((R,J)=>{Vt(N,1,`task-card ${i(o)??""}`,"svelte-yjw1ud"),cs(N,`--overdue-tint: ${i(c)??""}; --overdue-border: ${i(l)??""};`),Se(N,"aria-label",R),cs(re,`background-color: ${i(u)??""}`),Se(re,"title",`Priority: ${(e.task.priority||"normal")??""}`),z(be,e.task.name),z(S,J),Vt(Ne,1,`task-card__health ${i(O)??""}`,"svelte-yjw1ud"),Se(Ne,"title",`Task health: ${i(w)??""}%`),cs(Ge,`width: ${i(w)??""}%`),Se(_t,"aria-expanded",i(D))},[()=>i(F)(),()=>Ns(i(t))]),E(n,N),jt()}Rn(["keydown","click"]);var Bl=x(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),zl=x('<div class="today-tab__card-wrapper svelte-u7986x"><!></div>'),Fl=x('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x"><!></div></div>');function Ll(n,e){Pt(e,!0);const t=X(()=>[...e.tasks].sort((D,p)=>new Date(D.dueAt).getTime()-new Date(p.dueAt).getTime()));let s=H(0),a=Me([]);Wt(()=>{i(s)>=i(t).length&&f(s,Math.max(0,i(t).length-1),!0)});function r(D){var y;if(i(t).length===0)return;const p=Math.max(0,Math.min(D,i(t).length-1));f(s,p,!0),(y=a[p])==null||y.focus()}function o(D,p){D.key==="ArrowDown"?(D.preventDefault(),r(p+1)):D.key==="ArrowUp"?(D.preventDefault(),r(p-1)):D.key==="Home"?(D.preventDefault(),r(0)):D.key==="End"&&(D.preventDefault(),r(i(t).length-1))}var c=Fl(),l=d(c),u=v(d(l),2),_=d(u),k=v(l,2),g=d(k);{var w=D=>{var p=Bl();E(D,p)},O=D=>{var p=dn(),y=wt(p);Qe(y,19,()=>i(t),M=>M.id,(M,C,B)=>{var j=zl();j.__keydown=G=>o(G,i(B));var ve=d(j);Rl(ve,{get task(){return i(C)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),hs(j,(G,V)=>a[V]=G,G=>a==null?void 0:a[G],()=>[i(B)]),K(()=>Se(j,"tabindex",i(B)===i(s)?0:-1)),ft("focus",j,()=>f(s,i(B),!0)),E(M,j)}),E(D,p)};W(g,D=>{i(t).length===0?D(w):D(O,!1)})}K(()=>z(_,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),E(n,c),jt()}Rn(["keydown"]);var Pl=x('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),jl=x('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Kl=x('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),Hl=x('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ul=x('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),Yl=x('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Ql=x('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Wl=x('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function Vl(n,e){Pt(e,!0);let t=H(null),s=H(!1),a=H(""),r=H(""),o=H(Me(new Set)),c=H(0),l=Me([]),u=H(null);const _=X(()=>[...e.tasks].sort((S,q)=>new Date(S.dueAt).getTime()-new Date(q.dueAt).getTime())),k=X(()=>()=>{const S=i(r).trim().toLowerCase();return S?i(_).filter(q=>{var le;return[q.name,q.description,q.category,q.linkedBlockContent,(le=q.tags)==null?void 0:le.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(S)}):i(_)}),g=X(()=>i(k).map(S=>S.id)),w=X(()=>i(o).size>0),O=X(()=>i(k).length>0&&i(k).every(S=>i(o).has(S.id))),D=X(()=>i(k).some(S=>i(o).has(S.id))&&!i(O));Wt(()=>{const S=new Set([...i(o)].filter(q=>e.tasks.some(ce=>ce.id===q)));S.size!==i(o).size&&f(o,S,!0)}),Wt(()=>{i(u)&&(i(u).indeterminate=i(D))}),Wt(()=>{i(c)>=i(k).length&&f(c,Math.max(0,i(k).length-1),!0)}),Wt(()=>{const S=window.setTimeout(()=>{f(r,i(a),!0)},300);return()=>{window.clearTimeout(S)}});function p(S){f(t,S,!0)}function y(){i(t)&&(e.onDelete(i(t)),f(t,null))}function M(){f(t,null)}function C(S){const q=new Set(i(o));q.has(S)?q.delete(S):q.add(S),f(o,q,!0)}function B(){const S=new Set(i(o));i(O)?i(g).forEach(q=>S.delete(q)):i(g).forEach(q=>S.add(q)),f(o,S,!0)}function j(S){var ce;if(i(k).length===0)return;const q=Math.max(0,Math.min(S,i(k).length-1));f(c,q,!0),(ce=l[q])==null||ce.focus()}function ve(S,q){S.key==="ArrowDown"?(S.preventDefault(),j(q+1)):S.key==="ArrowUp"?(S.preventDefault(),j(q-1)):S.key==="Home"?(S.preventDefault(),j(0)):S.key==="End"&&(S.preventDefault(),j(i(k).length-1))}function G(){if(i(o).size===0){f(s,!1);return}e.onBulkDelete([...i(o)]),f(o,new Set,!0),f(s,!1)}function V(){f(s,!1)}function _e(S){const{type:q,interval:ce}=S.frequency,le=q==="daily"?"day":q==="weekly"?"week":q==="monthly"?"month":"year",Ae=ce===1?`Every ${le}`:`Every ${ce} ${le}s`;if(q==="weekly")return`${Ae} on ${S.frequency.weekdays.map(ye=>ol[ye]??ye).join(", ")}`;if(q==="monthly")return`${Ae} on day ${S.frequency.dayOfMonth}`;if(q==="yearly"){const ye=ue[S.frequency.month]??`Month ${S.frequency.month+1}`;return`${Ae} on ${ye} ${S.frequency.dayOfMonth}`}return Ae}const ue=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var me=Wl(),Y=wt(me),se=d(Y),pe=v(d(se),2),P=d(pe),h=v(d(P),2),T=v(P,2);T.__click=function(...S){var q;(q=e.onCreate)==null||q.apply(this,S)};var I=v(se,2),F=d(I),N=d(F),Q=d(N),ee=v(N,2),re=d(ee);re.__click=()=>e.onBulkEnable([...i(o)]);var oe=v(re,2);oe.__click=()=>e.onBulkDisable([...i(o)]);var be=v(oe,2);be.__click=()=>f(s,!0);var Ee=v(F,2);{var ge=S=>{var q=Pl();E(S,q)},Ie=S=>{var q=Ul(),ce=d(q);{var le=ye=>{var we=jl(),Ne=d(we),Ge=d(Ne);K(Pe=>z(Ge,`No tasks match "${Pe??""}".`),[()=>i(r).trim()]),E(ye,we)},Ae=ye=>{var we=Hl(),Ne=d(we),Ge=d(Ne),Pe=d(Ge),ht=d(Pe);ht.__click=B,hs(ht,Je=>f(u,Je),()=>i(u));var _t=v(Ne);Qe(_t,23,()=>i(k),Je=>Je.id,(Je,ke,Ze)=>{var je=Kl();je.__keydown=He=>ve(He,i(Ze));var tn=d(je),rt=d(tn);rt.__click=()=>C(i(ke).id);var _n=v(tn),Bn=d(_n),R=v(_n),J=d(R),de=v(R),Ce=d(de),$e=v(de),Ke=d($e),Mt=d(Ke);Mt.__change=()=>e.onToggleEnabled(i(ke));var Ot=v($e),qt=d(Ot),mn=d(qt);mn.__click=()=>e.onEdit(i(ke));var zn=v(mn,2);zn.__click=()=>e.onDuplicate(i(ke));var Nt=v(zn,2);Nt.__click=()=>p(i(ke)),hs(je,(He,nn)=>l[nn]=He,He=>l==null?void 0:l[He],()=>[i(Ze)]),K((He,nn,ns,Fn)=>{Vt(je,1,Uo(i(ke).enabled?"":"disabled"),"svelte-i091qn"),Se(je,"tabindex",i(Ze)===i(c)?0:-1),Se(je,"aria-selected",He),Se(rt,"aria-label",`Select ${i(ke).name}`),Xs(rt,nn),z(Bn,i(ke).name),z(J,ns),z(Ce,Fn),Xs(Mt,i(ke).enabled)},[()=>i(o).has(i(ke).id),()=>i(o).has(i(ke).id),()=>Ns(new Date(i(ke).dueAt)),()=>_e(i(ke))]),ft("focus",je,()=>f(c,i(Ze),!0)),E(Je,je)}),K(()=>{Xs(ht,i(O)),ht.disabled=i(k).length===0}),E(ye,we)};W(ce,ye=>{i(k).length===0?ye(le):ye(Ae,!1)})}E(S,q)};W(Ee,S=>{i(_).length===0?S(ge):S(Ie,!1)})}var xe=v(Y,2);{var De=S=>{var q=Yl(),ce=d(q),le=v(d(ce),2),Ae=d(le),ye=v(le,2),we=d(ye);we.__click=M;var Ne=v(we,2);Ne.__click=y,K(()=>z(Ae,`Are you sure you want to delete "${i(t).name??""}"? This action cannot be undone.`)),E(S,q)};W(xe,S=>{i(t)&&S(De)})}var Xe=v(xe,2);{var Et=S=>{var q=Ql(),ce=d(q),le=v(d(ce),2),Ae=d(le),ye=v(le,2),we=d(ye);we.__click=V;var Ne=v(we,2);Ne.__click=G,K(()=>z(Ae,`Are you sure you want to delete ${i(o).size??""} task${i(o).size===1?"":"s"}? This action cannot be undone.`)),E(S,q)};W(Xe,S=>{i(s)&&S(Et)})}K(()=>{h.disabled=i(_).length===0,z(Q,`${i(o).size??""} selected`),re.disabled=!i(w),oe.disabled=!i(w),be.disabled=!i(w)}),dt(h,()=>i(a),S=>f(a,S)),E(n,me),jt()}Rn(["click","keydown","change"]);var Xl=x('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Gl=x('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Jl=x('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Zl=x('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),$l=x('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),ec=x('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),tc=x('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),nc=x('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function sc(n,e){Pt(e,!0);let t=Jo(e,"days",3,30);function s(y){const{frequency:M}=y;if(M.type==="weekly"){const C=[...M.weekdays].sort((B,j)=>B-j).join(",");return`weekly:${M.interval}:${M.time??""}:${C}`}return M.type==="monthly"?`monthly:${M.interval}:${M.time??""}:${M.dayOfMonth}`:M.type==="yearly"?`yearly:${M.interval}:${M.time??""}:${M.month}:${M.dayOfMonth}`:`daily:${M.interval}:${M.time??""}`}function a(y,M){const C=y.map(B=>`${B.id}:${B.enabled}:${B.dueAt}:${s(B)}`).join("|");return`${M}:${C}`}function r(y,M){const C=va(new Date),B=bl(_s(C,M-1)),j=24*60*60*1e3,G=Tl(C,M).map(V=>({date:V,tasks:[]}));for(const V of y.filter(_e=>_e.enabled)){const _e=new Date(V.dueAt),ue=e.recurrenceEngine.getOccurrencesInRange(C,B,V.frequency,_e);for(const me of ue){const Y=va(me),se=Math.floor((Y.getTime()-C.getTime())/j);se>=0&&se<M&&G[se].tasks.push({task:V,occurrence:me})}}for(const V of G)V.tasks.sort((_e,ue)=>_e.occurrence.getTime()-ue.occurrence.getTime());return G}const o=(()=>{let y="",M=[];return{get(C,B){const j=a(C,B);return j===y||(y=j,M=r(C,B)),M}}})(),c=X(()=>o.get(e.tasks,t())),l=X(()=>i(c).some(y=>y.tasks.length>0));var u=nc(),_=d(u),k=v(d(_),2),g=d(k),w=v(_,2),O=d(w);{var D=y=>{var M=Xl(),C=d(M),B=d(C);K(()=>z(B,`No tasks scheduled in the next ${t()??""} days.`)),E(y,M)},p=y=>{var M=tc();Qe(M,21,()=>i(c),C=>C.date.toISOString(),(C,B)=>{var j=dn(),ve=wt(j);{var G=V=>{var _e=ec(),ue=d(_e),me=d(ue),Y=d(me),se=v(me,2),pe=d(se),P=v(ue,2);Qe(P,21,()=>i(B).tasks,({task:h,occurrence:T})=>h.id+T.toISOString(),(h,T)=>{let I=()=>i(T).task,F=()=>i(T).occurrence;var N=$l(),Q=d(N),ee=d(Q),re=v(Q,2),oe=d(re),be=d(oe),Ee=v(oe,2),ge=d(Ee);{var Ie=S=>{var q=Gl(),ce=d(q);K(()=>z(ce,`üîó ${I().linkedBlockId??""}`)),E(S,q)};W(ge,S=>{I().linkedBlockId&&S(Ie)})}var xe=v(ge,2);{var De=S=>{var q=Jl(),ce=d(q);K(()=>z(ce,`‚ö° ${I().priority??""}`)),E(S,q)};W(xe,S=>{I().priority&&S(De)})}var Xe=v(xe,2);{var Et=S=>{var q=Zl(),ce=d(q);K(le=>z(ce,`üè∑Ô∏è ${le??""}`),[()=>I().tags.join(", ")]),E(S,q)};W(Xe,S=>{var q;(q=I().tags)!=null&&q.length&&S(Et)})}K(S=>{z(ee,S),z(be,I().name)},[()=>ml(F())]),E(h,N)}),K((h,T)=>{z(Y,h),z(pe,T)},[()=>kl(i(B).date),()=>i(B).date.toLocaleDateString(void 0,{weekday:"short"})]),E(V,_e)};W(ve,V=>{i(B).tasks.length>0&&V(G)})}E(C,j)}),E(y,M)};W(O,y=>{i(l)?y(p,!1):y(D)})}K(()=>z(g,`Next ${t()??""} days`)),E(n,u),jt()}var ac=x('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),ic=x('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),rc=x('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),oc=x('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),lc=x('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),cc=x('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),uc=x('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),dc=x('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),fc=x('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),vc=x('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function hc(n,e){Pt(e,!0);const t=X(()=>()=>{let h=0,T=0;for(const N of e.tasks)h+=N.completionCount||0,T+=N.missCount||0;const I=h+T,F=I>0?h/I*100:100;return{totalCompletions:h,totalMisses:T,completionRate:Math.round(F)}}),s=X(()=>()=>[...e.tasks].filter(h=>(h.currentStreak||0)>0).sort((h,T)=>(T.currentStreak||0)-(h.currentStreak||0)).slice(0,10)),a=X(()=>()=>[...e.tasks].map(h=>({task:h,health:gr(h)})).sort((h,T)=>h.health-T.health)),r=X(()=>()=>i(a)().slice(-5).reverse()),o=X(()=>()=>i(a)().slice(0,5)),c=X(()=>()=>{const h=[];for(const T of e.tasks)if(T.recentCompletions&&T.recentCompletions.length>0)for(const I of T.recentCompletions)h.push({task:T,completedAt:I});return h.sort((T,I)=>new Date(I.completedAt).getTime()-new Date(T.completedAt).getTime()).slice(0,10)});function l(h){return new Date(h).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(h){return h>=80?"#10b981":h>=60?"#3b82f6":h>=40?"#f59e0b":"#ef4444"}var _=vc(),k=v(d(_),2),g=d(k),w=v(d(g),2),O=d(w),D=d(O),p=d(D),y=v(O,2),M=d(y),C=d(M),B=v(y,2),j=d(B),ve=d(j),G=v(g,2);{var V=h=>{var T=rc(),I=v(d(T),2);Qe(I,21,()=>i(s)(),It,(F,N,Q)=>{var ee=ic(),re=d(ee);re.textContent=`#${Q+1}`;var oe=v(re,2),be=d(oe),Ee=v(oe,2),ge=d(Ee),Ie=v(ge);{var xe=De=>{var Xe=ac();E(De,Xe)};W(Ie,De=>{i(N).bestStreak&&i(N).currentStreak===i(N).bestStreak&&De(xe)})}K(()=>{z(be,i(N).name),z(ge,`${i(N).currentStreak??""} day${i(N).currentStreak!==1?"s":""} `)}),E(F,ee)}),E(h,T)};W(G,h=>{i(s)().length>0&&h(V)})}var _e=v(G,2),ue=v(d(_e),2);{var me=h=>{var T=lc(),I=v(wt(T),2);Qe(I,21,()=>i(r)(),It,(F,N)=>{let Q=()=>i(N).task,ee=()=>i(N).health;var re=oc(),oe=d(re),be=d(oe),Ee=v(oe,2),ge=d(Ee),Ie=v(ge,2),xe=d(Ie);K(De=>{z(be,Q().name),cs(ge,`width: ${ee()??""}%; background-color: ${De??""}`),z(xe,`${ee()??""}/100`)},[()=>u(ee())]),E(F,re)}),E(h,T)};W(ue,h=>{i(r)().length>0&&h(me)})}var Y=v(ue,2);{var se=h=>{var T=uc(),I=v(wt(T),2);Qe(I,21,()=>i(o)(),It,(F,N)=>{let Q=()=>i(N).task,ee=()=>i(N).health;var re=cc(),oe=d(re),be=d(oe),Ee=v(oe,2),ge=d(Ee),Ie=v(ge,2),xe=d(Ie);K(De=>{z(be,Q().name),cs(ge,`width: ${ee()??""}%; background-color: ${De??""}`),z(xe,`${ee()??""}/100`)},[()=>u(ee())]),E(F,re)}),E(h,T)};W(Y,h=>{i(o)().length>0&&i(o)()[0].health<80&&h(se)})}var pe=v(_e,2);{var P=h=>{var T=fc(),I=v(d(T),2);Qe(I,21,()=>i(c)(),It,(F,N)=>{let Q=()=>i(N).task,ee=()=>i(N).completedAt;var re=dc(),oe=v(d(re),2),be=d(oe),Ee=d(be),ge=v(be,2),Ie=d(ge);K(xe=>{z(Ee,Q().name),z(Ie,xe)},[()=>l(ee())]),E(F,re)}),E(h,T)};W(pe,h=>{i(c)().length>0&&h(P)})}K((h,T,I)=>{z(p,h),z(C,T),z(ve,`${I??""}%`)},[()=>i(t)().totalCompletions,()=>i(t)().totalMisses,()=>i(t)().completionRate]),E(n,_),jt()}class br{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,a)=>s-a)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t){const{type:s,time:a}=t,r=this.normalizeInterval(t.interval);let o;switch(s){case"daily":o=this.calculateNextDaily(e,r);break;case"weekly":o=this.calculateNextWeekly(e,r,this.normalizeWeekdays(t.weekdays));break;case"monthly":o=this.calculateNextMonthly(e,r,this.normalizeDayOfMonth(t.dayOfMonth,e.getDate()));break;case"yearly":o=this.calculateNextYearly(e,r,this.normalizeMonth(t.month,e.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,e.getDate()));break;default:throw new Error(`Unknown frequency type: ${s}`)}if(a){const{hours:c,minutes:l}=yr(a);if(Number.isFinite(c)&&Number.isFinite(l)){const{date:u,shifted:_}=yl(o,c,l);_&&xt("DST shift detected while applying recurrence time",{requestedTime:a,original:o.toISOString(),adjusted:u.toISOString()}),o=u}}return o}calculateNextDaily(e,t){return _s(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return ui(e,t);const a=this.getMondayIndex(e),r=Math.min($s,t*14);for(let o=1;o<=r;o++){if(Math.floor((a+o)/7)%t!==0)continue;const l=_s(e,o),u=this.getMondayIndex(l);if(s.includes(u))return l}return xt("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),ui(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const a=s??e.getDate(),r=e.getFullYear(),c=e.getMonth()+t,l=r+Math.floor(c/12),u=(c%12+12)%12,_=new Date(l,u+1,0).getDate(),k=Math.min(a,_),g=new Date(e);return g.setFullYear(l,u,k),g}calculateNextYearly(e,t,s,a){const r=a??e.getDate(),o=e.getFullYear()+t,c=new Date(o,s+1,0).getDate(),l=Math.min(r,c),u=new Date(e);return u.setFullYear(o,s,l),u}getOccurrencesInRange(e,t,s,a){const r=[];let o=new Date(a),c=0;for(;o<=t&&c<$s;)o>=e&&r.push(new Date(o)),o=this.calculateNext(o,s),c++;return r}getMissedOccurrences(e,t,s,a){const r=[];let o=new Date(a),c=0;for(;o<=e&&c<$s;)o=this.calculateNext(o,s),c++;let l=0;for(;o<t&&l<Cs;)r.push(new Date(o)),o=this.calculateNext(o,s),l++;return l>=Cs&&xt("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:a.toISOString(),cap:Cs}),r}}const wr="recurring-task-templates";function Ma(){if(typeof window>"u")return[];try{const n=window.localStorage.getItem(wr);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e.filter(t=>!!t&&typeof t.id=="string"):[]}catch{return[]}}function _c(n){const e=Ma(),t=e.findIndex(s=>s.id===n.id);return t>=0?e[t]=n:e.push(n),Tr(e),e}function mc(n){const e=Ma().filter(t=>t.id!==n);return Tr(e),e}function Tr(n){typeof window>"u"||window.localStorage.setItem(wr,JSON.stringify(n))}function kc(){return`template_${Date.now()}_${Math.random().toString(36).slice(2,8)}`}var gc=x("<option> </option>"),pc=x('<div class="task-form__error svelte-egfst" id="task-name-error"> </div>'),yc=x('<div class="task-form__error svelte-egfst" id="task-due-error"> </div>'),bc=x('<button type="button"> </button>'),wc=x('<div class="task-form__error svelte-egfst"> </div>'),Tc=x('<div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="weekdays-group">Weekdays</label> <div id="weekdays-group" class="task-form__weekdays svelte-egfst" role="group" aria-label="Select weekdays"></div> <!></div>'),Sc=x('<div class="task-form__error svelte-egfst" id="task-day-error"> </div>'),Ec=x('<div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="day-of-month">Day of Month</label> <input id="day-of-month" class="task-form__input svelte-egfst" type="number" min="1" max="31" aria-describedby="task-day-error"/> <!></div>'),Dc=x("<option> </option>"),Ac=x('<div class="task-form__error svelte-egfst"> </div>'),Cc=x('<div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-month">Month</label> <select id="task-month" class="task-form__select svelte-egfst"></select> <!></div>'),Ic=x('<p class="task-form__preview-message svelte-egfst"> </p>'),xc=x("<li> </li>"),Mc=x('<ul class="task-form__preview-list svelte-egfst"></ul>'),Oc=x('<div class="task-form svelte-egfst"><h2 class="task-form__title svelte-egfst"> </h2> <div class="task-form__section task-form__section--templates svelte-egfst"><h3 class="task-form__section-title svelte-egfst">Templates</h3> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-template">Choose Template</label> <select id="task-template" class="task-form__select svelte-egfst"><option>Select a template</option><!></select></div> <div class="task-form__field task-form__template-actions svelte-egfst"><input class="task-form__input svelte-egfst" type="text" placeholder="Template name"/> <button type="button" class="task-form__button task-form__button--secondary svelte-egfst">Save Template</button> <button type="button" class="task-form__button task-form__button--ghost svelte-egfst">Delete Template</button></div></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-name">Task Name *</label> <input id="task-name" class="task-form__input svelte-egfst" type="text" placeholder="Enter task name" aria-describedby="task-name-error"/> <!></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-due">Due Date & Time *</label> <input id="task-due" class="task-form__input svelte-egfst" type="datetime-local" aria-describedby="task-due-error"/> <!></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="frequency-type">Frequency Type</label> <select id="frequency-type" class="task-form__select svelte-egfst"><option>Daily</option><option>Weekly</option><option>Monthly</option><option>Yearly</option></select></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-interval">Repeat Every (interval)</label> <input id="task-interval" class="task-form__input svelte-egfst" type="number" min="1"/></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-time">Time (HH:mm)</label> <input id="task-time" class="task-form__input svelte-egfst" type="time"/></div> <!> <!> <!> <div class="task-form__field task-form__field--preview svelte-egfst"><div class="task-form__label svelte-egfst">Next 3 occurrences</div> <!></div> <div class="task-form__field svelte-egfst"><label class="task-form__checkbox svelte-egfst"><input type="checkbox" class="svelte-egfst"/> <span>Enabled</span></label></div> <div class="task-form__section svelte-egfst"><h3 class="task-form__section-title svelte-egfst">Routing Metadata</h3> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-block">Linked Block ID</label> <input id="task-block" class="task-form__input svelte-egfst" type="text" placeholder="20260112101010-abcdef"/></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-priority">Priority</label> <select id="task-priority" class="task-form__select svelte-egfst"><option>Low</option><option>Normal</option><option>High</option></select></div> <div class="task-form__field svelte-egfst"><label class="task-form__label svelte-egfst" for="task-tags">Tags</label> <input id="task-tags" class="task-form__input svelte-egfst" type="text" placeholder="health, habit"/></div></div> <div class="task-form__actions svelte-egfst"><button class="task-form__button task-form__button--cancel svelte-egfst">Cancel</button> <button class="task-form__button task-form__button--save svelte-egfst">Save Task</button></div></div>');function qc(n,e){Pt(e,!0);const t=X(()=>!!e.task),s=new br;let a=H(""),r=H(""),o=H("daily"),c=H(1),l=H("09:00"),u=H(Me([])),_=H(1),k=H(Me(new Date().getMonth())),g=H(!0),w=H(""),O=H("normal"),D=H(""),p=H(Me(Ma())),y=H(""),M=H(""),C=H(Me({name:!1,dueAt:!1,weekdays:!1,dayOfMonth:!1,month:!1}));const B=X(()=>i(C).name&&!i(a).trim()?"Task name is required.":""),j=X(()=>i(C).dueAt?i(r)?Number.isNaN(new Date(i(r)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),ve=X(()=>i(C).weekdays&&i(o)==="weekly"&&i(u).length===0?"Select at least one weekday.":""),G=X(()=>i(C).dayOfMonth&&(i(o)==="monthly"||i(o)==="yearly")&&(i(_)<1||i(_)>31)?"Day of month must be between 1 and 31.":""),V=X(()=>i(C).month&&i(o)==="yearly"&&(Number(i(k))<0||Number(i(k))>11)?"Select a valid month.":""),_e=X(()=>!!(i(B)||i(j)||i(ve)||i(G)||i(V)));function ue(){return i(o)==="weekly"?{type:"weekly",interval:i(c),time:i(l),weekdays:i(u)}:i(o)==="monthly"?{type:"monthly",interval:i(c),time:i(l),dayOfMonth:i(_)}:i(o)==="yearly"?{type:"yearly",interval:i(c),time:i(l),month:Number(i(k)),dayOfMonth:i(_)}:{type:"daily",interval:i(c),time:i(l)}}const me=X(()=>()=>!i(r)||Number.isNaN(new Date(i(r)).getTime())?"Set a valid due date to preview upcoming occurrences.":i(o)==="weekly"&&i(u).length===0?"Select at least one weekday to preview upcoming occurrences.":(i(o)==="monthly"||i(o)==="yearly")&&(i(_)<1||i(_)>31)?"Choose a valid day of month to preview upcoming occurrences.":i(o)==="yearly"&&(Number(i(k))<0||Number(i(k))>11)?"Choose a valid month to preview upcoming occurrences.":""),Y=X(()=>()=>{if(i(me))return[];const A=new Date(i(r)),L=ue(),Z=[];let ot=new Date(A);for(let et=0;et<3;et+=1)Z.push(new Date(ot)),ot=s.calculateNext(ot,L);return Z});Wt(()=>{e.task?(f(a,e.task.name||"",!0),f(r,e.task.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16),!0),f(o,e.task.frequency.type||"daily",!0),f(c,e.task.frequency.interval||1,!0),f(l,e.task.frequency.time||"09:00",!0),f(u,e.task.frequency.type==="weekly"?e.task.frequency.weekdays:[],!0),f(_,e.task.frequency.type==="monthly"||e.task.frequency.type==="yearly"?e.task.frequency.dayOfMonth:new Date(e.task.dueAt).getDate(),!0),f(k,e.task.frequency.type==="yearly"?e.task.frequency.month:new Date(e.task.dueAt).getMonth(),!0),f(g,e.task.enabled??!0,!0),f(w,e.task.linkedBlockId||"",!0),f(O,e.task.priority||"normal",!0),f(D,e.task.tags?e.task.tags.join(", "):"",!0),f(M,""),f(y,""),f(C,{name:!1,dueAt:!1,weekdays:!1,dayOfMonth:!1,month:!1},!0)):(f(a,""),f(r,new Date().toISOString().slice(0,16),!0),f(o,"daily"),f(c,1),f(l,"09:00"),f(u,[],!0),f(_,new Date().getDate(),!0),f(k,new Date().getMonth(),!0),f(g,!0),f(w,""),f(O,"normal"),f(D,""),f(M,""),f(y,""),f(C,{name:!1,dueAt:!1,weekdays:!1,dayOfMonth:!1,month:!1},!0))});function se(){if(f(C,{name:!0,dueAt:!0,weekdays:!0,dayOfMonth:!0,month:!0},!0),i(_e)){$.warning("Please fix the highlighted fields.");return}const A=ue(),L=e.task?{...e.task,name:i(a).trim(),dueAt:new Date(i(r)).toISOString(),frequency:A,enabled:i(g),linkedBlockId:i(w).trim()||void 0,priority:i(O),tags:i(D).split(",").map(Z=>Z.trim()).filter(Boolean),updatedAt:new Date().toISOString()}:_r(i(a).trim(),A,new Date(i(r)));e.task||(L.enabled=i(g),L.linkedBlockId=i(w).trim()||void 0,L.priority=i(O),L.tags=i(D).split(",").map(Z=>Z.trim()).filter(Boolean)),e.onSave(L)}function pe(A){i(C).weekdays=!0,i(u).includes(A)?f(u,i(u).filter(L=>L!==A),!0):f(u,[...i(u),A].sort(),!0)}const P=rl,h=["Mo","Tu","We","Th","Fr","Sa","Su"],T=["January","February","March","April","May","June","July","August","September","October","November","December"];function I(A){const L=i(p).find(Z=>Z.id===A);L&&(f(a,L.name,!0),f(o,L.frequencyType,!0),f(c,L.interval,!0),f(l,L.time,!0),f(u,[...L.weekdays],!0),f(_,L.dayOfMonth,!0),f(k,L.month,!0),f(g,L.enabled,!0),f(w,L.linkedBlockId||"",!0),f(O,L.priority,!0),f(D,L.tags.join(", "),!0),f(C,{name:!1,dueAt:!1,weekdays:!1,dayOfMonth:!1,month:!1},!0))}function F(A){const L=A.target;f(y,L.value,!0),i(y)&&(I(i(y)),$.info("Template applied."))}function N(){const A=i(M).trim()||i(a).trim();if(!A){$.warning("Enter a template name or task name first.");return}const L=i(y)||kc();f(p,_c({id:L,label:A,name:i(a).trim()||A,frequencyType:i(o),interval:i(c),time:i(l),weekdays:i(u),dayOfMonth:i(_),month:Number(i(k)),enabled:i(g),linkedBlockId:i(w).trim()||void 0,priority:i(O),tags:i(D).split(",").map(Z=>Z.trim()).filter(Boolean)}),!0),f(y,L,!0),f(M,""),$.success("Template saved.")}function Q(){if(!i(y)){$.info("Select a template to delete.");return}const A=i(p).find(L=>L.id===i(y));f(p,mc(i(y)),!0),f(y,""),$.info(`Template "${(A==null?void 0:A.label)??"Deleted"}" removed.`)}var ee=Oc(),re=d(ee),oe=d(re),be=v(re,2),Ee=v(d(be),2),ge=v(d(Ee),2);ge.__change=F;var Ie=d(ge);Ie.value=Ie.__value="";var xe=v(Ie);Qe(xe,17,()=>i(p),It,(A,L)=>{var Z=gc(),ot=d(Z),et={};K(()=>{z(ot,i(L).label),et!==(et=i(L).id)&&(Z.value=(Z.__value=i(L).id)??"")}),E(A,Z)});var De=v(Ee,2),Xe=d(De),Et=v(Xe,2);Et.__click=N;var S=v(Et,2);S.__click=Q;var q=v(be,2),ce=v(d(q),2);ce.__input=()=>i(C).name=!0;var le=v(ce,2);{var Ae=A=>{var L=pc(),Z=d(L);K(()=>z(Z,i(B))),E(A,L)};W(le,A=>{i(B)&&A(Ae)})}var ye=v(q,2),we=v(d(ye),2);we.__input=()=>i(C).dueAt=!0;var Ne=v(we,2);{var Ge=A=>{var L=yc(),Z=d(L);K(()=>z(Z,i(j))),E(A,L)};W(Ne,A=>{i(j)&&A(Ge)})}var Pe=v(ye,2),ht=v(d(Pe),2),_t=d(ht);_t.value=_t.__value="daily";var Je=v(_t);Je.value=Je.__value="weekly";var ke=v(Je);ke.value=ke.__value="monthly";var Ze=v(ke);Ze.value=Ze.__value="yearly";var je=v(Pe,2),tn=v(d(je),2),rt=v(je,2),_n=v(d(rt),2),Bn=v(rt,2);{var R=A=>{var L=Tc(),Z=v(d(L),2);Qe(Z,21,()=>P,It,(Te,Ue,mt)=>{var lt=bc();lt.__click=()=>pe(mt);var Qs=d(lt);K((Ar,Cr)=>{Vt(lt,1,`task-form__weekday ${Ar??""}`,"svelte-egfst"),Se(lt,"aria-pressed",Cr),Se(lt,"aria-label",i(Ue)),Se(lt,"title",i(Ue)),z(Qs,h[mt])},[()=>i(u).includes(mt)?"task-form__weekday--active":"task-form__weekday--inactive",()=>i(u).includes(mt)]),ft("blur",lt,()=>i(C).weekdays=!0),E(Te,lt)});var ot=v(Z,2);{var et=Te=>{var Ue=wc(),mt=d(Ue);K(()=>z(mt,i(ve))),E(Te,Ue)};W(ot,Te=>{i(ve)&&Te(et)})}E(A,L)};W(Bn,A=>{i(o)==="weekly"&&A(R)})}var J=v(Bn,2);{var de=A=>{var L=Ec(),Z=v(d(L),2);Z.__input=()=>i(C).dayOfMonth=!0;var ot=v(Z,2);{var et=Te=>{var Ue=Sc(),mt=d(Ue);K(()=>z(mt,i(G))),E(Te,Ue)};W(ot,Te=>{i(G)&&Te(et)})}K(()=>Se(Z,"aria-invalid",!!i(G))),ft("blur",Z,()=>i(C).dayOfMonth=!0),dt(Z,()=>i(_),Te=>f(_,Te)),E(A,L)};W(J,A=>{(i(o)==="monthly"||i(o)==="yearly")&&A(de)})}var Ce=v(J,2);{var $e=A=>{var L=Cc(),Z=v(d(L),2);Z.__input=()=>i(C).month=!0,Qe(Z,21,()=>T,It,(Te,Ue,mt)=>{var lt=Dc(),Qs=d(lt);lt.value=lt.__value=mt,K(()=>z(Qs,i(Ue))),E(Te,lt)});var ot=v(Z,2);{var et=Te=>{var Ue=Ac(),mt=d(Ue);K(()=>z(mt,i(V))),E(Te,Ue)};W(ot,Te=>{i(V)&&Te(et)})}K(()=>Se(Z,"aria-invalid",!!i(V))),ft("blur",Z,()=>i(C).month=!0),Ts(Z,()=>i(k),Te=>f(k,Te)),E(A,L)};W(Ce,A=>{i(o)==="yearly"&&A($e)})}var Ke=v(Ce,2),Mt=v(d(Ke),2);{var Ot=A=>{var L=Ic(),Z=d(L);K(()=>z(Z,i(me))),E(A,L)},qt=A=>{var L=Mc();Qe(L,21,()=>i(Y),It,(Z,ot)=>{var et=xc(),Te=d(et);K(Ue=>z(Te,Ue),[()=>Ns(i(ot))]),E(Z,et)}),E(A,L)};W(Mt,A=>{i(me)?A(Ot):A(qt,!1)})}var mn=v(Ke,2),zn=d(mn),Nt=d(zn),He=v(mn,2),nn=v(d(He),2),ns=v(d(nn),2),Fn=v(nn,2),Kt=v(d(Fn),2),Ht=d(Kt);Ht.value=Ht.__value="low";var kn=v(Ht);kn.value=kn.__value="normal";var bs=v(kn);bs.value=bs.__value="high";var Ys=v(Fn,2),sn=v(d(Ys),2),Ln=v(He,2),Oa=d(Ln);Oa.__click=function(...A){var L;(L=e.onCancel)==null||L.apply(this,A)};var Dr=v(Oa,2);Dr.__click=se,K(()=>{z(oe,i(t)?"Edit Task":"Create New Task"),Se(ce,"aria-invalid",!!i(B)),Se(we,"aria-invalid",!!i(j))}),Ts(ge,()=>i(y),A=>f(y,A)),dt(Xe,()=>i(M),A=>f(M,A)),ft("blur",ce,()=>i(C).name=!0),dt(ce,()=>i(a),A=>f(a,A)),ft("blur",we,()=>i(C).dueAt=!0),dt(we,()=>i(r),A=>f(r,A)),Ts(ht,()=>i(o),A=>f(o,A)),dt(tn,()=>i(c),A=>f(c,A)),dt(_n,()=>i(l),A=>f(l,A)),fr(Nt,()=>i(g),A=>f(g,A)),dt(ns,()=>i(w),A=>f(w,A)),Ts(Kt,()=>i(O),A=>f(O,A)),dt(sn,()=>i(D),A=>f(D,A)),E(n,ee),jt()}Rn(["change","click","input"]);const Nc=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];var Rc=x('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),Bc=x("<div> </div>"),zc=x('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Fc=x('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Lc=x('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">n8n Integration</h2> <!></div> <div class="settings__content svelte-1ke3hir"><section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section> <section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section></div> <div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div></div>');function Pc(n,e){Pt(e,!0);let t=H(Me(fa)),s=H(null),a=Me({});Wt(()=>{f(t,e.eventService.getConfig(),!0)});async function r(){try{await e.eventService.saveConfig(i(t)),$.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(Y){$.error("Failed to save settings: "+Y)}}async function o(){f(s,"n8n"),a.n8n={success:!1,message:"Testing..."};try{const Y=await e.eventService.testConnection();a.n8n={success:Y.success,message:Y.success?"Test successful!":Y.message||"Test failed. Check configuration."}}catch(Y){a.n8n={success:!1,message:"Error: "+(Y instanceof Error?Y.message:String(Y))}}finally{f(s,null)}}var c=Lc(),l=d(c),u=v(d(l),2);{var _=Y=>{var se=Rc();se.__click=function(...pe){var P;(P=e.onClose)==null||P.apply(this,pe)},E(Y,se)};W(u,Y=>{e.onClose&&Y(_)})}var k=v(l,2),g=d(k),w=d(g),O=v(d(w),2),D=d(O),p=v(w,2),y=v(d(p),2),M=v(p,2),C=v(d(M),2),B=v(M,2);B.__click=o;var j=d(B),ve=v(B,2);{var G=Y=>{var se=Bc(),pe=d(se);K(()=>{Vt(se,1,`settings__test-result ${a.n8n.success?"success":"error"}`,"svelte-1ke3hir"),z(pe,a.n8n.message)}),E(Y,se)};W(ve,Y=>{a.n8n&&Y(G)})}var V=v(g,2),_e=v(d(V),2);Qe(_e,21,()=>Nc,It,(Y,se)=>{var pe=Fc(),P=d(pe),h=d(P),T=d(h),I=v(h,2),F=d(I),N=v(I,2);{var Q=oe=>{var be=zc(),Ee=d(be);K(()=>z(Ee,i(se).context)),E(oe,be)};W(N,oe=>{i(se).context&&oe(Q)})}var ee=v(P,2),re=d(ee);K(()=>{z(T,i(se).label),z(F,i(se).description),z(re,i(se).keys)}),E(Y,pe)});var ue=v(k,2),me=d(ue);me.__click=r,K(()=>{y.disabled=!i(t).n8n.enabled,C.disabled=!i(t).n8n.enabled,B.disabled=!i(t).n8n.enabled||i(s)==="n8n",z(j,i(s)==="n8n"?"Testing...":"Test Connection")}),fr(D,()=>i(t).n8n.enabled,Y=>i(t).n8n.enabled=Y),dt(y,()=>i(t).n8n.webhookUrl,Y=>i(t).n8n.webhookUrl=Y),dt(C,()=>i(t).n8n.sharedSecret,Y=>i(t).n8n.sharedSecret=Y),E(n,c),jt()}Rn(["click"]);var jc=x('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Kc=x('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Hc=x('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Uc=x('<div class="dashboard__tabs svelte-1y1a8hs"><button>üìã Today & Overdue <!></button> <button>üìù All Tasks <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button> <button>üìÖ Timeline</button> <button>üìä Analytics</button></div> <div class="dashboard__content svelte-1y1a8hs"><!></div>',1),Yc=x('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div> <!></div>');function Qc(n,e){Pt(e,!0);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let a=H("today"),r=H(!1),o=H(!1),c=H(void 0),l=H(Me([])),u=X(()=>fl(i(l)));function _(h="initial"){f(l,e.repository.getAllTasks().map(T=>({...T})),!0),h!=="initial"&&$.info("Task list reloaded")}_();const k=()=>_("reload");Ia(()=>{window.addEventListener("recurring-task-refresh",k)}),Zo(()=>{window.removeEventListener("recurring-task-refresh",k)});async function g(h){nt.emit("task:complete",{taskId:h.id})}async function w(h){const T=i(l),I=ea(i(l),h.id,F=>{const N={...F},Q=new Date(N.dueAt),ee=t.tomorrow();return ee.setHours(Q.getHours(),Q.getMinutes(),0,0),N.dueAt=ee.toISOString(),N.snoozeCount=(N.snoozeCount||0)+1,N.updatedAt=new Date().toISOString(),N});f(l,I,!0),$.info(`Task "${h.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task.snoozed",h),await e.scheduler.delayToTomorrow(h.id)}catch(F){f(l,T,!0),$.error("Failed to delay task: "+F),_("external")}}async function O(h){var I;if(!((I=h.name)!=null&&I.trim())){$.error("Task name is required");return}if(!vr(h.frequency)){$.error("Invalid frequency configuration");return}const T={...h};f(l,li(i(l),T),!0),f(r,!1),f(c,void 0),$.success(`Task "${h.name}" saved successfully`),e.repository.saveTask(T).catch(F=>{$.error("Failed to save task: "+F),_("external")})}async function D(h){const T=i(l);f(l,ci(i(l),h.id),!0);const I=window.setTimeout(async()=>{try{await e.repository.deleteTask(h.id)}catch(F){f(l,T,!0),$.error("Failed to delete task: "+F),_("external")}},5e3);bn({message:`Task "${h.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(I),f(l,T,!0),$.info(`Restored "${h.name}"`)},showCountdown:!0})}async function p(h){const T=h.name.endsWith(" (copy)")?`${h.name} ${new Date().toLocaleDateString()}`:`${h.name} (copy)`,I=ll(h,{name:T});f(l,li(i(l),I),!0),$.success(`Duplicated "${h.name}"`),e.repository.saveTask(I).catch(F=>{f(l,ci(i(l),I.id),!0),$.error("Failed to duplicate task: "+F),_("external")})}async function y(h){const T=!h.enabled,I={...h,enabled:T},F=ea(i(l),h.id,()=>I);f(l,F,!0),$.info(`Task ${T?"enabled":"disabled"}`),e.repository.saveTask(I).catch(N=>{$.error("Failed to update task: "+N),_("external")})}async function M(h,T){if(h.length===0)return;const I=i(l),F=new Set(h),N=i(l).map(Q=>F.has(Q.id)?{...Q,enabled:T}:Q);f(l,N,!0),$.info(`${T?"Enabled":"Disabled"} ${h.length} task${h.length===1?"":"s"}`);try{const Q=N.filter(ee=>F.has(ee.id));await Promise.all(Q.map(ee=>e.repository.saveTask(ee)))}catch(Q){f(l,I,!0),$.error(`Failed to ${T?"enable":"disable"} tasks: ${Q}`),_("external")}}async function C(h){if(h.length===0)return;const T=i(l),I=new Set(h),F=i(l).filter(Q=>I.has(Q.id));f(l,i(l).filter(Q=>!I.has(Q.id)),!0);const N=window.setTimeout(async()=>{try{await Promise.all(F.map(Q=>e.repository.deleteTask(Q.id)))}catch(Q){f(l,T,!0),$.error("Failed to delete tasks: "+Q),_("external")}},5e3);bn({message:`${F.length} task${F.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(N),f(l,T,!0),$.info("Bulk delete undone")},showCountdown:!0})}function B(h){f(c,h,!0),f(r,!0)}function j(){f(c,void 0),f(r,!0)}function ve(){f(r,!1),f(c,void 0)}function G(){f(o,!0)}function V(){f(o,!1)}async function _e(h){const T=i(l),I=ea(i(l),h.id,F=>{const N={...F};kr(N);const Q=s.calculateNext(new Date(N.dueAt),N.frequency);return N.dueAt=Q.toISOString(),N});f(l,I,!0),$.info(`Task "${h.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",h),await e.scheduler.skipTaskOccurrence(h.id)}catch(F){f(l,T,!0),$.error("Failed to skip task: "+F),_("external")}}var ue=Yc(),me=d(ue),Y=v(d(me),2);Y.__click=G;var se=v(me,2);{var pe=h=>{var T=jc(),I=d(T);Pc(I,{get eventService(){return e.eventService},onClose:V}),E(h,T)},P=h=>{var T=dn(),I=wt(T);{var F=Q=>{var ee=Kc(),re=d(ee);qc(re,{get task(){return i(c)},onSave:O,onCancel:ve}),E(Q,ee)},N=Q=>{var ee=Uc(),re=wt(ee),oe=d(re);oe.__click=()=>f(a,"today");var be=v(d(oe));{var Ee=le=>{var Ae=Hc(),ye=d(Ae);K(()=>z(ye,i(u).length)),E(le,Ae)};W(be,le=>{i(u).length>0&&le(Ee)})}var ge=v(oe,2);ge.__click=()=>f(a,"all");var Ie=v(d(ge)),xe=d(Ie),De=v(ge,2);De.__click=()=>f(a,"timeline");var Xe=v(De,2);Xe.__click=()=>f(a,"analytics");var Et=v(re,2),S=d(Et);{var q=le=>{Ll(le,{get tasks(){return i(u)},onDone:g,onDelay:w,onSkip:_e,onEdit:B,get timezoneHandler(){return t}})},ce=le=>{var Ae=dn(),ye=wt(Ae);{var we=Ge=>{Vl(Ge,{get tasks(){return i(l)},onEdit:B,onDelete:D,onDuplicate:p,onToggleEnabled:y,onBulkEnable:Pe=>M(Pe,!0),onBulkDisable:Pe=>M(Pe,!1),onBulkDelete:C,onCreate:j})},Ne=Ge=>{var Pe=dn(),ht=wt(Pe);{var _t=ke=>{{let Ze=X(()=>e.scheduler.getRecurrenceEngine());sc(ke,{get tasks(){return i(l)},get recurrenceEngine(){return i(Ze)}})}},Je=ke=>{var Ze=dn(),je=wt(Ze);{var tn=rt=>{hc(rt,{get tasks(){return i(l)}})};W(je,rt=>{i(a)==="analytics"&&rt(tn)},!0)}E(ke,Ze)};W(ht,ke=>{i(a)==="timeline"?ke(_t):ke(Je,!1)},!0)}E(Ge,Pe)};W(ye,Ge=>{i(a)==="all"?Ge(we):Ge(Ne,!1)},!0)}E(le,Ae)};W(S,le=>{i(a)==="today"?le(q):le(ce,!1)})}K(()=>{Vt(oe,1,`dashboard__tab ${i(a)==="today"?"active":""}`,"svelte-1y1a8hs"),Vt(ge,1,`dashboard__tab ${i(a)==="all"?"active":""}`,"svelte-1y1a8hs"),z(xe,i(l).length),Vt(De,1,`dashboard__tab ${i(a)==="timeline"?"active":""}`,"svelte-1y1a8hs"),Vt(Xe,1,`dashboard__tab ${i(a)==="analytics"?"active":""}`,"svelte-1y1a8hs")}),E(Q,ee)};W(I,Q=>{i(r)?Q(F):Q(N,!1)},!0)}E(h,T)};W(se,h=>{i(o)?h(pe):h(P,!1)})}E(n,ue),jt()}Rn(["click"]);var Wc=x('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Vc=x('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Xc=x('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Gc=x('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function Jc(n,e){var pe;Pt(e,!0);let t=H(Me(((pe=e.prefill)==null?void 0:pe.suggestedName)??"")),s=H(Me(new Date().toISOString().slice(0,16))),a=H(Me({name:!1,dueAt:!1})),r=H(!1),o=H(null);const c=X(()=>i(a).name&&!i(t).trim()?"Task name is required.":""),l=X(()=>i(a).dueAt?i(s)?Number.isNaN(new Date(i(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=X(()=>!!(i(c)||i(l)));Ia(()=>{var P;if((P=e.prefill)!=null&&P.suggestedTime){const h=new Date,[T,I]=e.prefill.suggestedTime.split(":").map(Number);h.setHours(T,I,0,0),f(s,h.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var h;(h=i(o))==null||h.focus()})});async function _(){var I,F;if(f(a,{name:!0,dueAt:!0},!0),i(u)){$.warning("Please fill out the required fields.");return}const P=el(),h=i(s).slice(11,16);if(P.time=h,!vr(P)){$.error("Invalid frequency configuration.");return}const T=_r(i(t).trim(),P,new Date(i(s)));T.linkedBlockId=((I=e.prefill)==null?void 0:I.linkedBlockId)||void 0,T.linkedBlockContent=((F=e.prefill)==null?void 0:F.linkedBlockContent)||void 0,f(r,!0);try{await e.repository.saveTask(T),$.success(`Task "${T.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(N){$.error("Failed to create task: "+N)}finally{f(r,!1)}}function k(P){P.key==="Escape"&&e.onClose(),(P.metaKey||P.ctrlKey)&&P.key==="Enter"&&(P.preventDefault(),_())}var g=Gc();g.__keydown=k;var w=d(g),O=d(w),D=v(d(O),2);D.__click=function(...P){var h;(h=e.onClose)==null||h.apply(this,P)};var p=v(O,2),y=v(d(p),2);y.__input=()=>i(a).name=!0,hs(y,P=>f(o,P),()=>i(o));var M=v(y,2);{var C=P=>{var h=Wc(),T=d(h);K(()=>z(T,i(c))),E(P,h)};W(M,P=>{i(c)&&P(C)})}var B=v(p,2),j=v(d(B),2);j.__input=()=>i(a).dueAt=!0;var ve=v(j,2);{var G=P=>{var h=Vc(),T=d(h);K(()=>z(T,i(l))),E(P,h)};W(ve,P=>{i(l)&&P(G)})}var V=v(B,2);{var _e=P=>{var h=Xc(),T=v(d(h)),I=d(T);K(()=>z(I,e.prefill.linkedBlockId)),E(P,h)};W(V,P=>{var h;(h=e.prefill)!=null&&h.linkedBlockId&&P(_e)})}var ue=v(V,2),me=d(ue);me.__click=function(...P){var h;(h=e.onClose)==null||h.apply(this,P)};var Y=v(me,2);Y.__click=_;var se=d(Y);K(()=>{Se(y,"aria-invalid",!!i(c)),Se(j,"aria-invalid",!!i(l)),Y.disabled=i(r),z(se,i(r)?"Saving‚Ä¶":"Create Task")}),ft("blur",y,()=>i(a).name=!0),dt(y,()=>i(t),P=>f(t,P)),ft("blur",j,()=>i(a).dueAt=!0),dt(j,()=>i(s),P=>f(s,P)),E(n,g),jt()}Rn(["keydown","click","input"]);class Zc{constructor(e){b(this,"plugin");this.plugin=e}getCurrentVersion(){return As}async createBackup(e){try{const t=await this.plugin.loadData(e);if(t){const s=`${e}-backup-${Date.now()}`;await this.plugin.saveData(s,t),U(`Created backup: ${s}`)}}catch(t){throw he("Failed to create backup",t),t}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t){U("No data to migrate");return}const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0){U("No data to migrate");return}let a=!1;for(let r=0;r<s.length;r++){const o=s[r],c=o.version||0;c<As&&(a||(await this.createBackup(e),a=!0),s[r]=this.migrateTask(o,c),U(`Migrated task ${o.id} from v${c} to v${As}`))}if(a){const r=Array.isArray(t)?s:{...t,tasks:s};await this.plugin.saveData(e,r),U(`Migration complete: ${s.length} tasks processed`)}else U("No migration needed - all tasks up to date")}catch(t){throw he("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),s}}class $c{constructor(e,t=50){b(this,"pendingState",null);b(this,"writeInProgress",!1);b(this,"scheduledTimer",null);b(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){he("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return he("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const ha={},eu=Object.freeze(Object.defineProperty({__proto__:null,default:ha},Symbol.toStringTag,{value:"Module"})),di=new Set;function Is(n){const e=`${n.feature}:${n.capability}:${n.message}`;di.has(e)||(di.add(e),xt(n.message,{feature:n.feature,capability:n.capability,cause:n.cause}))}class Sr extends Error{constructor(t,s,a){super(a);b(this,"capability");b(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class Er extends Error{constructor(t,s,a,r){super(a);b(this,"capability");b(this,"feature");b(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=r}}class tu{constructor(e=globalThis){b(this,"supportedCapabilities");b(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,a;return typeof((a=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:a.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(a){throw new Er("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",a)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Sr("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const nu=".tmp";class su{constructor(e,t){b(this,"plugin");b(this,"apiAdapter");b(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(yn);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){he("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),U(`Saved ${e.tasks.length} active tasks`)}catch(t){throw he("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(yn,e);return}const s=this.resolveStoragePath(yn);if(!s){await this.plugin.saveData(yn,e);return}const a=ha.dirname(s);await t.mkdir(a,{recursive:!0});const r=`${s}${nu}`,o=JSON.stringify(e),c=await t.open(r,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(r,s)}catch{await t.rm(s,{force:!0}),await t.rename(r,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>eu);return this.fsPromises=e.promises,this.fsPromises}catch(e){return xt("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Is({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):ha.join(t,"storage",`p${s}`,`${e}.json`)}}const fi=1,vi=1e3;class au{constructor(e){b(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[a,r]of s.entries())await this.appendTasksToYear(t,a,r);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),a=[];for(const c of s){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&a.push(u)}const r=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??a.length;return a.slice(r,r+o)}async loadIndex(){try{const e=await this.plugin.loadData(Ds);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??fi,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){he("Failed to load archive index",e)}return{version:fi,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Ds,e)}catch(t){throw he("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Ds}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){he("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw he("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const a=this.getCompletionTimestamp(s),r=new Date(a).getFullYear(),o=t.get(r);o?o.push(s):t.set(r,[s])}return t}async appendTasksToYear(e,t,s){let a=[...s];for(;a.length>0;){const r=this.findOrCreateChunk(e,t),o=await this.loadChunk(r.key)||{tasks:[]},c=vi-o.tasks.length,l=a.slice(0,c);o.tasks.push(...l),a=a.slice(l.length);const u=this.updateChunkMeta(r,l);r.count=u.count,r.start=u.start,r.end=u.end,await this.saveChunk(r.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const a=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(a&&a.count<vi)return a;const r=a?a.sequence+1:1,o={key:this.buildChunkKey(t,r),year:t,sequence:r,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,a=e.end;for(const r of t){const o=this.getCompletionTimestamp(r);(!s||o<s)&&(s=o),(!a||o>a)&&(a=o)}return{...e,count:e.count+t.length,start:s,end:a}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,a=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(r=>{const o=r.start?new Date(r.start).getTime():null,c=r.end?new Date(r.end).getTime():null;return!(s&&c&&c<s||a&&o&&o>a)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),a=new Date(s).getTime();return!(t.from&&a<new Date(t.from).getTime()||t.to&&a>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class iu{constructor(e,t=new tu){b(this,"plugin");b(this,"activeTasks");b(this,"blockIndex",new Map);b(this,"taskBlockIndex",new Map);b(this,"dueIndex",new Map);b(this,"activeStore");b(this,"archiveStore");b(this,"persistence");b(this,"blockAttrSyncEnabled",!0);b(this,"blockApi");b(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new su(e,t),this.archiveStore=new au(e),this.persistence=new $c(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),U(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));U(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);U(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[a]of this.dueIndex)a<=t&&s.push(...this.getTasksForDueKey(a));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const a of t){const r=this.activeTasks.get(a);if(!r){this.removeStaleDueIndexEntry(e,a,"missing task");continue}if(!r.enabled){this.removeStaleDueIndexEntry(e,a,"task disabled");continue}if(r.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,a,"date mismatch");continue}s.push(r)}return s}removeStaleDueIndexEntry(e,t,s){const a=this.dueIndex.get(e);a&&(a.delete(t),a.size===0&&this.dueIndex.delete(e),xt("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[ii]:e.id,[ri]:e.dueAt,[oi]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[ii]:"",[ri]:"",[oi]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Is({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof Sr||s instanceof Er?Is({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Is({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const a=new Date(s.dueAt);return a>=e&&a<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(yn);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(Va);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(Xa,t),U(`Created legacy backup at ${Xa}`);const a=s.filter(c=>!c.enabled&&c.lastCompletedAt),r=s.filter(c=>!a.includes(c)),o=new Map(r.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),a.length>0&&await this.archiveStore.archiveTasks(a),U("Legacy storage migration complete",{activeCount:r.length,archivedCount:a.length,legacyKey:Va,activeKey:yn,archiveIndexKey:Ds})}}class ru{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class ou{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:a}=yr(t);if(!Number.isFinite(s)||!Number.isFinite(a))return new Date(e);const r=new Date(e);return r.setHours(s,a,0,0),r}isSameLocalDay(e,t){const s=new Date(e),a=new Date(t);return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),a=Math.trunc(s/(1e3*60)),r=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(a)<60?a>0?`in ${a}m`:`${-a}m ago`:Math.abs(r)<24?r>0?`in ${r}h`:`${-r}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class lu{constructor(e,t){b(this,"intervalMs");b(this,"timeoutId",null);b(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:hr,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class cu{constructor(e,t=SCHEDULER_INTERVAL_MS,s){b(this,"storage");b(this,"recurrenceEngine");b(this,"emittedDue",new Set);b(this,"emittedMissed",new Set);b(this,"timezoneHandler");b(this,"isChecking",!1);b(this,"lastCheckStartTime",0);b(this,"plugin",null);b(this,"listeners",{"task:due":new Set,"task:overdue":new Set});b(this,"MAX_EMITTED_ENTRIES",1e3);b(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);b(this,"persistTimeoutId",null);b(this,"emittedStateReady",null);b(this,"timer");this.storage=e,this.recurrenceEngine=new br,this.timezoneHandler=new ou,this.plugin=s||null,this.timer=new lu(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),U("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),U("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)xt("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const a=new Date(s.dueAt),r=a<=e;if(r){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:s.id,dueAt:a,context:"today",task:s}),this.registerEmittedKey("due",c),U(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(r&&e.getTime()-a.getTime()>=al&&(!o||o<a)){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:a,context:"overdue",task:s}),this.registerEmittedKey("missed",c),xt(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){let e=!1;if(this.emittedDue.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedDue);this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,U(`Cleaned up emittedDue set: ${t.length} -> ${this.emittedDue.size}`)}if(this.emittedMissed.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedMissed);this.emittedMissed=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,U(`Cleaned up emittedMissed set: ${t.length} -> ${this.emittedMissed.size}`)}e&&this.schedulePersistEmittedState()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);cl(t);const s=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(s);const a=new Date(t.dueAt),r=this.recurrenceEngine.calculateNext(a,t.frequency);t.dueAt=r.toISOString(),await this.storage.saveTask(t),U(`Task "${t.name}" completed and rescheduled to ${r.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const a=new Date(s.dueAt),r=new Date(a.getTime()+t*60*1e3);s.dueAt=r.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),U(`Task "${s.name}" delayed by ${t} minutes to ${r.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),a=this.timezoneHandler.tomorrow();a.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=a.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),U(`Task "${t.name}" delayed to tomorrow: ${a.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);kr(t);const s=new Date(t.dueAt),a=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=a.toISOString(),await this.storage.saveTask(t),U(`Task "${t.name}" skipped to ${a.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),U("First run detected, no recovery needed");return}U(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const a=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const r of a){const o=this.buildOccurrenceKey(s.id,r,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:r,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(a){he(`Failed to recover task ${s.id}:`,a)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),U("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let a=s,r=0;for(;a<t&&r<Cs;)a=this.recurrenceEngine.calculateNext(a,e.frequency),r++;a>s&&(e.dueAt=a.toISOString(),await this.storage.saveTask(e),U(`Advanced task "${e.name}" to ${a.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(ai);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){he("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(ai,{timestamp:e.toISOString()})}catch(t){he("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const a of s)try{const r=a(t);r instanceof Promise&&r.catch(o=>{he(`Scheduler listener error for ${e}:`,o)})}catch(r){he(`Scheduler listener error for ${e}:`,r)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??il,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(Za),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(a=>typeof a=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(a=>typeof a=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),U("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){he("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(Za,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){he("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const uu=7,du=2e3;class fu{constructor(e,t){b(this,"plugin");b(this,"storageKey");b(this,"notifications",new Map);b(this,"escalations",new Map);b(this,"lastCleanup",new Date);b(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),U(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){he("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,pr("Saved notification state")}catch(e){he("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>du&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-uu*24*60*60*1e3);let a=0;for(const[r,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(r),a++);a>0&&(U(`Cleaned up ${a} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function vu(n){return{id:n.id,name:n.name,dueAt:n.dueAt,frequency:n.frequency,linkedBlockId:n.linkedBlockId,linkedBlockContent:n.linkedBlockContent,priority:n.priority,tags:n.tags,notificationChannels:n.notificationChannels,completionCount:n.completionCount,missCount:n.missCount,currentStreak:n.currentStreak,bestStreak:n.bestStreak}}const hu=30*1e3,_u=30*60*1e3,gn=500;class mu{constructor(e,t={}){b(this,"plugin");b(this,"config");b(this,"queue",[]);b(this,"dedupeKeys",new Set);b(this,"flushIntervalId",null);b(this,"fetcher");b(this,"notificationState");b(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...fa},this.notificationState=t.notificationState??new fu(this.plugin,tl)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(Ga);e&&(this.config={...fa,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(Ga,e)}async loadQueue(){try{const e=await this.plugin.loadData(Ja);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>gn){const s=this.queue.length-gn;this.queue=this.queue.slice(-gn),console.warn(`Event queue trimmed to ${gn} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-Zs);await this.plugin.saveData(Ja,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},sl))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const a=this.buildDedupeKey(e,t);if(this.isDuplicate(a))return;const r=this.buildPayload(e,t,a,1,s);await this.sendPayload(r)?(this.markDelivered(a),await this.persistQueue()):this.enqueue(r)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:$a,version:ei,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const a of this.queue){if(new Date(a.nextAttemptAt).getTime()>e){s.push(a);continue}const r={...a.payload,delivery:{...a.payload.delivery,attempt:a.attempt}};if(await this.sendPayload(r))this.markDelivered(r.delivery.dedupeKey),t=!0;else{const c=a.attempt+1,l=this.getRetryDelay(c);s.push({...a,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,a,r=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:$a,version:ei,occurredAt:o.toISOString(),task:vu(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:r,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:a}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>Zs){const t=Array.from(this.dedupeKeys).slice(-Zs);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=gn){const s=this.queue.length-gn+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${gn}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=hu*Math.pow(2,e-1);return Math.min(t,_u)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,a=s.encode(t),r=s.encode(e),o=await crypto.subtle.importKey("raw",a,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,r);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let a="";this.config.n8n.sharedSecret&&(a=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const r={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return a&&(r["X-Shehab-Signature"]=a),this.config.n8n.sharedSecret&&(r["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),r}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),a=await this.buildHeaders(e),r=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:a,body:s});if(!r.ok)return console.error("n8n webhook failed:",r.statusText),!1;if(t){const o=await r.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const rn=class rn{constructor(e){b(this,"plugin");b(this,"isInitialized",!1);b(this,"storage");b(this,"repository");b(this,"scheduler");b(this,"eventService");this.plugin=e}static getInstance(e){if(!rn.instance){if(!e)return null;rn.instance=new rn(e)}return rn.instance}async initialize(){if(this.isInitialized){xt("TaskManager already initialized");return}U("Initializing TaskManager"),this.storage=new iu(this.plugin),await this.storage.init(),this.repository=new ru(this.storage),this.eventService=new mu(this.plugin),await this.eventService.init(),this.scheduler=new cu(this.storage,hr,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,U("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),U("TaskManager started")}async destroy(){U("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,rn.instance=null,U("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};b(rn,"instance",null);let Rs=rn;function ku(n,e){n.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{gu()}}),n.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{n.openDock()}}),n.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await pu(e)}}),U("Registered slash commands and hotkeys")}function gu(){nt.emit("task:create",{source:"command"});const n=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(n)}async function pu(n){try{const e=n.getTodayAndOverdueTasks();if(e.length===0){U("No tasks due today");return}const t=e[0];nt.emit("task:complete",{taskId:t.id});const s=new CustomEvent("recurring-task-complete",{detail:{taskId:t.id}});window.dispatchEvent(s),U(`Quick completing task: ${t.name}`)}catch(e){he("Failed to quick complete task",e)}}function hi(n,e){nt.emit("task:snooze",{taskId:n,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:e}})),U(`Snoozing task ${n} for ${e} minutes`)}function yu(n){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=va(t),a=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));nt.emit("task:snooze",{taskId:n,minutes:a}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:a}})),U(`Snoozing task ${n} to tomorrow`)}function bu(n){n.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],a=s==null?void 0:s.getAttribute("data-node-id");if(!a)return;const r=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=n.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{nt.emit("task:create",{source:"block-menu",linkedBlockId:a,linkedBlockContent:r,suggestedName:_i(r),suggestedTime:mi(r)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:a,linkedBlockContent:r,suggestedName:_i(r),suggestedTime:mi(r)}}))}});try{const u=Rs.getInstance();if(u&&u.isReady()){const k=u.getRepository().getTaskByBlockId(a);if(k){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=n.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{nt.emit("task:complete",{taskId:k.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:k.id}}))}});const g=[{label:"15 minutes",click:()=>hi(k.id,15)},{label:"1 hour",click:()=>hi(k.id,60)},{label:"Tomorrow",click:()=>yu(k.id)}];e.menu.addItem({icon:"iconClock",label:((l=n.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:g})}}}catch{pr("TaskManager not available for quick actions")}}),U("Registered block context menu")}function _i(n){const e=n.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function mi(n){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=n.match(e);if(t){let a=parseInt(t[1],10);const r=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&a<12?a+=12:o==="AM"&&a===12&&(a=0),`${a.toString().padStart(2,"0")}:${r}`}return null}class wu{constructor(e,t){b(this,"plugin");b(this,"repository");b(this,"topbarElement",null);b(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),U("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),U("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const a=new Date(s.dueAt);return a<new Date&&!xa(a)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const a=document.createElement("span");a.className="b3-badge",a.textContent=e.length.toString(),a.style.display="block",a.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(a)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){nt.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class Tu extends ma.Plugin{constructor(){super(...arguments);b(this,"taskManager");b(this,"repository");b(this,"scheduler");b(this,"eventService");b(this,"migrationManager");b(this,"topbarMenu");b(this,"dashboardComponent",null);b(this,"dockEl");b(this,"quickAddComponent",null);b(this,"quickAddContainer",null);b(this,"pendingCompletionTimeouts",new Map);b(this,"handleCreateTaskEvent",t=>{try{const s=t;U("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){he("Failed to handle create task event",s),$.error("Failed to open task creator.")}});b(this,"handleSettingsEvent",t=>{try{U("Settings event received",t.detail),this.openDock()}catch(s){he("Failed to handle settings event",s),$.error("Failed to open settings.")}});b(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:a}=s.detail??{};if(!a)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(a)}catch(s){he("Failed to complete task",s),$.error("Failed to complete task.")}});b(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:a,minutes:r}=s.detail??{};if(!a||typeof r!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(a,r)}catch(s){he("Failed to snooze task",s),$.error("Failed to snooze task.")}})}async onload(){U("Loading Recurring Tasks Plugin"),this.migrationManager=new Zc(this);try{await this.migrationManager.migrate(yn)}catch(s){he("Migration failed, continuing with existing data",s)}const t=Rs.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();try{await this.taskManager.start()}catch(s){he("Failed to start TaskManager",s)}ku(this,this.repository),bu(this),this.topbarMenu=new wu(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:nl,init:s=>{this.dockEl=s.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),U("Recurring Tasks Plugin loaded successfully")}async onunload(){U("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Ha(Qc,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(Ua(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{nt.on("task:create",t=>{U("Create task event received",t),this.openQuickAdd(t)}),nt.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),nt.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),nt.on("task:settings",()=>{this.openDock()}),nt.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){he("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){nt.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){$.info(`Completion already pending for "${s.name}".`);return}const a=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),U(`Task completed: ${s.name}`)}catch(o){he("Failed to finalize task completion",o),$.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,a);const r=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),$.info(`Undo: "${s.name}" restored`))};bn({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:r,showCountdown:!0})}}async handleSnoozeTask(t,s){const a=this.repository.getTask(t);a&&(await this.eventService.handleTaskSnoozed(a),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),U(`Task snoozed: ${a.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Ha(Jc,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd()}})}closeQuickAdd(){this.quickAddComponent&&(Ua(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}}module.exports=Tu;
